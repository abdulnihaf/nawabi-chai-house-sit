<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCH Runner Settlement</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--muted:#64748b;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;--purple:#8b5cf6}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .pin-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .pin-screen.hidden{display:none}
    .pin-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;max-width:360px;width:100%}
    .pin-box .icon{font-size:48px;margin-bottom:20px}
    .pin-box h2{font-size:24px;margin-bottom:8px}
    .pin-box p{color:var(--text2);font-size:14px;margin-bottom:24px}
    .pin-input{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .pin-input input{width:48px;height:56px;background:var(--bg2);border:2px solid var(--border);border-radius:10px;font-size:24px;font-family:'JetBrains Mono',monospace;text-align:center;color:var(--text);outline:none}
    .pin-input input:focus{border-color:var(--purple)}
    .pin-input input.filled{border-color:var(--green)}
    .pin-error{color:var(--red);font-size:13px;display:none}
    .pin-error.show{display:block}
    .pin-success{color:var(--green);font-size:14px;margin-top:16px;display:none}
    .pin-success.show{display:block}
    .dashboard{display:none;padding:20px;max-width:900px;margin:0 auto}
    .dashboard.show{display:block}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
    .header h1{font-size:24px;font-weight:700;display:flex;align-items:center;gap:10px}
    .header h1::before{content:'';width:6px;height:28px;background:linear-gradient(180deg,var(--purple),var(--blue));border-radius:3px}
    .user-badge{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 14px;font-size:13px;display:flex;align-items:center;gap:8px}
    .user-badge .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
    .btn{padding:8px 16px;border:none;border-radius:6px;font-weight:600;font-size:13px;cursor:pointer}
    .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
    .btn-outline:hover{border-color:var(--red);color:var(--red)}
    .runner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:24px}
    .runner-card{background:var(--card);border:2px solid var(--border);border-radius:10px;padding:16px;text-align:center;cursor:pointer;transition:all .2s}
    .runner-card:hover{border-color:var(--text2)}
    .runner-card.selected{border-color:var(--purple);background:rgba(139,92,246,.1)}
    .runner-card .name{font-size:14px;font-weight:600;margin-bottom:4px}
    .runner-card .code{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;display:none}
    .panel.show{display:block}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .panel-header h3{font-size:16px}
    .period{font-size:11px;color:var(--text2);background:var(--bg2);padding:6px 10px;border-radius:6px}
    .row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
    .row:last-child{border-bottom:none}
    .row .label{color:var(--text2);font-size:14px}
    .row .value{font-size:16px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .row.total{padding-top:16px;margin-top:8px;border-top:2px solid var(--border)}
    .row.total .label{font-weight:600;color:var(--text)}
    .row.total .value{font-size:24px;color:var(--green)}
    .info-box{background:var(--bg2);border-radius:8px;padding:12px;margin-top:16px;font-size:12px;color:var(--text2)}
    .loading-text{color:var(--muted);text-align:center;padding:40px;font-size:13px}
    @media(max-width:640px){.runner-grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="pin-screen" id="pinScreen">
    <div class="pin-box">
      <div class="icon">üîê</div>
      <h2>Settlement Access</h2>
      <p>Enter your 4-digit PIN</p>
      <div class="pin-input">
        <input type="password" maxlength="1" id="p1" inputmode="numeric">
        <input type="password" maxlength="1" id="p2" inputmode="numeric">
        <input type="password" maxlength="1" id="p3" inputmode="numeric">
        <input type="password" maxlength="1" id="p4" inputmode="numeric">
      </div>
      <div class="pin-error" id="pinError">Invalid PIN</div>
      <div class="pin-success" id="pinSuccess">Welcome!</div>
    </div>
  </div>
  <div class="dashboard" id="dashboard">
    <header class="header">
      <h1>Runner Settlement</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="user-badge"><span class="dot"></span><span id="userName">-</span></div>
        <button class="btn btn-outline" onclick="logout()">Logout</button>
      </div>
    </header>
    <h4 style="font-size:13px;color:var(--text2);margin-bottom:12px">Select Runner</h4>
    <div class="runner-grid" id="runnerGrid"></div>
    <div class="panel" id="panel">
      <div class="panel-header">
        <h3 id="runnerName">-</h3>
        <span class="period" id="period">-</span>
      </div>
      <div id="panelContent"><div class="loading-text">Loading...</div></div>
    </div>
  </div>
  <script>
    const PINS={'1298':'Tanveer','0582':'MD Kesmat','0305':'Nihaf'};
    const RUNNERS=[{id:64,name:'FAROOQ',barcode:'RUN001'},{id:65,name:'AMIN',barcode:'RUN002'},{id:66,name:'NCH Runner 03',barcode:'RUN003'},{id:67,name:'NCH Runner 04',barcode:'RUN004'},{id:68,name:'NCH Runner 05',barcode:'RUN005'}];
    let currentUser=null,selectedRunner=null;
    const $=id=>document.getElementById(id);
    const fmt=n=>'‚Çπ'+Math.round(n).toLocaleString('en-IN');
    const pins=[$('p1'),$('p2'),$('p3'),$('p4')];
    pins.forEach((inp,i)=>{
      inp.addEventListener('input',e=>{
        if(e.target.value.length===1){inp.classList.add('filled');if(i<3)pins[i+1].focus();else checkPin();}
      });
      inp.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!inp.value&&i>0){pins[i-1].focus();pins[i-1].classList.remove('filled');}});
    });
    function checkPin(){
      const pin=pins.map(p=>p.value).join('');
      if(PINS[pin]){currentUser=PINS[pin];$('pinSuccess').textContent='Welcome, '+currentUser+'!';$('pinSuccess').classList.add('show');$('pinError').classList.remove('show');setTimeout(()=>{$('pinScreen').classList.add('hidden');$('dashboard').classList.add('show');$('userName').textContent=currentUser;renderRunners();},800);}
      else{$('pinError').classList.add('show');pins.forEach(p=>{p.value='';p.classList.remove('filled');});pins[0].focus();}
    }
    function logout(){currentUser=null;selectedRunner=null;$('dashboard').classList.remove('show');$('pinScreen').classList.remove('hidden');$('pinSuccess').classList.remove('show');pins.forEach(p=>{p.value='';p.classList.remove('filled');});pins[0].focus();}
    function renderRunners(){$('runnerGrid').innerHTML=RUNNERS.map(r=>'<div class="runner-card" onclick="selectRunner('+r.id+',this)"><div class="name">'+r.name+'</div><div class="code">'+r.barcode+'</div></div>').join('');}
    async function selectRunner(id,el){
      document.querySelectorAll('.runner-card').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      selectedRunner=RUNNERS.find(r=>r.id===id);
      $('panel').classList.add('show');
      $('runnerName').textContent=selectedRunner.name;
      $('period').textContent='Today 00:00 ‚Üí Now';
      $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo & Razorpay...</div>';
      try{
        const today=new Date();today.setHours(0,0,0,0);
        const res=await fetch('/api/nch-data?from='+today.toISOString().slice(0,10)+'T00:00:00');
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        const runner=data.data.runners.find(r=>r.id===id);
        if(runner){
          const cash=runner.cashToCollect;
          $('panelContent').innerHTML='<div class="row"><span class="label">Tokens Issued (Chai)</span><span class="value">'+fmt(runner.tokens)+'</span></div><div class="row"><span class="label">Sales Made</span><span class="value">'+fmt(runner.sales)+'</span></div><div class="row"><span class="label">UPI Collected (Razorpay)</span><span class="value" style="color:var(--blue)">'+fmt(runner.upi)+'</span></div><div class="row total"><span class="label">Cash to Collect</span><span class="value" style="color:'+(cash>=0?'var(--green)':'var(--red)')+'">'+fmt(cash)+'</span></div><div class="info-box">‚ö†Ô∏è Settlement recording requires database setup. Currently showing live position only.</div>';
        }else{
          $('panelContent').innerHTML='<div class="loading-text">No activity for this runner today</div>';
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }
    pins[0].focus();
  </script>
</body>
</html>
