<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCH Runner Settlement</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--yellow:#eab308;--orange:#f97316}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .pin-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .pin-screen.hidden{display:none}
    .pin-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;max-width:360px;width:100%}
    .pin-box .icon{font-size:48px;margin-bottom:20px}
    .pin-box h2{font-size:24px;margin-bottom:8px}
    .pin-box p{color:var(--text2);font-size:14px;margin-bottom:24px}
    .pin-input{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .pin-input input{width:48px;height:56px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:24px;text-align:center;font-family:'JetBrains Mono',monospace;transition:all 0.2s}
    .pin-input input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(168,85,247,0.2)}
    .pin-input input.filled{border-color:var(--green);background:rgba(34,197,94,0.1)}
    .pin-success{display:none;align-items:center;gap:8px;justify-content:center;color:var(--green);font-weight:600;margin-top:16px}
    .pin-success.show{display:flex}
    .dashboard{display:none;min-height:100vh}
    .dashboard.show{display:block}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:20px;display:flex;align-items:center;gap:8px}
    .header h1::before{content:'';width:4px;height:24px;background:var(--purple);border-radius:2px}
    .user-badge{display:flex;align-items:center;gap:12px}
    .user-badge .dot{width:8px;height:8px;background:var(--green);border-radius:50%}
    .user-badge .name{font-weight:600}
    .logout-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px}
    .logout-btn:hover{background:var(--border)}
    .content{padding:24px;max-width:1200px;margin:0 auto}
    .section-title{font-size:14px;color:var(--text2);margin-bottom:16px}
    .runner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-bottom:32px}
    .runner-card{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
    .runner-card:hover{border-color:var(--purple);transform:translateY(-2px)}
    .runner-card.selected{border-color:var(--purple);background:rgba(168,85,247,0.1)}
    .runner-card.counter{border-color:var(--orange)}
    .runner-card.counter:hover{border-color:var(--orange);background:rgba(249,115,22,0.1)}
    .runner-card.counter.selected{border-color:var(--orange);background:rgba(249,115,22,0.2)}
    .runner-card.expense{border-color:var(--red)}
    .runner-card.expense:hover{border-color:var(--red);background:rgba(239,68,68,0.1)}
    .runner-card.expense.selected{border-color:var(--red);background:rgba(239,68,68,0.2)}
    .runner-card .name{font-weight:600;margin-bottom:4px}
    .runner-card .code{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;display:none}
    .panel.show{display:block}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .panel-header h2{font-size:20px}
    .panel-header .period{font-size:12px;color:var(--text2);background:var(--bg2);padding:6px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace}
    .row{display:flex;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border)}
    .row:last-of-type{border-bottom:none}
    .row .label{color:var(--text2)}
    .row .value{font-weight:600;font-family:'JetBrains Mono',monospace}
    .row.total{padding-top:20px;margin-top:8px;border-top:2px solid var(--border);border-bottom:none}
    .row.total .label{font-weight:600;color:var(--text)}
    .row.total .value{font-size:24px}
    .row.sub{opacity:0.7;padding:8px 0 8px 16px;font-size:14px}
    .info-box{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);border-radius:8px;padding:12px 16px;margin-top:20px;font-size:13px;color:var(--yellow)}
    .loading-text{text-align:center;color:var(--text2);padding:40px}
    .settle-btn{width:100%;background:var(--green);color:#fff;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-top:20px;transition:all 0.2s}
    .settle-btn:hover{background:#16a34a;transform:translateY(-1px)}
    .settle-btn:disabled{background:var(--border);cursor:not-allowed;transform:none}
    .settle-btn.loading{background:var(--yellow);cursor:wait}
    .settle-btn.counter-btn{background:var(--orange)}
    .settle-btn.counter-btn:hover{background:#ea580c}
    .collection-panel{background:var(--card);border:2px solid var(--yellow);border-radius:16px;padding:24px;margin-top:32px;display:none}
    .collection-panel.show{display:block}
    .collection-panel h3{font-size:18px;margin-bottom:4px}
    .collection-panel .subtitle{font-size:13px;color:var(--text2);margin-bottom:20px}
    .collection-big-number{text-align:center;padding:24px 0}
    .collection-big-number .amount{font-size:48px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .collection-big-number .label{font-size:14px;color:var(--text2);margin-top:4px}
    .collection-breakdown{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
    .collection-breakdown .cb-card{background:var(--bg2);border-radius:10px;padding:14px;text-align:center}
    .collection-breakdown .cb-card .cb-val{font-size:20px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .collection-breakdown .cb-card .cb-label{font-size:11px;color:var(--text2);margin-top:4px}
    .settlement-list{margin:16px 0;max-height:200px;overflow-y:auto}
    .settlement-list .sl-item{display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);font-size:13px}
    .settlement-list .sl-item:last-child{border-bottom:none}
    .settlement-list .sl-who{color:var(--text2)}
    .settlement-list .sl-amount{font-family:'JetBrains Mono',monospace;font-weight:500}
    .collect-btn{width:100%;background:var(--yellow);color:#000;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin-top:16px;transition:all 0.2s}
    .collect-btn:hover{background:#ca8a04;transform:translateY(-1px)}
    .collect-btn:disabled{background:var(--border);color:var(--text2);cursor:not-allowed;transform:none}
    .field-group{margin-top:12px}
    .field-group label{font-size:13px;color:var(--text2);display:block;margin-bottom:6px}
    .field-group input,.field-group select{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;padding:12px;font-family:'JetBrains Mono',monospace}
    .field-group input:focus,.field-group select:focus{outline:none;border-color:var(--yellow)}
    .collection-history{margin-top:24px;border-top:1px solid var(--border);padding-top:16px}
    .collection-history h4{font-size:14px;color:var(--text2);margin-bottom:12px}
    .ch-item{background:var(--bg2);border-radius:10px;padding:14px;margin-bottom:8px}
    .ch-item .ch-top{display:flex;justify-content:space-between;align-items:center}
    .ch-item .ch-amount{font-size:18px;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .ch-item .ch-date{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .ch-item .ch-detail{font-size:12px;color:var(--text2);margin-top:6px}
    .counter-balance-readonly{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-top:32px;display:none}
    .counter-balance-readonly.show{display:block}
    .counter-balance-readonly h3{font-size:16px;margin-bottom:12px;color:var(--text2)}
    .counter-balance-readonly .bal-amount{font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .counter-balance-readonly .bal-detail{font-size:12px;color:var(--text2);margin-top:6px}
    .bal-breakdown{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px}
    .bal-breakdown .bb{background:var(--bg2);border-radius:8px;padding:10px;text-align:center}
    .bal-breakdown .bb-val{font-size:16px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .bal-breakdown .bb-label{font-size:10px;color:var(--text2);margin-top:2px}
    .expense-input{background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;padding:10px;font-family:'JetBrains Mono',monospace;width:100%}
    .expense-input:focus{outline:none;border-color:var(--red)}
    .expense-reason{background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;padding:10px;width:100%;font-family:'Plus Jakarta Sans',sans-serif}
    .expense-reason:focus{outline:none;border-color:var(--red)}
    .verify-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .verify-badge.ok{background:rgba(34,197,94,0.15);color:var(--green)}
    .verify-badge.warn{background:rgba(239,68,68,0.15);color:var(--red)}
    .verify-box{background:var(--bg2);border-radius:10px;padding:14px;margin-top:16px;font-size:13px}
    .verify-box .verify-title{font-size:12px;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
    .verify-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
    .verify-row:last-child{border-bottom:none}
    .verify-row .vr-label{color:var(--text2)}
    .verify-row .vr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .audit-banner{border-radius:10px;padding:14px;margin-top:16px;font-size:13px;display:flex;gap:10px;align-items:flex-start}
    .audit-banner.warning{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);color:var(--yellow)}
    .audit-banner.critical{background:rgba(239,68,68,0.1);border:1px solid var(--red);color:var(--red)}
    .audit-banner .ab-icon{font-size:18px;flex-shrink:0}
    .audit-banner .ab-text{flex:1;line-height:1.4}
    .discrepancy-list{margin-top:16px}
    .discrepancy-item{background:var(--bg2);border-radius:8px;padding:12px;margin-bottom:8px;font-size:13px;display:flex;gap:8px;align-items:flex-start}
    .discrepancy-item.warning{border-left:3px solid var(--yellow)}
    .discrepancy-item.critical{border-left:3px solid var(--red)}
    .discrepancy-item .di-icon{flex-shrink:0}
    .discrepancy-item .di-text{flex:1;color:var(--text2);line-height:1.4}
    .discrepancy-item .di-text strong{color:var(--text)}
    .recon-panel{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:24px;margin-top:32px;display:none}
    .recon-panel.show{display:block}
    .recon-panel.balanced{border-color:var(--green)}
    .recon-panel.warning{border-color:var(--yellow)}
    .recon-panel.critical{border-color:var(--red)}
    .recon-panel h3{font-size:18px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .recon-equation{background:var(--bg2);border-radius:10px;padding:16px;margin:16px 0;text-align:center;font-family:'JetBrains Mono',monospace}
    .recon-equation .eq-main{font-size:16px;font-weight:600;line-height:1.8}
    .recon-equation .eq-status{font-size:14px;font-weight:700;margin-top:8px}
    .recon-section{margin-top:16px}
    .recon-section h4{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
    .recon-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px}
    .recon-row .rr-label{color:var(--text2)}
    .recon-row .rr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .recon-row.total{border-top:1px solid var(--border);margin-top:4px;padding-top:8px;font-weight:600}
    .recon-row.total .rr-label{color:var(--text)}
    .cross-payment-notice{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.3);border-radius:10px;padding:14px;margin-top:12px;font-size:13px}
    .cross-payment-notice .cpn-title{font-weight:600;color:var(--yellow);margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .cross-payment-notice .cpn-item{color:var(--text2);line-height:1.5;padding:4px 0}
    .cross-payment-notice .cpn-shift{color:var(--green);font-size:12px;margin-top:6px}
    .rectify-panel{background:var(--card);border:2px solid var(--orange);border-radius:16px;padding:24px;margin-bottom:32px;display:none}
    .rectify-panel.show{display:block}
    .rectify-panel h3{font-size:18px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .rectify-panel .subtitle{font-size:13px;color:var(--text2);margin-bottom:16px}
    .rectify-card{background:var(--bg2);border-radius:10px;padding:16px;margin-bottom:10px;border-left:3px solid var(--orange)}
    .rectify-card.critical{border-left-color:var(--red)}
    .rectify-card.fixed{opacity:0.4;pointer-events:none}
    .rectify-card .rc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .rectify-card .rc-order{font-weight:600;font-family:'JetBrains Mono',monospace;font-size:14px}
    .rectify-card .rc-amount{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:16px;color:var(--orange)}
    .rectify-card .rc-detail{font-size:12px;color:var(--text2);line-height:1.5;margin-bottom:10px}
    .rectify-card .rc-actions{display:flex;gap:8px;align-items:center}
    .rectify-card select{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;padding:8px 10px;flex:1}
    .rectify-card select:focus{outline:none;border-color:var(--orange)}
    .rectify-btn{background:var(--orange);color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap}
    .rectify-btn:hover{background:#ea580c}
    .rectify-btn:disabled{background:var(--border);cursor:not-allowed}
    .unsold-input-box{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;margin:12px 0}
    .unsold-input-box label{font-size:12px;color:var(--text2);display:block;margin-bottom:6px}
    .unsold-input-box input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;padding:10px;font-family:'JetBrains Mono',monospace}
    .unsold-input-box input:focus{outline:none;border-color:var(--orange)}
    .unsold-input-box .hint{font-size:11px;color:var(--text2);margin-top:4px}
    .cash-breakdown-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px}
    .cash-breakdown-row .cbr-label{color:var(--text2)}
    .cash-breakdown-row .cbr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .cash-breakdown-row.total{border-top:1px solid var(--border);margin-top:4px;padding-top:8px;font-weight:600}
    .cash-breakdown-row.total .cbr-label{color:var(--text)}
    .badge-count{background:var(--orange);color:#fff;border-radius:12px;font-size:12px;font-weight:700;padding:2px 8px;margin-left:8px}
    .variance-source{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
    .variance-source:last-child{border-bottom:none}
    .variance-source .vs-label{color:var(--text2);flex:1}
    .variance-source .vs-amount{font-family:'JetBrains Mono',monospace;font-weight:600;margin:0 8px}
    .variance-source .vs-fix{background:var(--orange);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;font-weight:600}
    .variance-source .vs-fix:hover{background:#ea580c}
    .confirm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
    .confirm-dialog{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:24px;max-width:420px;width:100%;max-height:90vh;overflow-y:auto}
    .confirm-dialog h3{font-size:18px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .confirm-row{display:flex;justify-content:space-between;padding:8px 0;font-size:13px;border-bottom:1px solid var(--border)}
    .confirm-row:last-of-type{border-bottom:none}
    .confirm-row .cr-label{color:var(--text2)}
    .confirm-row .cr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .confirm-checks{margin:16px 0;padding:12px;background:var(--bg2);border-radius:10px}
    .confirm-check{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:13px}
    .confirm-check .cc-icon{font-size:16px;flex-shrink:0}
    .confirm-check .cc-label{flex:1;color:var(--text2)}
    .confirm-check .cc-status{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:12px}
    .confirm-check .cc-status.ok{color:var(--green)}
    .confirm-check .cc-status.warn{color:var(--yellow)}
    .confirm-check .cc-status.bad{color:var(--red)}
    .confirm-warn{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);border-radius:8px;padding:10px;font-size:12px;color:var(--yellow);margin:12px 0}
    .confirm-buttons{display:flex;gap:12px;margin-top:16px}
    .confirm-buttons button{flex:1;padding:14px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s}
    .confirm-buttons .cancel-btn{background:var(--bg2);color:var(--text);border:1px solid var(--border)}
    .confirm-buttons .cancel-btn:hover{background:var(--border)}
    .shift-health{display:flex;flex-wrap:wrap;gap:8px;margin-top:16px;padding:12px;background:var(--bg2);border-radius:10px}
    .shift-health .sh-item{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text2);padding:4px 8px;background:var(--bg);border-radius:6px}
    .shift-health .sh-item.ok{border:1px solid rgba(34,197,94,0.3)}
    .shift-health .sh-item.warn{border:1px solid rgba(234,179,8,0.3)}
    .shift-health .sh-item.bad{border:1px solid rgba(239,68,68,0.3)}
    .expense-attr{padding-left:16px;font-size:11px;color:var(--text2);opacity:0.8}
    .shift-history-panel{background:var(--card);border-radius:16px;padding:24px;margin-bottom:32px;display:none}
    .shift-history-panel.show{display:block}
    .shift-history-panel h3{font-size:18px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .shift-history-panel .subtitle{font-size:13px;color:var(--text2);margin-bottom:16px}
    .sh-card{background:var(--bg2);border-radius:12px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all 0.2s}
    .sh-card:hover{border-color:var(--blue)}
    .sh-card-header{display:flex;justify-content:space-between;align-items:center}
    .sh-card-title{font-size:14px;font-weight:600}
    .sh-card-time{font-size:12px;color:var(--text2)}
    .sh-card-meta{display:flex;gap:12px;margin-top:6px;font-size:12px;color:var(--text2)}
    .sh-card-meta span{font-family:JetBrains Mono,monospace}
    .sh-card-badge{display:inline-block;font-size:11px;padding:2px 8px;border-radius:6px;font-weight:600}
    .sh-card-badge.balanced{background:rgba(34,197,94,0.15);color:var(--green)}
    .sh-card-badge.variance{background:rgba(239,68,68,0.15);color:var(--red)}
    .sh-card-detail{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:none}
    .sh-card-detail.show{display:block}
    .sh-card-detail .loading-text{font-size:12px;color:var(--text2);text-align:center;padding:12px}
    /* === SHIFT WIZARD v2 === */
    .wizard-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:900;display:none;overflow-y:auto}
    .wizard-overlay.show{display:block}
    .wizard-container{max-width:600px;margin:0 auto;padding:16px 16px 100px}
    .wizard-header{display:flex;align-items:center;justify-content:space-between;padding:16px 0;margin-bottom:8px}
    .wizard-header h2{font-size:18px;display:flex;align-items:center;gap:8px}
    .wizard-close{background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px}
    .wizard-close:hover{background:var(--border);color:var(--text)}
    .wizard-steps{display:flex;gap:4px;margin-bottom:24px}
    .wizard-step{flex:1;text-align:center;padding:10px 4px;border-radius:8px;font-size:12px;font-weight:600;background:var(--bg2);color:var(--text2);transition:all 0.3s}
    .wizard-step.active{background:var(--purple);color:#fff}
    .wizard-step.done{background:rgba(34,197,94,0.2);color:var(--green)}
    .wizard-step-content{display:none}
    .wizard-step-content.active{display:block}
    .wizard-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px}
    .wizard-card h3{font-size:16px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .wizard-row{display:flex;justify-content:space-between;padding:8px 0;font-size:14px;border-bottom:1px solid rgba(45,58,79,0.5)}
    .wizard-row:last-of-type{border-bottom:none}
    .wizard-row .wr-label{color:var(--text2)}
    .wizard-row .wr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .wizard-row.total{border-top:2px solid var(--border);margin-top:4px;padding-top:12px;font-weight:600}
    .wizard-row.total .wr-label{color:var(--text)}
    .wizard-row.total .wr-val{font-size:18px}
    .wizard-upi-box{border-radius:10px;padding:14px;margin:12px 0;font-size:13px}
    .wizard-upi-box.ok{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2)}
    .wizard-upi-box.warn{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2)}
    .wizard-upi-box .upi-title{font-weight:600;margin-bottom:6px;display:flex;justify-content:space-between}
    .wizard-upi-box .upi-detail{color:var(--text2);line-height:1.5}
    .wizard-input-group{margin:16px 0}
    .wizard-input-group label{font-size:13px;color:var(--text2);display:block;margin-bottom:6px}
    .wizard-input-group .wi-expected{font-size:12px;color:var(--text2);margin-bottom:8px;font-family:'JetBrains Mono',monospace}
    .wizard-input-group input{width:100%;background:var(--bg2);border:2px solid var(--border);border-radius:10px;color:var(--text);font-size:22px;padding:14px;font-family:'JetBrains Mono',monospace;transition:border-color 0.2s}
    .wizard-input-group input:focus{outline:none;border-color:var(--purple)}
    .wizard-match{border-radius:10px;padding:14px;margin:12px 0;font-size:13px;line-height:1.5}
    .wizard-match.ok{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:var(--green)}
    .wizard-match.warn{background:rgba(234,179,8,0.1);border:1px solid rgba(234,179,8,0.3);color:var(--yellow)}
    .wizard-match.bad{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--red)}
    .wizard-match.info{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);color:var(--blue)}
    .wizard-runner-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px;transition:border-color 0.2s}
    .wizard-runner-card.absent{opacity:0.5;border-style:dashed}
    .wizard-runner-card .wrc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .wizard-runner-card .wrc-name{font-size:16px;font-weight:700}
    .wizard-runner-card .wrc-badge{font-size:11px;padding:4px 10px;border-radius:6px;font-weight:600;background:var(--bg2);color:var(--text2)}
    .wizard-runner-card .wrc-calc{background:var(--bg2);border-radius:8px;padding:10px 14px;margin:12px 0;font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .wizard-absent-toggle{display:flex;align-items:center;gap:10px;margin-top:14px;padding:12px;background:var(--bg2);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text2)}
    .wizard-absent-toggle input[type=checkbox]{width:18px;height:18px;accent-color:var(--orange)}
    .wizard-nav{display:flex;gap:12px;margin-top:24px;position:sticky;bottom:0;padding:16px 0;background:linear-gradient(transparent,var(--bg) 20%)}
    .wizard-nav button{flex:1;padding:16px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s}
    .wizard-nav .wn-back{background:var(--bg2);color:var(--text);border:1px solid var(--border)}
    .wizard-nav .wn-back:hover{background:var(--border)}
    .wizard-nav .wn-next{background:var(--purple);color:#fff}
    .wizard-nav .wn-next:hover{background:#7c3aed}
    .wizard-nav .wn-submit{background:var(--green);color:#fff}
    .wizard-nav .wn-submit:hover{background:#16a34a}
    .wizard-nav .wn-submit:disabled{background:var(--border);cursor:not-allowed}
    .wizard-recon-box{border-radius:12px;padding:16px;margin:12px 0;text-align:center}
    .wizard-recon-box.balanced{background:rgba(34,197,94,0.1);border:2px solid var(--green)}
    .wizard-recon-box.variance{background:rgba(234,179,8,0.1);border:2px solid var(--yellow)}
    .wizard-recon-box.bad{background:rgba(239,68,68,0.1);border:2px solid var(--red)}
    .wizard-recon-box .wrb-icon{font-size:32px;margin-bottom:6px}
    .wizard-recon-box .wrb-text{font-size:16px;font-weight:700}
    .wizard-recon-box .wrb-amount{font-size:24px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-top:4px}
    .wizard-resolution{background:var(--bg2);border-radius:10px;padding:14px;margin:12px 0}
    .wizard-resolution .wr-title{font-size:12px;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
    .wizard-resolution-item{padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;display:flex;gap:8px;align-items:flex-start}
    .wizard-resolution-item:last-child{border-bottom:none}
    .wizard-resolution-item .wri-icon{flex-shrink:0}
    .wizard-resolution-item .wri-text{flex:1;color:var(--text2);line-height:1.4}
    .shift-card{border-color:var(--green)}
    .shift-card:hover{background:rgba(34,197,94,0.1)!important;border-color:var(--green)!important}
    .shift-card.selected{background:rgba(34,197,94,0.15);border-color:var(--green)}
    .shift-report{display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
    .shift-report.show{display:block}
    .shift-report-section{margin-bottom:16px}
    .shift-report-section h4{font-size:13px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
    .sr-row{display:flex;justify-content:space-between;padding:5px 0;font-size:13px}
    .sr-row .sr-label{color:var(--text2)}
    .sr-row .sr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .sr-row.total{border-top:1px solid var(--border);margin-top:4px;padding-top:8px;font-weight:600}
    .sr-row.total .sr-label{color:var(--text)}
    .print-report-header{display:none;text-align:center;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #333}
    .print-report-header h2{font-size:22px;margin-bottom:4px}
    .print-report-header p{font-size:13px;color:#666}
    .payment-trail-panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:32px;display:none}
    .payment-trail-panel.show{display:block}
    .payment-trail-panel h3{font-size:18px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .payment-trail-panel .subtitle{font-size:13px;color:var(--text2);margin-bottom:16px}
    .pt-method-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:16px}
    .pt-method-card{background:var(--bg2);border-radius:10px;padding:14px;text-align:center}
    .pt-method-card .pt-icon{font-size:20px;margin-bottom:4px}
    .pt-method-card .pt-label{font-size:11px;color:var(--text2);margin-bottom:2px}
    .pt-method-card .pt-amount{font-size:18px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .pt-expense-section{background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:10px;padding:14px;margin-bottom:16px}
    .pt-expense-section .pt-exp-title{font-size:12px;font-weight:600;color:var(--red);margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .pt-expense-item{display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:var(--text2)}
    .pt-expense-item .pt-exp-amt{font-family:'JetBrains Mono',monospace;font-weight:500;color:var(--red)}
    .pt-grand-total{display:flex;justify-content:space-between;padding:14px 0;border-top:2px solid var(--border);font-size:16px;font-weight:700}
    .pt-grand-total .pt-gt-label{color:var(--text)}
    .pt-grand-total .pt-gt-val{font-family:'JetBrains Mono',monospace;color:var(--green)}
    .pt-runner-breakdown{background:var(--bg2);border-radius:10px;margin-top:12px;overflow:hidden}
    .pt-rb-toggle{width:100%;background:none;border:none;color:var(--text2);padding:12px 14px;font-size:13px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-family:'Plus Jakarta Sans',sans-serif}
    .pt-rb-toggle:hover{color:var(--text)}
    .pt-rb-content{display:none;padding:0 14px 14px}
    .pt-rb-content.show{display:block}
    .pt-rb-runner{margin-bottom:10px}
    .pt-rb-runner-name{font-size:13px;font-weight:600;margin-bottom:4px}
    .pt-rb-row{display:flex;justify-content:space-between;padding:3px 0 3px 12px;font-size:12px;color:var(--text2)}
    .pt-rb-row .pt-rb-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    @media print{
      body{background:#fff!important;color:#000!important;font-size:12px}
      .pin-screen,.header,.runner-grid,.panel,.collection-panel,.counter-balance-readonly,.recon-panel,.wizard-overlay,.discrepancy-panel,.payment-trail-panel,.sh-card:not(.printing),.wizard-nav,.no-print{display:none!important}
      .dashboard{display:block!important}
      .shift-history-panel{display:block!important;background:#fff!important;border:none!important}
      .shift-history-panel h3,.shift-history-panel .subtitle{display:none!important}
      .sh-card.printing{display:block!important;border:1px solid #ccc!important;background:#fff!important;color:#000!important;page-break-inside:avoid}
      .sh-card.printing *{color:#000!important}
      .sh-card.printing .sh-card-badge{border:1px solid #333}
      .sh-card.printing .shift-report{display:block!important}
      .print-report-header{display:block!important}
      .sr-row .sr-label{color:#666!important}
      .shift-report-section h4{color:#333!important;border-color:#ccc!important}
    }
  </style>
</head>
<body>
  <div class="pin-screen" id="pinScreen">
    <div class="pin-box">
      <div class="icon">üîê</div>
      <h2>Runner Settlement</h2>
      <p>Enter your 4-digit PIN to continue</p>
      <div class="pin-input" id="pinInput">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
      </div>
      <div class="pin-success" id="pinSuccess">‚úì Welcome back</div>
    </div>
  </div>
  <div class="dashboard" id="dashboard">
    <div class="header">
      <h1>Runner Settlement</h1>
      <div class="user-badge">
        <span class="dot"></span>
        <span class="name" id="userName"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="content">
      <div class="section-title">Select Runner, Counter, or Record Expense</div>
      <div class="runner-grid" id="runnerGrid"></div>
      <div class="rectify-panel" id="discrepancyPanel"></div>
      <div class="panel" id="panel">
        <div class="panel-header">
          <h2 id="runnerName"></h2>
          <span class="period" id="period"></span>
        </div>
        <div id="panelContent"></div>
      </div>
      <div class="counter-balance-readonly" id="counterBalanceReadonly"></div>
      <div class="collection-panel" id="collectionPanel"></div>
      <div class="recon-panel" id="shiftReconPanel"></div>
      <div class="payment-trail-panel" id="paymentTrailPanel"></div>
      <div class="shift-history-panel" id="shiftHistoryPanel"></div>
    </div>
  </div>
  <!-- SHIFT WIZARD OVERLAY -->
  <div class="wizard-overlay" id="wizardOverlay">
    <div class="wizard-container">
      <div class="wizard-header">
        <h2>üèÅ End My Shift</h2>
        <button class="wizard-close" onclick="closeWizard()">‚úï Cancel</button>
      </div>
      <div class="wizard-steps">
        <div class="wizard-step active" id="wizStep1">1. Counter</div>
        <div class="wizard-step" id="wizStep2">2. Runners</div>
        <div class="wizard-step" id="wizStep3">3. Reconcile</div>
      </div>
      <div id="wizardContent"></div>
    </div>
  </div>
  <script>
    const $=id=>document.getElementById(id);
    const fmt=n=>'‚Çπ'+n.toLocaleString('en-IN');
    const RUNNERS=[
      {id:'counter',name:'üí∞ Cash Counter',barcode:'POS-27',isCounter:true},
      {id:'expense',name:'üìù Record Expense',barcode:'Cash Out',isExpense:true},
      {id:64,name:'FAROOQ',barcode:'RUN001'},
      {id:65,name:'AMIN',barcode:'RUN002'},
      {id:66,name:'NCH Runner 03',barcode:'RUN003'},
      {id:67,name:'NCH Runner 04',barcode:'RUN004'},
      {id:68,name:'NCH Runner 05',barcode:'RUN005'}
    ];
    const COLLECTORS=['Naveen','Nihaf'];
    let currentUser=null,currentPin=null,selectedRunner=null,currentRunnerData=null,currentPeriodStart=null,currentCounterData=null,currentCounterTotal=0,currentLiveCounterCash=0;
    const OWNER_PINS=['0305','3754'];
    const CASHIERS=['Md Kesmat','Jafar','Nafees','Tanveer'];
    let isStaffSimpleUI=true;
    let staffMisattributed=[];
    let staffShiftDataCache={data:null,from:null,timestamp:0};

    const pins=Array.from($('pinInput').querySelectorAll('input'));
    pins.forEach((input,i)=>{
      input.addEventListener('input',e=>{
        const v=e.target.value;
        if(v){input.classList.add('filled');if(i<3)pins[i+1].focus();else checkPin();}
        else input.classList.remove('filled');
      });
      input.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!e.target.value&&i>0){pins[i-1].focus();pins[i-1].value='';pins[i-1].classList.remove('filled');}});
    });

    async function checkPin(){
      const pin=pins.map(p=>p.value).join('');
      if(pin.length!==4)return;
      try{
        const res=await fetch('/api/settlement?action=verify-pin&pin='+pin);
        const data=await res.json();
        if(data.success){
          currentUser=data.user;
          currentPin=pin;
          isStaffSimpleUI=!OWNER_PINS.includes(pin);
          $('pinSuccess').textContent='‚úì Welcome, '+data.user;
          $('pinSuccess').classList.add('show');
          $('userName').textContent=data.user;
          setTimeout(()=>{
            $('pinScreen').classList.add('hidden');
            $('dashboard').classList.add('show');
            if(isStaffSimpleUI){
              renderStaffDashboard();
            }else{
              renderRunners();
              loadCashAtCounter();
              loadShiftReconciliation();
              loadDiscrepancies();
              loadShiftHistory();
              loadShiftHistoryV2();
            }
          },800);
        }else{
          pins.forEach(p=>{p.value='';p.classList.remove('filled');p.style.borderColor='var(--red)';});
          setTimeout(()=>pins.forEach(p=>p.style.borderColor=''),500);
          pins[0].focus();
        }
      }catch(e){console.error(e);}
    }

    function logout(){
      currentUser=null;currentPin=null;isStaffSimpleUI=true;selectedRunner=null;
      staffMisattributed=[];staffShiftDataCache={data:null,from:null,timestamp:0};
      $('dashboard').classList.remove('show');
      $('pinScreen').classList.remove('hidden');
      $('pinSuccess').classList.remove('show');
      $('collectionPanel').classList.remove('show');
      $('counterBalanceReadonly').classList.remove('show');
      $('panel').classList.remove('show');
      $('shiftReconPanel').classList.remove('show');
      $('shiftHistoryPanel').classList.remove('show');
      $('discrepancyPanel').classList.remove('show');
      $('paymentTrailPanel').classList.remove('show');
      lastShiftReconData=null;
      pins.forEach(p=>{p.value='';p.classList.remove('filled');});
      pins[0].focus();
    }

    function renderRunners(){
      // "End My Shift" CTA at the top
      let html='<div class="runner-card shift-card" onclick="startShiftWizard()"><div class="name">üèÅ End My Shift</div><div class="code">Settle All</div></div>';
      html+=RUNNERS.map(r=>{
        const cls=r.isCounter?' counter':(r.isExpense?' expense':'');
        const idStr=typeof r.id==='string'?"'"+r.id+"'":r.id;
        return '<div class="runner-card'+cls+'" onclick="selectRunner('+idStr+',this)"><div class="name">'+r.name+'</div><div class="code">'+r.barcode+'</div></div>';
      }).join('');
      $('runnerGrid').innerHTML=html;
    }

    function toLocalISO(d){
      return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
    }
    const fmtD=(d)=>{const day=d.getDate().toString().padStart(2,'0');const mon=d.toLocaleString('en-IN',{month:'short'});const hr=d.getHours().toString().padStart(2,'0');const mn=d.getMinutes().toString().padStart(2,'0');return day+' '+mon+' '+hr+':'+mn;};
    const fmtDate=(d)=>{const day=d.getDate().toString().padStart(2,'0');const mon=d.toLocaleString('en-IN',{month:'short'});const yr=d.getFullYear();const hr=d.getHours().toString().padStart(2,'0');const mn=d.getMinutes().toString().padStart(2,'0');return day+' '+mon+' '+yr+', '+hr+':'+mn;};

    async function selectRunner(id,el){
      document.querySelectorAll('.runner-card').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      selectedRunner=RUNNERS.find(r=>r.id===id);
      $('panel').classList.add('show');

      if(id==='expense'){
        $('runnerName').textContent='üìù Record Expense';
        $('period').textContent='';
        loadExpensePanel();
      }else if(id==='counter'){
        $('runnerName').textContent=selectedRunner.name;
        $('period').textContent='Loading...';
        $('panelContent').innerHTML='<div class="loading-text">Checking last settlement...</div>';
        await loadCounterSettlement();
      }else{
        $('runnerName').textContent=selectedRunner.name;
        $('period').textContent='Loading...';
        $('panelContent').innerHTML='<div class="loading-text">Checking last settlement...</div>';
        await loadRunnerSettlement(id);
      }
    }

    // === EXPENSE PANEL ===
    function loadExpensePanel(){
      $('panelContent').innerHTML=
        '<div style="margin-bottom:16px;color:var(--text2);font-size:14px">Record cash given out from the counter for supplies, milk, etc.</div>'+
        '<div class="field-group"><label>Amount (‚Çπ)</label><input type="number" id="expenseAmount" class="expense-input" placeholder="e.g. 200" min="1" step="10" inputmode="numeric"></div>'+
        '<div class="field-group" style="margin-top:12px"><label>Reason</label><input type="text" id="expenseReason" class="expense-reason" placeholder="e.g. Milk, Sugar, Supplies"></div>'+
        '<button class="settle-btn" style="background:var(--red)" onclick="recordExpense()">Record Expense</button>';
    }

    async function recordExpense(){
      const amount=parseFloat(document.getElementById('expenseAmount')?.value||'0');
      const reason=(document.getElementById('expenseReason')?.value||'').trim();
      const btn=document.querySelector('.settle-btn');

      if(amount<=0){btn.textContent='Enter amount';btn.style.background='var(--red)';setTimeout(()=>{btn.textContent='Record Expense';},1500);return;}
      if(!reason){btn.textContent='Enter reason';btn.style.background='var(--red)';setTimeout(()=>{btn.textContent='Record Expense';},1500);return;}

      btn.disabled=true;btn.textContent='Recording...';

      try{
        const res=await fetch('/api/settlement?action=record-expense',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({recorded_by:currentUser,amount,reason})
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Expense Recorded!';btn.style.background='var(--green)';
          setTimeout(()=>{loadExpensePanel();loadCashAtCounter();},1500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // === MISSED EXPENSE (Naveen records on behalf of cashier) ===
    async function recordMissedExpense(){
      const amount=parseFloat(document.getElementById('missedExpAmount')?.value||'0');
      const reason=(document.getElementById('missedExpReason')?.value||'').trim();
      const cashier=document.getElementById('missedExpCashier')?.value||'';
      const btn=document.getElementById('missedExpBtn');

      if(amount<=0){btn.textContent='Enter amount';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}
      if(!reason){btn.textContent='Enter reason';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}
      if(!cashier){btn.textContent='Select cashier';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}

      btn.disabled=true;btn.textContent='Recording...';

      try{
        const res=await fetch('/api/settlement?action=record-expense',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({recorded_by:currentUser,amount,reason,attributed_to:cashier,notes:'Missed expense recorded by '+currentUser})
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Expense Recorded!';btn.style.background='var(--green)';
          setTimeout(()=>loadCashAtCounter(),1500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;}
    }

    // === COUNTER SETTLEMENT ===
    async function loadCounterSettlement(){
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id=counter');
        const lastData=await lastRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.periodStart?new Date(lastData.periodStart):baseline;
        currentPeriodStart=fromDate;
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo...</div>';
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        const mc=data.data.mainCounter;currentCounterData=mc;
        const vf=data.data.verification;const rc=data.data.runnerCounter;
        // Check for discrepancies at counter level
        const counterDisc=(data.data.discrepancies||[]).filter(d=>d.type==='token_issue_no_runner'||d.type==='runner_ledger_no_runner');
        const counterRevenue=mc.cash+mc.upi+mc.card;const cashToSettle=mc.cash;
        const hasLast=lastData.lastSettlement;
        const periodReason=lastData.periodReason;
        let statusBox='';
        if(periodReason==='last_collection'&&lastData.lastCollection){statusBox='<div class="info-box" style="background:rgba(234,179,8,0.1);border-color:var(--yellow);color:var(--yellow)">üì¶ Period reset by cash collection at '+fmtD(new Date(lastData.lastCollection.collected_at))+'</div>';}
        else if(hasLast){const who=hasLast.settled_by===currentUser?'You':hasLast.settled_by;statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+' (‚Çπ'+hasLast.cash_settled.toLocaleString('en-IN')+' cash)</div>';}
        else{statusBox='<div class="info-box">‚ö†Ô∏è Never settled. Showing from baseline (Feb 4, 5 PM).</div>';}

        // Build UPI verification box
        let verifyHtml='';
        if(vf){
          const ccOk=vf.cashCounter.status==='ok';const rcOk=vf.runnerCounter.status==='ok';
          const ccBadge=ccOk?'<span class="verify-badge ok">‚úì Verified</span>':'<span class="verify-badge warn">‚ö† ‚Çπ'+Math.abs(vf.cashCounter.variance)+' variance</span>';
          const rcBadge=rcOk?'<span class="verify-badge ok">‚úì Verified</span>':'<span class="verify-badge warn">‚ö† ‚Çπ'+Math.abs(vf.runnerCounter.variance)+' variance</span>';
          verifyHtml='<div class="verify-box"><div class="verify-title">üîç UPI Cross-Verification (Odoo ‚Üî Razorpay)</div>'+
            '<div class="verify-row"><span class="vr-label">Cash Counter UPI</span><span class="vr-val">Odoo: '+fmt(vf.cashCounter.odooUPI)+' | Razorpay: '+fmt(vf.cashCounter.razorpayUPI)+' '+ccBadge+'</span></div>'+
            '<div class="verify-row"><span class="vr-label">Runner Counter UPI</span><span class="vr-val">Odoo: '+fmt(vf.runnerCounter.odooUPI)+' | Razorpay: '+fmt(vf.runnerCounter.razorpayUPI)+' '+rcBadge+'</span></div>';
          if(!ccOk){
            const dir=vf.cashCounter.variance>0?'Odoo shows more UPI than Razorpay received ‚Äî possible cash recorded as UPI':'Razorpay received more than Odoo recorded ‚Äî possible missed UPI entry';
            verifyHtml+='<div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:12px;color:var(--red)">Cash Counter: '+dir+'</div>';
          }
          if(!rcOk){
            const dir=vf.runnerCounter.variance>0?'Odoo shows more UPI than Razorpay received ‚Äî possible runner sale recorded as UPI':'Razorpay received more than Odoo recorded ‚Äî possible missed order';
            verifyHtml+='<div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:12px;color:var(--red)">Runner Counter: '+dir+'</div>';
          }
          verifyHtml+='</div>';
        }

        // Runner Counter direct UPI info
        let rcHtml='';
        if(rc&&rc.upi>0){
          rcHtml='<div class="row" style="opacity:0.5"><span class="label">Runner Counter UPI (direct)</span><span class="value" style="color:var(--blue)">'+fmt(rc.upi)+'</span></div>';
        }

        let settleBtn='';
        const shiftBadge=buildShiftHealthBadge();
        if(counterRevenue>0){settleBtn=shiftBadge+'<button class="settle-btn counter-btn" onclick="settleCounter()">‚úì Settle '+fmt(cashToSettle)+' Cash</button>';}
        if(counterRevenue>0||hasLast){
          $('panelContent').innerHTML=
            '<div class="row"><span class="label">Counter Revenue</span><span class="value">'+fmt(counterRevenue)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ Cash</span><span class="value">'+fmt(mc.cash)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ UPI (to bank)</span><span class="value" style="color:var(--blue)">'+fmt(mc.upi)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ Card (to bank)</span><span class="value" style="color:var(--blue)">'+fmt(mc.card)+'</span></div>'+
            '<div class="row" style="opacity:0.5"><span class="label">Token Issue (‚Üí Runners)</span><span class="value">'+fmt(mc.tokenIssue)+'</span></div>'+
            '<div class="row" style="opacity:0.5"><span class="label">Complimentary</span><span class="value">'+fmt(mc.complimentary)+'</span></div>'+
            rcHtml+
            '<div class="row total"><span class="label">Cash to Settle</span><span class="value" style="color:var(--orange)">'+fmt(cashToSettle)+'</span></div>'+
            (counterDisc.length>0?'<div class="discrepancy-list">'+counterDisc.map(d=>'<div class="discrepancy-item '+(d.severity==='critical'?'critical':'warning')+'"><span class="di-icon">'+(d.severity==='critical'?'üö®':'‚ö†Ô∏è')+'</span><span class="di-text">'+d.message+'</span></div>').join('')+'</div>':'')+
            verifyHtml+statusBox+settleBtn;
        }else{
          if(hasLast){const who=hasLast.settled_by===currentUser?'you':hasLast.settled_by;$('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';}
          else{$('panelContent').innerHTML='<div class="loading-text">No counter activity</div>';}
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }

    // === RUNNER SETTLEMENT ===
    async function loadRunnerSettlement(id){
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id='+id);
        const lastData=await lastRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.periodStart?new Date(lastData.periodStart):baseline;
        currentPeriodStart=fromDate;
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo & Razorpay...</div>';
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();if(!data.success)throw new Error(data.error);
        const runner=data.data.runners.find(r=>r.id===id);currentRunnerData=runner;
        const hasLast=lastData.lastSettlement;const hasActivity=runner&&(runner.tokens>0||runner.sales>0||runner.upi>0);
        const periodReason=lastData.periodReason;
        // Check for discrepancies affecting this runner
        const disc=data.data.discrepancies||[];
        const runnerDisc=disc.filter(d=>d.runner===selectedRunner.name||d.type==='runner_ledger_no_runner');
        let discHtml='';
        if(runnerDisc.length>0){
          discHtml='<div class="discrepancy-list">';
          for(const d of runnerDisc){
            const cls=d.severity==='critical'?'critical':'warning';
            const icon=d.severity==='critical'?'üö®':'‚ö†Ô∏è';
            discHtml+='<div class="discrepancy-item '+cls+'"><span class="di-icon">'+icon+'</span><span class="di-text">'+d.message+'</span></div>';
          }
          discHtml+='</div>';
        }
        let statusBox='';
        if(periodReason==='last_collection'&&lastData.lastCollection){statusBox='<div class="info-box" style="background:rgba(234,179,8,0.1);border-color:var(--yellow);color:var(--yellow)">üì¶ Period reset by cash collection at '+fmtD(new Date(lastData.lastCollection.collected_at))+'</div>';}
        else if(hasLast){const who=hasLast.settled_by===currentUser?'You':hasLast.settled_by;statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+' (‚Çπ'+hasLast.cash_settled.toLocaleString('en-IN')+' cash)</div>';}
        else{statusBox='<div class="info-box">‚ö†Ô∏è Never settled. Showing from baseline (Feb 4, 5 PM).</div>';}
        if(hasActivity){
          const baseCash=runner.cashToCollect;currentRunnerData=runner;
          // Unsold token input: only show if runner has tokens
          let unsoldHtml='';
          if(runner.tokens>0){
            unsoldHtml='<div class="unsold-input-box">'+
              '<label>Unsold Tokens Returned (‚Çπ amount)</label>'+
              '<input type="number" id="unsoldTokensInput" min="0" max="'+runner.tokens+'" value="0" step="10" inputmode="numeric" oninput="recalcRunnerCash()">'+
              '<div class="hint">Enter the ‚Çπ value of unsold tokens the runner is returning. Max: '+fmt(runner.tokens)+'</div>'+
            '</div>'+
            '<div class="row" id="effectiveTokensRow"><span class="label">Effective Tokens Sold</span><span class="value" id="effectiveTokensVal">'+fmt(runner.tokens)+'</span></div>';
          }
          const cashColor=baseCash>=0?'var(--green)':'var(--red)';
          const runnerShiftBadge=buildShiftHealthBadge();
          let settleBtn='';
          if(baseCash>0){settleBtn=runnerShiftBadge+'<button class="settle-btn" id="settleRunnerBtn" onclick="settleRunner()">‚úì Settle '+fmt(baseCash)+' Cash</button>';}
          else if(baseCash<0){settleBtn='<div class="info-box" style="background:rgba(59,130,246,0.1);border-color:var(--blue);color:var(--blue)">Runner collected more UPI than sales - verify before settling</div>'+runnerShiftBadge+'<button class="settle-btn" id="settleRunnerBtn" style="background:var(--blue)" onclick="settleRunner()">‚úì Confirm Settlement</button>';}
          else{settleBtn=runnerShiftBadge+'<button class="settle-btn" id="settleRunnerBtn" onclick="settleRunner()">‚úì Mark as Settled (‚Çπ0 cash)</button>';}
          // Cross-payment credit display (blue, informational ‚Äî NOT error)
          let crossPayHtml='';
          if(runner.crossPaymentCredit>0){
            crossPayHtml+='<div style="background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.2);border-radius:10px;padding:12px;margin:8px 0">';
            crossPayHtml+='<div class="row" style="margin:0"><span class="label" style="color:var(--blue)">‚úì Cross-Payment Credit</span><span class="value" style="color:var(--blue)">-'+fmt(runner.crossPaymentCredit)+'</span></div>';
            crossPayHtml+='<div style="padding:4px 0 0 0;font-size:12px;color:var(--text2)">';
            for(const cp of (runner.crossPayments||[])){
              if(cp.orderName){crossPayHtml+='<div style="padding:2px 0">‚úì '+cp.orderName+': Customer paid via '+cp.paidViaLabel+'</div>';}
            }
            crossPayHtml+='<div style="color:var(--blue);margin-top:4px">No cash owed for these orders ‚Äî payment verified via Razorpay</div>';
            crossPayHtml+='</div></div>';
          }
          // Probable cross-QR notice (heuristic, informational)
          const probableCPs=(runner.crossPayments||[]).filter(cp=>cp.isProbable);
          let probableHtml='';
          if(probableCPs.length>0){
            probableHtml='<div style="background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);border-radius:10px;padding:12px;margin:8px 0">';
            probableHtml+='<div style="font-weight:600;color:var(--blue);font-size:13px;margin-bottom:4px">‚ÑπÔ∏è Possible Cross-QR Payment</div>';
            for(const cp of probableCPs){probableHtml+='<div style="font-size:12px;color:var(--text2);padding:2px 0">‚Çπ'+cp.amount+' may have been paid on '+cp.paidViaLabel+'</div>';}
            probableHtml+='<div style="font-size:11px;color:var(--blue);margin-top:6px">Confirm with runner if needed</div></div>';
          }
          $('panelContent').innerHTML='<div class="row"><span class="label">Tokens Issued (Chai)</span><span class="value">'+fmt(runner.tokens)+'</span></div>'+unsoldHtml+'<div class="row"><span class="label">Sales Made (Snacks)</span><span class="value">'+fmt(runner.sales)+'</span></div><div class="row"><span class="label">UPI Collected (Razorpay)</span><span class="value" style="color:var(--blue)">'+fmt(runner.upi)+'</span></div>'+crossPayHtml+'<div class="row total"><span class="label">Cash to Collect</span><span class="value" id="cashToCollectVal" style="color:'+cashColor+'">'+fmt(baseCash)+'</span></div>'+discHtml+probableHtml+statusBox+settleBtn;
        }else{
          if(hasLast){const who=hasLast.settled_by===currentUser?'you':hasLast.settled_by;$('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';}
          else{$('panelContent').innerHTML='<div class="loading-text">No activity for this runner</div>';}
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }

    async function settleRunner(){
      if(!selectedRunner||!currentRunnerData)return;
      const unsoldInput=document.getElementById('unsoldTokensInput');
      const unsoldTokens=unsoldInput?parseFloat(unsoldInput.value)||0:0;
      const effectiveCash=currentRunnerData.cashToCollect-unsoldTokens;
      const sr=lastShiftReconData;
      const bc=sr?sr.balanceCheck:null;
      const discCount=currentMisattributed.length;
      // Build rows
      const rows=[{label:'Period',value:$('period').textContent}];
      if(currentRunnerData.tokens>0){
        rows.push({label:'Tokens Issued',value:fmt(currentRunnerData.tokens)});
        if(unsoldTokens>0){
          rows.push({label:'Unsold Returned',value:'-'+fmt(unsoldTokens),color:'var(--orange)'});
          rows.push({label:'Effective Tokens',value:fmt(currentRunnerData.tokens-unsoldTokens)});
        }
      }
      rows.push({label:'Sales (Snacks)',value:fmt(currentRunnerData.sales)});
      rows.push({label:'UPI Collected',value:fmt(currentRunnerData.upi),color:'var(--blue)'});
      if(currentRunnerData.crossPaymentCredit>0){rows.push({label:'Cross-Payment Credit',value:'-'+fmt(currentRunnerData.crossPaymentCredit),color:'var(--blue)'});}
      rows.push({label:'Cash to Collect',value:fmt(effectiveCash),color:effectiveCash>=0?'var(--green)':'var(--red)'});
      // Checks
      const checks=[];
      if(bc){
        if(bc.isBalanced){checks.push({icon:'‚úÖ',label:'Shift Balance',status:'BALANCED',cls:'ok'});}
        else{checks.push({icon:Math.abs(bc.variance)<=50?'‚ö†Ô∏è':'üö®',label:'Shift Balance',status:'‚Çπ'+Math.abs(bc.variance)+' variance',cls:Math.abs(bc.variance)<=50?'warn':'bad'});}
      }
      checks.push({icon:discCount===0?'‚úÖ':'‚ö†Ô∏è',label:'Discrepancies',status:discCount===0?'None':discCount+' unfixed',cls:discCount===0?'ok':'warn'});
      let warning='';
      if(effectiveCash<0)warning='Runner owes less than UPI collected ‚Äî verify before confirming.';
      showConfirmDialog({
        title:'üìã Confirm '+selectedRunner.name+' Settlement',
        rows,checks,warning:warning||null,amount:effectiveCash,btnColor:'var(--green)',
        onConfirm:()=>doSettleRunner(unsoldTokens,effectiveCash)
      });
    }

    async function doSettleRunner(unsoldTokens,effectiveCash){
      const btn=document.getElementById('settleRunnerBtn')||document.querySelector('.settle-btn');
      if(btn){btn.disabled=true;btn.classList.add('loading');btn.textContent='Recording settlement...';}
      try{
        const now=new Date();
        const notesParts=[];
        if(unsoldTokens>0)notesParts.push('Unsold tokens: '+fmt(unsoldTokens));
        if(currentRunnerData.crossPaymentCredit>0)notesParts.push('Cross-payment credit: '+fmt(currentRunnerData.crossPaymentCredit)+' ('+currentRunnerData.crossPayments.length+' orders paid via other channels)');
        const res=await fetch('/api/settlement?action=settle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({runner_id:selectedRunner.id,runner_name:selectedRunner.name,settled_by:currentUser,period_start:toLocalISO(currentPeriodStart),period_end:toLocalISO(now),tokens_amount:currentRunnerData.tokens,sales_amount:currentRunnerData.sales,upi_amount:currentRunnerData.upi,cash_settled:effectiveCash,unsold_tokens:unsoldTokens,notes:notesParts.length>0?notesParts.join('; '):'Settled via dashboard'})});
        const data=await res.json();
        if(data.success){if(btn){btn.textContent='‚úì Settlement Recorded!';btn.style.background='var(--green)';}setTimeout(()=>{const card=document.querySelector('.runner-card.selected');if(card)selectRunner(selectedRunner.id,card);loadCashAtCounter();loadShiftReconciliation();loadDiscrepancies();loadShiftHistory();},1500);}
        else{throw new Error(data.error);}
      }catch(e){if(btn){btn.disabled=false;btn.classList.remove('loading');btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}}
    }

    function recalcRunnerCash(){
      if(!currentRunnerData)return;
      const unsoldInput=document.getElementById('unsoldTokensInput');
      const unsold=unsoldInput?parseFloat(unsoldInput.value)||0:0;
      // Validate
      if(unsold>currentRunnerData.tokens){unsoldInput.value=currentRunnerData.tokens;return recalcRunnerCash();}
      if(unsold<0){unsoldInput.value=0;return recalcRunnerCash();}
      // Update effective tokens
      const effectiveTokens=currentRunnerData.tokens-unsold;
      const effEl=document.getElementById('effectiveTokensVal');
      if(effEl)effEl.textContent=fmt(effectiveTokens);
      // Update cash to collect
      const newCash=currentRunnerData.cashToCollect-unsold;
      const cashEl=document.getElementById('cashToCollectVal');
      if(cashEl){cashEl.textContent=fmt(newCash);cashEl.style.color=newCash>=0?'var(--green)':'var(--red)';}
      // Update settle button
      const btn=document.getElementById('settleRunnerBtn');
      if(btn){
        if(newCash>0){btn.textContent='‚úì Settle '+fmt(newCash)+' Cash';btn.style.background='var(--green)';}
        else if(newCash===0){btn.textContent='‚úì Mark as Settled (‚Çπ0 cash)';btn.style.background='var(--green)';}
        else{btn.textContent='‚úì Confirm Settlement';btn.style.background='var(--blue)';}
      }
    }

    // ========== SHIFT HEALTH BADGE ==========
    function buildShiftHealthBadge(){
      if(!lastShiftReconData)return '';
      const sr=lastShiftReconData;
      const bc=sr.balanceCheck;
      const discCount=currentMisattributed.length;
      // Shift balance check
      let balCls='ok',balText='‚úÖ Balanced';
      if(!bc.isBalanced){
        if(Math.abs(bc.variance)<=50){balCls='warn';balText='‚ö†Ô∏è ‚Çπ'+Math.abs(bc.variance)+' variance';}
        else{balCls='bad';balText='üö® ‚Çπ'+Math.abs(bc.variance)+' variance';}
      }
      // UPI check
      let upiCls='ok',upiText='‚úÖ UPI Verified';
      if(sr.verifiedUPI){
        const ccVar=Math.abs((sr.verifiedUPI.counterQR||0)-(sr.verifiedUPI.counterQR||0));
        // Check from the raw verification data if available
      }
      // Discrepancy check
      let discCls='ok',discText='‚úÖ 0 issues';
      if(discCount>0){discCls=discCount>2?'bad':'warn';discText='‚ö†Ô∏è '+discCount+' issue'+(discCount>1?'s':'');}
      return '<div class="shift-health">'+
        '<div class="sh-item '+balCls+'">Shift: '+balText+'</div>'+
        '<div class="sh-item '+upiCls+'">'+upiText+'</div>'+
        '<div class="sh-item '+discCls+'">Discrepancies: '+discText+'</div>'+
      '</div>';
    }

    // ========== CONFIRMATION DIALOG ==========
    function showConfirmDialog(opts){
      // opts: {title, rows:[{label,value,color}], checks:[{icon,label,status,cls}], warning, amount, onConfirm, btnColor}
      const overlay=document.createElement('div');
      overlay.className='confirm-overlay';
      let rowsHtml=opts.rows.map(r=>'<div class="confirm-row"><span class="cr-label">'+r.label+'</span><span class="cr-val"'+(r.color?' style="color:'+r.color+'"':'')+'>'+(r.value||'')+'</span></div>').join('');
      let checksHtml='';
      if(opts.checks&&opts.checks.length>0){
        checksHtml='<div class="confirm-checks">'+
          opts.checks.map(c=>'<div class="confirm-check"><span class="cc-icon">'+c.icon+'</span><span class="cc-label">'+c.label+'</span><span class="cc-status '+c.cls+'">'+c.status+'</span></div>').join('')+
        '</div>';
      }
      let warnHtml=opts.warning?'<div class="confirm-warn">‚ö†Ô∏è '+opts.warning+'</div>':'';
      overlay.innerHTML='<div class="confirm-dialog">'+
        '<h3>'+opts.title+'</h3>'+rowsHtml+checksHtml+warnHtml+
        '<div class="confirm-buttons">'+
          '<button class="cancel-btn" onclick="this.closest(\'.confirm-overlay\').remove()">Cancel</button>'+
          '<button class="settle-btn" style="margin:0;background:'+(opts.btnColor||'var(--green)')+'" id="confirmSettleBtn">‚úì Confirm '+fmt(opts.amount)+'</button>'+
        '</div></div>';
      document.body.appendChild(overlay);
      overlay.querySelector('#confirmSettleBtn').addEventListener('click',()=>{overlay.remove();opts.onConfirm();});
      overlay.addEventListener('click',(e)=>{if(e.target===overlay)overlay.remove();});
    }

    async function settleCounter(){
      if(!currentCounterData)return;
      const cashToSettle=currentCounterData.cash;
      const sr=lastShiftReconData;
      const bc=sr?sr.balanceCheck:null;
      const discCount=currentMisattributed.length;
      // Build checks
      const checks=[];
      if(bc){
        if(bc.isBalanced){checks.push({icon:'‚úÖ',label:'Shift Balance',status:'BALANCED',cls:'ok'});}
        else if(Math.abs(bc.variance)<=50){checks.push({icon:'‚ö†Ô∏è',label:'Shift Balance',status:'‚Çπ'+Math.abs(bc.variance)+' variance',cls:'warn'});}
        else{checks.push({icon:'üö®',label:'Shift Balance',status:'‚Çπ'+Math.abs(bc.variance)+' variance',cls:'bad'});}
      }
      checks.push({icon:discCount===0?'‚úÖ':'‚ö†Ô∏è',label:'Discrepancies',status:discCount===0?'None':discCount+' unfixed',cls:discCount===0?'ok':'warn'});
      // Warning if shift not balanced
      let warning='';
      if(bc&&!bc.isBalanced)warning='Settling with ‚Çπ'+Math.abs(bc.variance)+' shift variance.';
      if(discCount>0)warning+=(warning?' ':'')+'There are '+discCount+' unfixed discrepancies.';
      showConfirmDialog({
        title:'üìã Confirm Counter Settlement',
        rows:[
          {label:'Period',value:$('period').textContent},
          {label:'Cash Sales',value:fmt(currentCounterData.cash)},
          {label:'UPI (to bank)',value:fmt(currentCounterData.upi),color:'var(--blue)'},
          {label:'Card (to bank)',value:fmt(currentCounterData.card),color:'var(--blue)'},
          {label:'Token Issue (‚Üí Runners)',value:fmt(currentCounterData.tokenIssue),color:'var(--text2)'},
          {label:'Complimentary',value:fmt(currentCounterData.complimentary),color:'var(--text2)'},
          {label:'Cash to Settle',value:fmt(cashToSettle),color:'var(--orange)'}
        ],
        checks,warning:warning||null,amount:cashToSettle,btnColor:'var(--orange)',
        onConfirm:doSettleCounter
      });
    }

    async function doSettleCounter(){
      const btn=document.querySelector('.settle-btn');if(btn){btn.disabled=true;btn.classList.add('loading');btn.textContent='Recording settlement...';}
      try{
        const now=new Date();const cashToSettle=currentCounterData.cash;
        const res=await fetch('/api/settlement?action=settle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({runner_id:'counter',runner_name:'Cash Counter',settled_by:currentUser,period_start:toLocalISO(currentPeriodStart),period_end:toLocalISO(now),tokens_amount:0,sales_amount:currentCounterData.cash+currentCounterData.upi+currentCounterData.card,upi_amount:currentCounterData.upi+currentCounterData.card,cash_settled:cashToSettle,notes:'Counter settlement - Cash:'+currentCounterData.cash+' UPI:'+currentCounterData.upi+' Card:'+currentCounterData.card})});
        const data=await res.json();
        if(data.success){if(btn){btn.textContent='‚úì Settlement Recorded!';btn.style.background='var(--green)';}setTimeout(()=>{const card=document.querySelector('.runner-card.selected');if(card)selectRunner('counter',card);loadCashAtCounter();loadShiftReconciliation();loadShiftHistory();},1500);}
        else{throw new Error(data.error);}
      }catch(e){if(btn){btn.disabled=false;btn.classList.remove('loading');btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}}
    }

    // ========== EXPENSE ATTRIBUTION HELPER ==========
    function buildExpenseAttribution(expenses){
      if(!expenses||expenses.length===0)return '';
      const byPerson={};
      for(const e of expenses){
        const who=e.recorded_by||'Unknown';
        if(!byPerson[who])byPerson[who]={total:0,count:0};
        byPerson[who].total+=e.amount;
        byPerson[who].count++;
      }
      let html='';
      for(const [who,data] of Object.entries(byPerson)){
        html+='<div class="expense-attr">'+who+': -'+fmt(data.total)+' ('+data.count+' item'+(data.count>1?'s':'')+')</div>';
      }
      return html;
    }

    // ========== CASH AT COUNTER / COLLECTION ==========
    async function loadCashAtCounter(){
      const isCollector=COLLECTORS.includes(currentUser);
      try{
        const baseline=new Date(2026,1,4,17,0,0);
        // Fetch D1 balance, counter period, and collection history in parallel
        const [balRes,counterPeriodRes,histRes]=await Promise.all([
          fetch('/api/settlement?action=counter-balance'),
          fetch('/api/settlement?action=get-last-settlement&runner_id=counter'),
          fetch('/api/settlement?action=collection-history&limit=5')
        ]);
        const data=await balRes.json();if(!data.success)throw new Error(data.error);
        const bal=data.balance;const lastCol=data.lastCollection;
        const counterPeriod=await counterPeriodRes.json();

        // Counter's own period: unsettled counter cash starts from here
        const counterFrom=counterPeriod.periodStart?new Date(counterPeriod.periodStart):baseline;

        // Fetch live Odoo counter cash from counter's period (unsettled cash only)
        const odooRes=await fetch('/api/nch-data?from='+toLocalISO(counterFrom));
        const odooData=await odooRes.json();
        let liveCounterCash=0;
        if(odooData.success){liveCounterCash=odooData.data.mainCounter.cash||0;}
        currentLiveCounterCash=liveCounterCash;

        // Total cash at counter = petty + runner settlements + settled counter cash + UNSETTLED counter cash - expenses
        const totalCash=bal.pettyCash+bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;
        currentCounterTotal=totalCash;

        if(isCollector){
          $('counterBalanceReadonly').classList.remove('show');
          $('collectionPanel').classList.add('show');
          let sinceText='Since baseline (Feb 4)';
          if(lastCol){sinceText='Since last collection by '+lastCol.collected_by+' on '+fmtDate(new Date(lastCol.collected_at));}

          // New cash = runner settlements + settled counter + unsettled counter cash - expenses
          const newCash=bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;

          // Settlement list (runner settlements from D1)
          let slHtml='';
          if(bal.settlements.length>0){
            slHtml='<div class="settlement-list">';
            for(const s of bal.settlements){const t=new Date(s.settled_at);const source=s.runner_id==='counter'?'Counter':s.runner_name;slHtml+='<div class="sl-item"><span class="sl-who">'+source+' ‚Äî '+s.settled_by+' '+fmtD(t)+'</span><span class="sl-amount">'+fmt(s.cash_settled)+'</span></div>';}
            slHtml+='</div>';
          }
          // Expense list
          let expHtml='';
          if(bal.expenses&&bal.expenses.length>0){
            expHtml='<div class="settlement-list" style="margin-top:8px">';
            for(const e of bal.expenses){const t=new Date(e.recorded_at);const attr=e.attributed_to?' (by '+e.attributed_to+')':'';expHtml+='<div class="sl-item"><span class="sl-who" style="color:var(--red)">Expense: '+e.reason+attr+' ‚Äî '+e.recorded_by+' '+fmtD(t)+'</span><span class="sl-amount" style="color:var(--red)">-'+fmt(e.amount)+'</span></div>';}
            expHtml+='</div>';
          }

          // Collection history
          let histHtml='';
          const histData=await histRes.json();
          if(histData.success&&histData.collections.length>0){
            histHtml='<div class="collection-history"><h4>Recent Collections</h4>';
            for(const c of histData.collections){
              const cd=new Date(c.collected_at);
              let dl='By '+c.collected_by+' ‚Äî Collected: '+fmt(c.amount);
              if(c.expenses>0)dl+=' | Expenses: '+fmt(c.expenses);
              if(c.petty_cash>0)dl+=' | Left behind: '+fmt(c.petty_cash);
              if(c.discrepancy&&c.discrepancy!==0){const dc=c.discrepancy>0?'var(--red)':'var(--green)';const dl2=c.discrepancy>0?'Short':'Extra';dl+=' | <span style="color:'+dc+'">'+dl2+': '+fmt(Math.abs(c.discrepancy))+'</span>';}
              histHtml+='<div class="ch-item"><div class="ch-top"><span class="ch-amount">'+fmt(c.amount)+'</span><span class="ch-date">'+fmtDate(cd)+'</span></div><div class="ch-detail">'+dl+'</div></div>';
            }
            histHtml+='</div>';
          }

          // Missed expense section (Naveen can add expenses cashiers forgot to record)
          let missedExpenseHtml='<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px">'+
            '<div style="font-size:14px;font-weight:600;margin-bottom:4px;color:var(--red)">üìù Record Missed Expense</div>'+
            '<div style="font-size:12px;color:var(--text2);margin-bottom:12px">If a cashier forgot to record an expense, add it here before collecting</div>'+
            '<div class="field-group"><label>Amount (‚Çπ)</label><input type="number" id="missedExpAmount" class="expense-input" placeholder="e.g. 200" min="1" step="10" inputmode="numeric"></div>'+
            '<div class="field-group" style="margin-top:8px"><label>Reason</label><input type="text" id="missedExpReason" class="expense-reason" placeholder="e.g. Milk, Sugar, Supplies"></div>'+
            '<div class="field-group" style="margin-top:8px"><label>Which cashier gave this cash?</label><select id="missedExpCashier" style="width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;padding:10px">'+
            '<option value="">‚Äî Select Cashier ‚Äî</option>'+
            '<option value="Tanveer">Tanveer</option>'+
            '<option value="Md Kesmat">Md Kesmat</option>'+
            '<option value="Jafar">Jafar</option>'+
            '<option value="Yashwant">Yashwant</option>'+
            '<option value="Zoya">Zoya</option>'+
            '</select></div>'+
            '<button class="settle-btn" style="background:var(--red);margin-top:12px" id="missedExpBtn" onclick="recordMissedExpense()">Record Missed Expense</button></div>';

          // Collect section ‚Äî show if there's any cash at the counter
          let collectBtn='';
          if(totalCash>0){
            collectBtn='<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px"><div style="font-size:14px;font-weight:600;margin-bottom:12px">Collect Cash</div>'+
              '<div class="field-group"><label>How much cash are you taking?</label><input type="number" id="collectAmountInput" placeholder="Count and enter" min="0" step="50" oninput="updateCollectSummary()"></div>'+
              '<div id="collectSummary" style="margin-top:12px"></div>'+
              '<button class="collect-btn" id="collectBtn" onclick="collectCash()" disabled>Enter amount above</button></div>';
          }else{
            collectBtn='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì No cash pending collection</div>';
          }

          // Breakdown cards for new cash
          const totalCounterCash=bal.counterCash+liveCounterCash;
          let bdHtml='<div class="collection-breakdown">';
          bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</div><div class="cb-label">Runner Settlements</div></div>';
          bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--orange)">'+fmt(totalCounterCash)+'</div><div class="cb-label">Counter Cash</div></div>';
          if(bal.totalExpenses>0)bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</div><div class="cb-label">Expenses</div></div>';
          bdHtml+='</div>';

          // Physical cash card with full breakdown
          const displayCash=Math.max(0,totalCash);
          const totalCounterCashForBreakdown=bal.counterCash+liveCounterCash;
          let cardsHtml=
            '<div style="background:linear-gradient(135deg,rgba(234,179,8,0.15),rgba(234,179,8,0.05));border:1.5px solid var(--yellow);border-radius:14px;padding:20px;margin-bottom:16px">'+
              '<div style="text-align:center;margin-bottom:16px">'+
                '<div style="font-size:13px;color:var(--text2);margin-bottom:6px">üíµ Physical Cash at Counter</div>'+
                '<div style="font-size:44px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--yellow)">'+fmt(displayCash)+'</div>'+
                '<div style="font-size:12px;color:var(--text2);margin-top:4px">This is what you should count</div>'+
              '</div>'+
              (totalCash<0?'<div style="background:rgba(239,68,68,0.15);border:1px solid var(--red);border-radius:8px;padding:10px;font-size:12px;color:var(--red);text-align:center;margin-bottom:12px">‚ö†Ô∏è System expects less cash than zero ‚Äî check for unrecorded expenses or settlements</div>':'')+
              '<div style="border-top:1px solid rgba(234,179,8,0.2);padding-top:12px">'+
                '<div style="font-size:12px;color:var(--text2);margin-bottom:8px">üìä Breakdown</div>'+
                '<div class="cash-breakdown-row"><span class="cbr-label">Previous petty cash</span><span class="cbr-val" style="color:var(--yellow)">'+fmt(bal.pettyCash)+'</span></div>'+
                '<div class="cash-breakdown-row"><span class="cbr-label">+ Counter cash settled</span><span class="cbr-val">'+fmt(bal.counterCash)+'</span></div>'+
                '<div class="cash-breakdown-row"><span class="cbr-label">+ Unsettled drawer</span><span class="cbr-val">'+fmt(liveCounterCash)+'</span></div>'+
                '<div class="cash-breakdown-row"><span class="cbr-label">+ Runner cash settled</span><span class="cbr-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</span></div>'+
                (bal.totalExpenses>0?'<div class="cash-breakdown-row"><span class="cbr-label" style="color:var(--red)">‚àí Expenses</span><span class="cbr-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</span></div>'+buildExpenseAttribution(bal.expenses):'')+
                '<div class="cash-breakdown-row total"><span class="cbr-label">= Physical cash</span><span class="cbr-val" style="color:var(--yellow)">'+fmt(displayCash)+'</span></div>'+
              '</div>'+
            '</div>';

          $('collectionPanel').innerHTML=
            '<h3>üí∞ Cash Collection</h3><div class="subtitle">'+sinceText+'</div>'+
            cardsHtml+bdHtml+slHtml+expHtml+missedExpenseHtml+collectBtn+histHtml;

        }else{
          // Staff read-only view
          $('collectionPanel').classList.remove('show');
          $('counterBalanceReadonly').classList.add('show');
          let sinceText='';if(lastCol){sinceText='Since '+fmtDate(new Date(lastCol.collected_at));}
          const staffNewCash=bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;
          const staffTotalCounter=bal.counterCash+liveCounterCash;

          let breakdownHtml='<div class="bal-breakdown">';
          breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</div><div class="bb-label">Runner Cash</div></div>';
          breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--orange)">'+fmt(staffTotalCounter)+'</div><div class="bb-label">Counter Cash</div></div>';
          if(bal.totalExpenses>0){breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</div><div class="bb-label">Expenses</div></div>';}
          breakdownHtml+='</div>';

          const staffDisplayCash=Math.max(0,totalCash);
          $('counterBalanceReadonly').innerHTML=
            '<h3>üíµ Cash at Counter</h3>'+
            '<div style="text-align:center;margin-bottom:16px">'+
              '<div class="bal-amount">'+fmt(staffDisplayCash)+'</div>'+
              '<div class="bal-detail">Physical cash at counter</div>'+
            '</div>'+
            (totalCash<0?'<div style="background:rgba(239,68,68,0.15);border:1px solid var(--red);border-radius:8px;padding:10px;font-size:12px;color:var(--red);text-align:center;margin-bottom:12px">‚ö†Ô∏è System expects negative ‚Äî check expenses/settlements</div>':'')+
            '<div style="background:var(--bg2);border-radius:10px;padding:14px;margin-bottom:12px">'+
              '<div style="font-size:12px;color:var(--text2);margin-bottom:8px">üìä Breakdown</div>'+
              '<div class="cash-breakdown-row"><span class="cbr-label">Previous petty cash</span><span class="cbr-val" style="color:var(--yellow)">'+fmt(bal.pettyCash)+'</span></div>'+
              '<div class="cash-breakdown-row"><span class="cbr-label">+ Counter cash settled</span><span class="cbr-val">'+fmt(bal.counterCash)+'</span></div>'+
              '<div class="cash-breakdown-row"><span class="cbr-label">+ Unsettled drawer</span><span class="cbr-val">'+fmt(liveCounterCash)+'</span></div>'+
              '<div class="cash-breakdown-row"><span class="cbr-label">+ Runner cash settled</span><span class="cbr-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</span></div>'+
              (bal.totalExpenses>0?'<div class="cash-breakdown-row"><span class="cbr-label" style="color:var(--red)">‚àí Expenses</span><span class="cbr-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</span></div>'+buildExpenseAttribution(bal.expenses):'')+
              '<div class="cash-breakdown-row total"><span class="cbr-label">= Physical cash</span><span class="cbr-val" style="color:var(--yellow)">'+fmt(staffDisplayCash)+'</span></div>'+
            '</div>'+
            (sinceText?'<div class="bal-detail" style="margin-top:8px">'+sinceText+'</div>':'')+
            '<div class="bal-detail">'+bal.settlementCount+' settlement'+(bal.settlementCount!==1?'s':'')+' since last collection</div>';
        }
      }catch(e){console.error('Counter balance error:',e);}
    }

    function updateCollectSummary(){
      const collectAmt=parseFloat(document.getElementById('collectAmountInput')?.value||'0');
      const summaryEl=document.getElementById('collectSummary');
      const btn=document.getElementById('collectBtn');
      if(!summaryEl||!btn)return;

      // Total physical cash at counter
      const expected=currentCounterTotal;

      if(collectAmt<=0){summaryEl.innerHTML='';btn.disabled=true;btn.textContent='Enter amount above';return;}

      if(collectAmt>expected){
        // Taking more than expected ‚Äî flag it
        const over=collectAmt-expected;
        summaryEl.innerHTML=
          '<div style="background:var(--bg2);border-radius:10px;padding:14px;font-size:13px">'+
          '<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text2)">Total cash at counter</span><span style="font-family:JetBrains Mono,monospace">'+fmt(expected)+'</span></div>'+
          '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">You are taking</span><span style="font-family:JetBrains Mono,monospace">'+fmt(collectAmt)+'</span></div>'+
          '<div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px;margin-top:6px"><span style="color:var(--text2)">Left at counter (petty)</span><span style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--red)">‚Çπ0</span></div>'+
          '<div style="color:var(--red);font-weight:600;margin-top:8px">‚ö† Taking ‚Çπ'+over.toLocaleString('en-IN')+' more than system expected</div></div>';
        btn.disabled=false;
        btn.textContent='Confirm Collection ‚Äî Taking '+fmt(collectAmt);
        return;
      }

      // Remainder automatically becomes petty cash
      const remainder=expected-collectAmt;

      summaryEl.innerHTML=
        '<div style="background:var(--bg2);border-radius:10px;padding:14px;font-size:13px">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text2)">Total cash at counter</span><span style="font-family:JetBrains Mono,monospace">'+fmt(expected)+'</span></div>'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">You are taking</span><span style="font-family:JetBrains Mono,monospace">-'+fmt(collectAmt)+'</span></div>'+
        '<div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px;margin-top:6px"><span style="color:var(--yellow)">Left at counter (becomes petty cash)</span><span style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--yellow)">'+fmt(remainder)+'</span></div>'+
        '</div>';

      btn.disabled=false;
      btn.textContent='Confirm Collection ‚Äî Taking '+fmt(collectAmt);
    }

    async function collectCash(){
      const btn=document.getElementById('collectBtn');if(!btn)return;
      btn.disabled=true;btn.textContent='Recording collection...';
      try{
        const collectAmt=parseFloat(document.getElementById('collectAmountInput')?.value||'0');
        if(collectAmt<=0){btn.disabled=false;btn.textContent='Enter the cash amount';btn.style.background='var(--red)';setTimeout(()=>{btn.style.background='';updateCollectSummary();},2000);return;}

        // Auto-calculate petty cash: whatever is left at the counter after collection
        const pettyCash=Math.max(0,currentCounterTotal-collectAmt);

        const res=await fetch('/api/settlement?action=collect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({collected_by:currentUser,amount:collectAmt,petty_cash:pettyCash,live_counter_cash:currentLiveCounterCash,notes:'Collected via dashboard'})});
        const data=await res.json();
        if(data.success){
          let msg='‚úì Collected '+fmt(collectAmt)+' ‚Äî ‚Çπ'+pettyCash.toLocaleString('en-IN')+' left as petty';
          btn.textContent=msg;btn.style.background='var(--green)';btn.style.color='#fff';
          setTimeout(()=>loadCashAtCounter(),2500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // ========== SHIFT RECONCILIATION ==========
    let lastShiftReconData=null;

    async function loadShiftReconciliation(){
      try{
        // Fetch active shift period (same logic as counter settlement)
        const periodRes=await fetch('/api/settlement?action=get-last-settlement&runner_id=counter');
        const periodData=await periodRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        const shiftFrom=periodData.periodStart?new Date(periodData.periodStart):baseline;
        const res=await fetch('/api/nch-data?from='+toLocalISO(shiftFrom));
        const data=await res.json();
        if(!data.success||!data.data.shiftReconciliation){$('shiftReconPanel').classList.remove('show');return;}
        const sr=data.data.shiftReconciliation;
        lastShiftReconData=sr;
        const bc=sr.balanceCheck;
        const panel=$('shiftReconPanel');
        panel.classList.add('show');
        panel.classList.remove('balanced','warning','critical');
        if(bc.isBalanced)panel.classList.add('balanced');
        else if(Math.abs(bc.variance)<=50)panel.classList.add('warning');
        else panel.classList.add('critical');

        const statusIcon=bc.isBalanced?'‚úÖ':Math.abs(bc.variance)<=50?'‚ö†Ô∏è':'üö®';
        const statusText=bc.isBalanced?'SHIFT BALANCED':bc.variance>0?'‚Çπ'+Math.abs(bc.variance)+' UNACCOUNTED':'‚Çπ'+Math.abs(bc.variance)+' EXTRA';
        const statusColor=bc.isBalanced?'var(--green)':Math.abs(bc.variance)<=50?'var(--yellow)':'var(--red)';

        const shiftPeriodLabel=fmtD(shiftFrom)+' ‚Üí Now';
        let html='<h3>'+statusIcon+' Shift Reconciliation</h3><div class="subtitle">'+shiftPeriodLabel+'</div>';
        html+='<div class="recon-equation">';
        html+='<div class="eq-main">Sales '+fmt(sr.totalSales)+' = Cash '+fmt(bc.expectedCash)+' + UPI '+fmt(sr.verifiedUPI.total)+' + Card '+fmt(sr.card)+' + Comp '+fmt(sr.complimentary)+'</div>';
        html+='<div class="eq-status" style="color:'+statusColor+'">'+statusText+'</div>';
        html+='</div>';

        // Cash breakdown
        html+='<div class="recon-section"><h4>Cash Breakdown</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter Drawer (Unsettled)</span><span class="rr-val">'+fmt(sr.cashBreakdown.counterDrawer)+'</span></div>';
        for(const r of sr.cashBreakdown.runnerCashObligations){
          if(r.tokens>0||r.sales>0||r.upi>0){
            const cpNote=r.crossPaymentCredit>0?' <span style="font-size:11px;color:var(--blue)">(incl. -'+fmt(r.crossPaymentCredit)+' credit)</span>':'';
            html+='<div class="recon-row"><span class="rr-label">'+r.name+' Cash Owed'+cpNote+'</span><span class="rr-val" style="color:'+(r.cashToCollect>=0?'var(--green)':'var(--red)')+'">'+fmt(r.cashToCollect)+'</span></div>';
          }
        }
        html+='<div class="recon-row total"><span class="rr-label">Total Expected Cash</span><span class="rr-val">'+fmt(bc.expectedCash)+'</span></div>';
        html+='</div>';

        // UPI breakdown
        html+='<div class="recon-section"><h4>UPI Breakdown (Razorpay Verified)</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.counterQR)+'</span></div>';
        html+='<div class="recon-row"><span class="rr-label">Runner Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.runnerCounterQR)+'</span></div>';
        for(const [barcode,amt] of Object.entries(sr.verifiedUPI.runnerQRs)){
          if(amt>0)html+='<div class="recon-row"><span class="rr-label">'+barcode+' QR</span><span class="rr-val">'+fmt(amt)+'</span></div>';
        }
        html+='<div class="recon-row total"><span class="rr-label">Total Verified UPI</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.total)+'</span></div>';
        html+='</div>';

        // Card + Comp
        if(sr.card>0||sr.complimentary>0){
          html+='<div class="recon-section"><h4>Other</h4>';
          if(sr.card>0)html+='<div class="recon-row"><span class="rr-label">Card</span><span class="rr-val">'+fmt(sr.card)+'</span></div>';
          if(sr.complimentary>0)html+='<div class="recon-row"><span class="rr-label">Complimentary</span><span class="rr-val" style="color:var(--text2)">'+fmt(sr.complimentary)+'</span></div>';
          html+='</div>';
        }

        // Variance sources ‚Äî explain WHY shift doesn't balance
        if(sr.varianceSources&&sr.varianceSources.length>0&&!bc.isBalanced){
          html+='<div class="recon-section"><h4>Variance Sources</h4>';
          for(const vs of sr.varianceSources){
            html+='<div class="variance-source">';
            html+='<span class="vs-label">'+(vs.fixable?'üîß':'üìä')+' '+vs.label+' ('+vs.count+')</span>';
            html+='<span class="vs-amount" style="color:'+(vs.fixable?'var(--orange)':'var(--red)')+'">'+fmt(Math.abs(vs.amount))+'</span>';
            if(vs.fixable)html+='<button class="vs-fix" onclick="document.getElementById(\'discrepancyPanel\').scrollIntoView({behavior:\'smooth\'})">Fix</button>';
            html+='</div>';
          }
          html+='</div>';
        }

        // Cross-payments (green confirmed, blue probable ‚Äî NOT errors)
        if(sr.crossPayments&&sr.crossPayments.length>0){
          const confirmed=sr.crossPayments.filter(cp=>!cp.isProbable);
          const probable=sr.crossPayments.filter(cp=>cp.isProbable);
          html+='<div class="recon-section"><h4>Cross-Payments</h4>';
          if(confirmed.length>0){
            html+='<div style="font-size:12px;color:var(--green);margin-bottom:8px">Confirmed ‚Äî orders paid via different QR channel:</div>';
            for(const cp of confirmed){
              html+='<div class="cross-payment-notice" style="border-color:rgba(34,197,94,0.3);background:rgba(34,197,94,0.05)">';
              html+='<div class="cpn-title" style="color:var(--green)">‚úì '+(cp.orderName||'Cross-QR')+' ‚Äî '+fmt(cp.amount)+'</div>';
              html+='<div class="cpn-item">'+cp.description+'</div>';
              html+='<div class="cpn-item" style="color:var(--green)">'+cp.runnerCashImpact+'</div>';
              html+='<div class="cpn-shift">'+cp.shiftImpact+'</div></div>';
            }
          }
          if(probable.length>0){
            html+='<div style="font-size:12px;color:var(--blue);margin:'+(confirmed.length>0?'12px':'0')+' 0 8px 0">Probable ‚Äî detected from Razorpay patterns:</div>';
            for(const cp of probable){
              html+='<div class="cross-payment-notice" style="border-color:rgba(59,130,246,0.3);background:rgba(59,130,246,0.05)">';
              html+='<div class="cpn-title" style="color:var(--blue)">‚ÑπÔ∏è Possible Cross-QR ‚Äî '+fmt(cp.amount)+'</div>';
              html+='<div class="cpn-item">'+cp.description+'</div></div>';
            }
          }
          html+='</div>';
        }

        panel.innerHTML=html;
      }catch(e){console.error('Shift recon error:',e);}
    }

    function getCrossPaymentsForRunner(runnerName){
      if(!lastShiftReconData||!lastShiftReconData.crossPayments)return[];
      return lastShiftReconData.crossPayments.filter(cp=>cp.runner===runnerName);
    }

    function renderCrossPaymentNotice(runnerName){
      const cps=getCrossPaymentsForRunner(runnerName);
      if(cps.length===0)return '';
      let html='<div class="cross-payment-notice"><div class="cpn-title">‚ö†Ô∏è Cross-Payment Notice</div>';
      for(const cp of cps){
        html+='<div class="cpn-item">'+cp.description+'</div><div class="cpn-item" style="color:var(--yellow)">'+cp.runnerCashImpact+'</div>';
      }
      html+='<div class="cpn-shift">Shift total is correct ‚Äî UPI covers this amount at the counter level.</div></div>';
      return html;
    }

    // ========== SHIFT HISTORY TRAIL ==========
    async function loadShiftHistory(){
      try{
        const res=await fetch('/api/settlement?action=history&limit=20');
        const data=await res.json();
        if(!data.success||!data.settlements||data.settlements.length===0){$('shiftHistoryPanel').classList.remove('show');return;}
        const panel=$('shiftHistoryPanel');
        panel.classList.add('show');
        let html='<h3>üìã Shift History</h3><div class="subtitle">Tap any shift to view full reconciliation</div>';
        for(const s of data.settlements){
          const pStart=new Date(s.period_start);
          const pEnd=new Date(s.period_end);
          const isCounter=s.runner_id==='counter'||s.runner_id===0;
          const typeBadge=isCounter?'Counter':'Runner';
          const typeIcon=isCounter?'üí∞':'üèÉ';
          html+='<div class="sh-card" onclick="toggleShiftDetail(this,\''+s.period_start+'\',\''+s.period_end+'\')">';
          html+='<div class="sh-card-header">';
          html+='<div><div class="sh-card-title">'+typeIcon+' '+(isCounter?'Counter Settlement':s.runner_name)+' ‚Üí '+s.settled_by+'</div>';
          html+='<div class="sh-card-time">'+fmtD(pStart)+' ‚Üí '+fmtD(pEnd)+'</div></div>';
          html+='<div style="text-align:right"><div style="font-size:18px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--green)">'+fmt(s.cash_settled)+'</div></div>';
          html+='</div>';
          html+='<div class="sh-card-meta">';
          if(s.tokens_amount>0)html+='<span>Tokens: '+fmt(s.tokens_amount)+'</span>';
          if(s.sales_amount>0)html+='<span>Sales: '+fmt(s.sales_amount)+'</span>';
          if(s.upi_amount>0)html+='<span>UPI: '+fmt(s.upi_amount)+'</span>';
          if(s.unsold_tokens>0)html+='<span style="color:var(--orange)">Returned: '+fmt(s.unsold_tokens)+'</span>';
          html+='</div>';
          html+='<div class="sh-card-detail" id="shd_'+s.id+'"><div class="loading-text">Tap to load full reconciliation...</div></div>';
          html+='</div>';
        }
        panel.innerHTML=html;
      }catch(e){console.error('Shift history error:',e);}
    }

    async function toggleShiftDetail(card,periodStart,periodEnd){
      const detail=card.querySelector('.sh-card-detail');
      if(!detail)return;
      if(detail.classList.contains('show')){detail.classList.remove('show');return;}
      // Close all other open details
      document.querySelectorAll('.sh-card-detail.show').forEach(d=>d.classList.remove('show'));
      detail.classList.add('show');
      // If already loaded, just show
      if(detail.dataset.loaded==='true')return;
      detail.innerHTML='<div class="loading-text">Loading from Odoo & Razorpay...</div>';
      try{
        const fromISO=toLocalISO(new Date(periodStart));
        const toISO=toLocalISO(new Date(periodEnd));
        const res=await fetch('/api/nch-data?from='+fromISO+'&to='+toISO);
        const data=await res.json();
        if(!data.success){detail.innerHTML='<div class="loading-text" style="color:var(--red)">Error loading data</div>';return;}
        const sr=data.data.shiftReconciliation;
        if(!sr){detail.innerHTML='<div class="loading-text">No reconciliation data for this period</div>';return;}
        const bc=sr.balanceCheck;
        const statusIcon=bc.isBalanced?'‚úÖ':Math.abs(bc.variance)<=50?'‚ö†Ô∏è':'üö®';
        const statusText=bc.isBalanced?'BALANCED':bc.variance>0?'‚Çπ'+Math.abs(bc.variance)+' UNACCOUNTED':'‚Çπ'+Math.abs(bc.variance)+' EXTRA';
        const statusColor=bc.isBalanced?'var(--green)':Math.abs(bc.variance)<=50?'var(--yellow)':'var(--red)';

        let html='<div class="recon-equation" style="margin-bottom:8px">';
        html+='<div class="eq-main">Sales '+fmt(sr.totalSales)+' = Cash '+fmt(bc.expectedCash)+' + UPI '+fmt(sr.verifiedUPI.total)+' + Card '+fmt(sr.card)+' + Comp '+fmt(sr.complimentary)+'</div>';
        html+='<div class="eq-status" style="color:'+statusColor+'">'+statusIcon+' '+statusText+'</div>';
        html+='</div>';

        // Cash breakdown
        html+='<div class="recon-section" style="padding:8px 0"><h4 style="font-size:12px">Cash Breakdown</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter Drawer</span><span class="rr-val">'+fmt(sr.cashBreakdown.counterDrawer)+'</span></div>';
        for(const r of sr.cashBreakdown.runnerCashObligations){
          if(r.tokens>0||r.sales>0||r.upi>0){
            const cpNote=r.crossPaymentCredit>0?' <span style="font-size:10px;color:var(--blue)">(-'+fmt(r.crossPaymentCredit)+' credit)</span>':'';
            html+='<div class="recon-row"><span class="rr-label">'+r.name+' Cash'+cpNote+'</span><span class="rr-val">'+fmt(r.cashToCollect)+'</span></div>';
          }
        }
        html+='</div>';

        // UPI breakdown
        html+='<div class="recon-section" style="padding:8px 0"><h4 style="font-size:12px">UPI (Razorpay)</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.counterQR)+'</span></div>';
        if(sr.verifiedUPI.runnerCounterQR>0)html+='<div class="recon-row"><span class="rr-label">Runner Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.runnerCounterQR)+'</span></div>';
        for(const [barcode,amt] of Object.entries(sr.verifiedUPI.runnerQRs)){
          if(amt>0)html+='<div class="recon-row"><span class="rr-label">'+barcode+'</span><span class="rr-val">'+fmt(amt)+'</span></div>';
        }
        html+='</div>';

        // Cross-payments
        if(sr.crossPayments&&sr.crossPayments.length>0){
          html+='<div class="recon-section" style="padding:8px 0"><h4 style="font-size:12px">Cross-Payments</h4>';
          for(const cp of sr.crossPayments){
            const color=cp.isProbable?'var(--blue)':'var(--green)';
            const icon=cp.isProbable?'‚ÑπÔ∏è':'‚úì';
            html+='<div class="recon-row"><span class="rr-label" style="color:'+color+'">'+icon+' '+(cp.orderName||'Cross-QR')+' ‚Üí '+cp.runner+'</span><span class="rr-val" style="color:'+color+'">'+fmt(cp.amount)+'</span></div>';
          }
          html+='</div>';
        }

        // Variance sources
        if(sr.varianceSources&&sr.varianceSources.length>0&&!bc.isBalanced){
          html+='<div class="recon-section" style="padding:8px 0"><h4 style="font-size:12px">Variance Sources</h4>';
          for(const vs of sr.varianceSources){
            html+='<div class="variance-source"><span class="vs-label">'+(vs.fixable?'üîß':'üìä')+' '+vs.label+'</span><span class="vs-amount" style="color:var(--red)">'+fmt(Math.abs(vs.amount))+'</span></div>';
          }
          html+='</div>';
        }

        detail.innerHTML=html;
        detail.dataset.loaded='true';
      }catch(e){
        detail.innerHTML='<div class="loading-text" style="color:var(--red)">Failed: '+e.message+'</div>';
      }
    }

    // ========== DISCREPANCY RECTIFICATION PANEL ==========
    let currentMisattributed=[];
    const RUNNER_OPTIONS=[
      {id:64,name:'FAROOQ'},{id:65,name:'AMIN'},
      {id:66,name:'NCH Runner 03'},{id:67,name:'NCH Runner 04'},{id:68,name:'NCH Runner 05'}
    ];

    async function loadDiscrepancies(){
      try{
        const now=new Date();const todayISO=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+'T00:00:00';
        const res=await fetch('/api/nch-data?from='+todayISO);
        const data=await res.json();
        if(!data.success)return;
        currentMisattributed=data.data.misattributedOrders||[];
        const panel=$('discrepancyPanel');
        if(currentMisattributed.length===0){panel.classList.remove('show');return;}
        panel.classList.add('show');

        let html='<h3>‚ö†Ô∏è Discrepancies <span class="badge-count">'+currentMisattributed.length+'</span></h3>';
        html+='<div class="subtitle">These orders have wrong or missing runner attribution. Fix them to make the shift math accurate.</div>';

        for(let i=0;i<currentMisattributed.length;i++){
          const m=currentMisattributed[i];
          const orderTime=m.date_order?new Date(m.date_order+'Z').toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Kolkata'}):'';
          const posLabel=m.config_id===27?'Cash Counter':'Runner Counter';
          const isAuto=m.auto_resolved;
          const isCritical=!isAuto;
          const pmNames={37:'Cash',38:'UPI',39:'Card',40:'Runner Ledger',48:'Token Issue',49:'Complimentary'};
          const pmLabel=(m.payment_methods||[]).map(id=>pmNames[id]||'PM'+id).join(', ');

          html+='<div class="rectify-card'+(isCritical?' critical':'')+'" id="rectCard'+i+'">';
          html+='<div class="rc-header"><span class="rc-order">'+(isCritical?'üö®':'‚ö†Ô∏è')+' '+m.order_name+' ‚Ä¢ '+posLabel+' ‚Ä¢ '+orderTime+'</span><span class="rc-amount">'+fmt(m.amount)+'</span></div>';
          html+='<div class="rc-detail">';
          html+='Payment: '+pmLabel+'<br>';
          if(isAuto){
            html+='Selected: "'+m.current_partner_name+'" (wrong contact)<br>';
            html+='Auto-detected: <strong>'+m.correct_runner_name+'</strong>';
          }else{
            html+='<span style="color:var(--red)">No runner was selected</span><br>';
            html+='Who received this order?';
          }
          html+='</div>';
          html+='<div class="rc-actions">';
          html+='<select id="rectSelect'+i+'">';
          if(!isAuto)html+='<option value="">‚Äî Select Runner ‚Äî</option>';
          for(const ro of RUNNER_OPTIONS){
            const sel=(isAuto&&m.correct_partner_id===ro.id)?' selected':'';
            html+='<option value="'+ro.id+'"'+sel+'>'+ro.name+'</option>';
          }
          html+='</select>';
          html+='<button class="rectify-btn" id="rectBtn'+i+'" onclick="rectifyOrder('+i+')">‚úì Fix in Odoo</button>';
          html+='</div></div>';
        }
        panel.innerHTML=html;
      }catch(e){console.error('Load discrepancies error:',e);}
    }

    async function rectifyOrder(idx){
      const m=currentMisattributed[idx];
      const selectEl=document.getElementById('rectSelect'+idx);
      const btn=document.getElementById('rectBtn'+idx);
      const card=document.getElementById('rectCard'+idx);
      if(!selectEl||!btn)return;

      const correctId=parseInt(selectEl.value);
      if(!correctId){btn.textContent='Select runner';setTimeout(()=>{btn.textContent='‚úì Fix in Odoo';},1500);return;}

      // Ask for PIN
      const pin=prompt('Enter your 4-digit PIN to confirm rectification:');
      if(!pin||pin.length!==4)return;

      btn.disabled=true;btn.textContent='Fixing...';

      try{
        const res=await fetch('/api/settlement?action=rectify-discrepancy',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            pin,
            order_id:m.order_id,
            order_name:m.order_name,
            correct_partner_id:correctId,
            original_partner_id:m.current_partner_id
          })
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Fixed!';btn.style.background='var(--green)';
          if(card)card.classList.add('fixed');
          // Refresh shift recon to show updated variance
          setTimeout(()=>{loadShiftReconciliation();},1000);
        }else{
          throw new Error(data.error);
        }
      }catch(e){
        btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';
        setTimeout(()=>{btn.textContent='‚úì Fix in Odoo';btn.style.background='';},3000);
      }
    }

    // ========== SHIFT WIZARD v3 ‚Äî Full Drawer Accountability ==========
    let wizardData=null, wizardStep=1, wizardDrawerCashEntered=0, wizardRunnerInputs=[];

    async function startShiftWizard(){
      $('wizardContent').innerHTML='<div class="loading-text">Loading shift data...</div>';
      $('wizardOverlay').classList.add('show');
      wizardStep=1;
      updateWizardSteps();

      try{
        const baseline=new Date(2026,1,4,17,0,0);
        const runnerIds=[64,65,66,67,68];

        // Parallel fetch: counter-balance + counter period + all runner periods + last shift
        const [cbRes, lastShiftRes, ...periodResults]=await Promise.all([
          fetch('/api/settlement?action=counter-balance').then(r=>r.json()),
          fetch('/api/settlement?action=shift-history-v2&limit=1').then(r=>r.json()),
          fetch('/api/settlement?action=get-last-settlement&runner_id=counter').then(r=>r.json()),
          ...runnerIds.map(id=>fetch('/api/settlement?action=get-last-settlement&runner_id='+id).then(r=>r.json()))
        ]);

        const counterBalance=cbRes.success?{...cbRes.balance,lastCollectionAt:cbRes.lastCollection?.collected_at||null}:{pettyCash:0,counterCash:0,runnerCash:0,totalExpenses:0,expenses:[],settlements:[],total:0,lastCollectionAt:null};
        // Previous shift carry-forward: if last shift had a shortage, this shift can offset it
        const lastShift=(lastShiftRes.success&&lastShiftRes.shifts&&lastShiftRes.shifts.length>0)?lastShiftRes.shifts[0]:null;
        const prevVariance=lastShift?(lastShift.variance_unresolved||0):0;
        const counterPeriod=periodResults[0];
        const runnerPeriods={};
        runnerIds.forEach((id,i)=>{runnerPeriods[id]=periodResults[i+1];});

        const shiftFrom=counterPeriod.periodStart?new Date(counterPeriod.periodStart):baseline;

        // Fetch live Odoo + Razorpay data from counter period
        const res=await fetch('/api/nch-data?from='+toLocalISO(shiftFrom));
        const data=await res.json();
        if(!data.success) throw new Error(data.error||'Failed to load data');

        // === Runner classification: each runner from their OWN period ===
        // Every runner with activity since their last settlement is UNSETTLED.
        // Optimization: reuse the main nch-data for runners whose period >= counter period.
        // Only make separate API calls for runners with earlier periods.
        const allRunners=[];
        const extraFetches=[];
        for(const id of runnerIds){
          const rp=runnerPeriods[id];
          const rpFrom=rp.periodStart?new Date(rp.periodStart):baseline;
          const prevUnsold=(rp&&rp.lastSettlement&&rp.lastSettlement.unsold_tokens)?parseFloat(rp.lastSettlement.unsold_tokens):0;
          if(rpFrom>=shiftFrom){
            // Runner's period starts at or after counter period ‚Äî main nch-data covers it
            const runner=data.data.runners.find(x=>x.id===id);
            if(runner&&(runner.tokens>0||runner.sales>0||runner.upi>0)){
              runner._prevUnsold=prevUnsold;
              allRunners.push(runner);
            }else if(prevUnsold>0){
              // Runner has no new activity but has carry-forward tokens from prev settlement
              const rInfo=RUNNERS.find(r=>r.id===id);
              allRunners.push({id,name:rInfo?.name||'Runner '+id,barcode:rInfo?.barcode||'',tokens:0,sales:0,upi:0,cashToCollect:0,crossPaymentCredit:0,crossPayments:[],_prevUnsold:prevUnsold});
            }
          }else{
            // Runner's period is earlier ‚Äî needs separate fetch
            extraFetches.push(
              (function(runnerId,runnerPrevUnsold){
                return fetch('/api/nch-data?from='+toLocalISO(rpFrom)).then(r=>r.json()).then(d=>{
                  if(d.success){
                    const runner=d.data.runners.find(x=>x.id===runnerId);
                    if(runner&&(runner.tokens>0||runner.sales>0||runner.upi>0)){
                      runner._prevUnsold=runnerPrevUnsold;
                      allRunners.push(runner);
                    }else if(runnerPrevUnsold>0){
                      const rInfo=RUNNERS.find(r=>r.id===runnerId);
                      allRunners.push({id:runnerId,name:rInfo?.name||'Runner '+runnerId,barcode:rInfo?.barcode||'',tokens:0,sales:0,upi:0,cashToCollect:0,crossPaymentCredit:0,crossPayments:[],_prevUnsold:runnerPrevUnsold});
                    }
                  }
                }).catch(()=>{/* skip runner on API error */});
              })(id,prevUnsold)
            );
          }
        }
        if(extraFetches.length>0) await Promise.all(extraFetches);

        // Compute expected drawer using counter-balance formula
        // liveCounterCash = PM 37 from nch-data for the CURRENT unsettled counter window only
        //   (from last counter settlement ‚Üí now). This does NOT overlap with counterBalance.counterCash
        //   which covers settled periods since last collection. No subtraction needed.
        // Formula matches loadCashAtCounter(): petty + settled_counter + unsettled_counter + runner - expenses
        const liveCounterCash=data.data.mainCounter?.cash||0;
        const unsettledCounterCash=liveCounterCash;

        const expectedDrawer=counterBalance.pettyCash+counterBalance.counterCash+unsettledCounterCash+counterBalance.runnerCash-counterBalance.totalExpenses;

        wizardData={
          shiftFrom,
          periodStart:toLocalISO(shiftFrom),
          mainCounter:data.data.mainCounter,
          runnerCounter:data.data.runnerCounter,
          runners:allRunners,
          verification:data.data.verification||{},
          shiftRecon:data.data.shiftReconciliation||{},
          crossPayments:data.data.crossPayments||[],
          discrepancies:data.data.discrepancies||[],
          misattributed:data.data.misattributedOrders||[],
          runnerPeriods,
          counterBalance,
          expectedDrawer,
          unsettledCounterCash,
          prevVariance,
          lastShiftCashier:lastShift?.cashier_name||null,
          // ALL runners with activity are unsettled ‚Äî no "already collected" category
          unsettledRunners:allRunners,
          settledRunners:[]
        };

        // Discrepancy cash: unattributed orders (runner_ledger_no_runner, token_issue_no_runner)
        // These create cash obligations that no runner is charged for ‚Äî add to expected
        const discrepancyList=data.data.discrepancies||[];
        let discrepancyCashAdd=0;
        const discrepancyDetails=[];
        for(const d of discrepancyList){
          if(d.type==='runner_ledger_no_runner'||d.type==='token_issue_no_runner'){
            discrepancyCashAdd+=(d.amount||0);
            discrepancyDetails.push({type:d.type,amount:d.amount,order:d.order,label:d.message});
          }
        }
        wizardData.discrepancyCashAdd=discrepancyCashAdd;
        wizardData.discrepancyDetails=discrepancyDetails;

        // Active runners = all unsettled runners (for step 2 display)
        wizardData.activeRunners=allRunners;

        // Init runner inputs for ALL runners with activity (including carry-forward tokens)
        wizardRunnerInputs=allRunners.map(r=>{
          const prevUnsold=r._prevUnsold||0;
          const totalTokens=r.tokens+prevUnsold;
          const cashCalc=Math.max(0,(totalTokens+r.sales)-r.upi-(r.crossPaymentCredit||0));
          return {
            runner_id:r.id,
            runner_name:r.name,
            tokens:r.tokens,
            sales:r.sales,
            upi:r.upi,
            prevUnsoldTokens:prevUnsold,
            totalTokens:totalTokens,
            crossPaymentCredit:r.crossPaymentCredit||0,
            unsoldTokens:0,
            cashCalculated:cashCalc,
            cashCollected:cashCalc,
            userEdited:false,
            absent:false
          };
        });

        renderWizardStep1();
      }catch(e){
        $('wizardContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';
      }
    }

    function closeWizard(){
      $('wizardOverlay').classList.remove('show');
      wizardData=null;wizardStep=1;wizardRunnerInputs=[];
    }

    function updateWizardSteps(){
      for(let i=1;i<=3;i++){
        const el=$('wizStep'+i);
        el.classList.remove('active','done');
        if(i===wizardStep) el.classList.add('active');
        else if(i<wizardStep) el.classList.add('done');
      }
    }

    function renderWizardStep1(){
      wizardStep=1;updateWizardSteps();
      const cb=wizardData.counterBalance;
      const ed=wizardData.expectedDrawer;
      const shiftLabel=fmtD(wizardData.shiftFrom)+' ‚Üí Now';

      // Build expandable breakdown
      const lastCollectionTime=cb.lastCollectionAt?fmtD(new Date(cb.lastCollectionAt)):'start';
      let breakdownHtml=
        '<div id="wizBreakdownPanel" style="display:none;margin-top:12px;padding:12px;background:var(--bg2);border-radius:8px;font-size:13px">'+
          '<div class="wizard-row"><span class="wr-label">Petty cash (from last collection)</span><span class="wr-val">'+fmt(cb.pettyCash||0)+'</span></div>'+
          '<div class="wizard-row"><span class="wr-label">+ Counter settled (D1)</span><span class="wr-val" style="color:var(--green)">+'+fmt(cb.counterCash||0)+'</span></div>'+
          '<div class="wizard-row"><span class="wr-label">+ Unsettled counter cash (live)</span><span class="wr-val" style="color:var(--green)">+'+fmt(wizardData.unsettledCounterCash||0)+'</span></div>'+
          '<div class="wizard-row"><span class="wr-label">+ Runner cash settled (D1)</span><span class="wr-val" style="color:var(--green)">+'+fmt(cb.runnerCash||0)+'</span></div>'+
          '<div class="wizard-row"><span class="wr-label">- Expenses ('+(cb.expenses?.length||0)+' items)</span><span class="wr-val" style="color:var(--red)">-'+fmt(cb.totalExpenses||0)+'</span></div>'+
          '<div class="wizard-row total" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)"><span class="wr-label">= Expected drawer</span><span class="wr-val">'+fmt(ed)+'</span></div>'+
        '</div>';

      $('wizardContent').innerHTML=
        '<div class="wizard-step-content active" id="step1Content">'+
          '<div class="wizard-card"><h3>üíµ Count Your Drawer</h3>'+
            '<div style="font-size:12px;color:var(--text2);margin-bottom:16px">Count ALL the cash in your drawer right now.</div>'+
            '<div class="wizard-input-group">'+
              '<input type="number" id="wizDrawerCash" placeholder="Enter total cash amount" min="0" step="10" inputmode="numeric" style="font-size:24px;text-align:center;padding:16px" oninput="updateDrawerMatch()">'+
            '</div>'+
            '<div id="wizDrawerMatch"></div>'+
            '<div style="margin-top:12px;text-align:center">'+
              '<a href="javascript:void(0)" onclick="document.getElementById(\'wizBreakdownPanel\').style.display=document.getElementById(\'wizBreakdownPanel\').style.display===\'none\'?\'block\':\'none\'" style="font-size:12px;color:var(--blue);text-decoration:none">‚ñº How is expected calculated?</a>'+
            '</div>'+
            breakdownHtml+
          '</div>'+
          '<div class="wizard-nav">'+
            '<button class="wn-back" onclick="closeWizard()">‚úï Cancel</button>'+
            (wizardData.unsettledRunners.length>0
              ?'<button class="wn-next" onclick="goToWizardStep2()">Next ‚Üí Runners</button>'
              :'<button class="wn-next" onclick="goToWizardStep3()">Next ‚Üí Confirm</button>')+
          '</div>'+
        '</div>';
    }

    function updateDrawerMatch(){
      const input=document.getElementById('wizDrawerCash');
      if(!input)return;
      const entered=parseFloat(input.value)||0;
      wizardDrawerCashEntered=entered;
      const expected=wizardData.expectedDrawer;
      const diff=entered-expected;

      let html='';
      if(!input.value||input.value===''){
        html='';
      }else if(Math.abs(diff)<=5){
        html='<div class="wizard-match ok">‚úÖ Matches expected ‚Äî '+fmt(expected)+'</div>';
      }else if(Math.abs(diff)<=50){
        html='<div class="wizard-match warn">‚ö†Ô∏è '+(diff>0?'+':'')+fmt(diff)+' variance from expected '+fmt(expected)+'</div>';
      }else{
        html='<div class="wizard-match bad">üö® '+(diff>0?'+':'')+fmt(diff)+' variance from expected '+fmt(expected)+' ‚Äî investigate before proceeding</div>';
      }
      $('wizDrawerMatch').innerHTML=html;
    }

    function goToWizardStep2(){
      wizardDrawerCashEntered=parseFloat(document.getElementById('wizDrawerCash')?.value)||0;
      wizardStep=2;updateWizardSteps();

      let html='<div class="wizard-step-content active" id="step2Content">';

      // === All runners with activity ‚Äî collect from each ===
      if(wizardRunnerInputs.length===0){
        html+='<div class="wizard-card"><div class="loading-text">No active runners this shift</div></div>';
      }else{
        for(let i=0;i<wizardRunnerInputs.length;i++){
          const ri=wizardRunnerInputs[i];
          const cashCalc=(ri.totalTokens-ri.unsoldTokens+ri.sales)-ri.upi-ri.crossPaymentCredit;
          const clampedCalc=Math.max(0,cashCalc);
          ri.cashCalculated=clampedCalc;
          if(!ri.userEdited) ri.cashCollected=clampedCalc;

          let cpHtml='';
          if(ri.crossPaymentCredit>0){
            cpHtml='<div class="wizard-row"><span class="wr-label" style="color:var(--blue)">Cross-Payment Credit</span><span class="wr-val" style="color:var(--blue)">-'+fmt(ri.crossPaymentCredit)+'</span></div>';
          }

          let overCollectNote='';
          if(cashCalc<0){
            overCollectNote='<div class="wizard-match info">Runner collected more UPI than sales. '+fmt(Math.abs(cashCalc))+' excess. No cash to collect.</div>';
          }

          html+='<div class="wizard-runner-card'+(ri.absent?' absent':'')+'" id="wizRunner'+i+'">'+
            '<div class="wrc-header"><span class="wrc-name">'+ri.runner_name+'</span><span class="wrc-badge">Unsettled ‚Äî collect cash</span></div>'+
            (ri.prevUnsoldTokens>0?
              '<div style="background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2);border-radius:6px;padding:6px 10px;margin-bottom:8px;font-size:12px;color:var(--yellow)">üé´ Remaining tokens from prev: <strong>'+fmt(ri.prevUnsoldTokens)+'</strong></div>':'')+
            '<div class="wizard-row"><span class="wr-label">Tokens'+(ri.prevUnsoldTokens>0?' (Total)':' Issued')+'</span><span class="wr-val">'+fmt(ri.totalTokens)+'</span></div>'+
            (ri.prevUnsoldTokens>0?
              '<div style="font-size:11px;color:var(--text2);padding:0 0 4px 12px">'+fmt(ri.prevUnsoldTokens)+' carried + '+fmt(ri.tokens)+' new</div>':'')+
            '<div class="wizard-row"><span class="wr-label">Sales (Snacks)</span><span class="wr-val">'+fmt(ri.sales)+'</span></div>'+
            '<div class="wizard-row"><span class="wr-label">UPI Collected (QR)</span><span class="wr-val" style="color:var(--blue)">'+fmt(ri.upi)+'</span></div>'+
            cpHtml+
            (ri.totalTokens>0?
              '<div class="wizard-input-group"><label>Unsold tokens (‚Çπ)</label>'+
              '<input type="number" id="wizUnsold'+i+'" value="'+ri.unsoldTokens+'" min="0" max="'+ri.totalTokens+'" step="10" inputmode="numeric" oninput="updateRunnerCalc('+i+')" '+(ri.absent?'disabled':'')+'>'+
              '<div style="font-size:11px;color:var(--text2);margin-top:4px">Max: '+fmt(ri.totalTokens)+'</div></div>':'')+
            '<div class="wrc-calc" id="wizCalc'+i+'">Cash to collect: '+fmt(clampedCalc)+'</div>'+
            overCollectNote+
            (cashCalc>=0?
              '<div class="wizard-input-group"><label>Actual cash collected from runner</label>'+
              '<input type="number" id="wizActual'+i+'" value="'+ri.cashCollected+'" min="0" step="10" inputmode="numeric" onfocus="wizardRunnerInputs['+i+'].userEdited=true" oninput="updateRunnerActual('+i+')" '+(ri.absent?'disabled':'')+'>'+
              '</div><div id="wizRunnerMatch'+i+'"></div>':'')+
            '<label class="wizard-absent-toggle"><input type="checkbox" id="wizAbsent'+i+'" '+(ri.absent?'checked':'')+' onchange="toggleAbsent('+i+')"> Runner not present</label>'+
          '</div>';
        }
      }
      html+='<div class="wizard-nav">'+
        '<button class="wn-back" onclick="renderWizardStep1()">‚Üê Back</button>'+
        '<button class="wn-next" onclick="goToWizardStep3()">Next ‚Üí Confirm</button>'+
      '</div></div>';
      $('wizardContent').innerHTML=html;
      // Trigger match status for each unsettled runner
      for(let i=0;i<wizardRunnerInputs.length;i++) updateRunnerActual(i);
    }

    function updateRunnerCalc(idx){
      const ri=wizardRunnerInputs[idx];
      const unsoldInput=document.getElementById('wizUnsold'+idx);
      let unsold=parseFloat(unsoldInput?.value)||0;
      if(unsold>ri.totalTokens){unsold=ri.totalTokens;if(unsoldInput)unsoldInput.value=unsold;}
      if(unsold<0){unsold=0;if(unsoldInput)unsoldInput.value=0;}
      ri.unsoldTokens=unsold;
      const cashCalc=(ri.totalTokens-unsold+ri.sales)-ri.upi-ri.crossPaymentCredit;
      const clamped=Math.max(0,cashCalc);
      ri.cashCalculated=clamped;
      const calcEl=document.getElementById('wizCalc'+idx);
      if(calcEl) calcEl.textContent='Cash to collect: '+fmt(clamped);
      if(!ri.userEdited){
        ri.cashCollected=clamped;
        const actEl=document.getElementById('wizActual'+idx);
        if(actEl) actEl.value=clamped;
      }
      updateRunnerActual(idx);
    }

    function updateRunnerActual(idx){
      const ri=wizardRunnerInputs[idx];
      if(ri.absent) return;
      const actInput=document.getElementById('wizActual'+idx);
      if(!actInput)return;
      const collected=parseFloat(actInput.value)||0;
      ri.cashCollected=collected;
      const diff=collected-ri.cashCalculated;
      ri.cashVariance=diff;

      const matchEl=document.getElementById('wizRunnerMatch'+idx);
      if(!matchEl)return;

      if(Math.abs(diff)<=1){
        matchEl.innerHTML='<div class="wizard-match ok">‚úÖ Matches expected</div>';
      }else if(diff>0){
        matchEl.innerHTML='<div class="wizard-match warn">‚ö†Ô∏è '+fmt(diff)+' extra cash from runner</div>';
      }else{
        matchEl.innerHTML='<div class="wizard-match bad">üö® '+fmt(Math.abs(diff))+' short ‚Äî confirm with runner</div>';
      }
    }

    function toggleAbsent(idx){
      const cb=document.getElementById('wizAbsent'+idx);
      const ri=wizardRunnerInputs[idx];
      ri.absent=cb.checked;
      const card=document.getElementById('wizRunner'+idx);
      if(card) card.classList.toggle('absent',ri.absent);
      const unsoldEl=document.getElementById('wizUnsold'+idx);
      const actualEl=document.getElementById('wizActual'+idx);
      if(unsoldEl) unsoldEl.disabled=ri.absent;
      if(actualEl) actualEl.disabled=ri.absent;
      if(ri.absent){
        ri.cashCollected=0;ri.unsoldTokens=0;
        if(actualEl) actualEl.value=0;
        if(unsoldEl) unsoldEl.value=0;
        const matchEl=document.getElementById('wizRunnerMatch'+idx);
        if(matchEl) matchEl.innerHTML='<div class="wizard-match info">‚ö†Ô∏è '+ri.runner_name+'\'s '+fmt(ri.cashCalculated)+' obligation carries to next shift. No settlement recorded.</div>';
      }else{
        ri.cashCollected=ri.cashCalculated;
        if(actualEl) actualEl.value=ri.cashCalculated;
        ri.userEdited=false;
        updateRunnerActual(idx);
      }
    }

    function goToWizardStep3(){
      // Capture drawer cash from step 1 (if skipping step 2)
      const drawerInput=document.getElementById('wizDrawerCash');
      if(drawerInput) wizardDrawerCashEntered=parseFloat(drawerInput.value)||0;

      // Capture Step 2 inputs if coming from step 2
      if(wizardStep===2){
        for(let i=0;i<wizardRunnerInputs.length;i++){
          const ri=wizardRunnerInputs[i];
          if(!ri.absent){
            const unsoldEl=document.getElementById('wizUnsold'+i);
            const actualEl=document.getElementById('wizActual'+i);
            if(unsoldEl) ri.unsoldTokens=parseFloat(unsoldEl.value)||0;
            if(actualEl) ri.cashCollected=parseFloat(actualEl.value)||0;
            ri.cashCalculated=(ri.totalTokens-ri.unsoldTokens+ri.sales)-ri.upi-ri.crossPaymentCredit;
            ri.cashCalculated=Math.max(0,ri.cashCalculated);
            ri.cashVariance=ri.cashCollected-ri.cashCalculated;
          }
        }
      }
      wizardStep=3;updateWizardSteps();

      // === BIDIRECTIONAL VARIANCE RESOLUTION ===
      const v=wizardData.verification;
      const counterQRVar=(v.cashCounter?.variance)||0;  // + = Odoo > Razorpay, - = Razorpay > Odoo
      const rcQRVar=(v.runnerCounter?.variance)||0;
      const discAdd=wizardData.discrepancyCashAdd||0;
      const resolutions=[];

      // Drawer variance (drawer entered vs expected drawer)
      const drawerVariance=wizardDrawerCashEntered-wizardData.expectedDrawer;

      // Runner collected total and expected total (unsettled runners only)
      const runnerCollectedTotal=wizardRunnerInputs.filter(r=>!r.absent).reduce((s,r)=>s+r.cashCollected,0);
      const runnerExpectedTotal=wizardRunnerInputs.filter(r=>!r.absent).reduce((s,r)=>s+r.cashCalculated,0);

      // Total physical = drawer + newly collected from runners
      const totalPhysical=wizardDrawerCashEntered+runnerCollectedTotal;
      // Total expected = drawer expected + runner expected + discrepancy cash (unattributed orders)
      const totalExpected=wizardData.expectedDrawer+runnerExpectedTotal+discAdd;
      const rawVariance=totalPhysical-totalExpected;

      if(rawVariance>1){
        // EXCESS CASH ‚Äî resolve in order of likelihood
        let remainingExcess=rawVariance;

        // Phase E1: Counter QR (Odoo > Razorpay ‚Üí cash recorded as UPI ‚Üí excess cash)
        if(remainingExcess>0&&counterQRVar>0){
          const resolved=Math.min(remainingExcess,counterQRVar);
          resolutions.push({source:'counter_qr_variance',amount:resolved,resolved_by:'physical_excess',explanation:'Cash payment recorded as UPI in Odoo (Counter QR): '+fmt(resolved)});
          remainingExcess-=resolved;
        }
        // Phase E2: Runner Counter QR (same logic)
        if(remainingExcess>0&&rcQRVar>0){
          const resolved=Math.min(remainingExcess,rcQRVar);
          resolutions.push({source:'runner_counter_qr_variance',amount:resolved,resolved_by:'physical_excess',explanation:'Cash payment recorded as UPI in Odoo (Runner Counter QR): '+fmt(resolved)});
          remainingExcess-=resolved;
        }
        // Phase E3: Previous shift shortage recovery
        if(remainingExcess>0&&wizardData.prevVariance<0){
          const shortage=Math.abs(wizardData.prevVariance);
          const recovered=Math.min(remainingExcess,shortage);
          resolutions.push({source:'prev_shift_carryforward',amount:recovered,resolved_by:'shortage_recovery',explanation:'Recovering '+fmt(recovered)+' shortage from '+(wizardData.lastShiftCashier||'previous')+' shift (was '+fmt(shortage)+' short)'});
          remainingExcess-=recovered;
        }
        // Phase E4: Unexplained excess
        if(remainingExcess>0){
          resolutions.push({source:'unexplained',amount:remainingExcess,resolved_by:'none',explanation:fmt(remainingExcess)+' unexplained extra cash'});
        }
      }else if(rawVariance<-1){
        // CASH SHORT ‚Äî resolve in order of likelihood
        let remainingShortage=Math.abs(rawVariance);

        // Phase S1: Counter QR (Razorpay > Odoo ‚Üí UPI received but not recorded ‚Üí less cash expected)
        if(remainingShortage>0&&counterQRVar<0){
          const explained=Math.min(remainingShortage,Math.abs(counterQRVar));
          resolutions.push({source:'counter_qr_upi_excess',amount:-explained,resolved_by:'upi_not_recorded',explanation:fmt(explained)+' paid via Counter UPI but not recorded in Odoo ‚Äî cash correctly short'});
          remainingShortage-=explained;
        }
        // Phase S2: Runner Counter QR (same logic)
        if(remainingShortage>0&&rcQRVar<0){
          const explained=Math.min(remainingShortage,Math.abs(rcQRVar));
          resolutions.push({source:'runner_counter_qr_upi_excess',amount:-explained,resolved_by:'upi_not_recorded',explanation:fmt(explained)+' paid via Runner Counter UPI but not recorded in Odoo ‚Äî cash correctly short'});
          remainingShortage-=explained;
        }
        // Phase S3: Previous shift overage recovery
        if(remainingShortage>0&&wizardData.prevVariance>0){
          const overage=wizardData.prevVariance;
          const recovered=Math.min(remainingShortage,overage);
          resolutions.push({source:'prev_shift_overage',amount:-recovered,resolved_by:'overage_correction',explanation:fmt(recovered)+' offset from '+(wizardData.lastShiftCashier||'previous')+' shift overage (had '+fmt(overage)+' extra)'});
          remainingShortage-=recovered;
        }
        // Phase S4: Unexplained shortage
        if(remainingShortage>0){
          resolutions.push({source:'unexplained_shortage',amount:-remainingShortage,resolved_by:'none',explanation:fmt(remainingShortage)+' unexplained cash shortage'});
        }
      }

      const varianceResolved=resolutions.filter(r=>r.source!=='unexplained'&&r.source!=='unexplained_shortage').reduce((s,r)=>s+r.amount,0);
      const varianceUnresolved=rawVariance-varianceResolved;
      const absentObligation=wizardRunnerInputs.filter(r=>r.absent).reduce((s,r)=>s+r.cashCalculated,0);

      // Map excess per runner for DB storage
      for(const ri of wizardRunnerInputs){
        if(ri.absent)continue;
        ri.excessMappedTo='';ri.excessMappedAmount=0;
        const excess=ri.cashCollected-ri.cashCalculated;
        if(excess>0){
          ri.excessMappedTo='runner_excess';ri.excessMappedAmount=excess;
        }
      }

      // Store for submission
      wizardData.reconciliation={
        total_physical_cash:totalPhysical,
        expected_cash:totalExpected,
        raw_variance:rawVariance,
        discrepancy_cash_addition:discAdd,
        variance_resolved:varianceResolved,
        variance_unresolved:varianceUnresolved,
        discrepancy_resolutions:resolutions
      };

      // === RENDER STEP 3 ===
      let html='<div class="wizard-step-content active" id="step3Content">';

      // Physical cash summary
      html+='<div class="wizard-card"><h3>üíµ Cash Summary</h3>';
      html+='<div class="wizard-row"><span class="wr-label">Drawer cash entered</span><span class="wr-val">'+fmt(wizardDrawerCashEntered)+'</span></div>';
      for(const ri of wizardRunnerInputs){
        if(ri.absent) continue;
        html+='<div class="wizard-row"><span class="wr-label">+ '+ri.runner_name+' collected</span><span class="wr-val">+'+fmt(ri.cashCollected)+'</span></div>';
      }
      html+='<div class="wizard-row total"><span class="wr-label">Total physical cash</span><span class="wr-val">'+fmt(totalPhysical)+'</span></div>';
      html+='<div style="height:8px"></div>';
      html+='<div class="wizard-row"><span class="wr-label">Drawer expected</span><span class="wr-val">'+fmt(wizardData.expectedDrawer)+'</span></div>';
      for(const ri of wizardRunnerInputs){
        if(ri.absent) continue;
        html+='<div class="wizard-row"><span class="wr-label">+ '+ri.runner_name+' expected</span><span class="wr-val">+'+fmt(ri.cashCalculated)+'</span></div>';
      }
      if(discAdd>0){
        const discOrders=wizardData.discrepancyDetails||[];
        html+='<div class="wizard-row" style="border-top:1px dashed var(--border);padding-top:4px;margin-top:4px"><span class="wr-label" style="color:var(--orange)">+ Unattributed cash ('+discOrders.length+' order'+(discOrders.length>1?'s':'')+')</span><span class="wr-val" style="color:var(--orange)">+'+fmt(discAdd)+'</span></div>';
        for(const d of discOrders){
          html+='<div style="font-size:11px;color:var(--text2);padding:2px 0 2px 16px">‚îî '+d.order+': '+fmt(d.amount)+' ‚Äî '+(d.type==='runner_ledger_no_runner'?'Runner Ledger no runner':'Token Issue no runner')+'</div>';
        }
      }
      html+='<div class="wizard-row total"><span class="wr-label">Expected total</span><span class="wr-val">'+fmt(totalExpected)+'</span></div>';
      html+='</div>';

      // Final status ‚Äî simplified for cashier
      if(Math.abs(varianceUnresolved)<=5){
        html+='<div class="wizard-recon-box balanced"><div class="wrb-icon">‚úÖ</div><div class="wrb-text">BALANCED</div><div class="wrb-amount" style="color:var(--green)">All cash accounted for</div></div>';
      }else if(varianceResolved>0&&Math.abs(varianceUnresolved)<=5){
        html+='<div class="wizard-recon-box balanced"><div class="wrb-icon">‚úÖ</div><div class="wrb-text">BALANCED</div><div class="wrb-amount" style="color:var(--green)">'+fmt(varianceResolved)+' auto-resolved (UPI mismatch)</div></div>';
      }else if(varianceUnresolved>0){
        html+='<div class="wizard-recon-box '+(varianceUnresolved>50?'bad':'variance')+'"><div class="wrb-icon">'+(varianceUnresolved>50?'üö®':'‚ö†Ô∏è')+'</div><div class="wrb-text">'+(varianceResolved>0?fmt(varianceResolved)+' auto-resolved':'EXTRA CASH')+'</div><div class="wrb-amount" style="color:'+(varianceUnresolved>50?'var(--red)':'var(--yellow)')+'">'+fmt(varianceUnresolved)+' unresolved extra</div></div>';
      }else{
        html+='<div class="wizard-recon-box '+(Math.abs(varianceUnresolved)>50?'bad':'variance')+'"><div class="wrb-icon">'+(Math.abs(varianceUnresolved)>50?'üö®':'‚ö†Ô∏è')+'</div><div class="wrb-text">CASH SHORT</div><div class="wrb-amount" style="color:var(--red)">'+fmt(Math.abs(varianceUnresolved))+' unresolved</div></div>';
      }

      // Absent runners
      if(absentObligation>0){
        const absentList=wizardRunnerInputs.filter(r=>r.absent);
        html+='<div class="wizard-card" style="border-color:var(--orange)">';
        for(const r of absentList){
          html+='<div style="padding:8px 0;font-size:13px;color:var(--orange)">‚ö†Ô∏è '+r.runner_name+' ('+fmt(r.cashCalculated)+') ‚Äî carried to next shift</div>';
        }
        html+='</div>';
      }

      // Handover dropdown
      const handoverOpts=CASHIERS.filter(c=>c!==currentUser).map(c=>'<option value="'+c+'">'+c+'</option>').join('');
      html+='<div class="wizard-card" style="border-color:var(--blue)">'+
        '<div style="font-size:14px;font-weight:600;margin-bottom:8px">Handing over to</div>'+
        '<select id="wizHandoverTo" style="width:100%;padding:10px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;font-family:inherit">'+
          '<option value="">‚Äî Select next cashier ‚Äî</option>'+
          handoverOpts+
          '<option value="'+currentUser+'">'+currentUser+' (continuing)</option>'+
        '</select>'+
      '</div>';

      html+='<div class="wizard-nav">'+
        '<button class="wn-back" onclick="'+(wizardData.unsettledRunners.length>0?'goToWizardStep2()':'renderWizardStep1()')+'">‚Üê Back</button>'+
        '<button class="wn-submit" id="wizSubmitBtn" onclick="submitShiftWizard()">‚úÖ Confirm & End Shift</button>'+
      '</div></div>';

      $('wizardContent').innerHTML=html;
    }

    async function submitShiftWizard(){
      const btn=document.getElementById('wizSubmitBtn');
      if(!btn)return;
      const handoverEl=document.getElementById('wizHandoverTo');
      const handoverTo=handoverEl?handoverEl.value:'';
      if(!handoverTo){alert('Please select who you are handing over to.');return;}
      btn.disabled=true;btn.textContent='Recording settlement...';

      const mc=wizardData.mainCounter;
      const v=wizardData.verification;
      const rc=wizardData.reconciliation;
      const cb=wizardData.counterBalance;
      const now=new Date();

      const payload={
        settled_by:currentUser,
        handover_to:handoverTo,
        period_start:wizardData.periodStart,
        period_end:toLocalISO(now),
        counter_balance:{
          petty_cash_start:cb.pettyCash||0,
          counter_cash_settled:cb.counterCash||0,
          unsettled_counter_cash:wizardData.unsettledCounterCash||0,
          runner_cash_settled:cb.runnerCash||0,
          expenses_total:cb.totalExpenses||0,
          expected_drawer:wizardData.expectedDrawer||0
        },
        drawer_cash_entered:wizardDrawerCashEntered,
        counter:{
          cash_entered:wizardDrawerCashEntered,
          cash_expected:mc.cash||0,
          unsettled_counter_cash:wizardData.unsettledCounterCash||0,
          upi:mc.upi||0,
          card:mc.card||0,
          token_issue:mc.tokenIssue||0,
          complimentary:mc.complimentary||0
        },
        upi_verification:{
          counter_qr:{
            odoo:mc.upi||0,
            razorpay:v.cashCounter?.razorpay||0,
            variance:(v.cashCounter?.variance)||0
          },
          runner_counter_qr:{
            odoo:wizardData.runnerCounter?.upi||0,
            razorpay:v.runnerCounter?.razorpay||0,
            variance:(v.runnerCounter?.variance)||0
          }
        },
        runner_checkpoints:wizardRunnerInputs.map(ri=>({
          runner_id:ri.runner_id,
          runner_name:ri.runner_name,
          tokens_amount:ri.tokens,
          sales_amount:ri.sales,
          upi_amount:ri.upi,
          cross_payment_credit:ri.crossPaymentCredit,
          unsold_tokens:ri.unsoldTokens,
          cash_calculated:ri.cashCalculated,
          cash_collected:ri.cashCollected,
          cash_variance:ri.cashCollected-ri.cashCalculated,
          excess_mapped_to:ri.excessMappedTo||'',
          excess_mapped_amount:ri.excessMappedAmount||0,
          status:ri.absent?'absent':'present'
        })),
        reconciliation:rc
      };

      try{
        const res=await fetch('/api/settlement?action=cashier-shift-settle',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úÖ Shift Settled!';
          btn.style.background='var(--green)';
          setTimeout(()=>{
            closeWizard();
            loadCashAtCounter();
            loadShiftReconciliation();
            loadShiftHistory();
            loadShiftHistoryV2();
          },1500);
        }else{
          throw new Error(data.error);
        }
      }catch(e){
        btn.disabled=false;
        btn.textContent='Error: '+e.message;
        btn.style.background='var(--red)';
        setTimeout(()=>{btn.textContent='‚úÖ Confirm & End Shift';btn.style.background='';btn.disabled=false;},3000);
      }
    }

    // ========== SHIFT HISTORY V2 ==========
    async function loadShiftHistoryV2(){
      try{
        const res=await fetch('/api/settlement?action=shift-history-v2&limit=10');
        const data=await res.json();
        if(!data.success||!data.shifts||data.shifts.length===0) return;
        const panel=$('shiftHistoryPanel');
        if(!panel.classList.contains('show')) panel.classList.add('show');

        let v2Html='';
        for(let si=0;si<data.shifts.length;si++){
          const s=data.shifts[si];
          const pStart=new Date(s.period_start);
          const pEnd=new Date(s.settled_at);
          const isBalanced=Math.abs(s.variance_unresolved||0)<=1;
          const statusBadge=isBalanced
            ?'<span class="sh-card-badge balanced">‚úÖ Balanced</span>'
            :'<span class="sh-card-badge variance">‚ö†Ô∏è ‚Çπ'+Math.abs(s.variance_unresolved).toFixed(0)+'</span>';

          v2Html+='<div class="sh-card" id="shiftV2Card'+si+'" style="border:1px solid '+(isBalanced?'var(--green)':'var(--yellow)')+';border-radius:12px" onclick="toggleShiftReport('+si+',\''+s.period_start+'\',\''+s.period_end+'\')">';
          v2Html+='<div class="sh-card-header"><div><div class="sh-card-title">üèÅ Shift ‚Äî '+s.cashier_name+'</div><div class="sh-card-time">'+fmtD(pStart)+' ‚Üí '+fmtD(pEnd)+'</div></div><div style="text-align:right">'+statusBadge+'<div style="font-size:18px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--green);margin-top:4px">'+fmt(s.total_cash_physical)+'</div></div></div>';
          v2Html+='<div class="sh-card-meta"><span>Counter: '+fmt(s.counter_cash_entered)+'</span>';
          if(s.runner_count>0) v2Html+='<span>Runners: '+s.runner_count+'</span>';
          v2Html+='</div>';

          // Show checkpoints
          if(s.checkpoints&&s.checkpoints.length>0){
            v2Html+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">';
            for(const cp of s.checkpoints){
              const cpIcon=cp.status==='absent'?'‚è≥':'‚úÖ';
              const cpColor=cp.status==='absent'?'var(--orange)':'var(--text2)';
              v2Html+='<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px"><span style="color:'+cpColor+'">'+cpIcon+' '+cp.runner_name+(cp.status==='absent'?' (absent)':'')+'</span><span style="font-family:JetBrains Mono,monospace">'+fmt(cp.cash_collected)+(cp.cash_variance!==0?' <span style="color:'+(cp.cash_variance>0?'var(--yellow)':'var(--red)')+'">('+((cp.cash_variance>0?'+':'')+cp.cash_variance)+')</span>':'')+'</span></div>';
            }
            v2Html+='</div>';
          }

          // Show resolutions if any
          const resolutions=JSON.parse(s.discrepancy_resolutions||'[]');
          if(resolutions.length>0){
            v2Html+='<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">';
            for(const r of resolutions){
              const icon=r.source==='unexplained'?'‚ö†Ô∏è':'‚úÖ';
              v2Html+='<div style="font-size:11px;color:var(--text2);padding:2px 0">'+icon+' '+r.explanation+'</div>';
            }
            v2Html+='</div>';
          }

          // Detailed report area (expandable ‚Äî loaded on click for owners)
          v2Html+='<div class="shift-report" id="shiftReport'+si+'">'+
            '<div class="print-report-header" id="shiftReportHeader'+si+'">'+
              '<h2>Nawabi Chai House ‚Äî Shift Settlement Report</h2>'+
              '<p><strong>'+s.cashier_name+'</strong> | '+fmtDate(pStart)+' ‚Üí '+fmtDate(pEnd)+'</p>'+
            '</div>'+
            '<div id="shiftReportContent'+si+'"><div class="loading-text">Loading detailed report...</div></div>'+
          '</div>';

          v2Html+='</div>';
        }

        // Prepend v2 cards before existing history content
        const existingH3=panel.querySelector('h3');
        if(existingH3){
          const marker=document.createElement('div');
          marker.id='v2ShiftCards';
          marker.innerHTML=v2Html;
          const existingMarker=document.getElementById('v2ShiftCards');
          if(existingMarker) existingMarker.remove();
          const subtitle=panel.querySelector('.subtitle');
          if(subtitle) subtitle.after(marker);
          else existingH3.after(marker);
        }
      }catch(e){console.error('Shift history v2 error:',e);}
    }

    // ========== SHIFT REPORT DETAIL (Owner only) ==========
    async function toggleShiftReport(idx,periodStart,periodEnd){
      const report=document.getElementById('shiftReport'+idx);
      if(!report)return;
      // Toggle visibility
      if(report.classList.contains('show')){report.classList.remove('show');return;}
      // Close all others
      document.querySelectorAll('.shift-report.show').forEach(r=>r.classList.remove('show'));
      report.classList.add('show');
      // If already loaded, just show
      const content=document.getElementById('shiftReportContent'+idx);
      if(content.dataset.loaded==='true')return;
      content.innerHTML='<div class="loading-text">Loading from Odoo & Razorpay...</div>';
      try{
        const fromISO=toLocalISO(new Date(periodStart));
        const toISO=toLocalISO(new Date(periodEnd));
        const res=await fetch('/api/nch-data?from='+fromISO+'&to='+toISO);
        const data=await res.json();
        if(!data.success){content.innerHTML='<div class="loading-text" style="color:var(--red)">Error loading data</div>';return;}
        const sr=data.data.shiftReconciliation;
        const mc=data.data.mainCounter;
        const rc=data.data.runnerCounter;
        const runners=data.data.runners||[];
        const vf=data.data.verification;
        const disc=data.data.discrepancies||[];
        const crossPay=sr?.crossPayments||[];
        const misattr=data.data.misattributedOrders||[];

        let html='';

        // === 1. SALES OVERVIEW ===
        html+='<div class="shift-report-section"><h4>üìä Sales Overview</h4>';
        const totalSales=sr?sr.totalSales:((mc?.cash||0)+(mc?.upi||0)+(mc?.card||0)+(mc?.tokenIssue||0)+(mc?.complimentary||0));
        html+='<div class="sr-row total"><span class="sr-label">Total Sales</span><span class="sr-val">'+fmt(totalSales)+'</span></div>';
        html+='</div>';

        // === 2. PAYMENT BREAKDOWN ===
        html+='<div class="shift-report-section"><h4>üí≥ Payment Method Breakdown</h4>';
        html+='<div class="sr-row"><span class="sr-label">Cash (PM 37)</span><span class="sr-val">'+fmt(mc?.cash||0)+'</span></div>';
        html+='<div class="sr-row"><span class="sr-label">UPI Counter (PM 38)</span><span class="sr-val" style="color:var(--blue)">'+fmt(mc?.upi||0)+'</span></div>';
        html+='<div class="sr-row"><span class="sr-label">Card (PM 39)</span><span class="sr-val" style="color:var(--blue)">'+fmt(mc?.card||0)+'</span></div>';
        html+='<div class="sr-row"><span class="sr-label">Token Issue ‚Üí Runners (PM 48)</span><span class="sr-val">'+fmt(mc?.tokenIssue||0)+'</span></div>';
        html+='<div class="sr-row"><span class="sr-label">Complimentary (PM 49)</span><span class="sr-val" style="color:var(--text2)">'+fmt(mc?.complimentary||0)+'</span></div>';
        if(rc&&rc.upi>0)html+='<div class="sr-row"><span class="sr-label">Runner Counter UPI (direct)</span><span class="sr-val" style="color:var(--blue)">'+fmt(rc.upi)+'</span></div>';
        html+='</div>';

        // === 3. UPI VERIFICATION ===
        if(vf){
          html+='<div class="shift-report-section"><h4>üîç UPI Cross-Verification (Odoo ‚Üî Razorpay)</h4>';
          const ccOk=vf.cashCounter?.status==='ok';
          const rcOk=vf.runnerCounter?.status==='ok';
          html+='<div class="sr-row"><span class="sr-label">Counter QR ‚Äî Odoo</span><span class="sr-val">'+fmt(vf.cashCounter?.odooUPI||0)+'</span></div>';
          html+='<div class="sr-row"><span class="sr-label">Counter QR ‚Äî Razorpay</span><span class="sr-val">'+fmt(vf.cashCounter?.razorpayUPI||0)+'</span></div>';
          html+='<div class="sr-row"><span class="sr-label">Counter QR Variance</span><span class="sr-val" style="color:'+(ccOk?'var(--green)':'var(--red)')+'">'+fmt(Math.abs(vf.cashCounter?.variance||0))+' '+(ccOk?'‚úì':'‚ö†')+'</span></div>';
          html+='<div style="height:8px"></div>';
          html+='<div class="sr-row"><span class="sr-label">Runner Counter QR ‚Äî Odoo</span><span class="sr-val">'+fmt(vf.runnerCounter?.odooUPI||0)+'</span></div>';
          html+='<div class="sr-row"><span class="sr-label">Runner Counter QR ‚Äî Razorpay</span><span class="sr-val">'+fmt(vf.runnerCounter?.razorpayUPI||0)+'</span></div>';
          html+='<div class="sr-row"><span class="sr-label">Runner Counter QR Variance</span><span class="sr-val" style="color:'+(rcOk?'var(--green)':'var(--red)')+'">'+fmt(Math.abs(vf.runnerCounter?.variance||0))+' '+(rcOk?'‚úì':'‚ö†')+'</span></div>';
          html+='</div>';
        }

        // === 4. RUNNER BREAKDOWN ===
        if(runners.length>0){
          html+='<div class="shift-report-section"><h4>üèÉ Runner Activity</h4>';
          for(const r of runners){
            if(r.tokens===0&&r.sales===0&&r.upi===0)continue;
            const cashExp=Math.max(0,(r.tokens+r.sales)-r.upi-(r.crossPaymentCredit||0));
            html+='<div style="background:var(--bg2);border-radius:10px;padding:12px;margin-bottom:8px">';
            html+='<div style="font-weight:600;margin-bottom:6px">'+r.name+'</div>';
            html+='<div class="sr-row"><span class="sr-label">Tokens Issued</span><span class="sr-val">'+fmt(r.tokens)+'</span></div>';
            html+='<div class="sr-row"><span class="sr-label">Sales (Snacks)</span><span class="sr-val">'+fmt(r.sales)+'</span></div>';
            html+='<div class="sr-row"><span class="sr-label">UPI Collected (QR)</span><span class="sr-val" style="color:var(--blue)">'+fmt(r.upi)+'</span></div>';
            if(r.crossPaymentCredit>0)html+='<div class="sr-row"><span class="sr-label">Cross-Payment Credit</span><span class="sr-val" style="color:var(--blue)">-'+fmt(r.crossPaymentCredit)+'</span></div>';
            html+='<div class="sr-row total"><span class="sr-label">Cash to Collect</span><span class="sr-val" style="color:'+(cashExp>=0?'var(--green)':'var(--red)')+'">'+fmt(cashExp)+'</span></div>';
            html+='</div>';
          }
          html+='</div>';
        }

        // === 5. CASH RECONCILIATION ===
        if(sr){
          html+='<div class="shift-report-section"><h4>üíµ Cash Reconciliation</h4>';
          const bc=sr.balanceCheck;
          html+='<div class="sr-row"><span class="sr-label">Counter Drawer Cash</span><span class="sr-val">'+fmt(sr.cashBreakdown?.counterDrawer||0)+'</span></div>';
          for(const ro of (sr.cashBreakdown?.runnerCashObligations||[])){
            if(ro.tokens>0||ro.sales>0)html+='<div class="sr-row"><span class="sr-label">'+ro.name+' Cash Owed</span><span class="sr-val">'+fmt(ro.cashToCollect)+'</span></div>';
          }
          html+='<div class="sr-row total"><span class="sr-label">Total Expected Cash</span><span class="sr-val">'+fmt(bc?.expectedCash||0)+'</span></div>';
          html+='<div style="height:4px"></div>';
          html+='<div class="sr-row"><span class="sr-label">Total UPI (Razorpay verified)</span><span class="sr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI?.total||0)+'</span></div>';
          if(sr.card>0)html+='<div class="sr-row"><span class="sr-label">Card</span><span class="sr-val">'+fmt(sr.card)+'</span></div>';
          if(sr.complimentary>0)html+='<div class="sr-row"><span class="sr-label">Complimentary</span><span class="sr-val">'+fmt(sr.complimentary)+'</span></div>';
          const balanceStatus=bc?.isBalanced?'‚úÖ BALANCED':'‚ö†Ô∏è ‚Çπ'+Math.abs(bc?.variance||0)+' '+(bc?.variance>0?'UNACCOUNTED':'EXTRA');
          const balColor=bc?.isBalanced?'var(--green)':'var(--red)';
          html+='<div class="sr-row total"><span class="sr-label">Shift Balance</span><span class="sr-val" style="color:'+balColor+'">'+balanceStatus+'</span></div>';
          html+='</div>';
        }

        // === 6. CROSS-PAYMENTS ===
        if(crossPay.length>0){
          html+='<div class="shift-report-section"><h4>üîÑ Cross-Payments</h4>';
          for(const cp of crossPay){
            const color=cp.isProbable?'var(--blue)':'var(--green)';
            const icon=cp.isProbable?'‚ÑπÔ∏è':'‚úì';
            html+='<div class="sr-row"><span class="sr-label" style="color:'+color+'">'+icon+' '+(cp.orderName||'Cross-QR')+' ‚Üí '+cp.runner+'</span><span class="sr-val" style="color:'+color+'">'+fmt(cp.amount)+'</span></div>';
          }
          html+='</div>';
        }

        // === 7. DISCREPANCIES ===
        if(disc.length>0){
          html+='<div class="shift-report-section"><h4>‚ö†Ô∏è Discrepancies</h4>';
          for(const d of disc){
            html+='<div class="sr-row"><span class="sr-label">'+(d.severity==='critical'?'üö®':'‚ö†Ô∏è')+' '+d.message+'</span><span class="sr-val" style="color:var(--red)">'+fmt(d.amount||0)+'</span></div>';
          }
          html+='</div>';
        }

        // === 8. MISATTRIBUTED ORDERS ===
        if(misattr.length>0){
          html+='<div class="shift-report-section"><h4>üîß Misattributed Orders</h4>';
          for(const m of misattr){
            html+='<div class="sr-row"><span class="sr-label">'+(m.auto_resolved?'‚úì':'üö®')+' '+m.order_name+' ‚Äî '+fmt(m.amount)+'</span><span class="sr-val" style="color:var(--orange)">'+(m.auto_resolved?m.correct_runner_name:'No runner')+'</span></div>';
          }
          html+='</div>';
        }

        // === VARIANCE SOURCES ===
        if(sr&&sr.varianceSources&&sr.varianceSources.length>0){
          html+='<div class="shift-report-section"><h4>üìä Variance Sources</h4>';
          for(const vs of sr.varianceSources){
            html+='<div class="sr-row"><span class="sr-label">'+(vs.fixable?'üîß':'üìä')+' '+vs.label+' ('+vs.count+')</span><span class="sr-val" style="color:var(--red)">'+fmt(Math.abs(vs.amount))+'</span></div>';
          }
          html+='</div>';
        }

        // Download button
        html+='<div style="text-align:center;margin-top:16px" class="no-print">'+
          '<button onclick="event.stopPropagation();downloadShiftReport('+idx+')" style="background:var(--purple);color:#fff;border:none;padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer">üì• Download Report</button>'+
        '</div>';

        content.innerHTML=html;
        content.dataset.loaded='true';
      }catch(e){
        content.innerHTML='<div class="loading-text" style="color:var(--red)">Failed: '+e.message+'</div>';
      }
    }

    function downloadShiftReport(idx){
      // Mark this card for printing
      document.querySelectorAll('.sh-card').forEach(c=>c.classList.remove('printing'));
      const card=document.getElementById('shiftV2Card'+idx);
      if(card)card.classList.add('printing');
      window.print();
      // Cleanup after print
      setTimeout(()=>{if(card)card.classList.remove('printing');},1000);
    }

    // ========== STAFF SIMPLIFIED UI ==========
    // === STAFF: Cached shift data fetch ===
    async function getStaffShiftData(){
      const baseline=new Date(2026,1,4,17,0,0);
      const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id=counter');
      const lastData=await lastRes.json();
      const shiftFrom=lastData.periodStart?new Date(lastData.periodStart):baseline;
      const fromKey=toLocalISO(shiftFrom);
      const now=Date.now();
      if(staffShiftDataCache.data&&staffShiftDataCache.from===fromKey&&(now-staffShiftDataCache.timestamp)<30000){
        return {data:staffShiftDataCache.data,shiftFrom};
      }
      const res=await fetch('/api/nch-data?from='+fromKey);
      const nchData=await res.json();
      if(!nchData.success)throw new Error(nchData.error||'Failed to load shift data');
      staffShiftDataCache={data:nchData.data,from:fromKey,timestamp:now};
      return {data:nchData.data,shiftFrom};
    }

    function invalidateStaffCache(){staffShiftDataCache={data:null,from:null,timestamp:0};}

    // Staff dashboard: End My Shift + Record Expense + runner cards + discrepancies + payment trail + shift history

    function renderStaffDashboard(){
      $('runnerGrid').parentElement.querySelector('.section-title').textContent='Settlement';
      // Grid: [End My Shift] [Record Expense] + 5 runner cards
      let html='<div class="runner-card shift-card" onclick="startStaffShiftWizard()"><div class="name">üèÅ End My Shift</div><div class="code">Settle All</div></div>';
      html+='<div class="runner-card expense" onclick="staffOpenExpensePanel(this)"><div class="name">üìù Record Expense</div><div class="code">Cash Out</div></div>';
      const runnerOnly=RUNNERS.filter(r=>typeof r.id==='number');
      html+=runnerOnly.map(r=>'<div class="runner-card" onclick="staffSelectRunner('+r.id+',this)"><div class="name">'+r.name+'</div><div class="code">'+r.barcode+'</div></div>').join('');
      $('runnerGrid').innerHTML=html;
      // Hide owner-only panels (staff must never see counter cash balance)
      $('collectionPanel').classList.remove('show');
      $('counterBalanceReadonly').classList.remove('show');
      $('shiftReconPanel').classList.remove('show');
      // Load staff-specific panels
      loadStaffDiscrepancies();
      loadStaffPaymentTrail();
      loadStaffShiftHistory();
    }

    // === STAFF: Discrepancy Panel ===
    async function loadStaffDiscrepancies(){
      try{
        const {data,shiftFrom}=await getStaffShiftData();
        const misattributed=data.misattributedOrders||[];
        const discrepancies=data.discrepancies||[];
        staffMisattributed=misattributed;
        const panel=$('discrepancyPanel');
        if(misattributed.length===0){panel.classList.remove('show');return;}
        panel.classList.add('show');
        let html='<h3>‚ö†Ô∏è Discrepancies <span class="badge-count">'+misattributed.length+'</span></h3>';
        html+='<div class="subtitle">Fix discrepancies before ending your shift.</div>';
        const pmNames={37:'Cash',38:'UPI',39:'Card',40:'Runner Ledger',48:'Token Issue',49:'Complimentary'};
        for(let i=0;i<misattributed.length;i++){
          const m=misattributed[i];
          const orderTime=m.date_order?new Date(m.date_order+'Z').toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Kolkata'}):'';
          const posLabel=m.config_id===27?'Cash Counter':'Runner Counter';
          const isAuto=m.auto_resolved;
          const isCritical=!isAuto;
          const pmLabel=(m.payment_methods||[]).map(id=>pmNames[id]||'PM'+id).join(', ');
          html+='<div class="rectify-card'+(isCritical?' critical':'')+'" id="staffRectCard'+i+'">';
          html+='<div class="rc-header"><span class="rc-order">'+(isCritical?'üö®':'‚ö†Ô∏è')+' '+m.order_name+' ‚Ä¢ '+posLabel+' ‚Ä¢ '+orderTime+'</span><span class="rc-amount">'+fmt(m.amount)+'</span></div>';
          html+='<div class="rc-detail">Payment: '+pmLabel+'<br>';
          if(isAuto){
            html+='Selected: "'+m.current_partner_name+'" (wrong contact)<br>';
            html+='Auto-detected: <strong>'+m.correct_runner_name+'</strong>';
          }else{
            html+='<span style="color:var(--red)">No runner was selected</span><br>Who received this order?';
          }
          html+='</div>';
          html+='<div class="rc-actions">';
          html+='<select id="staffRectSelect'+i+'">';
          if(!isAuto)html+='<option value="">‚Äî Select Runner ‚Äî</option>';
          for(const ro of RUNNER_OPTIONS){
            const sel=(isAuto&&m.correct_partner_id===ro.id)?' selected':'';
            html+='<option value="'+ro.id+'"'+sel+'>'+ro.name+'</option>';
          }
          html+='</select>';
          html+='<button class="rectify-btn" id="staffRectBtn'+i+'" onclick="staffRectifyOrder('+i+')">‚úì Fix in Odoo</button>';
          html+='</div></div>';
        }
        panel.innerHTML=html;
      }catch(e){console.error('Staff discrepancies error:',e);}
    }

    async function staffRectifyOrder(idx){
      const m=staffMisattributed[idx];
      const selectEl=document.getElementById('staffRectSelect'+idx);
      const btn=document.getElementById('staffRectBtn'+idx);
      const card=document.getElementById('staffRectCard'+idx);
      if(!selectEl||!btn)return;
      const correctId=parseInt(selectEl.value);
      if(!correctId){btn.textContent='Select runner';setTimeout(()=>{btn.textContent='‚úì Fix in Odoo';},1500);return;}
      btn.disabled=true;btn.textContent='Fixing...';
      try{
        const res=await fetch('/api/settlement?action=rectify-discrepancy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin:currentPin,order_id:m.order_id,order_name:m.order_name,correct_partner_id:correctId,original_partner_id:m.current_partner_id})});
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Fixed!';btn.style.background='var(--green)';
          if(card)card.classList.add('fixed');
          invalidateStaffCache();
          setTimeout(()=>{loadStaffDiscrepancies();loadStaffPaymentTrail();},1000);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';setTimeout(()=>{btn.textContent='‚úì Fix in Odoo';btn.style.background='';},3000);}
    }

    // === STAFF: Payment Trail ===
    async function loadStaffPaymentTrail(){
      const panel=$('paymentTrailPanel');
      try{
        const {data,shiftFrom}=await getStaffShiftData();
        const mc=data.mainCounter||{};
        const rc=data.runnerCounter||{};
        const runners=data.runners||[];
        // Fetch expenses for current shift period
        const cbRes=await fetch('/api/settlement?action=counter-balance');
        const cbData=await cbRes.json();
        const allExpenses=(cbData.success&&cbData.balance)?cbData.balance.expenses||[]:[];
        // Filter expenses to current shift period
        const shiftExpenses=allExpenses.filter(e=>{
          const et=new Date(e.recorded_at);
          return et>=shiftFrom;
        });
        const totalExpenses=shiftExpenses.reduce((s,e)=>s+(e.amount||0),0);
        // Calculate order count
        const totalOrders=(mc.orderCount||0)+(rc.orderCount||0);
        // Payment methods
        const methods=[];
        if((mc.cash||0)>0)methods.push({icon:'üíµ',label:'Cash',amount:mc.cash});
        if((mc.upi||0)>0)methods.push({icon:'üì±',label:'UPI Counter',amount:mc.upi});
        if((mc.card||0)>0)methods.push({icon:'üí≥',label:'Card',amount:mc.card});
        if((mc.tokenIssue||0)>0)methods.push({icon:'üé´',label:'Token Issue',amount:mc.tokenIssue});
        if((rc.runnerLedger||0)>0)methods.push({icon:'üìí',label:'Runner Ledger',amount:rc.runnerLedger});
        // Runner UPI (sum of individual runners)
        const runnerUpiTotal=runners.reduce((s,r)=>s+(r.upi||0),0);
        if(runnerUpiTotal>0)methods.push({icon:'üì±',label:'Runner UPI',amount:runnerUpiTotal});
        if((rc.upi||0)>0)methods.push({icon:'üì±',label:'Runner Counter UPI',amount:rc.upi});
        if((mc.complimentary||0)>0)methods.push({icon:'üéÅ',label:'Complimentary',amount:mc.complimentary});
        const grandTotal=methods.reduce((s,m)=>s+m.amount,0);
        if(methods.length===0&&totalExpenses===0){panel.classList.remove('show');return;}
        panel.classList.add('show');
        let html='<h3>üí≥ Payment Trail</h3>';
        html+='<div class="subtitle">'+totalOrders+' orders since '+fmtD(shiftFrom)+'</div>';
        // Method cards grid
        html+='<div class="pt-method-grid">';
        for(const m of methods){
          html+='<div class="pt-method-card"><div class="pt-icon">'+m.icon+'</div><div class="pt-label">'+m.label+'</div><div class="pt-amount">'+fmt(m.amount)+'</div></div>';
        }
        html+='</div>';
        // Expenses section
        if(shiftExpenses.length>0){
          html+='<div class="pt-expense-section"><div class="pt-exp-title">üì§ Expenses (-'+fmt(totalExpenses)+')</div>';
          for(const e of shiftExpenses){
            html+='<div class="pt-expense-item"><span>'+e.reason+'</span><span class="pt-exp-amt">-'+fmt(e.amount)+'</span></div>';
          }
          html+='</div>';
        }
        // Grand total
        html+='<div class="pt-grand-total"><span class="pt-gt-label">Total Sales</span><span class="pt-gt-val">'+fmt(grandTotal)+'</span></div>';
        // Runner breakdown (collapsible)
        if(runners.length>0){
          html+='<div class="pt-runner-breakdown">';
          html+='<button class="pt-rb-toggle" onclick="toggleStaffRunnerBreakdown()"><span>‚ñº Runner Breakdown</span><span id="ptRbArrow">‚ñº</span></button>';
          html+='<div class="pt-rb-content" id="ptRunnerBreakdown">';
          for(const r of runners){
            if((r.tokens||0)===0&&(r.sales||0)===0&&(r.upi||0)===0)continue;
            html+='<div class="pt-rb-runner"><div class="pt-rb-runner-name">'+r.name+'</div>';
            if(r.tokens>0)html+='<div class="pt-rb-row"><span>Tokens</span><span class="pt-rb-val">'+fmt(r.tokens)+'</span></div>';
            if(r.sales>0)html+='<div class="pt-rb-row"><span>Sales</span><span class="pt-rb-val">'+fmt(r.sales)+'</span></div>';
            if(r.upi>0)html+='<div class="pt-rb-row"><span>UPI</span><span class="pt-rb-val" style="color:var(--blue)">'+fmt(r.upi)+'</span></div>';
            html+='<div class="pt-rb-row" style="border-top:1px solid var(--border);margin-top:4px;padding-top:4px;font-weight:600"><span>Cash To Collect</span><span class="pt-rb-val">'+fmt(r.cashToCollect||0)+'</span></div>';
            html+='</div>';
          }
          html+='</div></div>';
        }
        panel.innerHTML=html;
      }catch(e){
        console.error('Payment trail error:',e);
        panel.classList.remove('show');
      }
    }

    function toggleStaffRunnerBreakdown(){
      const content=document.getElementById('ptRunnerBreakdown');
      const arrow=document.getElementById('ptRbArrow');
      if(!content)return;
      const isShown=content.classList.toggle('show');
      if(arrow)arrow.textContent=isShown?'‚ñ≤':'‚ñº';
    }

    // === STAFF: Expense Recording ===
    function staffOpenExpensePanel(el){
      document.querySelectorAll('.runner-card').forEach(c=>c.classList.remove('selected'));
      if(el)el.classList.add('selected');
      $('panel').classList.add('show');
      $('runnerName').textContent='üìù Record Expense';
      $('period').textContent='';
      $('panelContent').innerHTML=
        '<div style="margin-bottom:16px;color:var(--text2);font-size:14px">Record cash given out from the counter for supplies, milk, etc.</div>'+
        '<div class="field-group"><label>Amount (‚Çπ)</label><input type="number" id="staffExpAmount" class="expense-input" placeholder="e.g. 200" min="1" step="10" inputmode="numeric"></div>'+
        '<div class="field-group" style="margin-top:12px"><label>Reason</label><input type="text" id="staffExpReason" class="expense-reason" placeholder="e.g. Milk, Sugar, Supplies"></div>'+
        '<button class="settle-btn" style="background:var(--red)" id="staffExpBtn" onclick="staffRecordExpense()">Record Expense</button>';
    }

    async function staffRecordExpense(){
      const amount=parseFloat(document.getElementById('staffExpAmount')?.value||'0');
      const reason=(document.getElementById('staffExpReason')?.value||'').trim();
      const btn=document.getElementById('staffExpBtn');
      if(!btn)return;
      if(amount<=0){btn.textContent='Enter amount';setTimeout(()=>{btn.textContent='Record Expense';},1500);return;}
      if(!reason){btn.textContent='Enter reason';setTimeout(()=>{btn.textContent='Record Expense';},1500);return;}
      btn.disabled=true;btn.textContent='Recording...';
      try{
        const res=await fetch('/api/settlement?action=record-expense',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({recorded_by:currentUser,amount,reason})});
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Expense Recorded!';btn.style.background='var(--green)';
          invalidateStaffCache();
          setTimeout(()=>{staffOpenExpensePanel(document.querySelector('.runner-card.selected'));loadStaffPaymentTrail();},1500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // === STAFF: Individual Runner Settlement (blind entry) ===
    async function staffSelectRunner(id,el){
      document.querySelectorAll('.runner-card').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      selectedRunner=RUNNERS.find(r=>r.id===id);
      $('panel').classList.add('show');
      $('runnerName').textContent=selectedRunner.name;
      $('period').textContent='Loading...';
      $('panelContent').innerHTML='<div class="loading-text">Loading runner data...</div>';
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id='+id);
        const lastData=await lastRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.periodStart?new Date(lastData.periodStart):baseline;
        currentPeriodStart=fromDate;
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        const runner=data.data.runners.find(r=>r.id===id);
        currentRunnerData=runner;
        const hasLast=lastData.lastSettlement;
        // Carry-forward: unsold tokens from previous settlement
        const prevUnsoldTokens=(hasLast&&hasLast.unsold_tokens)?parseFloat(hasLast.unsold_tokens):0;
        const runnerTokens=runner?runner.tokens:0;
        const runnerSales=runner?runner.sales:0;
        const runnerUpi=runner?runner.upi:0;
        const totalTokens=runnerTokens+prevUnsoldTokens;
        const hasActivity=(totalTokens>0||runnerSales>0||runnerUpi>0);
        if(hasActivity){
          // Blind entry: show tokens/sales/UPI as facts + unsold tokens input
          let html='';
          if(prevUnsoldTokens>0){
            html+='<div class="info-box" style="background:rgba(234,179,8,0.08);border-color:var(--yellow);color:var(--yellow);margin-bottom:12px">üé´ Remaining tokens from previous settlement: <strong>'+fmt(prevUnsoldTokens)+'</strong></div>';
          }
          html+='<div class="row"><span class="label">Tokens Issued (Chai)</span><span class="value">'+fmt(totalTokens)+'</span></div>';
          if(prevUnsoldTokens>0){
            html+='<div style="font-size:11px;color:var(--text2);padding:0 0 4px 12px">'+fmt(prevUnsoldTokens)+' carried + '+fmt(runnerTokens)+' new</div>';
          }
          html+='<div class="row"><span class="label">Sales Made (Snacks)</span><span class="value">'+fmt(runnerSales)+'</span></div>';
          html+='<div class="row"><span class="label">UPI Collected (QR)</span><span class="value" style="color:var(--blue)">'+fmt(runnerUpi)+'</span></div>';
          // Unsold tokens input (‚Çπ amount)
          if(totalTokens>0){
            html+='<div class="unsold-input-box">'+
              '<label>Unsold Tokens with Runner (‚Çπ amount)</label>'+
              '<input type="number" id="staffUnsoldTokens" min="0" max="'+totalTokens+'" value="0" step="10" inputmode="numeric">'+
              '<div class="hint">Enter the ‚Çπ value of tokens runner still has. Max: '+fmt(totalTokens)+'</div>'+
            '</div>';
          }
          // Cash collected input ‚Äî NO expected amount shown
          html+='<div style="margin-top:16px"><div class="wizard-input-group">'+
            '<label style="font-size:14px;font-weight:600;color:var(--text)">Cash Collected from '+selectedRunner.name+'</label>'+
            '<input type="number" id="staffRunnerCash" placeholder="Enter cash amount" min="0" step="10" inputmode="numeric" style="font-size:22px;text-align:center;padding:14px">'+
          '</div></div>';
          // Status box
          let statusBox='';
          if(hasLast){const who=hasLast.settled_by===currentUser?'You':hasLast.settled_by;statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+'</div>';}
          html+=statusBox;
          html+='<button class="settle-btn" id="staffSettleRunnerBtn" onclick="staffSettleRunner()">‚úì Settle Runner</button>';
          // Store totalTokens for calculation
          currentRunnerData._totalTokens=totalTokens;
          currentRunnerData._prevUnsoldTokens=prevUnsoldTokens;
          $('panelContent').innerHTML=html;
        }else{
          if(hasLast){const who=hasLast.settled_by===currentUser?'you':hasLast.settled_by;$('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';}
          else{$('panelContent').innerHTML='<div class="loading-text">No activity for this runner</div>';}
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }

    async function staffSettleRunner(){
      if(!selectedRunner||!currentRunnerData)return;
      const btn=document.getElementById('staffSettleRunnerBtn');
      const unsoldInput=document.getElementById('staffUnsoldTokens');
      const cashInput=document.getElementById('staffRunnerCash');
      const unsoldTokens=unsoldInput?parseFloat(unsoldInput.value)||0:0;
      const cashCollected=cashInput?parseFloat(cashInput.value)||0:0;
      const totalTokens=currentRunnerData._totalTokens||currentRunnerData.tokens;
      // Validate unsold tokens
      if(unsoldTokens>totalTokens){if(btn){btn.textContent='Unsold tokens value too high';setTimeout(()=>{btn.textContent='‚úì Settle Runner';},1500);}return;}
      if(!cashInput||cashInput.value===''){if(btn){btn.textContent='Enter cash amount';setTimeout(()=>{btn.textContent='‚úì Settle Runner';},1500);}return;}
      // Expected cash = (totalTokens - unsoldTokens + sales) - upi - crossPaymentCredit
      const expectedCash=Math.max(0,(totalTokens-unsoldTokens+currentRunnerData.sales)-currentRunnerData.upi-(currentRunnerData.crossPaymentCredit||0));
      const variance=cashCollected-expectedCash;
      // If short, warn staff
      if(variance<-5){
        const shortAmt=Math.abs(variance);
        if(!confirm('‚ö†Ô∏è Cash is ‚Çπ'+shortAmt.toLocaleString('en-IN')+' short from '+selectedRunner.name+'.\n\nVerify with the runner and recount.\n\nSubmit anyway?'))return;
      }
      // Proceed with settlement (same API as owner)
      btn.disabled=true;btn.classList.add('loading');btn.textContent='Recording settlement...';
      try{
        const now=new Date();
        const notesParts=['Staff blind entry'];
        if(unsoldTokens>0)notesParts.push('Unsold tokens: '+fmt(unsoldTokens));
        if(currentRunnerData._prevUnsoldTokens>0)notesParts.push('Carried from prev: '+fmt(currentRunnerData._prevUnsoldTokens));
        if(currentRunnerData.crossPaymentCredit>0)notesParts.push('Cross-payment credit: '+fmt(currentRunnerData.crossPaymentCredit));
        if(variance>0)notesParts.push('Extra cash: +'+fmt(variance));
        if(variance<0)notesParts.push('Short: '+fmt(Math.abs(variance)));
        const res=await fetch('/api/settlement?action=settle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({runner_id:selectedRunner.id,runner_name:selectedRunner.name,settled_by:currentUser,period_start:toLocalISO(currentPeriodStart),period_end:toLocalISO(now),tokens_amount:totalTokens,sales_amount:currentRunnerData.sales,upi_amount:currentRunnerData.upi,cash_settled:cashCollected,unsold_tokens:unsoldTokens,notes:notesParts.join('; ')})});
        const data=await res.json();
        if(data.success){
          if(variance>=0){
            btn.textContent='‚úÖ Settlement Recorded!';btn.style.background='var(--green)';
          }else{
            btn.textContent='‚ö†Ô∏è Recorded (‚Çπ'+Math.abs(variance)+' short)';btn.style.background='var(--yellow)';btn.style.color='#000';
          }
          // Show unsold tokens carry-forward info
          if(unsoldTokens>0){
            const infoDiv=document.createElement('div');
            infoDiv.className='info-box';
            infoDiv.style.cssText='background:rgba(234,179,8,0.08);border-color:var(--yellow);color:var(--yellow);margin-top:12px';
            infoDiv.innerHTML='üé´ '+selectedRunner.name+' has <strong>'+fmt(unsoldTokens)+'</strong> in unsold tokens (will carry to next settlement)';
            btn.parentNode.insertBefore(infoDiv,btn.nextSibling);
          }
          invalidateStaffCache();
          setTimeout(()=>{
            const card=document.querySelector('.runner-card.selected');
            if(card)staffSelectRunner(selectedRunner.id,card);
            loadStaffPaymentTrail();
          },2500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.classList.remove('loading');btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // === STAFF: Shift Wizard (blind entry ‚Äî 3 steps) ===
    let staffWizardData=null,staffWizardStep=1,staffDrawerCash=0,staffRunnerInputs=[];

    async function startStaffShiftWizard(){
      $('wizardContent').innerHTML='<div class="loading-text">Loading shift data...</div>';
      $('wizardOverlay').classList.add('show');
      // Reuse wizard header but change label
      document.querySelector('.wizard-header h2').textContent='üèÅ End My Shift';
      staffWizardStep=1;updateStaffWizardSteps();

      try{
        const baseline=new Date(2026,1,4,17,0,0);
        const runnerIds=[64,65,66,67,68];
        // Same parallel fetch as owner wizard
        const [cbRes,lastShiftRes,...periodResults]=await Promise.all([
          fetch('/api/settlement?action=counter-balance').then(r=>r.json()),
          fetch('/api/settlement?action=shift-history-v2&limit=1').then(r=>r.json()),
          fetch('/api/settlement?action=get-last-settlement&runner_id=counter').then(r=>r.json()),
          ...runnerIds.map(id=>fetch('/api/settlement?action=get-last-settlement&runner_id='+id).then(r=>r.json()))
        ]);
        const counterBalance=cbRes.success?{...cbRes.balance,lastCollectionAt:cbRes.lastCollection?.collected_at||null}:{pettyCash:0,counterCash:0,runnerCash:0,totalExpenses:0,expenses:[],settlements:[],total:0,lastCollectionAt:null};
        const lastShift=(lastShiftRes.success&&lastShiftRes.shifts&&lastShiftRes.shifts.length>0)?lastShiftRes.shifts[0]:null;
        const prevVariance=lastShift?(lastShift.variance_unresolved||0):0;
        const counterPeriod=periodResults[0];
        const runnerPeriods={};
        runnerIds.forEach((id,i)=>{runnerPeriods[id]=periodResults[i+1];});
        const shiftFrom=counterPeriod.periodStart?new Date(counterPeriod.periodStart):baseline;
        // Fetch live data
        const res=await fetch('/api/nch-data?from='+toLocalISO(shiftFrom));
        const data=await res.json();
        if(!data.success)throw new Error(data.error||'Failed to load data');
        // Classify runners (same logic as owner wizard + carry-forward unsold tokens)
        const allRunners=[];const extraFetches=[];
        for(const id of runnerIds){
          const rp=runnerPeriods[id];
          const rpFrom=rp.periodStart?new Date(rp.periodStart):baseline;
          const prevUnsold=(rp&&rp.lastSettlement&&rp.lastSettlement.unsold_tokens)?parseFloat(rp.lastSettlement.unsold_tokens):0;
          if(rpFrom>=shiftFrom){
            const runner=data.data.runners.find(x=>x.id===id);
            if(runner&&(runner.tokens>0||runner.sales>0||runner.upi>0))allRunners.push(runner);
            else if(prevUnsold>0){
              // Runner has no new activity but has carry-forward tokens
              allRunners.push({id,name:RUNNERS.find(r=>r.id===id)?.name||'Runner '+id,barcode:'',tokens:0,sales:0,upi:0,cashToCollect:0,crossPaymentCredit:0,crossPayments:[]});
            }
          }else{
            extraFetches.push(fetch('/api/nch-data?from='+toLocalISO(rpFrom)).then(r=>r.json()).then(d=>{
              if(d.success){
                const runner=d.data.runners.find(x=>x.id===id);
                if(runner&&(runner.tokens>0||runner.sales>0||runner.upi>0))allRunners.push(runner);
                else if(prevUnsold>0){
                  allRunners.push({id,name:RUNNERS.find(r=>r.id===id)?.name||'Runner '+id,barcode:'',tokens:0,sales:0,upi:0,cashToCollect:0,crossPaymentCredit:0,crossPayments:[]});
                }
              }
            }).catch(()=>{}));
          }
        }
        if(extraFetches.length>0)await Promise.all(extraFetches);
        const liveCounterCash=data.data.mainCounter?.cash||0;
        const unsettledCounterCash=liveCounterCash;
        const expectedDrawer=counterBalance.pettyCash+counterBalance.counterCash+unsettledCounterCash+counterBalance.runnerCash-counterBalance.totalExpenses;
        // Discrepancy auto-mapping: sum up cash obligations from discrepancies
        const discrepancies=data.data.discrepancies||[];
        const verification=data.data.verification||{};
        let discrepancyCashAdd=0;
        // Type 1: Counter UPI recorded but not in Razorpay (Odoo PM38 > Razorpay)
        if(verification.cashCounter&&verification.cashCounter.variance>0)discrepancyCashAdd+=verification.cashCounter.variance;
        // Type 2: Runner Counter UPI mismatch
        if(verification.runnerCounter&&verification.runnerCounter.variance>0)discrepancyCashAdd+=verification.runnerCounter.variance;
        // Type 3: Runner ledger without runner (PM 40) + Token issue without runner (PM 48)
        for(const d of discrepancies){
          if(d.type==='runner_ledger_no_runner'||d.type==='token_issue_no_runner'){
            discrepancyCashAdd+=(d.amount||0);
          }
        }
        staffWizardData={
          shiftFrom,periodStart:toLocalISO(shiftFrom),
          mainCounter:data.data.mainCounter,
          runnerCounter:data.data.runnerCounter,
          verification,discrepancies,
          counterBalance,expectedDrawer,unsettledCounterCash,
          discrepancyCashAdd,
          prevVariance,lastShiftCashier:lastShift?.cashier_name||null,
          unsettledRunners:allRunners,
          runnerPeriods,
          misattributed:data.data.misattributedOrders||[],
          crossPayments:data.data.crossPayments||[]
        };
        staffRunnerInputs=allRunners.map(r=>{
          const rp=runnerPeriods[r.id];
          const prevUnsold=(rp&&rp.lastSettlement&&rp.lastSettlement.unsold_tokens)?parseFloat(rp.lastSettlement.unsold_tokens):0;
          const totalTokens=r.tokens+prevUnsold;
          return {
            runner_id:r.id,runner_name:r.name,
            tokens:r.tokens,sales:r.sales,upi:r.upi,
            prevUnsoldTokens:prevUnsold,
            totalTokens:totalTokens,
            crossPaymentCredit:r.crossPaymentCredit||0,
            unsoldTokens:0,
            cashCalculated:Math.max(0,(totalTokens+r.sales)-r.upi-(r.crossPaymentCredit||0)),
            cashCollected:0,userEdited:false,absent:false
          };
        });
        renderStaffWizardStep1();
      }catch(e){
        $('wizardContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';
      }
    }

    function updateStaffWizardSteps(){
      for(let i=1;i<=3;i++){
        const el=$('wizStep'+i);
        el.classList.remove('active','done');
        if(i===staffWizardStep)el.classList.add('active');
        else if(i<staffWizardStep)el.classList.add('done');
      }
    }

    function renderStaffWizardStep1(){
      staffWizardStep=1;updateStaffWizardSteps();
      $('wizardContent').innerHTML=
        '<div class="wizard-step-content active">'+
          '<div class="wizard-card"><h3>üí∞ Count Your Cash</h3>'+
            '<div style="font-size:14px;color:var(--text2);margin-bottom:8px;line-height:1.6">Count all the cash at the counter and enter the total amount.</div>'+
            '<div style="font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.5">Include all cash from sales, runner collections, and any remaining petty cash. Do NOT include UPI or card amounts.</div>'+
            '<div class="wizard-input-group">'+
              '<label style="font-size:15px;font-weight:600;color:var(--text)">Total Cash at Counter</label>'+
              '<input type="number" id="staffDrawerCashInput" placeholder="‚Çπ Enter total cash" min="0" step="10" inputmode="numeric" style="font-size:28px;text-align:center;padding:18px">'+
            '</div>'+
          '</div>'+
          '<div class="wizard-nav">'+
            '<button class="wn-back" onclick="closeStaffWizard()">‚úï Cancel</button>'+
            (staffWizardData.unsettledRunners.length>0
              ?'<button class="wn-next" onclick="goToStaffWizardStep2()">Next ‚Üí Runners</button>'
              :'<button class="wn-next" onclick="goToStaffWizardStep3()">Next ‚Üí Submit</button>')+
          '</div>'+
        '</div>';
    }

    function closeStaffWizard(){
      $('wizardOverlay').classList.remove('show');
      staffWizardData=null;staffWizardStep=1;staffRunnerInputs=[];
    }

    function goToStaffWizardStep2(){
      staffDrawerCash=parseFloat(document.getElementById('staffDrawerCashInput')?.value)||0;
      if(staffDrawerCash<=0){alert('Please enter the cash amount at the counter');return;}
      staffWizardStep=2;updateStaffWizardSteps();
      let html='<div class="wizard-step-content active">';
      html+='<div style="font-size:14px;color:var(--text2);margin-bottom:16px">Collect cash from each runner and enter the amount received.</div>';
      if(staffRunnerInputs.length===0){
        html+='<div class="wizard-card"><div class="loading-text">No active runners this shift</div></div>';
      }else{
        for(let i=0;i<staffRunnerInputs.length;i++){
          const ri=staffRunnerInputs[i];
          html+='<div class="wizard-runner-card'+(ri.absent?' absent':'')+'" id="staffWizRunner'+i+'">'+
            '<div class="wrc-header"><span class="wrc-name">'+ri.runner_name+'</span></div>'+
            (ri.prevUnsoldTokens>0?
              '<div style="background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2);border-radius:6px;padding:6px 10px;margin-bottom:8px;font-size:12px;color:var(--yellow)">üé´ Remaining tokens from prev: <strong>'+fmt(ri.prevUnsoldTokens)+'</strong></div>':'')+
            '<div class="wizard-row"><span class="wr-label">Tokens (Total)</span><span class="wr-val">'+fmt(ri.totalTokens)+'</span></div>'+
            (ri.prevUnsoldTokens>0?
              '<div style="font-size:11px;color:var(--text2);padding:0 0 4px 12px">'+fmt(ri.prevUnsoldTokens)+' carried + '+fmt(ri.tokens)+' new</div>':'')+
            '<div class="wizard-row"><span class="wr-label">Sales (Snacks)</span><span class="wr-val">'+fmt(ri.sales)+'</span></div>'+
            '<div class="wizard-row"><span class="wr-label">UPI Collected (QR)</span><span class="wr-val" style="color:var(--blue)">'+fmt(ri.upi)+'</span></div>'+
            (ri.totalTokens>0?
              '<div class="wizard-input-group"><label>Unsold Tokens with Runner (‚Çπ)</label>'+
              '<input type="number" id="staffWizUnsold'+i+'" value="0" min="0" max="'+ri.totalTokens+'" step="10" inputmode="numeric" '+(ri.absent?'disabled':'')+'>'+
              '<div style="font-size:11px;color:var(--text2);margin-top:4px">Max: '+fmt(ri.totalTokens)+'</div></div>':'')+
            '<div class="wizard-input-group"><label style="font-weight:600">Cash Collected from '+ri.runner_name+'</label>'+
            '<input type="number" id="staffWizCash'+i+'" placeholder="‚Çπ Enter cash" min="0" step="10" inputmode="numeric" style="font-size:20px;text-align:center;padding:12px" '+(ri.absent?'disabled':'')+'>'+
            '</div>'+
            '<label class="wizard-absent-toggle"><input type="checkbox" id="staffWizAbsent'+i+'" '+(ri.absent?'checked':'')+' onchange="toggleStaffAbsent('+i+')"> Runner not present (carry to next shift)</label>'+
          '</div>';
        }
      }
      html+='<div class="wizard-nav">'+
        '<button class="wn-back" onclick="renderStaffWizardStep1()">‚Üê Back</button>'+
        '<button class="wn-next" onclick="goToStaffWizardStep3()">Next ‚Üí Submit</button>'+
      '</div></div>';
      $('wizardContent').innerHTML=html;
    }

    function toggleStaffAbsent(idx){
      const cb=document.getElementById('staffWizAbsent'+idx);
      const ri=staffRunnerInputs[idx];
      ri.absent=cb.checked;
      const card=document.getElementById('staffWizRunner'+idx);
      if(card)card.classList.toggle('absent',ri.absent);
      const unsoldEl=document.getElementById('staffWizUnsold'+idx);
      const cashEl=document.getElementById('staffWizCash'+idx);
      if(unsoldEl)unsoldEl.disabled=ri.absent;
      if(cashEl)cashEl.disabled=ri.absent;
      if(ri.absent){ri.cashCollected=0;ri.unsoldTokens=0;if(cashEl)cashEl.value='';if(unsoldEl)unsoldEl.value=0;}
    }

    function goToStaffWizardStep3(){
      // Capture step 1 if needed
      const drawerInput=document.getElementById('staffDrawerCashInput');
      if(drawerInput)staffDrawerCash=parseFloat(drawerInput.value)||0;
      if(staffDrawerCash<=0&&staffWizardStep===1){alert('Please enter the cash amount');return;}
      // Capture step 2 inputs
      for(let i=0;i<staffRunnerInputs.length;i++){
        const ri=staffRunnerInputs[i];
        if(!ri.absent){
          const unsoldEl=document.getElementById('staffWizUnsold'+i);
          const cashEl=document.getElementById('staffWizCash'+i);
          if(unsoldEl)ri.unsoldTokens=parseFloat(unsoldEl.value)||0;
          if(cashEl)ri.cashCollected=parseFloat(cashEl.value)||0;
          // Expected = (totalTokens - unsoldTokens + sales) - upi - crossPaymentCredit
          ri.cashCalculated=Math.max(0,(ri.totalTokens-ri.unsoldTokens+ri.sales)-ri.upi-ri.crossPaymentCredit);
          ri.cashVariance=ri.cashCollected-ri.cashCalculated;
        }
      }
      staffWizardStep=3;updateStaffWizardSteps();
      // === Calculate result ===
      const expectedDrawer=staffWizardData.expectedDrawer;
      const discAdd=staffWizardData.discrepancyCashAdd;
      const adjustedExpectedDrawer=expectedDrawer+discAdd;
      const runnerCollected=staffRunnerInputs.filter(r=>!r.absent).reduce((s,r)=>s+r.cashCollected,0);
      const runnerExpected=staffRunnerInputs.filter(r=>!r.absent).reduce((s,r)=>s+r.cashCalculated,0);
      // Total cash staff is accounting for = drawer + runner cash collected
      // Expected = adjusted drawer expected + runner expected
      // But runner cash collected goes INTO the drawer, so:
      // The drawer already contains: petty + settled counter + unsettled + settled runner - expenses + newly collected runner cash
      // Expected drawer = expectedDrawer (before runner collection) + runner expected cash
      // But staff enters drawer BEFORE collecting from runners in step 2
      // So: total physical = drawer_entered + runner_collected
      // total expected = adjustedExpectedDrawer + runnerExpected
      const totalPhysical=staffDrawerCash+runnerCollected;
      const totalExpected=adjustedExpectedDrawer+runnerExpected;
      const totalVariance=totalPhysical-totalExpected;
      // Check runner variances individually
      const runnerShortages=staffRunnerInputs.filter(r=>!r.absent&&r.cashVariance<-10);
      // Store for submission
      staffWizardData.reconciliation={
        total_physical_cash:totalPhysical,
        expected_cash:totalExpected,
        raw_variance:totalVariance,
        discrepancy_cash_addition:discAdd,
        variance_resolved:0,
        variance_unresolved:totalVariance,
        discrepancy_resolutions:[]
      };
      // Handle carry-forward from previous shift
      let resolvedFromPrev=0;
      if(totalVariance>0&&staffWizardData.prevVariance<0){
        const shortage=Math.abs(staffWizardData.prevVariance);
        resolvedFromPrev=Math.min(totalVariance,shortage);
        staffWizardData.reconciliation.variance_resolved=resolvedFromPrev;
        staffWizardData.reconciliation.variance_unresolved=totalVariance-resolvedFromPrev;
        staffWizardData.reconciliation.discrepancy_resolutions.push({source:'prev_shift_carryforward',amount:resolvedFromPrev,resolved_by:'shortage_recovery',explanation:'Recovering '+fmt(resolvedFromPrev)+' from previous shift shortage'});
      }
      const finalVariance=totalVariance-resolvedFromPrev;
      // Map excess per runner for DB
      for(const ri of staffRunnerInputs){
        if(ri.absent)continue;
        ri.excessMappedTo='';ri.excessMappedAmount=0;
        const excess=ri.cashCollected-ri.cashCalculated;
        if(excess>0){ri.excessMappedTo='runner_excess';ri.excessMappedAmount=excess;}
      }
      // === RENDER RESULT ===
      let html='<div class="wizard-step-content active">';
      if(finalVariance>=-5){
        // ALL CLEAR (match or extra)
        // If extra ‚Üí silent, staff never knows. Log as unaccounted sale.
        if(finalVariance>5){
          staffWizardData.reconciliation.unaccounted_sale=finalVariance;
          staffWizardData.reconciliation.discrepancy_resolutions.push({source:'unaccounted_sale',amount:finalVariance,resolved_by:'silent_extra',explanation:'Extra cash logged as unaccounted sale'});
        }
        html+='<div class="wizard-card" style="border-color:var(--green);text-align:center;padding:40px 20px">'+
          '<div style="font-size:48px;margin-bottom:12px">‚úÖ</div>'+
          '<div style="font-size:22px;font-weight:700;color:var(--green);margin-bottom:8px">All Clear</div>'+
          '<div style="font-size:15px;color:var(--text2);margin-bottom:24px">Your shift has been settled successfully.<br>All cash is accounted for.</div>'+
          '<div style="display:flex;gap:16px;justify-content:center;margin-bottom:8px">'+
            '<div style="text-align:center"><div style="font-size:12px;color:var(--text2)">Counter Cash</div><div style="font-size:20px;font-weight:700;font-family:JetBrains Mono,monospace">'+fmt(staffDrawerCash)+'</div></div>'+
            (runnerCollected>0?'<div style="text-align:center"><div style="font-size:12px;color:var(--text2)">Runner Cash</div><div style="font-size:20px;font-weight:700;font-family:JetBrains Mono,monospace">'+fmt(runnerCollected)+' ('+staffRunnerInputs.filter(r=>!r.absent).length+' runners)</div></div>':'')+
          '</div>'+
          (function(){
            const runnersWithUnsold=staffRunnerInputs.filter(r=>!r.absent&&r.unsoldTokens>0);
            if(runnersWithUnsold.length===0)return '';
            let thtml='<div style="margin-top:12px;background:rgba(234,179,8,0.06);border:1px solid rgba(234,179,8,0.15);border-radius:8px;padding:10px 14px;text-align:left">';
            thtml+='<div style="font-size:12px;font-weight:600;color:var(--yellow);margin-bottom:4px">üé´ Unsold Tokens with Runners (carry to next)</div>';
            for(const r of runnersWithUnsold){thtml+='<div style="font-size:13px;color:var(--text2);padding:2px 0">'+r.runner_name+': '+fmt(r.unsoldTokens)+'</div>';}
            thtml+='</div>';
            return thtml;
          })()+
        '</div>';
        // Auto-submit
        html+='<div class="wizard-nav"><button class="wn-submit" id="staffWizSubmitBtn" onclick="submitStaffShiftWizard()">Done ‚úì</button></div>';
      }else{
        // CASH SHORT
        const shortAmount=Math.abs(finalVariance);
        html+='<div class="wizard-card" style="border-color:var(--red);text-align:center;padding:30px 20px">'+
          '<div style="font-size:48px;margin-bottom:12px">‚ö†Ô∏è</div>'+
          '<div style="font-size:22px;font-weight:700;color:var(--red);margin-bottom:8px">Cash Shortage: '+fmt(shortAmount)+'</div>'+
          '<div style="font-size:15px;color:var(--text2);margin-bottom:24px">The cash entered is '+fmt(shortAmount)+' less than expected.</div>'+
          '<div style="text-align:left;background:var(--bg2);border-radius:10px;padding:16px;margin-bottom:16px">'+
            '<div style="font-size:13px;color:var(--text2);margin-bottom:8px">Summary</div>'+
            '<div class="wizard-row"><span class="wr-label">Counter Cash Entered</span><span class="wr-val">'+fmt(staffDrawerCash)+'</span></div>'+
            (runnerCollected>0?'<div class="wizard-row"><span class="wr-label">Runner Cash Collected</span><span class="wr-val">'+fmt(runnerCollected)+'</span></div>':'')+
            '<div class="wizard-row total"><span class="wr-label">Total Cash</span><span class="wr-val">'+fmt(totalPhysical)+'</span></div>'+
          '</div>'+
          '<div style="text-align:left;font-size:14px;color:var(--text2);line-height:1.6;margin-bottom:16px">'+
            'Please verify:<br>'+
            '‚Ä¢ Recount the cash in the drawer<br>'+
            '‚Ä¢ Check if any expenses were not recorded<br>'+
            '‚Ä¢ Confirm all runner collections'+
          '</div>'+
          (function(){
            const runnersWithTokens=staffRunnerInputs.filter(r=>!r.absent&&r.tokens>0);
            if(runnersWithTokens.length===0)return '';
            let thtml='<div style="background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);border-radius:8px;padding:10px 14px;text-align:left;margin-bottom:12px">';
            thtml+='<div style="font-size:12px;font-weight:600;color:var(--blue);margin-bottom:4px">üé´ Tokens with Runners</div>';
            for(const r of runnersWithTokens){thtml+='<div style="font-size:13px;color:var(--text2);padding:2px 0">'+r.runner_name+': '+fmt(r.tokens)+'</div>';}
            thtml+='</div>';
            return thtml;
          })()+
        '</div>';
        // Runner shortages if any
        if(runnerShortages.length>0){
          html+='<div class="wizard-card" style="border-color:var(--yellow)">';
          for(const rs of runnerShortages){
            html+='<div style="padding:8px 0;font-size:14px;color:var(--yellow)">‚ö†Ô∏è '+rs.runner_name+': ‚Çπ'+Math.abs(rs.cashVariance)+' short (collected '+fmt(rs.cashCollected)+', expected '+fmt(rs.cashCalculated)+')</div>';
          }
          html+='</div>';
        }
        html+='<div class="wizard-nav">'+
          '<button class="wn-back" onclick="renderStaffWizardStep1()">üîÑ Recount Cash</button>'+
          '<button class="wn-submit" id="staffWizSubmitBtn" style="background:var(--yellow);color:#000" onclick="submitStaffShiftWizard()">Submit As-Is</button>'+
        '</div>';
      }
      // Absent runners
      const absentRunners=staffRunnerInputs.filter(r=>r.absent);
      if(absentRunners.length>0){
        let absentHtml='<div class="wizard-card" style="border-color:var(--orange)">';
        for(const r of absentRunners){
          absentHtml+='<div style="padding:8px 0;font-size:13px;color:var(--orange)">‚ö†Ô∏è '+r.runner_name+' ('+fmt(r.cashCalculated)+') ‚Äî obligation carried to next shift</div>';
        }
        absentHtml+='</div>';
        // Insert before nav
        html=html.replace('<div class="wizard-nav">',absentHtml+'<div class="wizard-nav">');
      }
      html+='</div>';
      $('wizardContent').innerHTML=html;
    }

    async function submitStaffShiftWizard(){
      const btn=document.getElementById('staffWizSubmitBtn');
      if(!btn)return;
      btn.disabled=true;btn.textContent='Recording settlement...';
      const mc=staffWizardData.mainCounter;
      const v=staffWizardData.verification;
      const rc=staffWizardData.reconciliation;
      const cb=staffWizardData.counterBalance;
      const now=new Date();
      const payload={
        settled_by:currentUser,
        period_start:staffWizardData.periodStart,
        period_end:toLocalISO(now),
        counter_balance:{
          petty_cash_start:cb.pettyCash||0,
          counter_cash_settled:cb.counterCash||0,
          unsettled_counter_cash:staffWizardData.unsettledCounterCash||0,
          runner_cash_settled:cb.runnerCash||0,
          expenses_total:cb.totalExpenses||0,
          expected_drawer:staffWizardData.expectedDrawer||0
        },
        drawer_cash_entered:staffDrawerCash,
        counter:{
          cash_entered:staffDrawerCash,
          cash_expected:mc.cash||0,
          unsettled_counter_cash:staffWizardData.unsettledCounterCash||0,
          upi:mc.upi||0,card:mc.card||0,
          token_issue:mc.tokenIssue||0,
          complimentary:mc.complimentary||0
        },
        upi_verification:{
          counter_qr:{odoo:mc.upi||0,razorpay:v.cashCounter?.razorpay||0,variance:(v.cashCounter?.variance)||0},
          runner_counter_qr:{odoo:staffWizardData.runnerCounter?.upi||0,razorpay:v.runnerCounter?.razorpay||0,variance:(v.runnerCounter?.variance)||0}
        },
        runner_checkpoints:staffRunnerInputs.map(ri=>({
          runner_id:ri.runner_id,runner_name:ri.runner_name,
          tokens_amount:ri.totalTokens||ri.tokens,sales_amount:ri.sales,upi_amount:ri.upi,
          cross_payment_credit:ri.crossPaymentCredit,
          unsold_tokens:ri.unsoldTokens,
          cash_calculated:ri.cashCalculated,cash_collected:ri.cashCollected,
          cash_variance:ri.cashCollected-ri.cashCalculated,
          excess_mapped_to:ri.excessMappedTo||'',excess_mapped_amount:ri.excessMappedAmount||0,
          status:ri.absent?'absent':'present'
        })),
        reconciliation:rc
      };
      try{
        const res=await fetch('/api/settlement?action=cashier-shift-settle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úÖ Shift Settled!';btn.style.background='var(--green)';btn.style.color='#fff';
          setTimeout(()=>{closeStaffWizard();renderStaffDashboard();},1500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';btn.style.color='#fff';setTimeout(()=>{btn.textContent='Submit';btn.style.background='';btn.disabled=false;},3000);}
    }

    // === STAFF: Simplified Shift History ===
    async function loadStaffShiftHistory(){
      try{
        const res=await fetch('/api/settlement?action=shift-history-v2&limit=10');
        const data=await res.json();
        const panel=$('shiftHistoryPanel');
        if(!data.success||!data.shifts||data.shifts.length===0){panel.classList.remove('show');return;}
        panel.classList.add('show');
        let html='<h3>üìã Recent Settlements</h3><div class="subtitle">Your shift history</div>';
        for(const s of data.shifts){
          const pStart=new Date(s.period_start);const pEnd=new Date(s.settled_at);
          const isBalanced=Math.abs(s.variance_unresolved||0)<=5;
          html+='<div class="sh-card" style="border:1px solid '+(isBalanced?'var(--green)':'var(--yellow)')+';border-radius:12px">'+
            '<div class="sh-card-header"><div><div class="sh-card-title">üèÅ Shift ‚Äî '+s.cashier_name+'</div><div class="sh-card-time">'+fmtD(pStart)+' ‚Üí '+fmtD(pEnd)+'</div></div>'+
            '<div style="text-align:right"><span class="sh-card-badge '+(isBalanced?'balanced':'variance')+'">'+(isBalanced?'‚úÖ All Clear':'‚ö†Ô∏è ‚Çπ'+Math.abs(s.variance_unresolved).toFixed(0)+' short')+'</span>'+
            '<div style="font-size:18px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--green);margin-top:4px">'+fmt(s.total_cash_physical)+'</div></div></div>';
          html+='<div class="sh-card-meta"><span>Counter: '+fmt(s.counter_cash_entered)+'</span>';
          if(s.runner_count>0)html+='<span>Runners: '+s.runner_count+'</span>';
          html+='</div></div>';
        }
        panel.innerHTML=html;
      }catch(e){console.error('Staff shift history error:',e);}
    }

    pins[0].focus();
  </script>
</body>
</html>
