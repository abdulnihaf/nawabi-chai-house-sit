<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCH Runner Settlement</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--yellow:#eab308;--orange:#f97316}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .pin-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .pin-screen.hidden{display:none}
    .pin-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;max-width:360px;width:100%}
    .pin-box .icon{font-size:48px;margin-bottom:20px}
    .pin-box h2{font-size:24px;margin-bottom:8px}
    .pin-box p{color:var(--text2);font-size:14px;margin-bottom:24px}
    .pin-input{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .pin-input input{width:48px;height:56px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:24px;text-align:center;font-family:'JetBrains Mono',monospace;transition:all 0.2s}
    .pin-input input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(168,85,247,0.2)}
    .pin-input input.filled{border-color:var(--green);background:rgba(34,197,94,0.1)}
    .pin-success{display:none;align-items:center;gap:8px;justify-content:center;color:var(--green);font-weight:600;margin-top:16px}
    .pin-success.show{display:flex}
    .dashboard{display:none;min-height:100vh}
    .dashboard.show{display:block}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:20px;display:flex;align-items:center;gap:8px}
    .header h1::before{content:'';width:4px;height:24px;background:var(--purple);border-radius:2px}
    .user-badge{display:flex;align-items:center;gap:12px}
    .user-badge .dot{width:8px;height:8px;background:var(--green);border-radius:50%}
    .user-badge .name{font-weight:600}
    .logout-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px}
    .logout-btn:hover{background:var(--border)}
    .content{padding:24px;max-width:1200px;margin:0 auto}
    .section-title{font-size:14px;color:var(--text2);margin-bottom:16px}
    .runner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-bottom:32px}
    .runner-card{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
    .runner-card:hover{border-color:var(--purple);transform:translateY(-2px)}
    .runner-card.selected{border-color:var(--purple);background:rgba(168,85,247,0.1)}
    .runner-card.counter{border-color:var(--orange)}
    .runner-card.counter:hover{border-color:var(--orange);background:rgba(249,115,22,0.1)}
    .runner-card.counter.selected{border-color:var(--orange);background:rgba(249,115,22,0.2)}
    .runner-card.expense{border-color:var(--red)}
    .runner-card.expense:hover{border-color:var(--red);background:rgba(239,68,68,0.1)}
    .runner-card.expense.selected{border-color:var(--red);background:rgba(239,68,68,0.2)}
    .runner-card .name{font-weight:600;margin-bottom:4px}
    .runner-card .code{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;display:none}
    .panel.show{display:block}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .panel-header h2{font-size:20px}
    .panel-header .period{font-size:12px;color:var(--text2);background:var(--bg2);padding:6px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace}
    .row{display:flex;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border)}
    .row:last-of-type{border-bottom:none}
    .row .label{color:var(--text2)}
    .row .value{font-weight:600;font-family:'JetBrains Mono',monospace}
    .row.total{padding-top:20px;margin-top:8px;border-top:2px solid var(--border);border-bottom:none}
    .row.total .label{font-weight:600;color:var(--text)}
    .row.total .value{font-size:24px}
    .row.sub{opacity:0.7;padding:8px 0 8px 16px;font-size:14px}
    .info-box{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);border-radius:8px;padding:12px 16px;margin-top:20px;font-size:13px;color:var(--yellow)}
    .loading-text{text-align:center;color:var(--text2);padding:40px}
    .settle-btn{width:100%;background:var(--green);color:#fff;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-top:20px;transition:all 0.2s}
    .settle-btn:hover{background:#16a34a;transform:translateY(-1px)}
    .settle-btn:disabled{background:var(--border);cursor:not-allowed;transform:none}
    .settle-btn.loading{background:var(--yellow);cursor:wait}
    .settle-btn.counter-btn{background:var(--orange)}
    .settle-btn.counter-btn:hover{background:#ea580c}
    .collection-panel{background:var(--card);border:2px solid var(--yellow);border-radius:16px;padding:24px;margin-top:32px;display:none}
    .collection-panel.show{display:block}
    .collection-panel h3{font-size:18px;margin-bottom:4px}
    .collection-panel .subtitle{font-size:13px;color:var(--text2);margin-bottom:20px}
    .collection-big-number{text-align:center;padding:24px 0}
    .collection-big-number .amount{font-size:48px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .collection-big-number .label{font-size:14px;color:var(--text2);margin-top:4px}
    .collection-breakdown{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
    .collection-breakdown .cb-card{background:var(--bg2);border-radius:10px;padding:14px;text-align:center}
    .collection-breakdown .cb-card .cb-val{font-size:20px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .collection-breakdown .cb-card .cb-label{font-size:11px;color:var(--text2);margin-top:4px}
    .settlement-list{margin:16px 0;max-height:200px;overflow-y:auto}
    .settlement-list .sl-item{display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);font-size:13px}
    .settlement-list .sl-item:last-child{border-bottom:none}
    .settlement-list .sl-who{color:var(--text2)}
    .settlement-list .sl-amount{font-family:'JetBrains Mono',monospace;font-weight:500}
    .collect-btn{width:100%;background:var(--yellow);color:#000;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin-top:16px;transition:all 0.2s}
    .collect-btn:hover{background:#ca8a04;transform:translateY(-1px)}
    .collect-btn:disabled{background:var(--border);color:var(--text2);cursor:not-allowed;transform:none}
    .field-group{margin-top:12px}
    .field-group label{font-size:13px;color:var(--text2);display:block;margin-bottom:6px}
    .field-group input,.field-group select{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;padding:12px;font-family:'JetBrains Mono',monospace}
    .field-group input:focus,.field-group select:focus{outline:none;border-color:var(--yellow)}
    .collection-history{margin-top:24px;border-top:1px solid var(--border);padding-top:16px}
    .collection-history h4{font-size:14px;color:var(--text2);margin-bottom:12px}
    .ch-item{background:var(--bg2);border-radius:10px;padding:14px;margin-bottom:8px}
    .ch-item .ch-top{display:flex;justify-content:space-between;align-items:center}
    .ch-item .ch-amount{font-size:18px;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .ch-item .ch-date{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .ch-item .ch-detail{font-size:12px;color:var(--text2);margin-top:6px}
    .counter-balance-readonly{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-top:32px;display:none}
    .counter-balance-readonly.show{display:block}
    .counter-balance-readonly h3{font-size:16px;margin-bottom:12px;color:var(--text2)}
    .counter-balance-readonly .bal-amount{font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .counter-balance-readonly .bal-detail{font-size:12px;color:var(--text2);margin-top:6px}
    .bal-breakdown{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px}
    .bal-breakdown .bb{background:var(--bg2);border-radius:8px;padding:10px;text-align:center}
    .bal-breakdown .bb-val{font-size:16px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .bal-breakdown .bb-label{font-size:10px;color:var(--text2);margin-top:2px}
    .expense-input{background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;padding:10px;font-family:'JetBrains Mono',monospace;width:100%}
    .expense-input:focus{outline:none;border-color:var(--red)}
    .expense-reason{background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;padding:10px;width:100%;font-family:'Plus Jakarta Sans',sans-serif}
    .expense-reason:focus{outline:none;border-color:var(--red)}
    .verify-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .verify-badge.ok{background:rgba(34,197,94,0.15);color:var(--green)}
    .verify-badge.warn{background:rgba(239,68,68,0.15);color:var(--red)}
    .verify-box{background:var(--bg2);border-radius:10px;padding:14px;margin-top:16px;font-size:13px}
    .verify-box .verify-title{font-size:12px;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
    .verify-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
    .verify-row:last-child{border-bottom:none}
    .verify-row .vr-label{color:var(--text2)}
    .verify-row .vr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .audit-banner{border-radius:10px;padding:14px;margin-top:16px;font-size:13px;display:flex;gap:10px;align-items:flex-start}
    .audit-banner.warning{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);color:var(--yellow)}
    .audit-banner.critical{background:rgba(239,68,68,0.1);border:1px solid var(--red);color:var(--red)}
    .audit-banner .ab-icon{font-size:18px;flex-shrink:0}
    .audit-banner .ab-text{flex:1;line-height:1.4}
    .discrepancy-list{margin-top:16px}
    .discrepancy-item{background:var(--bg2);border-radius:8px;padding:12px;margin-bottom:8px;font-size:13px;display:flex;gap:8px;align-items:flex-start}
    .discrepancy-item.warning{border-left:3px solid var(--yellow)}
    .discrepancy-item.critical{border-left:3px solid var(--red)}
    .discrepancy-item .di-icon{flex-shrink:0}
    .discrepancy-item .di-text{flex:1;color:var(--text2);line-height:1.4}
    .discrepancy-item .di-text strong{color:var(--text)}
    .recon-panel{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:24px;margin-top:32px;display:none}
    .recon-panel.show{display:block}
    .recon-panel.balanced{border-color:var(--green)}
    .recon-panel.warning{border-color:var(--yellow)}
    .recon-panel.critical{border-color:var(--red)}
    .recon-panel h3{font-size:18px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .recon-equation{background:var(--bg2);border-radius:10px;padding:16px;margin:16px 0;text-align:center;font-family:'JetBrains Mono',monospace}
    .recon-equation .eq-main{font-size:16px;font-weight:600;line-height:1.8}
    .recon-equation .eq-status{font-size:14px;font-weight:700;margin-top:8px}
    .recon-section{margin-top:16px}
    .recon-section h4{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
    .recon-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px}
    .recon-row .rr-label{color:var(--text2)}
    .recon-row .rr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .recon-row.total{border-top:1px solid var(--border);margin-top:4px;padding-top:8px;font-weight:600}
    .recon-row.total .rr-label{color:var(--text)}
    .cross-payment-notice{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.3);border-radius:10px;padding:14px;margin-top:12px;font-size:13px}
    .cross-payment-notice .cpn-title{font-weight:600;color:var(--yellow);margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .cross-payment-notice .cpn-item{color:var(--text2);line-height:1.5;padding:4px 0}
    .cross-payment-notice .cpn-shift{color:var(--green);font-size:12px;margin-top:6px}
    .rectify-panel{background:var(--card);border:2px solid var(--orange);border-radius:16px;padding:24px;margin-bottom:32px;display:none}
    .rectify-panel.show{display:block}
    .rectify-panel h3{font-size:18px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .rectify-panel .subtitle{font-size:13px;color:var(--text2);margin-bottom:16px}
    .rectify-card{background:var(--bg2);border-radius:10px;padding:16px;margin-bottom:10px;border-left:3px solid var(--orange)}
    .rectify-card.critical{border-left-color:var(--red)}
    .rectify-card.fixed{opacity:0.4;pointer-events:none}
    .rectify-card .rc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .rectify-card .rc-order{font-weight:600;font-family:'JetBrains Mono',monospace;font-size:14px}
    .rectify-card .rc-amount{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:16px;color:var(--orange)}
    .rectify-card .rc-detail{font-size:12px;color:var(--text2);line-height:1.5;margin-bottom:10px}
    .rectify-card .rc-actions{display:flex;gap:8px;align-items:center}
    .rectify-card select{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;padding:8px 10px;flex:1}
    .rectify-card select:focus{outline:none;border-color:var(--orange)}
    .rectify-btn{background:var(--orange);color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap}
    .rectify-btn:hover{background:#ea580c}
    .rectify-btn:disabled{background:var(--border);cursor:not-allowed}
    .unsold-input-box{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;margin:12px 0}
    .unsold-input-box label{font-size:12px;color:var(--text2);display:block;margin-bottom:6px}
    .unsold-input-box input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;padding:10px;font-family:'JetBrains Mono',monospace}
    .unsold-input-box input:focus{outline:none;border-color:var(--orange)}
    .unsold-input-box .hint{font-size:11px;color:var(--text2);margin-top:4px}
    .cash-breakdown-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px}
    .cash-breakdown-row .cbr-label{color:var(--text2)}
    .cash-breakdown-row .cbr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .cash-breakdown-row.total{border-top:1px solid var(--border);margin-top:4px;padding-top:8px;font-weight:600}
    .cash-breakdown-row.total .cbr-label{color:var(--text)}
    .badge-count{background:var(--orange);color:#fff;border-radius:12px;font-size:12px;font-weight:700;padding:2px 8px;margin-left:8px}
    .variance-source{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
    .variance-source:last-child{border-bottom:none}
    .variance-source .vs-label{color:var(--text2);flex:1}
    .variance-source .vs-amount{font-family:'JetBrains Mono',monospace;font-weight:600;margin:0 8px}
    .variance-source .vs-fix{background:var(--orange);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;font-weight:600}
    .variance-source .vs-fix:hover{background:#ea580c}
    .confirm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
    .confirm-dialog{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:24px;max-width:420px;width:100%;max-height:90vh;overflow-y:auto}
    .confirm-dialog h3{font-size:18px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .confirm-row{display:flex;justify-content:space-between;padding:8px 0;font-size:13px;border-bottom:1px solid var(--border)}
    .confirm-row:last-of-type{border-bottom:none}
    .confirm-row .cr-label{color:var(--text2)}
    .confirm-row .cr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .confirm-checks{margin:16px 0;padding:12px;background:var(--bg2);border-radius:10px}
    .confirm-check{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:13px}
    .confirm-check .cc-icon{font-size:16px;flex-shrink:0}
    .confirm-check .cc-label{flex:1;color:var(--text2)}
    .confirm-check .cc-status{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:12px}
    .confirm-check .cc-status.ok{color:var(--green)}
    .confirm-check .cc-status.warn{color:var(--yellow)}
    .confirm-check .cc-status.bad{color:var(--red)}
    .confirm-warn{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);border-radius:8px;padding:10px;font-size:12px;color:var(--yellow);margin:12px 0}
    .confirm-buttons{display:flex;gap:12px;margin-top:16px}
    .confirm-buttons button{flex:1;padding:14px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s}
    .confirm-buttons .cancel-btn{background:var(--bg2);color:var(--text);border:1px solid var(--border)}
    .confirm-buttons .cancel-btn:hover{background:var(--border)}
    .shift-health{display:flex;flex-wrap:wrap;gap:8px;margin-top:16px;padding:12px;background:var(--bg2);border-radius:10px}
    .shift-health .sh-item{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text2);padding:4px 8px;background:var(--bg);border-radius:6px}
    .shift-health .sh-item.ok{border:1px solid rgba(34,197,94,0.3)}
    .shift-health .sh-item.warn{border:1px solid rgba(234,179,8,0.3)}
    .shift-health .sh-item.bad{border:1px solid rgba(239,68,68,0.3)}
    .expense-attr{padding-left:16px;font-size:11px;color:var(--text2);opacity:0.8}
    .shift-history-panel{background:var(--card);border-radius:16px;padding:24px;margin-bottom:32px;display:none}
    .shift-history-panel.show{display:block}
    .shift-history-panel h3{font-size:18px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .shift-history-panel .subtitle{font-size:13px;color:var(--text2);margin-bottom:16px}
    .sh-card{background:var(--bg2);border-radius:12px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all 0.2s}
    .sh-card:hover{border-color:var(--blue)}
    .sh-card-header{display:flex;justify-content:space-between;align-items:center}
    .sh-card-title{font-size:14px;font-weight:600}
    .sh-card-time{font-size:12px;color:var(--text2)}
    .sh-card-meta{display:flex;gap:12px;margin-top:6px;font-size:12px;color:var(--text2)}
    .sh-card-meta span{font-family:JetBrains Mono,monospace}
    .sh-card-badge{display:inline-block;font-size:11px;padding:2px 8px;border-radius:6px;font-weight:600}
    .sh-card-badge.balanced{background:rgba(34,197,94,0.15);color:var(--green)}
    .sh-card-badge.variance{background:rgba(239,68,68,0.15);color:var(--red)}
    .sh-card-detail{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:none}
    .sh-card-detail.show{display:block}
    .sh-card-detail .loading-text{font-size:12px;color:var(--text2);text-align:center;padding:12px}
    /* === SHIFT WIZARD v2 === */
    .wizard-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:900;display:none;overflow-y:auto}
    .wizard-overlay.show{display:block}
    .wizard-container{max-width:600px;margin:0 auto;padding:16px 16px 100px}
    .wizard-header{display:flex;align-items:center;justify-content:space-between;padding:16px 0;margin-bottom:8px}
    .wizard-header h2{font-size:18px;display:flex;align-items:center;gap:8px}
    .wizard-close{background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px}
    .wizard-close:hover{background:var(--border);color:var(--text)}
    .wizard-steps{display:flex;gap:4px;margin-bottom:24px}
    .wizard-step{flex:1;text-align:center;padding:10px 4px;border-radius:8px;font-size:12px;font-weight:600;background:var(--bg2);color:var(--text2);transition:all 0.3s}
    .wizard-step.active{background:var(--purple);color:#fff}
    .wizard-step.done{background:rgba(34,197,94,0.2);color:var(--green)}
    .wizard-step-content{display:none}
    .wizard-step-content.active{display:block}
    .wizard-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px}
    .wizard-card h3{font-size:16px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .wizard-row{display:flex;justify-content:space-between;padding:8px 0;font-size:14px;border-bottom:1px solid rgba(45,58,79,0.5)}
    .wizard-row:last-of-type{border-bottom:none}
    .wizard-row .wr-label{color:var(--text2)}
    .wizard-row .wr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .wizard-row.total{border-top:2px solid var(--border);margin-top:4px;padding-top:12px;font-weight:600}
    .wizard-row.total .wr-label{color:var(--text)}
    .wizard-row.total .wr-val{font-size:18px}
    .wizard-upi-box{border-radius:10px;padding:14px;margin:12px 0;font-size:13px}
    .wizard-upi-box.ok{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2)}
    .wizard-upi-box.warn{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2)}
    .wizard-upi-box .upi-title{font-weight:600;margin-bottom:6px;display:flex;justify-content:space-between}
    .wizard-upi-box .upi-detail{color:var(--text2);line-height:1.5}
    .wizard-input-group{margin:16px 0}
    .wizard-input-group label{font-size:13px;color:var(--text2);display:block;margin-bottom:6px}
    .wizard-input-group .wi-expected{font-size:12px;color:var(--text2);margin-bottom:8px;font-family:'JetBrains Mono',monospace}
    .wizard-input-group input{width:100%;background:var(--bg2);border:2px solid var(--border);border-radius:10px;color:var(--text);font-size:22px;padding:14px;font-family:'JetBrains Mono',monospace;transition:border-color 0.2s}
    .wizard-input-group input:focus{outline:none;border-color:var(--purple)}
    .wizard-match{border-radius:10px;padding:14px;margin:12px 0;font-size:13px;line-height:1.5}
    .wizard-match.ok{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:var(--green)}
    .wizard-match.warn{background:rgba(234,179,8,0.1);border:1px solid rgba(234,179,8,0.3);color:var(--yellow)}
    .wizard-match.bad{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--red)}
    .wizard-match.info{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);color:var(--blue)}
    .wizard-runner-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px;transition:border-color 0.2s}
    .wizard-runner-card.absent{opacity:0.5;border-style:dashed}
    .wizard-runner-card .wrc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .wizard-runner-card .wrc-name{font-size:16px;font-weight:700}
    .wizard-runner-card .wrc-badge{font-size:11px;padding:4px 10px;border-radius:6px;font-weight:600;background:var(--bg2);color:var(--text2)}
    .wizard-runner-card .wrc-calc{background:var(--bg2);border-radius:8px;padding:10px 14px;margin:12px 0;font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .wizard-absent-toggle{display:flex;align-items:center;gap:10px;margin-top:14px;padding:12px;background:var(--bg2);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text2)}
    .wizard-absent-toggle input[type=checkbox]{width:18px;height:18px;accent-color:var(--orange)}
    .wizard-nav{display:flex;gap:12px;margin-top:24px;position:sticky;bottom:0;padding:16px 0;background:linear-gradient(transparent,var(--bg) 20%)}
    .wizard-nav button{flex:1;padding:16px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s}
    .wizard-nav .wn-back{background:var(--bg2);color:var(--text);border:1px solid var(--border)}
    .wizard-nav .wn-back:hover{background:var(--border)}
    .wizard-nav .wn-next{background:var(--purple);color:#fff}
    .wizard-nav .wn-next:hover{background:#7c3aed}
    .wizard-nav .wn-submit{background:var(--green);color:#fff}
    .wizard-nav .wn-submit:hover{background:#16a34a}
    .wizard-nav .wn-submit:disabled{background:var(--border);cursor:not-allowed}
    .wizard-recon-box{border-radius:12px;padding:16px;margin:12px 0;text-align:center}
    .wizard-recon-box.balanced{background:rgba(34,197,94,0.1);border:2px solid var(--green)}
    .wizard-recon-box.variance{background:rgba(234,179,8,0.1);border:2px solid var(--yellow)}
    .wizard-recon-box.bad{background:rgba(239,68,68,0.1);border:2px solid var(--red)}
    .wizard-recon-box .wrb-icon{font-size:32px;margin-bottom:6px}
    .wizard-recon-box .wrb-text{font-size:16px;font-weight:700}
    .wizard-recon-box .wrb-amount{font-size:24px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-top:4px}
    .wizard-resolution{background:var(--bg2);border-radius:10px;padding:14px;margin:12px 0}
    .wizard-resolution .wr-title{font-size:12px;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
    .wizard-resolution-item{padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;display:flex;gap:8px;align-items:flex-start}
    .wizard-resolution-item:last-child{border-bottom:none}
    .wizard-resolution-item .wri-icon{flex-shrink:0}
    .wizard-resolution-item .wri-text{flex:1;color:var(--text2);line-height:1.4}
    .shift-card{border-color:var(--green)}
    .shift-card:hover{background:rgba(34,197,94,0.1)!important;border-color:var(--green)!important}
    .shift-card.selected{background:rgba(34,197,94,0.15);border-color:var(--green)}
  </style>
</head>
<body>
  <div class="pin-screen" id="pinScreen">
    <div class="pin-box">
      <div class="icon">üîê</div>
      <h2>Runner Settlement</h2>
      <p>Enter your 4-digit PIN to continue</p>
      <div class="pin-input" id="pinInput">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
      </div>
      <div class="pin-success" id="pinSuccess">‚úì Welcome back</div>
    </div>
  </div>
  <div class="dashboard" id="dashboard">
    <div class="header">
      <h1>Runner Settlement</h1>
      <div class="user-badge">
        <span class="dot"></span>
        <span class="name" id="userName"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="content">
      <div class="section-title">Select Runner, Counter, or Record Expense</div>
      <div class="runner-grid" id="runnerGrid"></div>
      <div class="rectify-panel" id="discrepancyPanel"></div>
      <div class="panel" id="panel">
        <div class="panel-header">
          <h2 id="runnerName"></h2>
          <span class="period" id="period"></span>
        </div>
        <div id="panelContent"></div>
      </div>
      <div class="counter-balance-readonly" id="counterBalanceReadonly"></div>
      <div class="collection-panel" id="collectionPanel"></div>
      <div class="recon-panel" id="shiftReconPanel"></div>
      <div class="shift-history-panel" id="shiftHistoryPanel"></div>
    </div>
  </div>
  <!-- SHIFT WIZARD OVERLAY -->
  <div class="wizard-overlay" id="wizardOverlay">
    <div class="wizard-container">
      <div class="wizard-header">
        <h2>üèÅ End My Shift</h2>
        <button class="wizard-close" onclick="closeWizard()">‚úï Cancel</button>
      </div>
      <div class="wizard-steps">
        <div class="wizard-step active" id="wizStep1">1. Counter</div>
        <div class="wizard-step" id="wizStep2">2. Runners</div>
        <div class="wizard-step" id="wizStep3">3. Reconcile</div>
      </div>
      <div id="wizardContent"></div>
    </div>
  </div>
  <script>
    const $=id=>document.getElementById(id);
    const fmt=n=>'‚Çπ'+n.toLocaleString('en-IN');
    const RUNNERS=[
      {id:'counter',name:'üí∞ Cash Counter',barcode:'POS-27',isCounter:true},
      {id:'expense',name:'üìù Record Expense',barcode:'Cash Out',isExpense:true},
      {id:64,name:'FAROOQ',barcode:'RUN001'},
      {id:65,name:'AMIN',barcode:'RUN002'},
      {id:66,name:'NCH Runner 03',barcode:'RUN003'},
      {id:67,name:'NCH Runner 04',barcode:'RUN004'},
      {id:68,name:'NCH Runner 05',barcode:'RUN005'}
    ];
    const COLLECTORS=['Naveen','Nihaf'];
    let currentUser=null,selectedRunner=null,currentRunnerData=null,currentPeriodStart=null,currentCounterData=null,currentCounterTotal=0,currentLiveCounterCash=0;

    const pins=Array.from($('pinInput').querySelectorAll('input'));
    pins.forEach((input,i)=>{
      input.addEventListener('input',e=>{
        const v=e.target.value;
        if(v){input.classList.add('filled');if(i<3)pins[i+1].focus();else checkPin();}
        else input.classList.remove('filled');
      });
      input.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!e.target.value&&i>0){pins[i-1].focus();pins[i-1].value='';pins[i-1].classList.remove('filled');}});
    });

    async function checkPin(){
      const pin=pins.map(p=>p.value).join('');
      if(pin.length!==4)return;
      try{
        const res=await fetch('/api/settlement?action=verify-pin&pin='+pin);
        const data=await res.json();
        if(data.success){
          currentUser=data.user;
          $('pinSuccess').textContent='‚úì Welcome, '+data.user;
          $('pinSuccess').classList.add('show');
          $('userName').textContent=data.user;
          setTimeout(()=>{
            $('pinScreen').classList.add('hidden');
            $('dashboard').classList.add('show');
            renderRunners();
            loadCashAtCounter();
            loadShiftReconciliation();
            loadDiscrepancies();
            loadShiftHistory();
            loadShiftHistoryV2();
          },800);
        }else{
          pins.forEach(p=>{p.value='';p.classList.remove('filled');p.style.borderColor='var(--red)';});
          setTimeout(()=>pins.forEach(p=>p.style.borderColor=''),500);
          pins[0].focus();
        }
      }catch(e){console.error(e);}
    }

    function logout(){
      currentUser=null;selectedRunner=null;
      $('dashboard').classList.remove('show');
      $('pinScreen').classList.remove('hidden');
      $('pinSuccess').classList.remove('show');
      $('collectionPanel').classList.remove('show');
      $('counterBalanceReadonly').classList.remove('show');
      $('panel').classList.remove('show');
      $('shiftReconPanel').classList.remove('show');
      $('shiftHistoryPanel').classList.remove('show');
      $('discrepancyPanel').classList.remove('show');
      lastShiftReconData=null;
      pins.forEach(p=>{p.value='';p.classList.remove('filled');});
      pins[0].focus();
    }

    function renderRunners(){
      // "End My Shift" CTA at the top
      let html='<div class="runner-card shift-card" onclick="startShiftWizard()"><div class="name">üèÅ End My Shift</div><div class="code">Settle All</div></div>';
      html+=RUNNERS.map(r=>{
        const cls=r.isCounter?' counter':(r.isExpense?' expense':'');
        const idStr=typeof r.id==='string'?"'"+r.id+"'":r.id;
        return '<div class="runner-card'+cls+'" onclick="selectRunner('+idStr+',this)"><div class="name">'+r.name+'</div><div class="code">'+r.barcode+'</div></div>';
      }).join('');
      $('runnerGrid').innerHTML=html;
    }

    function toLocalISO(d){
      return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
    }
    const fmtD=(d)=>{const day=d.getDate().toString().padStart(2,'0');const mon=d.toLocaleString('en-IN',{month:'short'});const hr=d.getHours().toString().padStart(2,'0');const mn=d.getMinutes().toString().padStart(2,'0');return day+' '+mon+' '+hr+':'+mn;};
    const fmtDate=(d)=>{const day=d.getDate().toString().padStart(2,'0');const mon=d.toLocaleString('en-IN',{month:'short'});const yr=d.getFullYear();const hr=d.getHours().toString().padStart(2,'0');const mn=d.getMinutes().toString().padStart(2,'0');return day+' '+mon+' '+yr+', '+hr+':'+mn;};

    async function selectRunner(id,el){
      document.querySelectorAll('.runner-card').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      selectedRunner=RUNNERS.find(r=>r.id===id);
      $('panel').classList.add('show');

      if(id==='expense'){
        $('runnerName').textContent='üìù Record Expense';
        $('period').textContent='';
        loadExpensePanel();
      }else if(id==='counter'){
        $('runnerName').textContent=selectedRunner.name;
        $('period').textContent='Loading...';
        $('panelContent').innerHTML='<div class="loading-text">Checking last settlement...</div>';
        await loadCounterSettlement();
      }else{
        $('runnerName').textContent=selectedRunner.name;
        $('period').textContent='Loading...';
        $('panelContent').innerHTML='<div class="loading-text">Checking last settlement...</div>';
        await loadRunnerSettlement(id);
      }
    }

    // === EXPENSE PANEL ===
    function loadExpensePanel(){
      $('panelContent').innerHTML=
        '<div style="margin-bottom:16px;color:var(--text2);font-size:14px">Record cash given out from the counter for supplies, milk, etc.</div>'+
        '<div class="field-group"><label>Amount (‚Çπ)</label><input type="number" id="expenseAmount" class="expense-input" placeholder="e.g. 200" min="1" step="10" inputmode="numeric"></div>'+
        '<div class="field-group" style="margin-top:12px"><label>Reason</label><input type="text" id="expenseReason" class="expense-reason" placeholder="e.g. Milk, Sugar, Supplies"></div>'+
        '<button class="settle-btn" style="background:var(--red)" onclick="recordExpense()">Record Expense</button>';
    }

    async function recordExpense(){
      const amount=parseFloat(document.getElementById('expenseAmount')?.value||'0');
      const reason=(document.getElementById('expenseReason')?.value||'').trim();
      const btn=document.querySelector('.settle-btn');

      if(amount<=0){btn.textContent='Enter amount';btn.style.background='var(--red)';setTimeout(()=>{btn.textContent='Record Expense';},1500);return;}
      if(!reason){btn.textContent='Enter reason';btn.style.background='var(--red)';setTimeout(()=>{btn.textContent='Record Expense';},1500);return;}

      btn.disabled=true;btn.textContent='Recording...';

      try{
        const res=await fetch('/api/settlement?action=record-expense',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({recorded_by:currentUser,amount,reason})
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Expense Recorded!';btn.style.background='var(--green)';
          setTimeout(()=>{loadExpensePanel();loadCashAtCounter();},1500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // === MISSED EXPENSE (Naveen records on behalf of cashier) ===
    async function recordMissedExpense(){
      const amount=parseFloat(document.getElementById('missedExpAmount')?.value||'0');
      const reason=(document.getElementById('missedExpReason')?.value||'').trim();
      const cashier=document.getElementById('missedExpCashier')?.value||'';
      const btn=document.getElementById('missedExpBtn');

      if(amount<=0){btn.textContent='Enter amount';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}
      if(!reason){btn.textContent='Enter reason';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}
      if(!cashier){btn.textContent='Select cashier';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}

      btn.disabled=true;btn.textContent='Recording...';

      try{
        const res=await fetch('/api/settlement?action=record-expense',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({recorded_by:currentUser,amount,reason,attributed_to:cashier,notes:'Missed expense recorded by '+currentUser})
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Expense Recorded!';btn.style.background='var(--green)';
          setTimeout(()=>loadCashAtCounter(),1500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;}
    }

    // === COUNTER SETTLEMENT ===
    async function loadCounterSettlement(){
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id=counter');
        const lastData=await lastRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.periodStart?new Date(lastData.periodStart):baseline;
        currentPeriodStart=fromDate;
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo...</div>';
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        const mc=data.data.mainCounter;currentCounterData=mc;
        const vf=data.data.verification;const rc=data.data.runnerCounter;
        // Check for discrepancies at counter level
        const counterDisc=(data.data.discrepancies||[]).filter(d=>d.type==='token_issue_no_runner'||d.type==='runner_ledger_no_runner');
        const counterRevenue=mc.cash+mc.upi+mc.card;const cashToSettle=mc.cash;
        const hasLast=lastData.lastSettlement;
        const periodReason=lastData.periodReason;
        let statusBox='';
        if(periodReason==='last_collection'&&lastData.lastCollection){statusBox='<div class="info-box" style="background:rgba(234,179,8,0.1);border-color:var(--yellow);color:var(--yellow)">üì¶ Period reset by cash collection at '+fmtD(new Date(lastData.lastCollection.collected_at))+'</div>';}
        else if(hasLast){const who=hasLast.settled_by===currentUser?'You':hasLast.settled_by;statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+' (‚Çπ'+hasLast.cash_settled.toLocaleString('en-IN')+' cash)</div>';}
        else{statusBox='<div class="info-box">‚ö†Ô∏è Never settled. Showing from baseline (Feb 4, 5 PM).</div>';}

        // Build UPI verification box
        let verifyHtml='';
        if(vf){
          const ccOk=vf.cashCounter.status==='ok';const rcOk=vf.runnerCounter.status==='ok';
          const ccBadge=ccOk?'<span class="verify-badge ok">‚úì Verified</span>':'<span class="verify-badge warn">‚ö† ‚Çπ'+Math.abs(vf.cashCounter.variance)+' variance</span>';
          const rcBadge=rcOk?'<span class="verify-badge ok">‚úì Verified</span>':'<span class="verify-badge warn">‚ö† ‚Çπ'+Math.abs(vf.runnerCounter.variance)+' variance</span>';
          verifyHtml='<div class="verify-box"><div class="verify-title">üîç UPI Cross-Verification (Odoo ‚Üî Razorpay)</div>'+
            '<div class="verify-row"><span class="vr-label">Cash Counter UPI</span><span class="vr-val">Odoo: '+fmt(vf.cashCounter.odooUPI)+' | Razorpay: '+fmt(vf.cashCounter.razorpayUPI)+' '+ccBadge+'</span></div>'+
            '<div class="verify-row"><span class="vr-label">Runner Counter UPI</span><span class="vr-val">Odoo: '+fmt(vf.runnerCounter.odooUPI)+' | Razorpay: '+fmt(vf.runnerCounter.razorpayUPI)+' '+rcBadge+'</span></div>';
          if(!ccOk){
            const dir=vf.cashCounter.variance>0?'Odoo shows more UPI than Razorpay received ‚Äî possible cash recorded as UPI':'Razorpay received more than Odoo recorded ‚Äî possible missed UPI entry';
            verifyHtml+='<div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:12px;color:var(--red)">Cash Counter: '+dir+'</div>';
          }
          if(!rcOk){
            const dir=vf.runnerCounter.variance>0?'Odoo shows more UPI than Razorpay received ‚Äî possible runner sale recorded as UPI':'Razorpay received more than Odoo recorded ‚Äî possible missed order';
            verifyHtml+='<div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:12px;color:var(--red)">Runner Counter: '+dir+'</div>';
          }
          verifyHtml+='</div>';
        }

        // Runner Counter direct UPI info
        let rcHtml='';
        if(rc&&rc.upi>0){
          rcHtml='<div class="row" style="opacity:0.5"><span class="label">Runner Counter UPI (direct)</span><span class="value" style="color:var(--blue)">'+fmt(rc.upi)+'</span></div>';
        }

        let settleBtn='';
        const shiftBadge=buildShiftHealthBadge();
        if(counterRevenue>0){settleBtn=shiftBadge+'<button class="settle-btn counter-btn" onclick="settleCounter()">‚úì Settle '+fmt(cashToSettle)+' Cash</button>';}
        if(counterRevenue>0||hasLast){
          $('panelContent').innerHTML=
            '<div class="row"><span class="label">Counter Revenue</span><span class="value">'+fmt(counterRevenue)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ Cash</span><span class="value">'+fmt(mc.cash)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ UPI (to bank)</span><span class="value" style="color:var(--blue)">'+fmt(mc.upi)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ Card (to bank)</span><span class="value" style="color:var(--blue)">'+fmt(mc.card)+'</span></div>'+
            '<div class="row" style="opacity:0.5"><span class="label">Token Issue (‚Üí Runners)</span><span class="value">'+fmt(mc.tokenIssue)+'</span></div>'+
            '<div class="row" style="opacity:0.5"><span class="label">Complimentary</span><span class="value">'+fmt(mc.complimentary)+'</span></div>'+
            rcHtml+
            '<div class="row total"><span class="label">Cash to Settle</span><span class="value" style="color:var(--orange)">'+fmt(cashToSettle)+'</span></div>'+
            (counterDisc.length>0?'<div class="discrepancy-list">'+counterDisc.map(d=>'<div class="discrepancy-item '+(d.severity==='critical'?'critical':'warning')+'"><span class="di-icon">'+(d.severity==='critical'?'üö®':'‚ö†Ô∏è')+'</span><span class="di-text">'+d.message+'</span></div>').join('')+'</div>':'')+
            verifyHtml+statusBox+settleBtn;
        }else{
          if(hasLast){const who=hasLast.settled_by===currentUser?'you':hasLast.settled_by;$('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';}
          else{$('panelContent').innerHTML='<div class="loading-text">No counter activity</div>';}
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }

    // === RUNNER SETTLEMENT ===
    async function loadRunnerSettlement(id){
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id='+id);
        const lastData=await lastRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.periodStart?new Date(lastData.periodStart):baseline;
        currentPeriodStart=fromDate;
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo & Razorpay...</div>';
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();if(!data.success)throw new Error(data.error);
        const runner=data.data.runners.find(r=>r.id===id);currentRunnerData=runner;
        const hasLast=lastData.lastSettlement;const hasActivity=runner&&(runner.tokens>0||runner.sales>0||runner.upi>0);
        const periodReason=lastData.periodReason;
        // Check for discrepancies affecting this runner
        const disc=data.data.discrepancies||[];
        const runnerDisc=disc.filter(d=>d.runner===selectedRunner.name||d.type==='runner_ledger_no_runner');
        let discHtml='';
        if(runnerDisc.length>0){
          discHtml='<div class="discrepancy-list">';
          for(const d of runnerDisc){
            const cls=d.severity==='critical'?'critical':'warning';
            const icon=d.severity==='critical'?'üö®':'‚ö†Ô∏è';
            discHtml+='<div class="discrepancy-item '+cls+'"><span class="di-icon">'+icon+'</span><span class="di-text">'+d.message+'</span></div>';
          }
          discHtml+='</div>';
        }
        let statusBox='';
        if(periodReason==='last_collection'&&lastData.lastCollection){statusBox='<div class="info-box" style="background:rgba(234,179,8,0.1);border-color:var(--yellow);color:var(--yellow)">üì¶ Period reset by cash collection at '+fmtD(new Date(lastData.lastCollection.collected_at))+'</div>';}
        else if(hasLast){const who=hasLast.settled_by===currentUser?'You':hasLast.settled_by;statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+' (‚Çπ'+hasLast.cash_settled.toLocaleString('en-IN')+' cash)</div>';}
        else{statusBox='<div class="info-box">‚ö†Ô∏è Never settled. Showing from baseline (Feb 4, 5 PM).</div>';}
        if(hasActivity){
          const baseCash=runner.cashToCollect;currentRunnerData=runner;
          // Unsold token input: only show if runner has tokens
          let unsoldHtml='';
          if(runner.tokens>0){
            unsoldHtml='<div class="unsold-input-box">'+
              '<label>Unsold Tokens Returned (‚Çπ amount)</label>'+
              '<input type="number" id="unsoldTokensInput" min="0" max="'+runner.tokens+'" value="0" step="10" inputmode="numeric" oninput="recalcRunnerCash()">'+
              '<div class="hint">Enter the ‚Çπ value of unsold tokens the runner is returning. Max: '+fmt(runner.tokens)+'</div>'+
            '</div>'+
            '<div class="row" id="effectiveTokensRow"><span class="label">Effective Tokens Sold</span><span class="value" id="effectiveTokensVal">'+fmt(runner.tokens)+'</span></div>';
          }
          const cashColor=baseCash>=0?'var(--green)':'var(--red)';
          const runnerShiftBadge=buildShiftHealthBadge();
          let settleBtn='';
          if(baseCash>0){settleBtn=runnerShiftBadge+'<button class="settle-btn" id="settleRunnerBtn" onclick="settleRunner()">‚úì Settle '+fmt(baseCash)+' Cash</button>';}
          else if(baseCash<0){settleBtn='<div class="info-box" style="background:rgba(59,130,246,0.1);border-color:var(--blue);color:var(--blue)">Runner collected more UPI than sales - verify before settling</div>'+runnerShiftBadge+'<button class="settle-btn" id="settleRunnerBtn" style="background:var(--blue)" onclick="settleRunner()">‚úì Confirm Settlement</button>';}
          else{settleBtn=runnerShiftBadge+'<button class="settle-btn" id="settleRunnerBtn" onclick="settleRunner()">‚úì Mark as Settled (‚Çπ0 cash)</button>';}
          // Cross-payment credit display (blue, informational ‚Äî NOT error)
          let crossPayHtml='';
          if(runner.crossPaymentCredit>0){
            crossPayHtml+='<div style="background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.2);border-radius:10px;padding:12px;margin:8px 0">';
            crossPayHtml+='<div class="row" style="margin:0"><span class="label" style="color:var(--blue)">‚úì Cross-Payment Credit</span><span class="value" style="color:var(--blue)">-'+fmt(runner.crossPaymentCredit)+'</span></div>';
            crossPayHtml+='<div style="padding:4px 0 0 0;font-size:12px;color:var(--text2)">';
            for(const cp of (runner.crossPayments||[])){
              if(cp.orderName){crossPayHtml+='<div style="padding:2px 0">‚úì '+cp.orderName+': Customer paid via '+cp.paidViaLabel+'</div>';}
            }
            crossPayHtml+='<div style="color:var(--blue);margin-top:4px">No cash owed for these orders ‚Äî payment verified via Razorpay</div>';
            crossPayHtml+='</div></div>';
          }
          // Probable cross-QR notice (heuristic, informational)
          const probableCPs=(runner.crossPayments||[]).filter(cp=>cp.isProbable);
          let probableHtml='';
          if(probableCPs.length>0){
            probableHtml='<div style="background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);border-radius:10px;padding:12px;margin:8px 0">';
            probableHtml+='<div style="font-weight:600;color:var(--blue);font-size:13px;margin-bottom:4px">‚ÑπÔ∏è Possible Cross-QR Payment</div>';
            for(const cp of probableCPs){probableHtml+='<div style="font-size:12px;color:var(--text2);padding:2px 0">‚Çπ'+cp.amount+' may have been paid on '+cp.paidViaLabel+'</div>';}
            probableHtml+='<div style="font-size:11px;color:var(--blue);margin-top:6px">Confirm with runner if needed</div></div>';
          }
          $('panelContent').innerHTML='<div class="row"><span class="label">Tokens Issued (Chai)</span><span class="value">'+fmt(runner.tokens)+'</span></div>'+unsoldHtml+'<div class="row"><span class="label">Sales Made (Snacks)</span><span class="value">'+fmt(runner.sales)+'</span></div><div class="row"><span class="label">UPI Collected (Razorpay)</span><span class="value" style="color:var(--blue)">'+fmt(runner.upi)+'</span></div>'+crossPayHtml+'<div class="row total"><span class="label">Cash to Collect</span><span class="value" id="cashToCollectVal" style="color:'+cashColor+'">'+fmt(baseCash)+'</span></div>'+discHtml+probableHtml+statusBox+settleBtn;
        }else{
          if(hasLast){const who=hasLast.settled_by===currentUser?'you':hasLast.settled_by;$('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';}
          else{$('panelContent').innerHTML='<div class="loading-text">No activity for this runner</div>';}
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }

    async function settleRunner(){
      if(!selectedRunner||!currentRunnerData)return;
      const unsoldInput=document.getElementById('unsoldTokensInput');
      const unsoldTokens=unsoldInput?parseFloat(unsoldInput.value)||0:0;
      const effectiveCash=currentRunnerData.cashToCollect-unsoldTokens;
      const sr=lastShiftReconData;
      const bc=sr?sr.balanceCheck:null;
      const discCount=currentMisattributed.length;
      // Build rows
      const rows=[{label:'Period',value:$('period').textContent}];
      if(currentRunnerData.tokens>0){
        rows.push({label:'Tokens Issued',value:fmt(currentRunnerData.tokens)});
        if(unsoldTokens>0){
          rows.push({label:'Unsold Returned',value:'-'+fmt(unsoldTokens),color:'var(--orange)'});
          rows.push({label:'Effective Tokens',value:fmt(currentRunnerData.tokens-unsoldTokens)});
        }
      }
      rows.push({label:'Sales (Snacks)',value:fmt(currentRunnerData.sales)});
      rows.push({label:'UPI Collected',value:fmt(currentRunnerData.upi),color:'var(--blue)'});
      if(currentRunnerData.crossPaymentCredit>0){rows.push({label:'Cross-Payment Credit',value:'-'+fmt(currentRunnerData.crossPaymentCredit),color:'var(--blue)'});}
      rows.push({label:'Cash to Collect',value:fmt(effectiveCash),color:effectiveCash>=0?'var(--green)':'var(--red)'});
      // Checks
      const checks=[];
      if(bc){
        if(bc.isBalanced){checks.push({icon:'‚úÖ',label:'Shift Balance',status:'BALANCED',cls:'ok'});}
        else{checks.push({icon:Math.abs(bc.variance)<=50?'‚ö†Ô∏è':'üö®',label:'Shift Balance',status:'‚Çπ'+Math.abs(bc.variance)+' variance',cls:Math.abs(bc.variance)<=50?'warn':'bad'});}
      }
      checks.push({icon:discCount===0?'‚úÖ':'‚ö†Ô∏è',label:'Discrepancies',status:discCount===0?'None':discCount+' unfixed',cls:discCount===0?'ok':'warn'});
      let warning='';
      if(effectiveCash<0)warning='Runner owes less than UPI collected ‚Äî verify before confirming.';
      showConfirmDialog({
        title:'üìã Confirm '+selectedRunner.name+' Settlement',
        rows,checks,warning:warning||null,amount:effectiveCash,btnColor:'var(--green)',
        onConfirm:()=>doSettleRunner(unsoldTokens,effectiveCash)
      });
    }

    async function doSettleRunner(unsoldTokens,effectiveCash){
      const btn=document.getElementById('settleRunnerBtn')||document.querySelector('.settle-btn');
      if(btn){btn.disabled=true;btn.classList.add('loading');btn.textContent='Recording settlement...';}
      try{
        const now=new Date();
        const notesParts=[];
        if(unsoldTokens>0)notesParts.push('Unsold tokens: '+fmt(unsoldTokens));
        if(currentRunnerData.crossPaymentCredit>0)notesParts.push('Cross-payment credit: '+fmt(currentRunnerData.crossPaymentCredit)+' ('+currentRunnerData.crossPayments.length+' orders paid via other channels)');
        const res=await fetch('/api/settlement?action=settle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({runner_id:selectedRunner.id,runner_name:selectedRunner.name,settled_by:currentUser,period_start:toLocalISO(currentPeriodStart),period_end:toLocalISO(now),tokens_amount:currentRunnerData.tokens,sales_amount:currentRunnerData.sales,upi_amount:currentRunnerData.upi,cash_settled:effectiveCash,unsold_tokens:unsoldTokens,notes:notesParts.length>0?notesParts.join('; '):'Settled via dashboard'})});
        const data=await res.json();
        if(data.success){if(btn){btn.textContent='‚úì Settlement Recorded!';btn.style.background='var(--green)';}setTimeout(()=>{const card=document.querySelector('.runner-card.selected');if(card)selectRunner(selectedRunner.id,card);loadCashAtCounter();loadShiftReconciliation();loadDiscrepancies();loadShiftHistory();},1500);}
        else{throw new Error(data.error);}
      }catch(e){if(btn){btn.disabled=false;btn.classList.remove('loading');btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}}
    }

    function recalcRunnerCash(){
      if(!currentRunnerData)return;
      const unsoldInput=document.getElementById('unsoldTokensInput');
      const unsold=unsoldInput?parseFloat(unsoldInput.value)||0:0;
      // Validate
      if(unsold>currentRunnerData.tokens){unsoldInput.value=currentRunnerData.tokens;return recalcRunnerCash();}
      if(unsold<0){unsoldInput.value=0;return recalcRunnerCash();}
      // Update effective tokens
      const effectiveTokens=currentRunnerData.tokens-unsold;
      const effEl=document.getElementById('effectiveTokensVal');
      if(effEl)effEl.textContent=fmt(effectiveTokens);
      // Update cash to collect
      const newCash=currentRunnerData.cashToCollect-unsold;
      const cashEl=document.getElementById('cashToCollectVal');
      if(cashEl){cashEl.textContent=fmt(newCash);cashEl.style.color=newCash>=0?'var(--green)':'var(--red)';}
      // Update settle button
      const btn=document.getElementById('settleRunnerBtn');
      if(btn){
        if(newCash>0){btn.textContent='‚úì Settle '+fmt(newCash)+' Cash';btn.style.background='var(--green)';}
        else if(newCash===0){btn.textContent='‚úì Mark as Settled (‚Çπ0 cash)';btn.style.background='var(--green)';}
        else{btn.textContent='‚úì Confirm Settlement';btn.style.background='var(--blue)';}
      }
    }

    // ========== SHIFT HEALTH BADGE ==========
    function buildShiftHealthBadge(){
      if(!lastShiftReconData)return '';
      const sr=lastShiftReconData;
      const bc=sr.balanceCheck;
      const discCount=currentMisattributed.length;
      // Shift balance check
      let balCls='ok',balText='‚úÖ Balanced';
      if(!bc.isBalanced){
        if(Math.abs(bc.variance)<=50){balCls='warn';balText='‚ö†Ô∏è ‚Çπ'+Math.abs(bc.variance)+' variance';}
        else{balCls='bad';balText='üö® ‚Çπ'+Math.abs(bc.variance)+' variance';}
      }
      // UPI check
      let upiCls='ok',upiText='‚úÖ UPI Verified';
      if(sr.verifiedUPI){
        const ccVar=Math.abs((sr.verifiedUPI.counterQR||0)-(sr.verifiedUPI.counterQR||0));
        // Check from the raw verification data if available
      }
      // Discrepancy check
      let discCls='ok',discText='‚úÖ 0 issues';
      if(discCount>0){discCls=discCount>2?'bad':'warn';discText='‚ö†Ô∏è '+discCount+' issue'+(discCount>1?'s':'');}
      return '<div class="shift-health">'+
        '<div class="sh-item '+balCls+'">Shift: '+balText+'</div>'+
        '<div class="sh-item '+upiCls+'">'+upiText+'</div>'+
        '<div class="sh-item '+discCls+'">Discrepancies: '+discText+'</div>'+
      '</div>';
    }

    // ========== CONFIRMATION DIALOG ==========
    function showConfirmDialog(opts){
      // opts: {title, rows:[{label,value,color}], checks:[{icon,label,status,cls}], warning, amount, onConfirm, btnColor}
      const overlay=document.createElement('div');
      overlay.className='confirm-overlay';
      let rowsHtml=opts.rows.map(r=>'<div class="confirm-row"><span class="cr-label">'+r.label+'</span><span class="cr-val"'+(r.color?' style="color:'+r.color+'"':'')+'>'+(r.value||'')+'</span></div>').join('');
      let checksHtml='';
      if(opts.checks&&opts.checks.length>0){
        checksHtml='<div class="confirm-checks">'+
          opts.checks.map(c=>'<div class="confirm-check"><span class="cc-icon">'+c.icon+'</span><span class="cc-label">'+c.label+'</span><span class="cc-status '+c.cls+'">'+c.status+'</span></div>').join('')+
        '</div>';
      }
      let warnHtml=opts.warning?'<div class="confirm-warn">‚ö†Ô∏è '+opts.warning+'</div>':'';
      overlay.innerHTML='<div class="confirm-dialog">'+
        '<h3>'+opts.title+'</h3>'+rowsHtml+checksHtml+warnHtml+
        '<div class="confirm-buttons">'+
          '<button class="cancel-btn" onclick="this.closest(\'.confirm-overlay\').remove()">Cancel</button>'+
          '<button class="settle-btn" style="margin:0;background:'+(opts.btnColor||'var(--green)')+'" id="confirmSettleBtn">‚úì Confirm '+fmt(opts.amount)+'</button>'+
        '</div></div>';
      document.body.appendChild(overlay);
      overlay.querySelector('#confirmSettleBtn').addEventListener('click',()=>{overlay.remove();opts.onConfirm();});
      overlay.addEventListener('click',(e)=>{if(e.target===overlay)overlay.remove();});
    }

    async function settleCounter(){
      if(!currentCounterData)return;
      const cashToSettle=currentCounterData.cash;
      const sr=lastShiftReconData;
      const bc=sr?sr.balanceCheck:null;
      const discCount=currentMisattributed.length;
      // Build checks
      const checks=[];
      if(bc){
        if(bc.isBalanced){checks.push({icon:'‚úÖ',label:'Shift Balance',status:'BALANCED',cls:'ok'});}
        else if(Math.abs(bc.variance)<=50){checks.push({icon:'‚ö†Ô∏è',label:'Shift Balance',status:'‚Çπ'+Math.abs(bc.variance)+' variance',cls:'warn'});}
        else{checks.push({icon:'üö®',label:'Shift Balance',status:'‚Çπ'+Math.abs(bc.variance)+' variance',cls:'bad'});}
      }
      checks.push({icon:discCount===0?'‚úÖ':'‚ö†Ô∏è',label:'Discrepancies',status:discCount===0?'None':discCount+' unfixed',cls:discCount===0?'ok':'warn'});
      // Warning if shift not balanced
      let warning='';
      if(bc&&!bc.isBalanced)warning='Settling with ‚Çπ'+Math.abs(bc.variance)+' shift variance.';
      if(discCount>0)warning+=(warning?' ':'')+'There are '+discCount+' unfixed discrepancies.';
      showConfirmDialog({
        title:'üìã Confirm Counter Settlement',
        rows:[
          {label:'Period',value:$('period').textContent},
          {label:'Cash Sales',value:fmt(currentCounterData.cash)},
          {label:'UPI (to bank)',value:fmt(currentCounterData.upi),color:'var(--blue)'},
          {label:'Card (to bank)',value:fmt(currentCounterData.card),color:'var(--blue)'},
          {label:'Token Issue (‚Üí Runners)',value:fmt(currentCounterData.tokenIssue),color:'var(--text2)'},
          {label:'Complimentary',value:fmt(currentCounterData.complimentary),color:'var(--text2)'},
          {label:'Cash to Settle',value:fmt(cashToSettle),color:'var(--orange)'}
        ],
        checks,warning:warning||null,amount:cashToSettle,btnColor:'var(--orange)',
        onConfirm:doSettleCounter
      });
    }

    async function doSettleCounter(){
      const btn=document.querySelector('.settle-btn');if(btn){btn.disabled=true;btn.classList.add('loading');btn.textContent='Recording settlement...';}
      try{
        const now=new Date();const cashToSettle=currentCounterData.cash;
        const res=await fetch('/api/settlement?action=settle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({runner_id:'counter',runner_name:'Cash Counter',settled_by:currentUser,period_start:toLocalISO(currentPeriodStart),period_end:toLocalISO(now),tokens_amount:0,sales_amount:currentCounterData.cash+currentCounterData.upi+currentCounterData.card,upi_amount:currentCounterData.upi+currentCounterData.card,cash_settled:cashToSettle,notes:'Counter settlement - Cash:'+currentCounterData.cash+' UPI:'+currentCounterData.upi+' Card:'+currentCounterData.card})});
        const data=await res.json();
        if(data.success){if(btn){btn.textContent='‚úì Settlement Recorded!';btn.style.background='var(--green)';}setTimeout(()=>{const card=document.querySelector('.runner-card.selected');if(card)selectRunner('counter',card);loadCashAtCounter();loadShiftReconciliation();loadShiftHistory();},1500);}
        else{throw new Error(data.error);}
      }catch(e){if(btn){btn.disabled=false;btn.classList.remove('loading');btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}}
    }

    // ========== EXPENSE ATTRIBUTION HELPER ==========
    function buildExpenseAttribution(expenses){
      if(!expenses||expenses.length===0)return '';
      const byPerson={};
      for(const e of expenses){
        const who=e.recorded_by||'Unknown';
        if(!byPerson[who])byPerson[who]={total:0,count:0};
        byPerson[who].total+=e.amount;
        byPerson[who].count++;
      }
      let html='';
      for(const [who,data] of Object.entries(byPerson)){
        html+='<div class="expense-attr">'+who+': -'+fmt(data.total)+' ('+data.count+' item'+(data.count>1?'s':'')+')</div>';
      }
      return html;
    }

    // ========== CASH AT COUNTER / COLLECTION ==========
    async function loadCashAtCounter(){
      const isCollector=COLLECTORS.includes(currentUser);
      try{
        const baseline=new Date(2026,1,4,17,0,0);
        // Fetch D1 balance, counter period, and collection history in parallel
        const [balRes,counterPeriodRes,histRes]=await Promise.all([
          fetch('/api/settlement?action=counter-balance'),
          fetch('/api/settlement?action=get-last-settlement&runner_id=counter'),
          fetch('/api/settlement?action=collection-history&limit=5')
        ]);
        const data=await balRes.json();if(!data.success)throw new Error(data.error);
        const bal=data.balance;const lastCol=data.lastCollection;
        const counterPeriod=await counterPeriodRes.json();

        // Counter's own period: unsettled counter cash starts from here
        const counterFrom=counterPeriod.periodStart?new Date(counterPeriod.periodStart):baseline;

        // Fetch live Odoo counter cash from counter's period (unsettled cash only)
        const odooRes=await fetch('/api/nch-data?from='+toLocalISO(counterFrom));
        const odooData=await odooRes.json();
        let liveCounterCash=0;
        if(odooData.success){liveCounterCash=odooData.data.mainCounter.cash||0;}
        currentLiveCounterCash=liveCounterCash;

        // Total cash at counter = petty + runner settlements + settled counter cash + UNSETTLED counter cash - expenses
        const totalCash=bal.pettyCash+bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;
        currentCounterTotal=totalCash;

        if(isCollector){
          $('counterBalanceReadonly').classList.remove('show');
          $('collectionPanel').classList.add('show');
          let sinceText='Since baseline (Feb 4)';
          if(lastCol){sinceText='Since last collection by '+lastCol.collected_by+' on '+fmtDate(new Date(lastCol.collected_at));}

          // New cash = runner settlements + settled counter + unsettled counter cash - expenses
          const newCash=bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;

          // Settlement list (runner settlements from D1)
          let slHtml='';
          if(bal.settlements.length>0){
            slHtml='<div class="settlement-list">';
            for(const s of bal.settlements){const t=new Date(s.settled_at);const source=s.runner_id==='counter'?'Counter':s.runner_name;slHtml+='<div class="sl-item"><span class="sl-who">'+source+' ‚Äî '+s.settled_by+' '+fmtD(t)+'</span><span class="sl-amount">'+fmt(s.cash_settled)+'</span></div>';}
            slHtml+='</div>';
          }
          // Expense list
          let expHtml='';
          if(bal.expenses&&bal.expenses.length>0){
            expHtml='<div class="settlement-list" style="margin-top:8px">';
            for(const e of bal.expenses){const t=new Date(e.recorded_at);const attr=e.attributed_to?' (by '+e.attributed_to+')':'';expHtml+='<div class="sl-item"><span class="sl-who" style="color:var(--red)">Expense: '+e.reason+attr+' ‚Äî '+e.recorded_by+' '+fmtD(t)+'</span><span class="sl-amount" style="color:var(--red)">-'+fmt(e.amount)+'</span></div>';}
            expHtml+='</div>';
          }

          // Collection history
          let histHtml='';
          const histData=await histRes.json();
          if(histData.success&&histData.collections.length>0){
            histHtml='<div class="collection-history"><h4>Recent Collections</h4>';
            for(const c of histData.collections){
              const cd=new Date(c.collected_at);
              let dl='By '+c.collected_by+' ‚Äî Collected: '+fmt(c.amount);
              if(c.expenses>0)dl+=' | Expenses: '+fmt(c.expenses);
              if(c.petty_cash>0)dl+=' | Left behind: '+fmt(c.petty_cash);
              if(c.discrepancy&&c.discrepancy!==0){const dc=c.discrepancy>0?'var(--red)':'var(--green)';const dl2=c.discrepancy>0?'Short':'Extra';dl+=' | <span style="color:'+dc+'">'+dl2+': '+fmt(Math.abs(c.discrepancy))+'</span>';}
              histHtml+='<div class="ch-item"><div class="ch-top"><span class="ch-amount">'+fmt(c.amount)+'</span><span class="ch-date">'+fmtDate(cd)+'</span></div><div class="ch-detail">'+dl+'</div></div>';
            }
            histHtml+='</div>';
          }

          // Missed expense section (Naveen can add expenses cashiers forgot to record)
          let missedExpenseHtml='<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px">'+
            '<div style="font-size:14px;font-weight:600;margin-bottom:4px;color:var(--red)">üìù Record Missed Expense</div>'+
            '<div style="font-size:12px;color:var(--text2);margin-bottom:12px">If a cashier forgot to record an expense, add it here before collecting</div>'+
            '<div class="field-group"><label>Amount (‚Çπ)</label><input type="number" id="missedExpAmount" class="expense-input" placeholder="e.g. 200" min="1" step="10" inputmode="numeric"></div>'+
            '<div class="field-group" style="margin-top:8px"><label>Reason</label><input type="text" id="missedExpReason" class="expense-reason" placeholder="e.g. Milk, Sugar, Supplies"></div>'+
            '<div class="field-group" style="margin-top:8px"><label>Which cashier gave this cash?</label><select id="missedExpCashier" style="width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;padding:10px">'+
            '<option value="">‚Äî Select Cashier ‚Äî</option>'+
            '<option value="Tanveer">Tanveer</option>'+
            '<option value="Md Kesmat">Md Kesmat</option>'+
            '<option value="Jafar">Jafar</option>'+
            '<option value="Yashwant">Yashwant</option>'+
            '<option value="Zoya">Zoya</option>'+
            '</select></div>'+
            '<button class="settle-btn" style="background:var(--red);margin-top:12px" id="missedExpBtn" onclick="recordMissedExpense()">Record Missed Expense</button></div>';

          // Collect section ‚Äî show if there's any cash at the counter
          let collectBtn='';
          if(totalCash>0){
            collectBtn='<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px"><div style="font-size:14px;font-weight:600;margin-bottom:12px">Collect Cash</div>'+
              '<div class="field-group"><label>How much cash are you taking?</label><input type="number" id="collectAmountInput" placeholder="Count and enter" min="0" step="50" oninput="updateCollectSummary()"></div>'+
              '<div id="collectSummary" style="margin-top:12px"></div>'+
              '<button class="collect-btn" id="collectBtn" onclick="collectCash()" disabled>Enter amount above</button></div>';
          }else{
            collectBtn='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì No cash pending collection</div>';
          }

          // Breakdown cards for new cash
          const totalCounterCash=bal.counterCash+liveCounterCash;
          let bdHtml='<div class="collection-breakdown">';
          bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</div><div class="cb-label">Runner Settlements</div></div>';
          bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--orange)">'+fmt(totalCounterCash)+'</div><div class="cb-label">Counter Cash</div></div>';
          if(bal.totalExpenses>0)bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</div><div class="cb-label">Expenses</div></div>';
          bdHtml+='</div>';

          // Physical cash card with full breakdown
          const displayCash=Math.max(0,totalCash);
          const totalCounterCashForBreakdown=bal.counterCash+liveCounterCash;
          let cardsHtml=
            '<div style="background:linear-gradient(135deg,rgba(234,179,8,0.15),rgba(234,179,8,0.05));border:1.5px solid var(--yellow);border-radius:14px;padding:20px;margin-bottom:16px">'+
              '<div style="text-align:center;margin-bottom:16px">'+
                '<div style="font-size:13px;color:var(--text2);margin-bottom:6px">üíµ Physical Cash at Counter</div>'+
                '<div style="font-size:44px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--yellow)">'+fmt(displayCash)+'</div>'+
                '<div style="font-size:12px;color:var(--text2);margin-top:4px">This is what you should count</div>'+
              '</div>'+
              (totalCash<0?'<div style="background:rgba(239,68,68,0.15);border:1px solid var(--red);border-radius:8px;padding:10px;font-size:12px;color:var(--red);text-align:center;margin-bottom:12px">‚ö†Ô∏è System expects less cash than zero ‚Äî check for unrecorded expenses or settlements</div>':'')+
              '<div style="border-top:1px solid rgba(234,179,8,0.2);padding-top:12px">'+
                '<div style="font-size:12px;color:var(--text2);margin-bottom:8px">üìä Breakdown</div>'+
                '<div class="cash-breakdown-row"><span class="cbr-label">Previous petty cash</span><span class="cbr-val" style="color:var(--yellow)">'+fmt(bal.pettyCash)+'</span></div>'+
                '<div class="cash-breakdown-row"><span class="cbr-label">+ Counter cash settled</span><span class="cbr-val">'+fmt(bal.counterCash)+'</span></div>'+
                '<div class="cash-breakdown-row"><span class="cbr-label">+ Unsettled drawer</span><span class="cbr-val">'+fmt(liveCounterCash)+'</span></div>'+
                '<div class="cash-breakdown-row"><span class="cbr-label">+ Runner cash settled</span><span class="cbr-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</span></div>'+
                (bal.totalExpenses>0?'<div class="cash-breakdown-row"><span class="cbr-label" style="color:var(--red)">‚àí Expenses</span><span class="cbr-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</span></div>'+buildExpenseAttribution(bal.expenses):'')+
                '<div class="cash-breakdown-row total"><span class="cbr-label">= Physical cash</span><span class="cbr-val" style="color:var(--yellow)">'+fmt(displayCash)+'</span></div>'+
              '</div>'+
            '</div>';

          $('collectionPanel').innerHTML=
            '<h3>üí∞ Cash Collection</h3><div class="subtitle">'+sinceText+'</div>'+
            cardsHtml+bdHtml+slHtml+expHtml+missedExpenseHtml+collectBtn+histHtml;

        }else{
          // Staff read-only view
          $('collectionPanel').classList.remove('show');
          $('counterBalanceReadonly').classList.add('show');
          let sinceText='';if(lastCol){sinceText='Since '+fmtDate(new Date(lastCol.collected_at));}
          const staffNewCash=bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;
          const staffTotalCounter=bal.counterCash+liveCounterCash;

          let breakdownHtml='<div class="bal-breakdown">';
          breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</div><div class="bb-label">Runner Cash</div></div>';
          breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--orange)">'+fmt(staffTotalCounter)+'</div><div class="bb-label">Counter Cash</div></div>';
          if(bal.totalExpenses>0){breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</div><div class="bb-label">Expenses</div></div>';}
          breakdownHtml+='</div>';

          const staffDisplayCash=Math.max(0,totalCash);
          $('counterBalanceReadonly').innerHTML=
            '<h3>üíµ Cash at Counter</h3>'+
            '<div style="text-align:center;margin-bottom:16px">'+
              '<div class="bal-amount">'+fmt(staffDisplayCash)+'</div>'+
              '<div class="bal-detail">Physical cash at counter</div>'+
            '</div>'+
            (totalCash<0?'<div style="background:rgba(239,68,68,0.15);border:1px solid var(--red);border-radius:8px;padding:10px;font-size:12px;color:var(--red);text-align:center;margin-bottom:12px">‚ö†Ô∏è System expects negative ‚Äî check expenses/settlements</div>':'')+
            '<div style="background:var(--bg2);border-radius:10px;padding:14px;margin-bottom:12px">'+
              '<div style="font-size:12px;color:var(--text2);margin-bottom:8px">üìä Breakdown</div>'+
              '<div class="cash-breakdown-row"><span class="cbr-label">Previous petty cash</span><span class="cbr-val" style="color:var(--yellow)">'+fmt(bal.pettyCash)+'</span></div>'+
              '<div class="cash-breakdown-row"><span class="cbr-label">+ Counter cash settled</span><span class="cbr-val">'+fmt(bal.counterCash)+'</span></div>'+
              '<div class="cash-breakdown-row"><span class="cbr-label">+ Unsettled drawer</span><span class="cbr-val">'+fmt(liveCounterCash)+'</span></div>'+
              '<div class="cash-breakdown-row"><span class="cbr-label">+ Runner cash settled</span><span class="cbr-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</span></div>'+
              (bal.totalExpenses>0?'<div class="cash-breakdown-row"><span class="cbr-label" style="color:var(--red)">‚àí Expenses</span><span class="cbr-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</span></div>'+buildExpenseAttribution(bal.expenses):'')+
              '<div class="cash-breakdown-row total"><span class="cbr-label">= Physical cash</span><span class="cbr-val" style="color:var(--yellow)">'+fmt(staffDisplayCash)+'</span></div>'+
            '</div>'+
            (sinceText?'<div class="bal-detail" style="margin-top:8px">'+sinceText+'</div>':'')+
            '<div class="bal-detail">'+bal.settlementCount+' settlement'+(bal.settlementCount!==1?'s':'')+' since last collection</div>';
        }
      }catch(e){console.error('Counter balance error:',e);}
    }

    function updateCollectSummary(){
      const collectAmt=parseFloat(document.getElementById('collectAmountInput')?.value||'0');
      const summaryEl=document.getElementById('collectSummary');
      const btn=document.getElementById('collectBtn');
      if(!summaryEl||!btn)return;

      // Total physical cash at counter
      const expected=currentCounterTotal;

      if(collectAmt<=0){summaryEl.innerHTML='';btn.disabled=true;btn.textContent='Enter amount above';return;}

      if(collectAmt>expected){
        // Taking more than expected ‚Äî flag it
        const over=collectAmt-expected;
        summaryEl.innerHTML=
          '<div style="background:var(--bg2);border-radius:10px;padding:14px;font-size:13px">'+
          '<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text2)">Total cash at counter</span><span style="font-family:JetBrains Mono,monospace">'+fmt(expected)+'</span></div>'+
          '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">You are taking</span><span style="font-family:JetBrains Mono,monospace">'+fmt(collectAmt)+'</span></div>'+
          '<div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px;margin-top:6px"><span style="color:var(--text2)">Left at counter (petty)</span><span style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--red)">‚Çπ0</span></div>'+
          '<div style="color:var(--red);font-weight:600;margin-top:8px">‚ö† Taking ‚Çπ'+over.toLocaleString('en-IN')+' more than system expected</div></div>';
        btn.disabled=false;
        btn.textContent='Confirm Collection ‚Äî Taking '+fmt(collectAmt);
        return;
      }

      // Remainder automatically becomes petty cash
      const remainder=expected-collectAmt;

      summaryEl.innerHTML=
        '<div style="background:var(--bg2);border-radius:10px;padding:14px;font-size:13px">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text2)">Total cash at counter</span><span style="font-family:JetBrains Mono,monospace">'+fmt(expected)+'</span></div>'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">You are taking</span><span style="font-family:JetBrains Mono,monospace">-'+fmt(collectAmt)+'</span></div>'+
        '<div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px;margin-top:6px"><span style="color:var(--yellow)">Left at counter (becomes petty cash)</span><span style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--yellow)">'+fmt(remainder)+'</span></div>'+
        '</div>';

      btn.disabled=false;
      btn.textContent='Confirm Collection ‚Äî Taking '+fmt(collectAmt);
    }

    async function collectCash(){
      const btn=document.getElementById('collectBtn');if(!btn)return;
      btn.disabled=true;btn.textContent='Recording collection...';
      try{
        const collectAmt=parseFloat(document.getElementById('collectAmountInput')?.value||'0');
        if(collectAmt<=0){btn.disabled=false;btn.textContent='Enter the cash amount';btn.style.background='var(--red)';setTimeout(()=>{btn.style.background='';updateCollectSummary();},2000);return;}

        // Auto-calculate petty cash: whatever is left at the counter after collection
        const pettyCash=Math.max(0,currentCounterTotal-collectAmt);

        const res=await fetch('/api/settlement?action=collect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({collected_by:currentUser,amount:collectAmt,petty_cash:pettyCash,live_counter_cash:currentLiveCounterCash,notes:'Collected via dashboard'})});
        const data=await res.json();
        if(data.success){
          let msg='‚úì Collected '+fmt(collectAmt)+' ‚Äî ‚Çπ'+pettyCash.toLocaleString('en-IN')+' left as petty';
          btn.textContent=msg;btn.style.background='var(--green)';btn.style.color='#fff';
          setTimeout(()=>loadCashAtCounter(),2500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // ========== SHIFT RECONCILIATION ==========
    let lastShiftReconData=null;

    async function loadShiftReconciliation(){
      try{
        // Fetch active shift period (same logic as counter settlement)
        const periodRes=await fetch('/api/settlement?action=get-last-settlement&runner_id=counter');
        const periodData=await periodRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        const shiftFrom=periodData.periodStart?new Date(periodData.periodStart):baseline;
        const res=await fetch('/api/nch-data?from='+toLocalISO(shiftFrom));
        const data=await res.json();
        if(!data.success||!data.data.shiftReconciliation){$('shiftReconPanel').classList.remove('show');return;}
        const sr=data.data.shiftReconciliation;
        lastShiftReconData=sr;
        const bc=sr.balanceCheck;
        const panel=$('shiftReconPanel');
        panel.classList.add('show');
        panel.classList.remove('balanced','warning','critical');
        if(bc.isBalanced)panel.classList.add('balanced');
        else if(Math.abs(bc.variance)<=50)panel.classList.add('warning');
        else panel.classList.add('critical');

        const statusIcon=bc.isBalanced?'‚úÖ':Math.abs(bc.variance)<=50?'‚ö†Ô∏è':'üö®';
        const statusText=bc.isBalanced?'SHIFT BALANCED':bc.variance>0?'‚Çπ'+Math.abs(bc.variance)+' UNACCOUNTED':'‚Çπ'+Math.abs(bc.variance)+' EXTRA';
        const statusColor=bc.isBalanced?'var(--green)':Math.abs(bc.variance)<=50?'var(--yellow)':'var(--red)';

        const shiftPeriodLabel=fmtD(shiftFrom)+' ‚Üí Now';
        let html='<h3>'+statusIcon+' Shift Reconciliation</h3><div class="subtitle">'+shiftPeriodLabel+'</div>';
        html+='<div class="recon-equation">';
        html+='<div class="eq-main">Sales '+fmt(sr.totalSales)+' = Cash '+fmt(bc.expectedCash)+' + UPI '+fmt(sr.verifiedUPI.total)+' + Card '+fmt(sr.card)+' + Comp '+fmt(sr.complimentary)+'</div>';
        html+='<div class="eq-status" style="color:'+statusColor+'">'+statusText+'</div>';
        html+='</div>';

        // Cash breakdown
        html+='<div class="recon-section"><h4>Cash Breakdown</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter Drawer (Unsettled)</span><span class="rr-val">'+fmt(sr.cashBreakdown.counterDrawer)+'</span></div>';
        for(const r of sr.cashBreakdown.runnerCashObligations){
          if(r.tokens>0||r.sales>0||r.upi>0){
            const cpNote=r.crossPaymentCredit>0?' <span style="font-size:11px;color:var(--blue)">(incl. -'+fmt(r.crossPaymentCredit)+' credit)</span>':'';
            html+='<div class="recon-row"><span class="rr-label">'+r.name+' Cash Owed'+cpNote+'</span><span class="rr-val" style="color:'+(r.cashToCollect>=0?'var(--green)':'var(--red)')+'">'+fmt(r.cashToCollect)+'</span></div>';
          }
        }
        html+='<div class="recon-row total"><span class="rr-label">Total Expected Cash</span><span class="rr-val">'+fmt(bc.expectedCash)+'</span></div>';
        html+='</div>';

        // UPI breakdown
        html+='<div class="recon-section"><h4>UPI Breakdown (Razorpay Verified)</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.counterQR)+'</span></div>';
        html+='<div class="recon-row"><span class="rr-label">Runner Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.runnerCounterQR)+'</span></div>';
        for(const [barcode,amt] of Object.entries(sr.verifiedUPI.runnerQRs)){
          if(amt>0)html+='<div class="recon-row"><span class="rr-label">'+barcode+' QR</span><span class="rr-val">'+fmt(amt)+'</span></div>';
        }
        html+='<div class="recon-row total"><span class="rr-label">Total Verified UPI</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.total)+'</span></div>';
        html+='</div>';

        // Card + Comp
        if(sr.card>0||sr.complimentary>0){
          html+='<div class="recon-section"><h4>Other</h4>';
          if(sr.card>0)html+='<div class="recon-row"><span class="rr-label">Card</span><span class="rr-val">'+fmt(sr.card)+'</span></div>';
          if(sr.complimentary>0)html+='<div class="recon-row"><span class="rr-label">Complimentary</span><span class="rr-val" style="color:var(--text2)">'+fmt(sr.complimentary)+'</span></div>';
          html+='</div>';
        }

        // Variance sources ‚Äî explain WHY shift doesn't balance
        if(sr.varianceSources&&sr.varianceSources.length>0&&!bc.isBalanced){
          html+='<div class="recon-section"><h4>Variance Sources</h4>';
          for(const vs of sr.varianceSources){
            html+='<div class="variance-source">';
            html+='<span class="vs-label">'+(vs.fixable?'üîß':'üìä')+' '+vs.label+' ('+vs.count+')</span>';
            html+='<span class="vs-amount" style="color:'+(vs.fixable?'var(--orange)':'var(--red)')+'">'+fmt(Math.abs(vs.amount))+'</span>';
            if(vs.fixable)html+='<button class="vs-fix" onclick="document.getElementById(\'discrepancyPanel\').scrollIntoView({behavior:\'smooth\'})">Fix</button>';
            html+='</div>';
          }
          html+='</div>';
        }

        // Cross-payments (green confirmed, blue probable ‚Äî NOT errors)
        if(sr.crossPayments&&sr.crossPayments.length>0){
          const confirmed=sr.crossPayments.filter(cp=>!cp.isProbable);
          const probable=sr.crossPayments.filter(cp=>cp.isProbable);
          html+='<div class="recon-section"><h4>Cross-Payments</h4>';
          if(confirmed.length>0){
            html+='<div style="font-size:12px;color:var(--green);margin-bottom:8px">Confirmed ‚Äî orders paid via different QR channel:</div>';
            for(const cp of confirmed){
              html+='<div class="cross-payment-notice" style="border-color:rgba(34,197,94,0.3);background:rgba(34,197,94,0.05)">';
              html+='<div class="cpn-title" style="color:var(--green)">‚úì '+(cp.orderName||'Cross-QR')+' ‚Äî '+fmt(cp.amount)+'</div>';
              html+='<div class="cpn-item">'+cp.description+'</div>';
              html+='<div class="cpn-item" style="color:var(--green)">'+cp.runnerCashImpact+'</div>';
              html+='<div class="cpn-shift">'+cp.shiftImpact+'</div></div>';
            }
          }
          if(probable.length>0){
            html+='<div style="font-size:12px;color:var(--blue);margin:'+(confirmed.length>0?'12px':'0')+' 0 8px 0">Probable ‚Äî detected from Razorpay patterns:</div>';
            for(const cp of probable){
              html+='<div class="cross-payment-notice" style="border-color:rgba(59,130,246,0.3);background:rgba(59,130,246,0.05)">';
              html+='<div class="cpn-title" style="color:var(--blue)">‚ÑπÔ∏è Possible Cross-QR ‚Äî '+fmt(cp.amount)+'</div>';
              html+='<div class="cpn-item">'+cp.description+'</div></div>';
            }
          }
          html+='</div>';
        }

        panel.innerHTML=html;
      }catch(e){console.error('Shift recon error:',e);}
    }

    function getCrossPaymentsForRunner(runnerName){
      if(!lastShiftReconData||!lastShiftReconData.crossPayments)return[];
      return lastShiftReconData.crossPayments.filter(cp=>cp.runner===runnerName);
    }

    function renderCrossPaymentNotice(runnerName){
      const cps=getCrossPaymentsForRunner(runnerName);
      if(cps.length===0)return '';
      let html='<div class="cross-payment-notice"><div class="cpn-title">‚ö†Ô∏è Cross-Payment Notice</div>';
      for(const cp of cps){
        html+='<div class="cpn-item">'+cp.description+'</div><div class="cpn-item" style="color:var(--yellow)">'+cp.runnerCashImpact+'</div>';
      }
      html+='<div class="cpn-shift">Shift total is correct ‚Äî UPI covers this amount at the counter level.</div></div>';
      return html;
    }

    // ========== SHIFT HISTORY TRAIL ==========
    async function loadShiftHistory(){
      try{
        const res=await fetch('/api/settlement?action=history&limit=20');
        const data=await res.json();
        if(!data.success||!data.settlements||data.settlements.length===0){$('shiftHistoryPanel').classList.remove('show');return;}
        const panel=$('shiftHistoryPanel');
        panel.classList.add('show');
        let html='<h3>üìã Shift History</h3><div class="subtitle">Tap any shift to view full reconciliation</div>';
        for(const s of data.settlements){
          const pStart=new Date(s.period_start);
          const pEnd=new Date(s.period_end);
          const isCounter=s.runner_id==='counter'||s.runner_id===0;
          const typeBadge=isCounter?'Counter':'Runner';
          const typeIcon=isCounter?'üí∞':'üèÉ';
          html+='<div class="sh-card" onclick="toggleShiftDetail(this,\''+s.period_start+'\',\''+s.period_end+'\')">';
          html+='<div class="sh-card-header">';
          html+='<div><div class="sh-card-title">'+typeIcon+' '+(isCounter?'Counter Settlement':s.runner_name)+' ‚Üí '+s.settled_by+'</div>';
          html+='<div class="sh-card-time">'+fmtD(pStart)+' ‚Üí '+fmtD(pEnd)+'</div></div>';
          html+='<div style="text-align:right"><div style="font-size:18px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--green)">'+fmt(s.cash_settled)+'</div></div>';
          html+='</div>';
          html+='<div class="sh-card-meta">';
          if(s.tokens_amount>0)html+='<span>Tokens: '+fmt(s.tokens_amount)+'</span>';
          if(s.sales_amount>0)html+='<span>Sales: '+fmt(s.sales_amount)+'</span>';
          if(s.upi_amount>0)html+='<span>UPI: '+fmt(s.upi_amount)+'</span>';
          if(s.unsold_tokens>0)html+='<span style="color:var(--orange)">Returned: '+fmt(s.unsold_tokens)+'</span>';
          html+='</div>';
          html+='<div class="sh-card-detail" id="shd_'+s.id+'"><div class="loading-text">Tap to load full reconciliation...</div></div>';
          html+='</div>';
        }
        panel.innerHTML=html;
      }catch(e){console.error('Shift history error:',e);}
    }

    async function toggleShiftDetail(card,periodStart,periodEnd){
      const detail=card.querySelector('.sh-card-detail');
      if(!detail)return;
      if(detail.classList.contains('show')){detail.classList.remove('show');return;}
      // Close all other open details
      document.querySelectorAll('.sh-card-detail.show').forEach(d=>d.classList.remove('show'));
      detail.classList.add('show');
      // If already loaded, just show
      if(detail.dataset.loaded==='true')return;
      detail.innerHTML='<div class="loading-text">Loading from Odoo & Razorpay...</div>';
      try{
        const fromISO=toLocalISO(new Date(periodStart));
        const toISO=toLocalISO(new Date(periodEnd));
        const res=await fetch('/api/nch-data?from='+fromISO+'&to='+toISO);
        const data=await res.json();
        if(!data.success){detail.innerHTML='<div class="loading-text" style="color:var(--red)">Error loading data</div>';return;}
        const sr=data.data.shiftReconciliation;
        if(!sr){detail.innerHTML='<div class="loading-text">No reconciliation data for this period</div>';return;}
        const bc=sr.balanceCheck;
        const statusIcon=bc.isBalanced?'‚úÖ':Math.abs(bc.variance)<=50?'‚ö†Ô∏è':'üö®';
        const statusText=bc.isBalanced?'BALANCED':bc.variance>0?'‚Çπ'+Math.abs(bc.variance)+' UNACCOUNTED':'‚Çπ'+Math.abs(bc.variance)+' EXTRA';
        const statusColor=bc.isBalanced?'var(--green)':Math.abs(bc.variance)<=50?'var(--yellow)':'var(--red)';

        let html='<div class="recon-equation" style="margin-bottom:8px">';
        html+='<div class="eq-main">Sales '+fmt(sr.totalSales)+' = Cash '+fmt(bc.expectedCash)+' + UPI '+fmt(sr.verifiedUPI.total)+' + Card '+fmt(sr.card)+' + Comp '+fmt(sr.complimentary)+'</div>';
        html+='<div class="eq-status" style="color:'+statusColor+'">'+statusIcon+' '+statusText+'</div>';
        html+='</div>';

        // Cash breakdown
        html+='<div class="recon-section" style="padding:8px 0"><h4 style="font-size:12px">Cash Breakdown</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter Drawer</span><span class="rr-val">'+fmt(sr.cashBreakdown.counterDrawer)+'</span></div>';
        for(const r of sr.cashBreakdown.runnerCashObligations){
          if(r.tokens>0||r.sales>0||r.upi>0){
            const cpNote=r.crossPaymentCredit>0?' <span style="font-size:10px;color:var(--blue)">(-'+fmt(r.crossPaymentCredit)+' credit)</span>':'';
            html+='<div class="recon-row"><span class="rr-label">'+r.name+' Cash'+cpNote+'</span><span class="rr-val">'+fmt(r.cashToCollect)+'</span></div>';
          }
        }
        html+='</div>';

        // UPI breakdown
        html+='<div class="recon-section" style="padding:8px 0"><h4 style="font-size:12px">UPI (Razorpay)</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.counterQR)+'</span></div>';
        if(sr.verifiedUPI.runnerCounterQR>0)html+='<div class="recon-row"><span class="rr-label">Runner Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.runnerCounterQR)+'</span></div>';
        for(const [barcode,amt] of Object.entries(sr.verifiedUPI.runnerQRs)){
          if(amt>0)html+='<div class="recon-row"><span class="rr-label">'+barcode+'</span><span class="rr-val">'+fmt(amt)+'</span></div>';
        }
        html+='</div>';

        // Cross-payments
        if(sr.crossPayments&&sr.crossPayments.length>0){
          html+='<div class="recon-section" style="padding:8px 0"><h4 style="font-size:12px">Cross-Payments</h4>';
          for(const cp of sr.crossPayments){
            const color=cp.isProbable?'var(--blue)':'var(--green)';
            const icon=cp.isProbable?'‚ÑπÔ∏è':'‚úì';
            html+='<div class="recon-row"><span class="rr-label" style="color:'+color+'">'+icon+' '+(cp.orderName||'Cross-QR')+' ‚Üí '+cp.runner+'</span><span class="rr-val" style="color:'+color+'">'+fmt(cp.amount)+'</span></div>';
          }
          html+='</div>';
        }

        // Variance sources
        if(sr.varianceSources&&sr.varianceSources.length>0&&!bc.isBalanced){
          html+='<div class="recon-section" style="padding:8px 0"><h4 style="font-size:12px">Variance Sources</h4>';
          for(const vs of sr.varianceSources){
            html+='<div class="variance-source"><span class="vs-label">'+(vs.fixable?'üîß':'üìä')+' '+vs.label+'</span><span class="vs-amount" style="color:var(--red)">'+fmt(Math.abs(vs.amount))+'</span></div>';
          }
          html+='</div>';
        }

        detail.innerHTML=html;
        detail.dataset.loaded='true';
      }catch(e){
        detail.innerHTML='<div class="loading-text" style="color:var(--red)">Failed: '+e.message+'</div>';
      }
    }

    // ========== DISCREPANCY RECTIFICATION PANEL ==========
    let currentMisattributed=[];
    const RUNNER_OPTIONS=[
      {id:64,name:'FAROOQ'},{id:65,name:'AMIN'},
      {id:66,name:'NCH Runner 03'},{id:67,name:'NCH Runner 04'},{id:68,name:'NCH Runner 05'}
    ];

    async function loadDiscrepancies(){
      try{
        const now=new Date();const todayISO=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+'T00:00:00';
        const res=await fetch('/api/nch-data?from='+todayISO);
        const data=await res.json();
        if(!data.success)return;
        currentMisattributed=data.data.misattributedOrders||[];
        const panel=$('discrepancyPanel');
        if(currentMisattributed.length===0){panel.classList.remove('show');return;}
        panel.classList.add('show');

        let html='<h3>‚ö†Ô∏è Discrepancies <span class="badge-count">'+currentMisattributed.length+'</span></h3>';
        html+='<div class="subtitle">These orders have wrong or missing runner attribution. Fix them to make the shift math accurate.</div>';

        for(let i=0;i<currentMisattributed.length;i++){
          const m=currentMisattributed[i];
          const orderTime=m.date_order?new Date(m.date_order+'Z').toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Kolkata'}):'';
          const posLabel=m.config_id===27?'Cash Counter':'Runner Counter';
          const isAuto=m.auto_resolved;
          const isCritical=!isAuto;
          const pmNames={37:'Cash',38:'UPI',39:'Card',40:'Runner Ledger',48:'Token Issue',49:'Complimentary'};
          const pmLabel=(m.payment_methods||[]).map(id=>pmNames[id]||'PM'+id).join(', ');

          html+='<div class="rectify-card'+(isCritical?' critical':'')+'" id="rectCard'+i+'">';
          html+='<div class="rc-header"><span class="rc-order">'+(isCritical?'üö®':'‚ö†Ô∏è')+' '+m.order_name+' ‚Ä¢ '+posLabel+' ‚Ä¢ '+orderTime+'</span><span class="rc-amount">'+fmt(m.amount)+'</span></div>';
          html+='<div class="rc-detail">';
          html+='Payment: '+pmLabel+'<br>';
          if(isAuto){
            html+='Selected: "'+m.current_partner_name+'" (wrong contact)<br>';
            html+='Auto-detected: <strong>'+m.correct_runner_name+'</strong>';
          }else{
            html+='<span style="color:var(--red)">No runner was selected</span><br>';
            html+='Who received this order?';
          }
          html+='</div>';
          html+='<div class="rc-actions">';
          html+='<select id="rectSelect'+i+'">';
          if(!isAuto)html+='<option value="">‚Äî Select Runner ‚Äî</option>';
          for(const ro of RUNNER_OPTIONS){
            const sel=(isAuto&&m.correct_partner_id===ro.id)?' selected':'';
            html+='<option value="'+ro.id+'"'+sel+'>'+ro.name+'</option>';
          }
          html+='</select>';
          html+='<button class="rectify-btn" id="rectBtn'+i+'" onclick="rectifyOrder('+i+')">‚úì Fix in Odoo</button>';
          html+='</div></div>';
        }
        panel.innerHTML=html;
      }catch(e){console.error('Load discrepancies error:',e);}
    }

    async function rectifyOrder(idx){
      const m=currentMisattributed[idx];
      const selectEl=document.getElementById('rectSelect'+idx);
      const btn=document.getElementById('rectBtn'+idx);
      const card=document.getElementById('rectCard'+idx);
      if(!selectEl||!btn)return;

      const correctId=parseInt(selectEl.value);
      if(!correctId){btn.textContent='Select runner';setTimeout(()=>{btn.textContent='‚úì Fix in Odoo';},1500);return;}

      // Ask for PIN
      const pin=prompt('Enter your 4-digit PIN to confirm rectification:');
      if(!pin||pin.length!==4)return;

      btn.disabled=true;btn.textContent='Fixing...';

      try{
        const res=await fetch('/api/settlement?action=rectify-discrepancy',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            pin,
            order_id:m.order_id,
            order_name:m.order_name,
            correct_partner_id:correctId,
            original_partner_id:m.current_partner_id
          })
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Fixed!';btn.style.background='var(--green)';
          if(card)card.classList.add('fixed');
          // Refresh shift recon to show updated variance
          setTimeout(()=>{loadShiftReconciliation();},1000);
        }else{
          throw new Error(data.error);
        }
      }catch(e){
        btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';
        setTimeout(()=>{btn.textContent='‚úì Fix in Odoo';btn.style.background='';},3000);
      }
    }

    // ========== SHIFT WIZARD v2 ==========
    let wizardData=null, wizardStep=1, wizardCounterCashEntered=0, wizardRunnerInputs=[];

    async function startShiftWizard(){
      $('wizardContent').innerHTML='<div class="loading-text">Loading shift data...</div>';
      $('wizardOverlay').classList.add('show');
      wizardStep=1;
      updateWizardSteps();

      try{
        const baseline=new Date(2026,1,4,17,0,0);
        const runnerIds=[64,65,66,67,68];

        // Fetch counter + all runner periods in parallel
        const periodPromises=[
          fetch('/api/settlement?action=get-last-settlement&runner_id=counter').then(r=>r.json()),
          ...runnerIds.map(id=>fetch('/api/settlement?action=get-last-settlement&runner_id='+id).then(r=>r.json()))
        ];
        const periodResults=await Promise.all(periodPromises);
        const counterPeriod=periodResults[0];
        const runnerPeriods={};
        runnerIds.forEach((id,i)=>{runnerPeriods[id]=periodResults[i+1];});

        const shiftFrom=counterPeriod.periodStart?new Date(counterPeriod.periodStart):baseline;

        // Fetch main shift data from counter period (counter data is always correct)
        const res=await fetch('/api/nch-data?from='+toLocalISO(shiftFrom));
        const data=await res.json();
        if(!data.success) throw new Error(data.error||'Failed to load data');

        // Check for runners settled AFTER the counter period (mid-shift individual settlements)
        // These runners need fresh data from their own period, not the counter's
        const runnersNeedingRefresh=[];
        for(const id of runnerIds){
          const rp=runnerPeriods[id];
          if(rp.periodStart){
            const rpFrom=new Date(rp.periodStart);
            if(rpFrom>shiftFrom){
              runnersNeedingRefresh.push({id,from:rpFrom,periodStart:rp.periodStart});
            }
          }
        }

        // If any runners were individually settled mid-shift, re-fetch their data
        let runnerOverrides={};
        const midShiftRunnerIds=new Set(runnersNeedingRefresh.map(r=>r.id));
        if(runnersNeedingRefresh.length>0){
          const refreshPromises=runnersNeedingRefresh.map(r=>
            fetch('/api/nch-data?from='+toLocalISO(r.from)).then(res=>res.json()).then(d=>{
              if(d.success){
                const runner=d.data.runners.find(x=>x.id===r.id);
                if(runner){
                  runnerOverrides[r.id]=runner;
                }else{
                  // Runner had no activity after their mid-shift settlement ‚Äî zero out
                  runnerOverrides[r.id]={id:r.id,name:'',tokens:0,sales:0,upi:0,crossPaymentCredit:0,cashToCollect:0};
                }
              }
            })
          );
          await Promise.all(refreshPromises);
        }

        // Merge runner data: use overrides for mid-shift settled runners
        const mergedRunners=(data.data.runners||[]).map(r=>{
          if(midShiftRunnerIds.has(r.id)){
            // Always use override for mid-shift settled runners (even if zero activity)
            const override=runnerOverrides[r.id];
            if(override){
              if(!override.name) override.name=r.name; // preserve name from main data
              return override;
            }
            // Fetch failed ‚Äî zero out to be safe rather than show already-settled data
            return{...r,tokens:0,sales:0,upi:0,crossPaymentCredit:0,cashToCollect:0};
          }
          return r;
        });

        wizardData={
          shiftFrom,
          periodStart:toLocalISO(shiftFrom),
          mainCounter:data.data.mainCounter,
          runnerCounter:data.data.runnerCounter,
          runners:mergedRunners,
          verification:data.data.verification||{},
          shiftRecon:data.data.shiftReconciliation||{},
          crossPayments:data.data.crossPayments||[],
          discrepancies:data.data.discrepancies||[],
          misattributed:data.data.misattributedOrders||[],
          runnerPeriods:runnerPeriods,
          runnerOverrides:Object.keys(runnerOverrides).map(Number)
        };

        // Active runners = those with tokens, sales, or UPI activity
        wizardData.activeRunners=wizardData.runners.filter(r=>r.tokens>0||r.sales>0||r.upi>0);

        // Init runner inputs
        wizardRunnerInputs=wizardData.activeRunners.map(r=>({
          runner_id:r.id,
          runner_name:r.name,
          tokens:r.tokens,
          sales:r.sales,
          upi:r.upi,
          crossPaymentCredit:r.crossPaymentCredit||0,
          unsoldTokens:0,
          cashCalculated:Math.max(0,r.cashToCollect),
          cashCollected:Math.max(0,r.cashToCollect),
          userEdited:false,
          absent:false,
          midShiftSettled:wizardData.runnerOverrides.includes(r.id)
        }));

        renderWizardStep1();
      }catch(e){
        $('wizardContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';
      }
    }

    function closeWizard(){
      $('wizardOverlay').classList.remove('show');
      wizardData=null;wizardStep=1;wizardRunnerInputs=[];
    }

    function updateWizardSteps(){
      for(let i=1;i<=3;i++){
        const el=$('wizStep'+i);
        el.classList.remove('active','done');
        if(i===wizardStep) el.classList.add('active');
        else if(i<wizardStep) el.classList.add('done');
      }
    }

    function renderWizardStep1(){
      wizardStep=1;updateWizardSteps();
      const mc=wizardData.mainCounter;
      const v=wizardData.verification;
      const counterQRVar=(v.cashCounter?.variance)||0;
      const rcQRVar=(v.runnerCounter?.variance)||0;

      // UPI verification boxes
      let counterUpiHtml='';
      if(Math.abs(counterQRVar)<=1){
        counterUpiHtml='<div class="wizard-upi-box ok"><div class="upi-title"><span style="color:var(--green)">Cash Counter QR</span><span style="color:var(--green)">‚úÖ Verified</span></div><div class="upi-detail">Odoo: '+fmt(mc.upi)+' | Razorpay: '+fmt(v.cashCounter?.razorpay||mc.upi)+'</div></div>';
      }else{
        const dir=counterQRVar>0?'extra cash (recorded as UPI but was cash)':'less cash (UPI received but not in Odoo)';
        counterUpiHtml='<div class="wizard-upi-box warn"><div class="upi-title"><span style="color:var(--yellow)">Cash Counter QR</span><span style="color:var(--yellow)">‚ö†Ô∏è '+fmt(Math.abs(counterQRVar))+' variance</span></div><div class="upi-detail">Odoo: '+fmt(mc.upi)+' | Razorpay: '+fmt(v.cashCounter?.razorpay||0)+'<br>You may have '+fmt(Math.abs(counterQRVar))+' '+dir+'</div></div>';
      }

      let rcUpiHtml='';
      const rcOdoo=wizardData.runnerCounter?.upi||0;
      const rcRazorpay=v.runnerCounter?.razorpay||0;
      if(Math.abs(rcQRVar)<=1){
        rcUpiHtml='<div class="wizard-upi-box ok"><div class="upi-title"><span style="color:var(--green)">Runner Counter QR</span><span style="color:var(--green)">‚úÖ Verified</span></div><div class="upi-detail">Odoo: '+fmt(rcOdoo)+' | Razorpay: '+fmt(rcRazorpay)+'</div></div>';
      }else{
        const dir2=rcQRVar>0?'extra cash':'less cash';
        rcUpiHtml='<div class="wizard-upi-box warn"><div class="upi-title"><span style="color:var(--yellow)">Runner Counter QR</span><span style="color:var(--yellow)">‚ö†Ô∏è '+fmt(Math.abs(rcQRVar))+' variance</span></div><div class="upi-detail">Odoo: '+fmt(rcOdoo)+' | Razorpay: '+fmt(rcRazorpay)+'<br>You may have '+fmt(Math.abs(rcQRVar))+' '+dir2+'</div></div>';
      }

      const expectedCash=mc.cash||0;
      const shiftLabel=fmtD(wizardData.shiftFrom)+' ‚Üí Now';

      $('wizardContent').innerHTML=
        '<div class="wizard-step-content active" id="step1Content">'+
          '<div class="wizard-card"><h3>üìä Counter Sales Breakdown</h3>'+
            '<div style="font-size:12px;color:var(--text2);margin-bottom:12px">'+shiftLabel+'</div>'+
            '<div class="wizard-row"><span class="wr-label">Cash Sales (PM 37)</span><span class="wr-val">'+fmt(mc.cash)+'</span></div>'+
            '<div class="wizard-row"><span class="wr-label">UPI (to bank)</span><span class="wr-val" style="color:var(--blue)">'+fmt(mc.upi)+'</span></div>'+
            '<div class="wizard-row"><span class="wr-label">Card (to bank)</span><span class="wr-val" style="color:var(--blue)">'+fmt(mc.card)+'</span></div>'+
            '<div class="wizard-row"><span class="wr-label">Token Issue (‚Üí Runners)</span><span class="wr-val" style="color:var(--text2)">'+fmt(mc.tokenIssue)+'</span></div>'+
            '<div class="wizard-row"><span class="wr-label">Complimentary</span><span class="wr-val" style="color:var(--text2)">'+fmt(mc.complimentary)+'</span></div>'+
            '<div class="wizard-row total"><span class="wr-label">Expected Cash in Drawer</span><span class="wr-val">'+fmt(expectedCash)+'</span></div>'+
          '</div>'+
          '<div class="wizard-card"><h3>üîç UPI Verification</h3>'+counterUpiHtml+rcUpiHtml+'</div>'+
          '<div class="wizard-card"><h3>üíµ Your Count</h3>'+
            '<div class="wizard-input-group">'+
              '<label>How much CASH do you physically have at the counter?</label>'+
              '<div class="wi-expected">Expected: '+fmt(expectedCash)+'</div>'+
              '<input type="number" id="wizCounterCash" value="'+expectedCash+'" min="0" step="10" inputmode="numeric" oninput="updateCounterMatch()">'+
            '</div>'+
            '<div id="wizCounterMatch"></div>'+
          '</div>'+
          '<div class="wizard-nav">'+
            '<button class="wn-back" onclick="closeWizard()">‚úï Cancel</button>'+
            (wizardData.activeRunners.length>0
              ?'<button class="wn-next" onclick="goToWizardStep2()">Next ‚Üí Runners</button>'
              :'<button class="wn-next" onclick="goToWizardStep3()">Next ‚Üí Reconcile</button>')+
          '</div>'+
        '</div>';
      updateCounterMatch();
    }

    function updateCounterMatch(){
      const input=document.getElementById('wizCounterCash');
      if(!input)return;
      const entered=parseFloat(input.value)||0;
      wizardCounterCashEntered=entered;
      const expected=wizardData.mainCounter.cash||0;
      const diff=entered-expected;
      const v=wizardData.verification;
      const posCounterQR=Math.max(0,(v.cashCounter?.variance)||0);
      const posRCQR=Math.max(0,(v.runnerCounter?.variance)||0);
      const totalExplainable=posCounterQR+posRCQR;

      let html='';
      if(Math.abs(diff)<=1){
        html='<div class="wizard-match ok">‚úÖ Perfect match with system calculation</div>';
      }else if(diff>0&&diff<=totalExplainable+1){
        html='<div class="wizard-match ok">‚úÖ Extra '+fmt(diff)+' ‚Äî explained by UPI variance<br><span style="font-size:12px">A cash payment was likely recorded as UPI in Odoo</span></div>';
      }else if(diff>0&&diff>totalExplainable){
        const explained=totalExplainable;
        const unexplained=diff-explained;
        html='<div class="wizard-match warn">‚ö†Ô∏è Extra '+fmt(diff);
        if(explained>0) html+=' ‚Äî '+fmt(explained)+' explained by UPI variance';
        html+='<br>'+fmt(unexplained)+' unexplained extra cash</div>';
      }else if(diff<0){
        html='<div class="wizard-match bad">üö® '+fmt(Math.abs(diff))+' SHORT ‚Äî investigate before proceeding</div>';
      }
      $('wizCounterMatch').innerHTML=html;
    }

    function goToWizardStep2(){
      wizardCounterCashEntered=parseFloat(document.getElementById('wizCounterCash')?.value)||0;
      wizardStep=2;updateWizardSteps();

      let html='<div class="wizard-step-content active" id="step2Content">';
      if(wizardData.activeRunners.length===0){
        html+='<div class="wizard-card"><div class="loading-text">No active runners this shift</div></div>';
      }else{
        for(let i=0;i<wizardRunnerInputs.length;i++){
          const ri=wizardRunnerInputs[i];
          const r=wizardData.activeRunners[i];
          const cashCalc=(ri.tokens-ri.unsoldTokens+ri.sales)-ri.upi-ri.crossPaymentCredit;
          const clampedCalc=Math.max(0,cashCalc);
          ri.cashCalculated=clampedCalc;
          if(!ri.userEdited) ri.cashCollected=clampedCalc;

          let cpHtml='';
          if(ri.crossPaymentCredit>0){
            cpHtml='<div class="wizard-row"><span class="wr-label" style="color:var(--blue)">Cross-Payment Credit</span><span class="wr-val" style="color:var(--blue)">-'+fmt(ri.crossPaymentCredit)+'</span></div>';
          }

          let overCollectNote='';
          if(cashCalc<0){
            overCollectNote='<div class="wizard-match info">Runner collected more UPI than sales. '+fmt(Math.abs(cashCalc))+' excess. No cash to collect.</div>';
          }

          let midShiftNote='';
          if(ri.midShiftSettled){
            const rp=wizardData.runnerPeriods[ri.runner_id];
            const rpTime=rp&&rp.periodStart?fmtD(new Date(rp.periodStart)):'earlier this shift';
            midShiftNote='<div class="wizard-match info" style="margin-bottom:8px">‚ÑπÔ∏è Settled mid-shift. Showing activity since '+rpTime+'</div>';
          }

          html+='<div class="wizard-runner-card'+(ri.absent?' absent':'')+'" id="wizRunner'+i+'">'+
            '<div class="wrc-header"><span class="wrc-name">'+ri.runner_name+'</span><span class="wrc-badge">Runner '+(i+1)+' of '+wizardRunnerInputs.length+'</span></div>'+
            midShiftNote+
            '<div class="wizard-row"><span class="wr-label">Tokens Issued</span><span class="wr-val">'+fmt(ri.tokens)+'</span></div>'+
            '<div class="wizard-row"><span class="wr-label">Sales (Snacks)</span><span class="wr-val">'+fmt(ri.sales)+'</span></div>'+
            '<div class="wizard-row"><span class="wr-label">UPI Collected (QR)</span><span class="wr-val" style="color:var(--blue)">'+fmt(ri.upi)+'</span></div>'+
            cpHtml+
            (ri.tokens>0?
              '<div class="wizard-input-group"><label>Unsold tokens returned (‚Çπ)</label>'+
              '<input type="number" id="wizUnsold'+i+'" value="'+ri.unsoldTokens+'" min="0" max="'+ri.tokens+'" step="10" inputmode="numeric" oninput="updateRunnerCalc('+i+')" '+(ri.absent?'disabled':'')+'>'+
              '<div style="font-size:11px;color:var(--text2);margin-top:4px">Max: '+fmt(ri.tokens)+'</div></div>':'')+
            '<div class="wrc-calc" id="wizCalc'+i+'">System calculates: '+fmt(clampedCalc)+' cash owed</div>'+
            overCollectNote+
            (cashCalc>=0?
              '<div class="wizard-input-group"><label>Actual cash collected from runner</label>'+
              '<input type="number" id="wizActual'+i+'" value="'+ri.cashCollected+'" min="0" step="10" inputmode="numeric" onfocus="wizardRunnerInputs['+i+'].userEdited=true" oninput="updateRunnerActual('+i+')" '+(ri.absent?'disabled':'')+'>'+
              '</div><div id="wizRunnerMatch'+i+'"></div>':'')+
            '<label class="wizard-absent-toggle"><input type="checkbox" id="wizAbsent'+i+'" '+(ri.absent?'checked':'')+' onchange="toggleAbsent('+i+')"> Runner not present</label>'+
          '</div>';
        }
      }
      html+='<div class="wizard-nav">'+
        '<button class="wn-back" onclick="renderWizardStep1()">‚Üê Back</button>'+
        '<button class="wn-next" onclick="goToWizardStep3()">Next ‚Üí Reconcile</button>'+
      '</div></div>';
      $('wizardContent').innerHTML=html;
      // Trigger match status for each runner
      for(let i=0;i<wizardRunnerInputs.length;i++) updateRunnerActual(i);
    }

    function updateRunnerCalc(idx){
      const ri=wizardRunnerInputs[idx];
      const unsoldInput=document.getElementById('wizUnsold'+idx);
      let unsold=parseFloat(unsoldInput?.value)||0;
      if(unsold>ri.tokens){unsold=ri.tokens;if(unsoldInput)unsoldInput.value=unsold;}
      if(unsold<0){unsold=0;if(unsoldInput)unsoldInput.value=0;}
      ri.unsoldTokens=unsold;
      const cashCalc=(ri.tokens-unsold+ri.sales)-ri.upi-ri.crossPaymentCredit;
      const clamped=Math.max(0,cashCalc);
      ri.cashCalculated=clamped;
      const calcEl=document.getElementById('wizCalc'+idx);
      if(calcEl) calcEl.textContent='System calculates: '+fmt(clamped)+' cash owed';
      // Update actual if user hasn't manually edited
      if(!ri.userEdited){
        ri.cashCollected=clamped;
        const actEl=document.getElementById('wizActual'+idx);
        if(actEl) actEl.value=clamped;
      }
      updateRunnerActual(idx);
    }

    function updateRunnerActual(idx){
      const ri=wizardRunnerInputs[idx];
      if(ri.absent) return;
      const actInput=document.getElementById('wizActual'+idx);
      if(!actInput)return;
      const collected=parseFloat(actInput.value)||0;
      ri.cashCollected=collected;
      const diff=collected-ri.cashCalculated;
      ri.cashVariance=diff;

      const matchEl=document.getElementById('wizRunnerMatch'+idx);
      if(!matchEl)return;

      const v=wizardData.verification;
      const posCounterQR=Math.max(0,(v.cashCounter?.variance)||0);
      const posRCQR=Math.max(0,(v.runnerCounter?.variance)||0);
      const totalUPIVar=posCounterQR+posRCQR;

      if(Math.abs(diff)<=1){
        matchEl.innerHTML='<div class="wizard-match ok">‚úÖ Matches system calculation</div>';
      }else if(diff>0&&totalUPIVar>0){
        const mappable=Math.min(diff,totalUPIVar);
        const unmapped=diff-mappable;
        let msg='‚ö†Ô∏è '+fmt(diff)+' extra ‚Üí ';
        if(mappable>0) msg+=fmt(mappable)+' auto-mapped to UPI variance';
        if(unmapped>0) msg+=(mappable>0?', ':'')+fmt(unmapped)+' unexplained';
        matchEl.innerHTML='<div class="wizard-match '+(unmapped>0?'warn':'ok')+'">'+msg+'</div>';
      }else if(diff>0){
        matchEl.innerHTML='<div class="wizard-match warn">‚ö†Ô∏è '+fmt(diff)+' extra ‚Äî no UPI variance to explain it</div>';
      }else if(diff<0){
        matchEl.innerHTML='<div class="wizard-match bad">üö® '+fmt(Math.abs(diff))+' short ‚Äî confirm with runner</div>';
      }
    }

    function toggleAbsent(idx){
      const cb=document.getElementById('wizAbsent'+idx);
      const ri=wizardRunnerInputs[idx];
      ri.absent=cb.checked;
      const card=document.getElementById('wizRunner'+idx);
      if(card){
        card.classList.toggle('absent',ri.absent);
      }
      // Disable/enable inputs
      const unsoldEl=document.getElementById('wizUnsold'+idx);
      const actualEl=document.getElementById('wizActual'+idx);
      if(unsoldEl) unsoldEl.disabled=ri.absent;
      if(actualEl) actualEl.disabled=ri.absent;
      if(ri.absent){
        ri.cashCollected=0;ri.unsoldTokens=0;
        if(actualEl) actualEl.value=0;
        if(unsoldEl) unsoldEl.value=0;
        const matchEl=document.getElementById('wizRunnerMatch'+idx);
        if(matchEl) matchEl.innerHTML='<div class="wizard-match info">‚ö†Ô∏è '+ri.runner_name+'\'s '+fmt(ri.cashCalculated)+' obligation carries to next shift. No settlement recorded.</div>';
      }else{
        ri.cashCollected=ri.cashCalculated;
        if(actualEl) actualEl.value=ri.cashCalculated;
        ri.userEdited=false;
        updateRunnerActual(idx);
      }
    }

    function goToWizardStep3(){
      // Capture Step 2 inputs if coming from step 2
      if(wizardStep===2){
        for(let i=0;i<wizardRunnerInputs.length;i++){
          const ri=wizardRunnerInputs[i];
          if(!ri.absent){
            const unsoldEl=document.getElementById('wizUnsold'+i);
            const actualEl=document.getElementById('wizActual'+i);
            if(unsoldEl) ri.unsoldTokens=parseFloat(unsoldEl.value)||0;
            if(actualEl) ri.cashCollected=parseFloat(actualEl.value)||0;
            ri.cashCalculated=(ri.tokens-ri.unsoldTokens+ri.sales)-ri.upi-ri.crossPaymentCredit;
            ri.cashCalculated=Math.max(0,ri.cashCalculated);
            ri.cashVariance=ri.cashCollected-ri.cashCalculated;
          }
        }
      }
      wizardStep=3;updateWizardSteps();

      // === DISCREPANCY AUTO-RESOLUTION ALGORITHM ===
      const v=wizardData.verification;
      let unresolvedCounterQR=Math.max(0,(v.cashCounter?.variance)||0);
      let unresolvedRCQR=Math.max(0,(v.runnerCounter?.variance)||0);
      const resolutions=[];

      // Counter excess
      const counterExpected=wizardData.mainCounter.cash||0;
      let counterExcess=wizardCounterCashEntered-counterExpected;

      // Phase 1: Counter extra ‚Üí Counter QR
      if(counterExcess>0&&unresolvedCounterQR>0){
        const resolved=Math.min(counterExcess,unresolvedCounterQR);
        resolutions.push({source:'counter_qr_variance',amount:resolved,resolved_by:'counter_extra_cash',explanation:'Counter had '+fmt(resolved)+' extra ‚Üí matches Counter QR UPI variance'});
        unresolvedCounterQR-=resolved;counterExcess-=resolved;
      }
      // Phase 2: Counter extra ‚Üí Runner Counter QR
      if(counterExcess>0&&unresolvedRCQR>0){
        const resolved=Math.min(counterExcess,unresolvedRCQR);
        resolutions.push({source:'runner_counter_qr_variance',amount:resolved,resolved_by:'counter_extra_cash',explanation:'Counter had '+fmt(resolved)+' extra ‚Üí matches Runner Counter QR variance'});
        unresolvedRCQR-=resolved;counterExcess-=resolved;
      }
      // Phase 3: Runner extras ‚Üí UPI variances
      for(const ri of wizardRunnerInputs){
        if(ri.absent)continue;
        let runnerExcess=ri.cashCollected-ri.cashCalculated;
        if(runnerExcess<=0)continue;
        ri.excessMappedTo='';ri.excessMappedAmount=0;
        if(runnerExcess>0&&unresolvedCounterQR>0){
          const resolved=Math.min(runnerExcess,unresolvedCounterQR);
          resolutions.push({source:'counter_qr_variance',amount:resolved,resolved_by:ri.runner_name+'_extra_cash',explanation:ri.runner_name+' had '+fmt(resolved)+' extra ‚Üí matches Counter QR UPI variance'});
          unresolvedCounterQR-=resolved;runnerExcess-=resolved;
          ri.excessMappedTo='counter_qr_variance';ri.excessMappedAmount+=resolved;
        }
        if(runnerExcess>0&&unresolvedRCQR>0){
          const resolved=Math.min(runnerExcess,unresolvedRCQR);
          resolutions.push({source:'runner_counter_qr_variance',amount:resolved,resolved_by:ri.runner_name+'_extra_cash',explanation:ri.runner_name+' had '+fmt(resolved)+' extra ‚Üí matches Runner Counter QR variance'});
          unresolvedRCQR-=resolved;runnerExcess-=resolved;
          ri.excessMappedTo=(ri.excessMappedTo?ri.excessMappedTo+',':'')+'runner_counter_qr_variance';ri.excessMappedAmount+=resolved;
        }
        if(runnerExcess>0){
          resolutions.push({source:'unexplained',amount:runnerExcess,resolved_by:ri.runner_name+'_extra_cash',explanation:ri.runner_name+' had '+fmt(runnerExcess)+' unexplained extra cash'});
        }
      }
      if(counterExcess>0){
        resolutions.push({source:'unexplained',amount:counterExcess,resolved_by:'counter_extra_cash',explanation:'Counter had '+fmt(counterExcess)+' unexplained extra cash'});
      }

      // Totals
      const totalPhysical=wizardCounterCashEntered+wizardRunnerInputs.filter(r=>!r.absent).reduce((s,r)=>s+r.cashCollected,0);
      const sr=wizardData.shiftRecon;
      const mc=wizardData.mainCounter;
      const v=wizardData.verification;
      // Compute expected cash from actual wizard data (not shiftRecon which may include already-settled runner activity)
      // Counter expected = counter cash (PM 37) from Odoo
      const counterCashExpected=mc.cash||0;
      // Runner expected = sum of each present runner's cashCalculated (already uses correct per-runner periods)
      const runnerCashExpected=wizardRunnerInputs.filter(r=>!r.absent).reduce((s,r)=>s+r.cashCalculated,0);
      const effectiveExpected=counterCashExpected+runnerCashExpected;
      const totalUnsold=wizardRunnerInputs.reduce((s,r)=>s+r.unsoldTokens,0);
      const absentObligation=wizardRunnerInputs.filter(r=>r.absent).reduce((s,r)=>s+r.cashCalculated,0);
      const rawVariance=totalPhysical-effectiveExpected;
      const varianceResolved=resolutions.filter(r=>r.source!=='unexplained').reduce((s,r)=>s+r.amount,0);
      const varianceUnresolved=rawVariance-varianceResolved;

      // Store for submission
      wizardData.reconciliation={
        total_physical_cash:totalPhysical,
        expected_cash:effectiveExpected,
        raw_variance:rawVariance,
        variance_resolved:varianceResolved,
        variance_unresolved:varianceUnresolved,
        discrepancy_resolutions:resolutions
      };

      // === RENDER STEP 3 ===
      let html='<div class="wizard-step-content active" id="step3Content">';

      // Physical cash summary
      html+='<div class="wizard-card"><h3>üíµ Physical Cash Summary</h3>';
      html+='<div class="wizard-row"><span class="wr-label">Counter cash entered</span><span class="wr-val">'+fmt(wizardCounterCashEntered)+'</span></div>';
      for(const ri of wizardRunnerInputs){
        if(ri.absent) continue;
        const varText=ri.cashVariance!==0?' <span style="font-size:11px;color:'+(ri.cashVariance>0?'var(--yellow)':'var(--red)')+'">('+(ri.cashVariance>0?'+':'')+ri.cashVariance+')</span>':'';
        html+='<div class="wizard-row"><span class="wr-label">'+ri.runner_name+' collected</span><span class="wr-val">'+fmt(ri.cashCollected)+varText+'</span></div>';
      }
      html+='<div class="wizard-row total"><span class="wr-label">Total physical cash</span><span class="wr-val">'+fmt(totalPhysical)+'</span></div>';
      html+='</div>';

      // System expected ‚Äî built from actual wizard data per component
      html+='<div class="wizard-card"><h3>üìä System Expected Cash</h3>';
      html+='<div class="wizard-row"><span class="wr-label">Counter cash (Odoo PM 37)</span><span class="wr-val">'+fmt(counterCashExpected)+'</span></div>';
      for(const ri of wizardRunnerInputs){
        if(ri.absent) continue;
        html+='<div class="wizard-row"><span class="wr-label">'+ri.runner_name+' cash owed</span><span class="wr-val">'+fmt(ri.cashCalculated)+'</span></div>';
      }
      if(absentObligation>0) html+='<div class="wizard-row"><span class="wr-label" style="color:var(--orange)">Absent runner obligations (excluded)</span><span class="wr-val" style="color:var(--orange)">'+fmt(absentObligation)+'</span></div>';
      html+='<div class="wizard-row total"><span class="wr-label">Expected cash</span><span class="wr-val">'+fmt(effectiveExpected)+'</span></div>';
      html+='</div>';

      // Resolution
      if(resolutions.length>0){
        html+='<div class="wizard-card"><h3>üîß Discrepancy Resolution</h3>';
        html+='<div class="wizard-resolution"><div class="wr-title">How extra cash is explained</div>';
        for(const r of resolutions){
          const icon=r.source==='unexplained'?'‚ö†Ô∏è':'‚úÖ';
          html+='<div class="wizard-resolution-item"><span class="wri-icon">'+icon+'</span><span class="wri-text">'+r.explanation+'</span></div>';
        }
        html+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:13px;display:flex;justify-content:space-between"><span style="color:var(--text2)">Total resolved</span><span style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--green)">'+fmt(varianceResolved)+'</span></div>';
        html+='</div></div>';
      }

      // Final status
      if(Math.abs(varianceUnresolved)<=1){
        html+='<div class="wizard-recon-box balanced"><div class="wrb-icon">‚úÖ</div><div class="wrb-text">SHIFT BALANCED</div><div class="wrb-amount" style="color:var(--green)">Variance: ‚Çπ0</div></div>';
      }else if(varianceUnresolved>0){
        html+='<div class="wizard-recon-box '+(varianceUnresolved>50?'bad':'variance')+'"><div class="wrb-icon">'+(varianceUnresolved>50?'üö®':'‚ö†Ô∏è')+'</div><div class="wrb-text">EXTRA CASH</div><div class="wrb-amount" style="color:'+(varianceUnresolved>50?'var(--red)':'var(--yellow)')+'">+'+fmt(varianceUnresolved)+' unresolved</div></div>';
      }else{
        html+='<div class="wizard-recon-box '+(Math.abs(varianceUnresolved)>50?'bad':'variance')+'"><div class="wrb-icon">'+(Math.abs(varianceUnresolved)>50?'üö®':'‚ö†Ô∏è')+'</div><div class="wrb-text">CASH SHORT</div><div class="wrb-amount" style="color:var(--red)">'+fmt(Math.abs(varianceUnresolved))+' unresolved</div></div>';
      }

      // Absent runners
      const absentList=wizardRunnerInputs.filter(r=>r.absent);
      if(absentList.length>0){
        html+='<div class="wizard-card" style="border-color:var(--orange)">';
        for(const r of absentList){
          html+='<div style="padding:8px 0;font-size:13px;color:var(--orange)">‚ö†Ô∏è '+r.runner_name+' ('+fmt(r.cashCalculated)+' obligation) ‚Äî carried to next shift</div>';
        }
        html+='</div>';
      }

      // Misattributed orders warning
      if(wizardData.misattributed.length>0){
        html+='<div class="wizard-match warn" style="margin:12px 0">‚ö†Ô∏è '+wizardData.misattributed.length+' order(s) with missing/wrong runner attribution. Fix via discrepancy panel after settling.</div>';
      }

      html+='<div class="wizard-nav">'+
        '<button class="wn-back" onclick="'+(wizardData.activeRunners.length>0?'goToWizardStep2()':'renderWizardStep1()')+'">‚Üê Back</button>'+
        '<button class="wn-submit" id="wizSubmitBtn" onclick="submitShiftWizard()">‚úÖ Confirm & End Shift</button>'+
      '</div></div>';

      $('wizardContent').innerHTML=html;
    }

    async function submitShiftWizard(){
      const btn=document.getElementById('wizSubmitBtn');
      if(!btn)return;
      btn.disabled=true;btn.textContent='Recording settlement...';

      const mc=wizardData.mainCounter;
      const v=wizardData.verification;
      const rc=wizardData.reconciliation;
      const now=new Date();

      const payload={
        settled_by:currentUser,
        period_start:wizardData.periodStart,
        period_end:toLocalISO(now),
        counter:{
          cash_entered:wizardCounterCashEntered,
          cash_expected:mc.cash||0,
          upi:mc.upi||0,
          card:mc.card||0,
          token_issue:mc.tokenIssue||0,
          complimentary:mc.complimentary||0,
          upi_discrepancy:{
            counter_qr:{
              odoo:mc.upi||0,
              razorpay:v.cashCounter?.razorpay||0,
              variance:(v.cashCounter?.variance)||0
            },
            runner_counter_qr:{
              odoo:wizardData.runnerCounter?.upi||0,
              razorpay:v.runnerCounter?.razorpay||0,
              variance:(v.runnerCounter?.variance)||0
            }
          }
        },
        runner_checkpoints:wizardRunnerInputs.map(ri=>({
          runner_id:ri.runner_id,
          runner_name:ri.runner_name,
          tokens_amount:ri.tokens,
          sales_amount:ri.sales,
          upi_amount:ri.upi,
          cross_payment_credit:ri.crossPaymentCredit,
          unsold_tokens:ri.unsoldTokens,
          cash_calculated:ri.cashCalculated,
          cash_collected:ri.cashCollected,
          cash_variance:ri.cashCollected-ri.cashCalculated,
          excess_mapped_to:ri.excessMappedTo||'',
          excess_mapped_amount:ri.excessMappedAmount||0,
          status:ri.absent?'absent':'present'
        })),
        reconciliation:rc
      };

      try{
        const res=await fetch('/api/settlement?action=cashier-shift-settle',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úÖ Shift Settled!';
          btn.style.background='var(--green)';
          setTimeout(()=>{
            closeWizard();
            loadCashAtCounter();
            loadShiftReconciliation();
            loadShiftHistory();
            loadShiftHistoryV2();
          },1500);
        }else{
          throw new Error(data.error);
        }
      }catch(e){
        btn.disabled=false;
        btn.textContent='Error: '+e.message;
        btn.style.background='var(--red)';
        setTimeout(()=>{btn.textContent='‚úÖ Confirm & End Shift';btn.style.background='';btn.disabled=false;},3000);
      }
    }

    // ========== SHIFT HISTORY V2 ==========
    async function loadShiftHistoryV2(){
      try{
        const res=await fetch('/api/settlement?action=shift-history-v2&limit=10');
        const data=await res.json();
        if(!data.success||!data.shifts||data.shifts.length===0) return;
        // Inject v2 shift cards at the top of the existing shift history panel
        const panel=$('shiftHistoryPanel');
        if(!panel.classList.contains('show')) panel.classList.add('show');

        let v2Html='';
        for(const s of data.shifts){
          const pStart=new Date(s.period_start);
          const pEnd=new Date(s.settled_at);
          const isBalanced=Math.abs(s.variance_unresolved||0)<=1;
          const statusBadge=isBalanced
            ?'<span class="sh-card-badge balanced">‚úÖ Balanced</span>'
            :'<span class="sh-card-badge variance">‚ö†Ô∏è ‚Çπ'+Math.abs(s.variance_unresolved).toFixed(0)+'</span>';

          v2Html+='<div class="sh-card" style="border:1px solid '+(isBalanced?'var(--green)':'var(--yellow)')+';border-radius:12px">';
          v2Html+='<div class="sh-card-header"><div><div class="sh-card-title">üèÅ Shift ‚Äî '+s.cashier_name+'</div><div class="sh-card-time">'+fmtD(pStart)+' ‚Üí '+fmtD(pEnd)+'</div></div><div style="text-align:right">'+statusBadge+'<div style="font-size:18px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--green);margin-top:4px">'+fmt(s.total_cash_physical)+'</div></div></div>';
          v2Html+='<div class="sh-card-meta"><span>Counter: '+fmt(s.counter_cash_entered)+'</span>';
          if(s.runner_count>0) v2Html+='<span>Runners: '+s.runner_count+'</span>';
          v2Html+='</div>';

          // Show checkpoints
          if(s.checkpoints&&s.checkpoints.length>0){
            v2Html+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">';
            for(const cp of s.checkpoints){
              const cpIcon=cp.status==='absent'?'‚è≥':'‚úÖ';
              const cpColor=cp.status==='absent'?'var(--orange)':'var(--text2)';
              v2Html+='<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px"><span style="color:'+cpColor+'">'+cpIcon+' '+cp.runner_name+(cp.status==='absent'?' (absent)':'')+'</span><span style="font-family:JetBrains Mono,monospace">'+fmt(cp.cash_collected)+(cp.cash_variance!==0?' <span style="color:'+(cp.cash_variance>0?'var(--yellow)':'var(--red)')+'">('+((cp.cash_variance>0?'+':'')+cp.cash_variance)+')</span>':'')+'</span></div>';
            }
            v2Html+='</div>';
          }

          // Show resolutions if any
          const resolutions=JSON.parse(s.discrepancy_resolutions||'[]');
          if(resolutions.length>0){
            v2Html+='<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">';
            for(const r of resolutions){
              const icon=r.source==='unexplained'?'‚ö†Ô∏è':'‚úÖ';
              v2Html+='<div style="font-size:11px;color:var(--text2);padding:2px 0">'+icon+' '+r.explanation+'</div>';
            }
            v2Html+='</div>';
          }

          v2Html+='</div>';
        }

        // Prepend v2 cards before existing history content
        const existingH3=panel.querySelector('h3');
        if(existingH3){
          const marker=document.createElement('div');
          marker.id='v2ShiftCards';
          marker.innerHTML=v2Html;
          const existingMarker=document.getElementById('v2ShiftCards');
          if(existingMarker) existingMarker.remove();
          existingH3.after(document.createElement('div')); // subtitle spacer
          const subtitle=panel.querySelector('.subtitle');
          if(subtitle) subtitle.after(marker);
          else existingH3.after(marker);
        }
      }catch(e){console.error('Shift history v2 error:',e);}
    }

    pins[0].focus();
  </script>
</body>
</html>
