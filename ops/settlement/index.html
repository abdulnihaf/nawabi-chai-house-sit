<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>NCH Settlement</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--green:#22c55e;--green-dim:rgba(34,197,94,.12);--red:#ef4444;--red-dim:rgba(239,68,68,.12);--blue:#3b82f6;--blue-dim:rgba(59,130,246,.12);--purple:#a855f7;--purple-dim:rgba(168,85,247,.12);--yellow:#eab308;--yellow-dim:rgba(234,179,8,.12);--orange:#f97316;--orange-dim:rgba(249,115,22,.12)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-tap-highlight-color:transparent}
    .mono{font-family:'JetBrains Mono',monospace}

    /* â”€â”€â”€ PIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pin-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .pin-screen.hidden{display:none}
    .pin-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;max-width:360px;width:100%}
    .pin-box .icon{font-size:48px;margin-bottom:20px}
    .pin-box h2{font-size:24px;margin-bottom:8px}
    .pin-box p{color:var(--text2);font-size:14px;margin-bottom:24px}
    .pin-input{display:flex;gap:12px;justify-content:center;margin-bottom:16px}
    .pin-input input{width:48px;height:56px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:24px;text-align:center;font-family:'JetBrains Mono',monospace;transition:all .2s}
    .pin-input input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(168,85,247,.2)}
    .pin-input input.filled{border-color:var(--green);background:rgba(34,197,94,.1)}
    .pin-error{color:var(--red);font-size:13px;display:none}
    .pin-success{color:var(--green);font-weight:600;display:none}
    @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}

    /* â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dashboard{display:none;min-height:100vh}
    .dashboard.show{display:block}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
    .header h1{font-size:18px;display:flex;align-items:center;gap:8px}
    .header h1 .accent{width:4px;height:22px;border-radius:2px}
    .user-badge{display:flex;align-items:center;gap:10px}
    .user-badge .name{font-weight:600;font-size:14px}
    .logout-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:6px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-family:inherit}
    .content{padding:20px;max-width:700px;margin:0 auto}

    /* â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-bar{display:flex;gap:4px;background:var(--bg2);border-radius:12px;padding:4px;margin-bottom:20px}
    .tab{flex:1;padding:10px 8px;border-radius:10px;text-align:center;font-size:13px;font-weight:600;cursor:pointer;color:var(--text2);transition:all .2s}
    .tab.active{background:var(--card);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* â”€â”€â”€ RUNNER GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .runner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-bottom:20px}
    .runner-card{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:16px;text-align:center;cursor:pointer;transition:all .15s}
    .runner-card:active{transform:scale(.97)}
    .runner-card.selected{border-color:var(--purple);background:var(--purple-dim)}
    .runner-card .rname{font-weight:600;font-size:14px;margin-bottom:2px}
    .runner-card .rcode{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace}

    /* â”€â”€â”€ PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;display:none}
    .panel.show{display:block}
    .panel-title{font-size:18px;font-weight:700;margin-bottom:4px}
    .panel-period{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace;margin-bottom:20px}
    .row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
    .row:last-of-type{border-bottom:none}
    .row .label{color:var(--text2);font-size:14px}
    .row .value{font-weight:600;font-family:'JetBrains Mono',monospace;font-size:14px}
    .row.sub{padding:6px 0 6px 16px;opacity:.7;font-size:13px}
    .row.total{padding-top:16px;margin-top:8px;border-top:2px solid var(--border);border-bottom:none}
    .row.total .label{font-weight:700;color:var(--text)}
    .row.total .value{font-size:20px}

    /* â”€â”€â”€ INPUT ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-row{margin-top:16px;padding:16px;background:var(--bg2);border-radius:12px;border:2px solid var(--border)}
    .input-row label{display:block;font-size:13px;color:var(--text2);margin-bottom:8px;font-weight:600}
    .input-row input{width:100%;padding:14px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);font-size:22px;font-family:'JetBrains Mono',monospace;font-weight:700;text-align:center}
    .input-row input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(168,85,247,.2)}

    /* â”€â”€â”€ DISCREPANCY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .disc-section{display:none;margin-top:12px;padding:14px;background:var(--red-dim);border:1px solid var(--red);border-radius:10px}
    .disc-section.show{display:block}
    .disc-section .disc-amount{font-size:16px;font-weight:700;color:var(--red);margin-bottom:10px}
    .disc-section label{display:block;font-size:12px;color:var(--text2);margin-bottom:4px}
    .disc-section textarea{width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;font-family:inherit;min-height:60px;resize:vertical}
    .disc-section textarea:focus{outline:none;border-color:var(--red)}

    /* â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;margin-top:16px;display:flex;align-items:center;justify-content:center;gap:8px}
    .btn:active{transform:scale(.98)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-green{background:var(--green);color:#fff}
    .btn-orange{background:var(--orange);color:#fff}
    .btn-purple{background:var(--purple);color:#fff}
    .btn-red{background:var(--red);color:#fff}
    .btn-blue{background:var(--blue);color:#fff}
    .btn.loading{opacity:.7;cursor:wait}

    /* â”€â”€â”€ INFO/STATUS BOXES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .info-box{border-radius:10px;padding:12px 14px;margin-top:14px;font-size:13px;line-height:1.5}
    .info-green{background:var(--green-dim);border:1px solid var(--green);color:var(--green)}
    .info-yellow{background:var(--yellow-dim);border:1px solid var(--yellow);color:var(--yellow)}
    .info-red{background:var(--red-dim);border:1px solid var(--red);color:var(--red)}
    .info-blue{background:var(--blue-dim);border:1px solid var(--blue);color:var(--blue)}

    /* â”€â”€â”€ CASH SUMMARY (sticky bottom) */
    .cash-summary{background:var(--card);border-top:2px solid var(--border);padding:16px 20px;position:sticky;bottom:0;z-index:50}
    .cash-summary .summary-row{display:flex;justify-content:space-between;font-size:13px;padding:4px 0}
    .cash-summary .summary-row.net{font-size:18px;font-weight:700;padding:8px 0 0;border-top:1px solid var(--border);margin-top:4px}

    /* â”€â”€â”€ EXPENSE FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .expense-form{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px}
    .expense-form .cats{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .expense-form .cat{padding:8px 14px;background:var(--bg2);border:2px solid var(--border);border-radius:10px;font-size:13px;cursor:pointer;color:var(--text2);font-family:inherit;transition:all .15s}
    .expense-form .cat:active{transform:scale(.97)}
    .expense-form .cat.selected{border-color:var(--orange);background:var(--orange-dim);color:var(--orange)}
    .expense-form input,.expense-form textarea{width:100%;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-family:inherit;margin-bottom:10px}
    .expense-form input:focus,.expense-form textarea:focus{outline:none;border-color:var(--orange)}
    .expense-item{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .expense-item .exp-info{flex:1}
    .expense-item .exp-cat{font-size:11px;color:var(--orange);text-transform:uppercase;letter-spacing:.5px}
    .expense-item .exp-desc{font-size:13px;color:var(--text2);margin-top:2px}
    .expense-item .exp-amt{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:15px;color:var(--red)}
    .expense-item .exp-del{background:none;border:none;color:var(--text2);cursor:pointer;font-size:16px;margin-left:10px;padding:4px}

    /* â”€â”€â”€ MANAGER TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mgr-table{width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px}
    .mgr-table th{text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:.5px;padding:8px 6px;border-bottom:2px solid var(--border)}
    .mgr-table td{padding:10px 6px;border-bottom:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:13px}
    .mgr-table .name-col{font-family:'Plus Jakarta Sans',sans-serif;font-weight:600}
    .mgr-table .disc-col{color:var(--red)}
    .mgr-table .net-col{color:var(--green);font-weight:700}
    .mgr-table .total-row td{border-top:2px solid var(--border);font-weight:700;font-size:14px}
    .mgr-table .expand-btn{background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px;font-family:inherit;text-decoration:underline}
    .detail-expand{display:none;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;margin:8px 0 16px;font-size:13px}
    .detail-expand.show{display:block}
    .detail-expand .detail-title{font-weight:700;margin-bottom:8px;color:var(--text2);font-size:12px;text-transform:uppercase;letter-spacing:.5px}
    .detail-expand .detail-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(45,58,79,.5)}
    .detail-expand .detail-row:last-child{border-bottom:none}

    /* â”€â”€â”€ COLLECTION HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .history-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;cursor:pointer;transition:border-color .15s}
    .history-card:active{border-color:var(--purple)}
    .history-card .hc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .history-card .hc-date{font-weight:600}
    .history-card .hc-amount{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--green);font-size:16px}
    .history-card .hc-meta{color:var(--text2);font-size:12px}

    /* â”€â”€â”€ LOADING/TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading-overlay{display:none;position:fixed;inset:0;background:rgba(10,15,26,.8);z-index:300;align-items:center;justify-content:center;flex-direction:column;gap:16px}
    .loading-overlay.show{display:flex}
    .loader{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite}
    .loading-overlay p{color:var(--text2);font-size:14px}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 20px;font-size:14px;z-index:200;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;max-width:90%}
    .toast.show{opacity:1}
    .empty-state{text-align:center;padding:40px 20px;color:var(--text2)}
    .empty-state .icon{font-size:48px;margin-bottom:12px;opacity:.6}
  </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay"><div class="loader"></div><p id="loadingText">Loading...</p></div>
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â• PIN SCREEN â•â•â•â•â•â•â• -->
<div class="pin-screen" id="pinScreen">
  <div class="pin-box">
    <div class="icon">ğŸ’°</div>
    <h2>Settlement</h2>
    <p>Enter your 4-digit PIN</p>
    <div class="pin-input" id="pinInput">
      <input type="password" maxlength="1" inputmode="numeric">
      <input type="password" maxlength="1" inputmode="numeric">
      <input type="password" maxlength="1" inputmode="numeric">
      <input type="password" maxlength="1" inputmode="numeric">
    </div>
    <div class="pin-error" id="pinError">Invalid PIN. Try again.</div>
    <div class="pin-success" id="pinSuccess"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• CASHIER DASHBOARD â•â•â•â•â•â•â• -->
<div class="dashboard" id="cashierDash">
  <div class="header">
    <h1><span class="accent" style="background:var(--purple)"></span>Settlement</h1>
    <div class="user-badge">
      <span class="name" id="cashierName"></span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="content">
    <div class="tab-bar">
      <div class="tab active" onclick="switchTab('runners',this)">Runners</div>
      <div class="tab" onclick="switchTab('counter',this)">Counter</div>
      <div class="tab" onclick="switchTab('expenses',this)">Expenses</div>
    </div>

    <!-- TAB 1: Runner Settlement -->
    <div class="tab-content active" id="tab-runners">
      <div class="runner-grid" id="runnerGrid"></div>
      <div class="panel" id="runnerPanel">
        <div class="panel-title" id="rpName"></div>
        <div class="panel-period" id="rpPeriod"></div>
        <div id="rpContent"></div>
      </div>
    </div>

    <!-- TAB 2: Counter Settlement -->
    <div class="tab-content" id="tab-counter">
      <div class="panel show" id="counterPanel">
        <div class="panel-title">ğŸ’° Cash Counter</div>
        <div class="panel-period" id="cpPeriod"></div>
        <div id="cpContent"><div class="empty-state"><div class="icon">â³</div>Loading counter data...</div></div>
      </div>
    </div>

    <!-- TAB 3: Expenses -->
    <div class="tab-content" id="tab-expenses">
      <div class="expense-form">
        <div style="font-weight:700;margin-bottom:12px">Record Expense</div>
        <div class="cats" id="expCats">
          <button class="cat" onclick="selectCat(this,'police')">ğŸš” Police</button>
          <button class="cat" onclick="selectCat(this,'supplies')">ğŸ›’ Supplies</button>
          <button class="cat" onclick="selectCat(this,'transport')">ğŸš— Transport</button>
          <button class="cat" onclick="selectCat(this,'other')">ğŸ“‹ Other</button>
        </div>
        <input type="number" id="expAmount" placeholder="Amount (â‚¹)" inputmode="decimal">
        <textarea id="expDesc" placeholder="Description (e.g. Weekly police payment)" rows="2"></textarea>
        <button class="btn btn-orange" onclick="addExpense()">+ Record Expense</button>
      </div>
      <div style="font-weight:600;margin-bottom:10px;color:var(--text2);font-size:13px">PENDING EXPENSES</div>
      <div id="expenseList"></div>
    </div>
  </div>

  <!-- Sticky Cash Summary -->
  <div class="cash-summary" id="cashSummary" style="display:none">
    <div class="summary-row"><span style="color:var(--text2)">From runners</span><span class="mono" id="sumRunners">â‚¹0</span></div>
    <div class="summary-row"><span style="color:var(--text2)">From counter</span><span class="mono" id="sumCounter">â‚¹0</span></div>
    <div class="summary-row"><span style="color:var(--text2)">Expenses</span><span class="mono" style="color:var(--red)" id="sumExpenses">-â‚¹0</span></div>
    <div class="summary-row net"><span>Cash I'm Holding</span><span class="mono" style="color:var(--green)" id="sumNet">â‚¹0</span></div>
    <button class="btn btn-purple" onclick="handoverToManager()" id="handoverBtn" style="margin-top:10px">Hand Over to Manager</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• MANAGER DASHBOARD â•â•â•â•â•â•â• -->
<div class="dashboard" id="managerDash">
  <div class="header">
    <h1><span class="accent" style="background:var(--orange)"></span>Collection</h1>
    <div class="user-badge">
      <span class="name" id="managerName"></span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="content">
    <div class="tab-bar">
      <div class="tab active" onclick="switchMgrTab('pending',this)">Pending</div>
      <div class="tab" onclick="switchMgrTab('history',this)">History</div>
    </div>

    <div class="tab-content active" id="mtab-pending">
      <div id="mgrPendingContent"><div class="empty-state"><div class="icon">â³</div>Loading...</div></div>
    </div>

    <div class="tab-content" id="mtab-history">
      <div id="mgrHistoryContent"><div class="empty-state"><div class="icon">â³</div>Loading...</div></div>
    </div>
  </div>
</div>

<script>
const API = '/api/settlement';
const NCH_API = '/api/nch-data';
const fmt = n => 'â‚¹' + Math.abs(n).toLocaleString('en-IN', {maximumFractionDigits: 0});
const fmtD = d => { const dd = new Date(d); return dd.toLocaleDateString('en-IN', {day:'2-digit',month:'short'}) + ' ' + dd.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit',hour12:false}); };
const toISO = d => { const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dy=String(d.getDate()).padStart(2,'0'),h=String(d.getHours()).padStart(2,'0'),mn=String(d.getMinutes()).padStart(2,'0'),s=String(d.getSeconds()).padStart(2,'0'); return `${y}-${m}-${dy}T${h}:${mn}:${s}`; };

let currentStaff = null;
let runners = [];
let selectedRunner = null;
let currentRunnerOdoo = null;
let currentCounterOdoo = null;
let expenseCategory = null;

// â•â•â•â•â•â•â• PIN â•â•â•â•â•â•â•
const pins = Array.from(document.querySelectorAll('#pinInput input'));
pins.forEach((input, i) => {
  input.addEventListener('input', e => {
    if (e.target.value) { input.classList.add('filled'); if (i < 3) pins[i+1].focus(); else checkPin(); }
    else input.classList.remove('filled');
  });
  input.addEventListener('keydown', e => { if (e.key==='Backspace'&&!e.target.value&&i>0){pins[i-1].focus();pins[i-1].value='';pins[i-1].classList.remove('filled');} });
});
pins[0].focus();

async function checkPin() {
  const pin = pins.map(p => p.value).join('');
  if (pin.length !== 4) return;
  try {
    const res = await fetch(`${API}?action=verify-pin&pin=${pin}`);
    const data = await res.json();
    if (data.success) {
      currentStaff = data.staff;
      document.getElementById('pinSuccess').textContent = 'âœ“ Welcome, ' + data.staff.name;
      document.getElementById('pinSuccess').style.display = 'block';
      document.getElementById('pinError').style.display = 'none';
      setTimeout(() => {
        document.getElementById('pinScreen').classList.add('hidden');
        if (data.staff.role === 'cashier') initCashier();
        else if (data.staff.role === 'manager') initManager();
        else { showToast('Access denied for this role'); logout(); }
      }, 600);
    } else {
      document.getElementById('pinError').style.display = 'block';
      const wrap = document.getElementById('pinInput');
      wrap.style.animation = 'shake 0.4s ease';
      setTimeout(() => { wrap.style.animation = ''; pins.forEach(p=>{p.value='';p.classList.remove('filled');}); pins[0].focus(); }, 500);
    }
  } catch(e) { showToast('Connection error'); }
}

function logout() {
  currentStaff = null; selectedRunner = null; runners = [];
  document.getElementById('cashierDash').classList.remove('show');
  document.getElementById('managerDash').classList.remove('show');
  document.getElementById('pinScreen').classList.remove('hidden');
  document.getElementById('pinSuccess').style.display = 'none';
  document.getElementById('pinError').style.display = 'none';
  pins.forEach(p => { p.value = ''; p.classList.remove('filled'); });
  pins[0].focus();
}

// â•â•â•â•â•â•â• CASHIER VIEW â•â•â•â•â•â•â•
async function initCashier() {
  document.getElementById('cashierDash').classList.add('show');
  document.getElementById('cashierName').textContent = currentStaff.name;
  document.getElementById('cashSummary').style.display = 'block';
  await loadRunners();
  loadCashierSummary();
  loadCounterTab();
  loadExpenses();
}

async function loadRunners() {
  const res = await fetch(`${API}?action=get-runners`);
  const data = await res.json();
  runners = data.runners || [];
  const grid = document.getElementById('runnerGrid');
  grid.innerHTML = runners.map(r => `<div class="runner-card" data-id="${r.id}" onclick="selectRunner('${r.id}',this)"><div class="rname">${r.name}</div><div class="rcode">${r.runner_barcode}</div></div>`).join('');
}

async function selectRunner(id, el) {
  document.querySelectorAll('.runner-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedRunner = runners.find(r => r.id === id);
  const panel = document.getElementById('runnerPanel');
  panel.classList.add('show');
  document.getElementById('rpName').textContent = selectedRunner.name;
  document.getElementById('rpContent').innerHTML = '<div class="empty-state"><div class="icon">â³</div>Loading...</div>';

  // Get last handover
  const statusRes = await fetch(`${API}?action=get-runner-status&runner_staff_id=${id}`);
  const statusData = await statusRes.json();
  const periodStart = statusData.periodStart;
  document.getElementById('rpPeriod').textContent = fmtD(periodStart) + ' â†’ Now';

  // Get Odoo data
  const odooRes = await fetch(`${NCH_API}?from=${periodStart}`);
  const odooData = await odooRes.json();
  if (!odooData.success) { document.getElementById('rpContent').innerHTML = '<div class="empty-state" style="color:var(--red)">Error loading data</div>'; return; }

  const runner = odooData.data.runners.find(r => r.id === selectedRunner.runner_odoo_id);
  currentRunnerOdoo = runner;

  if (!runner || (runner.tokens === 0 && runner.sales === 0 && runner.upi === 0)) {
    let lastInfo = '';
    if (statusData.lastHandover) lastInfo = `<div class="info-box info-green">âœ“ Last settled: ${fmtD(statusData.lastHandover.created_at)} â€” ${fmt(statusData.lastHandover.actual_cash)} cash</div>`;
    document.getElementById('rpContent').innerHTML = `<div class="empty-state"><div class="icon">âœ…</div><div style="font-weight:600;margin-bottom:4px">No pending activity</div></div>${lastInfo}`;
    return;
  }

  const expectedCash = runner.cashToCollect;
  let lastInfo = '';
  if (statusData.lastHandover) lastInfo = `<div class="info-box info-green" style="margin-bottom:16px">Last: ${fmtD(statusData.lastHandover.created_at)} by ${statusData.lastHandover.created_by} â€” ${fmt(statusData.lastHandover.actual_cash)}</div>`;

  document.getElementById('rpContent').innerHTML = `
    ${lastInfo}
    <div class="row"><span class="label">Tokens Issued (Chai)</span><span class="value">${fmt(runner.tokens)}</span></div>
    <div class="row"><span class="label">Sales Made (Snacks)</span><span class="value">${fmt(runner.sales)}</span></div>
    <div class="row"><span class="label">UPI Collected</span><span class="value" style="color:var(--blue)">${fmt(runner.upi)}</span></div>
    <div class="row total"><span class="label">Expected Cash</span><span class="value" style="color:${expectedCash >= 0 ? 'var(--green)' : 'var(--red)'}">${fmt(expectedCash)}</span></div>
    <div class="input-row">
      <label>ACTUAL CASH RECEIVED</label>
      <input type="number" id="runnerActual" inputmode="decimal" value="${Math.max(0,expectedCash)}" onfocus="this.select()" oninput="checkRunnerDisc()">
    </div>
    <div class="disc-section" id="runnerDisc">
      <div class="disc-amount" id="runnerDiscAmt"></div>
      <label>Reason for discrepancy *</label>
      <textarea id="runnerDiscReason" placeholder="e.g. Customer at building 3 didn't pay"></textarea>
    </div>
    <button class="btn btn-green" id="runnerSettleBtn" onclick="settleRunner()">âœ“ Confirm Handover</button>
  `;
}

function checkRunnerDisc() {
  if (!currentRunnerOdoo) return;
  const actual = parseFloat(document.getElementById('runnerActual').value) || 0;
  const expected = currentRunnerOdoo.cashToCollect;
  const disc = expected - actual;
  const section = document.getElementById('runnerDisc');
  if (Math.abs(disc) > 0.5) {
    section.classList.add('show');
    document.getElementById('runnerDiscAmt').textContent = `âš ï¸ ${disc > 0 ? 'Short' : 'Over'} by ${fmt(Math.abs(disc))}`;
  } else {
    section.classList.remove('show');
  }
}

async function settleRunner() {
  if (!selectedRunner || !currentRunnerOdoo) return;
  const actual = parseFloat(document.getElementById('runnerActual').value) || 0;
  const expected = currentRunnerOdoo.cashToCollect;
  const disc = expected - actual;

  if (Math.abs(disc) > 0.5) {
    const reason = document.getElementById('runnerDiscReason').value.trim();
    if (!reason) { showToast('âš ï¸ Enter reason for discrepancy'); document.getElementById('runnerDiscReason').focus(); return; }
  }

  const btn = document.getElementById('runnerSettleBtn');
  btn.disabled = true; btn.classList.add('loading'); btn.textContent = 'Recording...';
  showLoading('Recording handover...');

  try {
    const statusRes = await fetch(`${API}?action=get-runner-status&runner_staff_id=${selectedRunner.id}`);
    const statusData = await statusRes.json();

    const res = await fetch(`${API}?action=runner-handover`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        runner_staff_id: selectedRunner.id,
        cashier_staff_id: currentStaff.id,
        period_start: statusData.periodStart,
        period_end: toISO(new Date()),
        expected_tokens: currentRunnerOdoo.tokens,
        expected_sales: currentRunnerOdoo.sales,
        expected_upi: currentRunnerOdoo.upi,
        expected_cash: expected,
        actual_cash: actual,
        discrepancy_reason: document.getElementById('runnerDiscReason')?.value?.trim() || '',
        notes: ''
      })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    showToast('âœ… ' + selectedRunner.name + ' handover recorded');
    // Re-select to refresh
    const card = document.querySelector(`.runner-card[data-id="${selectedRunner.id}"]`);
    if (card) selectRunner(selectedRunner.id, card);
    loadCashierSummary();
  } catch(e) {
    showToast('âŒ Error: ' + e.message);
    btn.disabled = false; btn.classList.remove('loading'); btn.textContent = 'âœ“ Confirm Handover';
  }
  hideLoading();
}

// â”€â”€â”€ Counter Tab â”€â”€â”€
async function loadCounterTab() {
  const cpContent = document.getElementById('cpContent');
  cpContent.innerHTML = '<div class="empty-state"><div class="icon">â³</div>Loading counter data...</div>';

  const statusRes = await fetch(`${API}?action=get-counter-status`);
  const statusData = await statusRes.json();
  const periodStart = statusData.periodStart;
  document.getElementById('cpPeriod').textContent = fmtD(periodStart) + ' â†’ Now';

  const odooRes = await fetch(`${NCH_API}?from=${periodStart}`);
  const odooData = await odooRes.json();
  if (!odooData.success) { cpContent.innerHTML = '<div class="empty-state" style="color:var(--red)">Error</div>'; return; }

  const mc = odooData.data.mainCounter;
  currentCounterOdoo = mc;
  const cashExpected = mc.cash;

  if (mc.cash === 0 && mc.upi === 0 && mc.card === 0) {
    let lastInfo = '';
    if (statusData.lastHandover) lastInfo = `<div class="info-box info-green">âœ“ Last settled: ${fmtD(statusData.lastHandover.created_at)} â€” ${fmt(statusData.lastHandover.actual_cash)} cash</div>`;
    cpContent.innerHTML = `<div class="empty-state"><div class="icon">âœ…</div><div style="font-weight:600">No pending counter activity</div></div>${lastInfo}`;
    return;
  }

  let lastInfo = '';
  if (statusData.lastHandover) lastInfo = `<div class="info-box info-green" style="margin-bottom:16px">Last: ${fmtD(statusData.lastHandover.created_at)} â€” ${fmt(statusData.lastHandover.actual_cash)} cash</div>`;

  cpContent.innerHTML = `
    ${lastInfo}
    <div class="row"><span class="label">Counter Revenue</span><span class="value">${fmt(mc.cash + mc.upi + mc.card)}</span></div>
    <div class="row sub"><span class="label">â†³ Cash</span><span class="value">${fmt(mc.cash)}</span></div>
    <div class="row sub"><span class="label">â†³ UPI (to bank)</span><span class="value" style="color:var(--blue)">${fmt(mc.upi)}</span></div>
    <div class="row sub"><span class="label">â†³ Card (to bank)</span><span class="value" style="color:var(--blue)">${fmt(mc.card)}</span></div>
    <div class="row" style="opacity:.5"><span class="label">Token Issue (â†’ Runners)</span><span class="value">${fmt(mc.tokenIssue)}</span></div>
    <div class="row total"><span class="label">Expected Cash</span><span class="value" style="color:var(--orange)">${fmt(cashExpected)}</span></div>
    <div class="input-row">
      <label>ACTUAL CASH COUNTED</label>
      <input type="number" id="counterActual" inputmode="decimal" value="${cashExpected}" onfocus="this.select()" oninput="checkCounterDisc()">
    </div>
    <div class="disc-section" id="counterDisc">
      <div class="disc-amount" id="counterDiscAmt"></div>
      <label>Reason</label>
      <textarea id="counterDiscReason" placeholder="e.g. Change given from counter cash"></textarea>
    </div>
    <button class="btn btn-orange" id="counterSettleBtn" onclick="settleCounter()">âœ“ Settle Counter</button>
  `;
}

function checkCounterDisc() {
  if (!currentCounterOdoo) return;
  const actual = parseFloat(document.getElementById('counterActual').value) || 0;
  const disc = currentCounterOdoo.cash - actual;
  const section = document.getElementById('counterDisc');
  if (Math.abs(disc) > 0.5) {
    section.classList.add('show');
    document.getElementById('counterDiscAmt').textContent = `âš ï¸ ${disc > 0 ? 'Short' : 'Over'} by ${fmt(Math.abs(disc))}`;
  } else {
    section.classList.remove('show');
  }
}

async function settleCounter() {
  if (!currentCounterOdoo) return;
  const actual = parseFloat(document.getElementById('counterActual').value) || 0;

  const btn = document.getElementById('counterSettleBtn');
  btn.disabled = true; btn.classList.add('loading'); btn.textContent = 'Recording...';
  showLoading('Settling counter...');

  try {
    const statusRes = await fetch(`${API}?action=get-counter-status`);
    const statusData = await statusRes.json();

    const res = await fetch(`${API}?action=counter-handover`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        cashier_staff_id: currentStaff.id,
        period_start: statusData.periodStart,
        period_end: toISO(new Date()),
        expected_cash: currentCounterOdoo.cash,
        expected_upi: currentCounterOdoo.upi,
        expected_card: currentCounterOdoo.card,
        actual_cash: actual,
        discrepancy_reason: document.getElementById('counterDiscReason')?.value?.trim() || '',
        notes: ''
      })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    showToast('âœ… Counter settled');
    loadCounterTab();
    loadCashierSummary();
  } catch(e) {
    showToast('âŒ Error: ' + e.message);
    btn.disabled = false; btn.classList.remove('loading'); btn.textContent = 'âœ“ Settle Counter';
  }
  hideLoading();
}

// â”€â”€â”€ Expenses Tab â”€â”€â”€
function selectCat(el, cat) {
  document.querySelectorAll('.cat').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  expenseCategory = cat;
}

async function addExpense() {
  if (!expenseCategory) { showToast('âš ï¸ Select a category'); return; }
  const amount = parseFloat(document.getElementById('expAmount').value);
  const desc = document.getElementById('expDesc').value.trim();
  if (!amount || amount <= 0) { showToast('âš ï¸ Enter amount'); return; }
  if (!desc) { showToast('âš ï¸ Enter description'); return; }

  showLoading('Recording expense...');
  try {
    const res = await fetch(`${API}?action=add-expense`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ staff_id: currentStaff.id, amount, category: expenseCategory, description: desc })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    showToast('âœ… Expense recorded');
    document.getElementById('expAmount').value = '';
    document.getElementById('expDesc').value = '';
    document.querySelectorAll('.cat').forEach(c => c.classList.remove('selected'));
    expenseCategory = null;
    loadExpenses();
    loadCashierSummary();
  } catch(e) { showToast('âŒ ' + e.message); }
  hideLoading();
}

async function loadExpenses() {
  const res = await fetch(`${API}?action=get-expenses&staff_id=${currentStaff.id}`);
  const data = await res.json();
  const list = document.getElementById('expenseList');
  if (!data.expenses || data.expenses.length === 0) {
    list.innerHTML = '<div class="empty-state">No pending expenses</div>';
    return;
  }
  const catIcons = {police: 'ğŸš”', supplies: 'ğŸ›’', transport: 'ğŸš—', other: 'ğŸ“‹'};
  list.innerHTML = data.expenses.map(e => `
    <div class="expense-item">
      <div class="exp-info">
        <div class="exp-cat">${catIcons[e.category] || ''} ${e.category}</div>
        <div class="exp-desc">${e.description}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:2px">${fmtD(e.created_at)}</div>
      </div>
      <div class="exp-amt">-${fmt(e.amount)}</div>
      <button class="exp-del" onclick="deleteExpense(${e.id})" title="Delete">âœ•</button>
    </div>
  `).join('');
}

async function deleteExpense(id) {
  if (!confirm('Delete this expense?')) return;
  try {
    const res = await fetch(`${API}?action=delete-expense`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ expense_id: id, staff_id: currentStaff.id })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    showToast('Expense deleted');
    loadExpenses();
    loadCashierSummary();
  } catch(e) { showToast('âŒ ' + e.message); }
}

// â”€â”€â”€ Cash Summary â”€â”€â”€
async function loadCashierSummary() {
  try {
    const res = await fetch(`${API}?action=get-cashier-summary&cashier_staff_id=${currentStaff.id}`);
    const data = await res.json();
    if (!data.success) return;
    const t = data.totals;
    document.getElementById('sumRunners').textContent = fmt(t.totalRunnerCash);
    document.getElementById('sumCounter').textContent = fmt(t.totalCounterCash);
    document.getElementById('sumExpenses').textContent = '-' + fmt(t.totalExpenses);
    document.getElementById('sumNet').textContent = fmt(t.netCash);

    const btn = document.getElementById('handoverBtn');
    if (t.netCash > 0 && !data.pendingManagerHandover) {
      btn.style.display = 'flex';
      btn.textContent = `Hand Over ${fmt(t.netCash)} to Manager`;
    } else if (data.pendingManagerHandover) {
      btn.style.display = 'flex';
      btn.textContent = 'âœ“ Already handed over';
      btn.disabled = true;
      btn.classList.add('btn-green');
      btn.classList.remove('btn-purple');
    } else {
      btn.style.display = 'none';
    }
  } catch(e) { /* silent */ }
}

async function handoverToManager() {
  const summaryRes = await fetch(`${API}?action=get-cashier-summary&cashier_staff_id=${currentStaff.id}`);
  const summaryData = await summaryRes.json();
  if (!summaryData.success) { showToast('Error loading summary'); return; }

  const net = summaryData.totals.netCash;
  const actualStr = prompt(`Cash to hand over to manager:\n\nExpected: â‚¹${net}\n\nEnter actual amount:`);
  if (actualStr === null) return;
  const actual = parseFloat(actualStr);
  if (isNaN(actual)) { showToast('Invalid amount'); return; }

  showLoading('Recording handover...');
  try {
    const res = await fetch(`${API}?action=cashier-to-manager`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ cashier_staff_id: currentStaff.id, actual_cash: actual, notes: '' })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    showToast(`âœ… Handed over ${fmt(actual)} to manager`);
    loadCashierSummary();
  } catch(e) { showToast('âŒ ' + e.message); }
  hideLoading();
}

function switchTab(name, el) {
  document.querySelectorAll('#cashierDash .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('#cashierDash .tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
}

// â•â•â•â•â•â•â• MANAGER VIEW â•â•â•â•â•â•â•
async function initManager() {
  document.getElementById('managerDash').classList.add('show');
  document.getElementById('managerName').textContent = currentStaff.name;
  loadPendingCollections();
  loadCollectionHistory();
}

async function loadPendingCollections() {
  const container = document.getElementById('mgrPendingContent');
  container.innerHTML = '<div class="empty-state"><div class="icon">â³</div>Loading pending collections...</div>';

  try {
    const res = await fetch(`${API}?action=get-pending-collections`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    if (data.pendingByStaff.length === 0) {
      let lastInfo = '';
      if (data.lastCollection) lastInfo = `<div class="info-box info-green" style="margin-top:16px">Last collection: ${fmtD(data.lastCollection.created_at)} â€” ${fmt(data.lastCollection.net_cash)}</div>`;
      container.innerHTML = `<div class="empty-state"><div class="icon">âœ…</div><h3>No Pending Collections</h3><p style="color:var(--text2)">All cash has been collected.</p></div>${lastInfo}`;
      return;
    }

    // Last collection info
    let lastHtml = '';
    if (data.lastCollection) {
      lastHtml = `<div class="info-box info-green" style="margin-bottom:20px">Last collection: ${fmtD(data.lastCollection.created_at)} â€” ${fmt(data.lastCollection.net_cash)} by ${data.lastCollection.manager_name || 'Manager'}</div>`;
    }

    // Build all rows for the table: runners + cashiers
    let allRunnerRows = [];
    let cashierRows = [];
    for (const entry of data.pendingByStaff) {
      // Runner rows
      for (const rh of entry.runnerHandovers) {
        allRunnerRows.push({
          name: rh.from_name,
          expected: rh.expected_cash,
          received: rh.actual_cash,
          disc: rh.discrepancy,
          reason: rh.discrepancy_reason,
          cashier: entry.cashier.name,
          time: rh.created_at
        });
      }
      // Cashier summary row
      cashierRows.push({
        name: entry.cashier.name,
        id: entry.cashier.id,
        received: entry.cashierHandover.actual_cash,
        expenses: entry.totals.expenses,
        disc: entry.totals.cashierDiscrepancy + entry.totals.runnerDiscrepancy,
        net: entry.totals.netCash,
        entry: entry
      });
    }

    // Build table
    let tableRows = '';
    // Runner rows
    for (const r of allRunnerRows) {
      const discHtml = r.disc !== 0 ? `<span style="color:var(--red)">${fmt(r.disc)}</span>` : 'â€”';
      tableRows += `<tr>
        <td class="name-col">${r.name}</td>
        <td>${fmt(r.expected)}</td>
        <td>${fmt(r.received)}</td>
        <td>â€”</td>
        <td class="disc-col">${discHtml}</td>
        <td>â€”</td>
      </tr>`;
    }
    // Counter rows (from all cashiers)
    for (const entry of data.pendingByStaff) {
      for (const ch of entry.counterHandovers) {
        tableRows += `<tr>
          <td class="name-col">Counter â†’ ${entry.cashier.name}</td>
          <td>${fmt(ch.expected_cash)}</td>
          <td>${fmt(ch.actual_cash)}</td>
          <td>â€”</td>
          <td class="disc-col">${ch.discrepancy !== 0 ? fmt(ch.discrepancy) : 'â€”'}</td>
          <td>â€”</td>
        </tr>`;
      }
    }
    // Cashier total rows
    for (const c of cashierRows) {
      const discHtml = c.disc !== 0 ? `<span style="color:var(--red)">${fmt(c.disc)}</span>` : 'â€”';
      tableRows += `<tr style="background:var(--bg2)">
        <td class="name-col" style="color:var(--purple)">ğŸ“‹ ${c.name} Total</td>
        <td>â€”</td>
        <td>${fmt(c.received + c.expenses)}</td>
        <td style="color:var(--red)">${c.expenses > 0 ? '-' + fmt(c.expenses) : 'â€”'}</td>
        <td class="disc-col">${discHtml}</td>
        <td class="net-col">${fmt(c.net)}</td>
      </tr>`;
      // Expandable detail
      if (c.entry.expenses.length > 0) {
        const expRows = c.entry.expenses.map(e => `<div class="detail-row"><span>${e.category}: ${e.description}</span><span style="color:var(--red)">-${fmt(e.amount)}</span></div>`).join('');
        tableRows += `<tr><td colspan="6" style="padding:0"><div class="detail-expand show" style="margin:0 8px 8px"><div class="detail-title">Expenses by ${c.name}</div>${expRows}</div></td></tr>`;
      }
      // Discrepancy details
      const discRunners = c.entry.runnerHandovers.filter(r => r.discrepancy !== 0);
      if (discRunners.length > 0) {
        const discRows = discRunners.map(r => `<div class="detail-row"><span>${r.from_name}: ${r.discrepancy_reason || 'No reason'}</span><span style="color:var(--red)">${fmt(r.discrepancy)} short</span></div>`).join('');
        tableRows += `<tr><td colspan="6" style="padding:0"><div class="detail-expand show" style="margin:0 8px 8px;border-color:var(--red)"><div class="detail-title" style="color:var(--red)">âš ï¸ Discrepancies</div>${discRows}</div></td></tr>`;
      }
    }

    // Grand total
    const gt = data.grandTotals;
    tableRows += `<tr class="total-row">
      <td class="name-col">TOTAL</td>
      <td>${fmt(gt.totalExpected)}</td>
      <td>${fmt(gt.totalReceived)}</td>
      <td style="color:var(--red)">${gt.totalExpenses > 0 ? '-' + fmt(gt.totalExpenses) : 'â€”'}</td>
      <td class="disc-col">${gt.totalDiscrepancy !== 0 ? fmt(gt.totalDiscrepancy) : 'â€”'}</td>
      <td class="net-col">${fmt(gt.netCash)}</td>
    </tr>`;

    container.innerHTML = `
      ${lastHtml}
      <div style="overflow-x:auto">
        <table class="mgr-table">
          <thead><tr>
            <th>Staff</th><th>Expected</th><th>Received</th><th>Expenses</th><th>Disc.</th><th>Net</th>
          </tr></thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>
      <div class="input-row" style="margin-top:20px">
        <label>ACTUAL CASH COLLECTED</label>
        <input type="number" id="collectActual" inputmode="decimal" value="${gt.netCash}" onfocus="this.select()">
      </div>
      <button class="btn btn-green" style="font-size:18px;padding:18px" onclick="confirmCollection()">âœ“ Confirm Collection â€” ${fmt(gt.netCash)}</button>
    `;
  } catch(e) {
    container.innerHTML = `<div class="empty-state" style="color:var(--red)">Error: ${e.message}</div>`;
  }
}

async function confirmCollection() {
  const actual = parseFloat(document.getElementById('collectActual').value);
  if (isNaN(actual)) { showToast('Enter amount'); return; }

  showLoading('Recording collection...');
  try {
    const res = await fetch(`${API}?action=collect`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ manager_staff_id: currentStaff.id, actual_cash_received: actual, notes: '' })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    showToast('âœ… Collection recorded â€” ' + fmt(actual));
    loadPendingCollections();
    loadCollectionHistory();
  } catch(e) { showToast('âŒ ' + e.message); }
  hideLoading();
}

async function loadCollectionHistory() {
  const container = document.getElementById('mgrHistoryContent');
  try {
    const res = await fetch(`${API}?action=collection-history`);
    const data = await res.json();
    if (!data.collections || data.collections.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div>No collection history yet</div>';
      return;
    }
    container.innerHTML = data.collections.map((c, idx) => {
      // Separate runner handovers, counter handovers, cashier-to-manager handovers
      const runners = (c.handovers || []).filter(h => h.handover_type === 'runner_to_cashier');
      const counters = (c.handovers || []).filter(h => h.handover_type === 'counter_to_cashier');
      const expenses = c.expenses || [];

      // Build detail rows for each handover
      let detailRows = '';
      for (const h of runners) {
        const discHtml = h.discrepancy !== 0
          ? `<span style="color:var(--red);font-size:11px;margin-left:6px">disc ${fmt(h.discrepancy)}</span>` : '';
        detailRows += `<div class="detail-row">
          <span style="color:var(--text)">${h.from_name}</span>
          <span>
            <span class="mono" style="color:var(--green);font-weight:600">${fmt(h.actual_cash)}</span>${discHtml}
          </span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:2px 0 6px;font-size:11px;color:var(--text2);border-bottom:1px solid rgba(45,58,79,.3)">
          <span>${fmtD(h.period_start)} â†’ ${fmtD(h.period_end)}</span>
          <span>Tokens ${fmt(h.expected_tokens)} â€¢ Sales ${fmt(h.expected_sales)} â€¢ UPI ${fmt(h.expected_upi)}</span>
        </div>`;
        if (h.discrepancy !== 0 && h.discrepancy_reason) {
          detailRows += `<div style="padding:4px 0 6px;font-size:11px;color:var(--red)">âš ï¸ ${h.discrepancy_reason}</div>`;
        }
      }

      for (const h of counters) {
        const discHtml = h.discrepancy !== 0
          ? `<span style="color:var(--red);font-size:11px;margin-left:6px">disc ${fmt(h.discrepancy)}</span>` : '';
        detailRows += `<div class="detail-row">
          <span style="color:var(--text)">Cash Counter</span>
          <span>
            <span class="mono" style="color:var(--green);font-weight:600">${fmt(h.actual_cash)}</span>${discHtml}
          </span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:2px 0 6px;font-size:11px;color:var(--text2);border-bottom:1px solid rgba(45,58,79,.3)">
          <span>${fmtD(h.period_start)} â†’ ${fmtD(h.period_end)}</span>
          <span>Cash ${fmt(h.expected_cash)} â€¢ UPI ${fmt(h.expected_upi)}</span>
        </div>`;
      }

      if (expenses.length > 0) {
        const catIcons = {police:'ğŸš”',supplies:'ğŸ›’',transport:'ğŸš—',other:'ğŸ“‹'};
        for (const e of expenses) {
          detailRows += `<div class="detail-row">
            <span style="color:var(--orange)">${catIcons[e.category]||''} ${e.category}: ${e.description}</span>
            <span class="mono" style="color:var(--red);font-weight:600">-${fmt(e.amount)}</span>
          </div>`;
        }
      }

      return `<div class="history-card" onclick="this.querySelector('.detail-expand').classList.toggle('show')" style="cursor:pointer">
        <div class="hc-header">
          <span class="hc-date">${fmtD(c.created_at)}</span>
          <span class="hc-amount">${fmt(c.net_cash)}</span>
        </div>
        <div class="hc-meta">
          By ${c.manager_name} â€¢ ${runners.length} runner${runners.length!==1?'s':''} â€¢ ${counters.length} counter
          ${expenses.length > 0 ? ' â€¢ ' + expenses.length + ' expense' + (expenses.length!==1?'s':'') : ''}
          ${c.total_discrepancy !== 0 ? ' â€¢ <span style="color:var(--red)">Disc ' + fmt(c.total_discrepancy) + '</span>' : ''}
          <span style="float:right;color:var(--blue);font-size:11px">tap to expand â–¾</span>
        </div>
        <div class="detail-expand">
          ${detailRows}
          <div class="detail-row" style="border-top:2px solid var(--border);margin-top:6px;padding-top:8px;font-weight:700">
            <span style="color:var(--text)">Total Collected</span>
            <span class="mono" style="color:var(--green);font-size:15px">${fmt(c.net_cash)}</span>
          </div>
        </div>
      </div>`;
    }).join('');
  } catch(e) { container.innerHTML = '<div class="empty-state" style="color:var(--red)">Error: ' + e.message + '</div>'; }
}

function switchMgrTab(name, el) {
  document.querySelectorAll('#managerDash .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('#managerDash .tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('mtab-' + name).classList.add('active');
}

// â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•
function showLoading(text) { document.getElementById('loadingText').textContent = text || 'Loading...'; document.getElementById('loadingOverlay').classList.add('show'); }
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }
function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
</script>
</body>
</html>
