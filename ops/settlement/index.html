<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCH Runner Settlement</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--yellow:#eab308;--orange:#f97316}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .pin-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .pin-screen.hidden{display:none}
    .pin-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;max-width:360px;width:100%}
    .pin-box .icon{font-size:48px;margin-bottom:20px}
    .pin-box h2{font-size:24px;margin-bottom:8px}
    .pin-box p{color:var(--text2);font-size:14px;margin-bottom:24px}
    .pin-input{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .pin-input input{width:48px;height:56px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:24px;text-align:center;font-family:'JetBrains Mono',monospace;transition:all 0.2s}
    .pin-input input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(168,85,247,0.2)}
    .pin-input input.filled{border-color:var(--green);background:rgba(34,197,94,0.1)}
    .pin-success{display:none;align-items:center;gap:8px;justify-content:center;color:var(--green);font-weight:600;margin-top:16px}
    .pin-success.show{display:flex}
    .dashboard{display:none;min-height:100vh}
    .dashboard.show{display:block}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:20px;display:flex;align-items:center;gap:8px}
    .header h1::before{content:'';width:4px;height:24px;background:var(--purple);border-radius:2px}
    .user-badge{display:flex;align-items:center;gap:12px}
    .user-badge .dot{width:8px;height:8px;background:var(--green);border-radius:50%}
    .user-badge .name{font-weight:600}
    .logout-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px}
    .logout-btn:hover{background:var(--border)}
    .content{padding:24px;max-width:1200px;margin:0 auto}
    .section-title{font-size:14px;color:var(--text2);margin-bottom:16px}
    .runner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-bottom:32px}
    .runner-card{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
    .runner-card:hover{border-color:var(--purple);transform:translateY(-2px)}
    .runner-card.selected{border-color:var(--purple);background:rgba(168,85,247,0.1)}
    .runner-card.counter{border-color:var(--orange)}
    .runner-card.counter:hover{border-color:var(--orange);background:rgba(249,115,22,0.1)}
    .runner-card.counter.selected{border-color:var(--orange);background:rgba(249,115,22,0.2)}
    .runner-card .name{font-weight:600;margin-bottom:4px}
    .runner-card .code{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;display:none}
    .panel.show{display:block}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .panel-header h2{font-size:20px}
    .panel-header .period{font-size:12px;color:var(--text2);background:var(--bg2);padding:6px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace}
    .row{display:flex;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border)}
    .row:last-of-type{border-bottom:none}
    .row .label{color:var(--text2)}
    .row .value{font-weight:600;font-family:'JetBrains Mono',monospace}
    .row.total{padding-top:20px;margin-top:8px;border-top:2px solid var(--border);border-bottom:none}
    .row.total .label{font-weight:600;color:var(--text)}
    .row.total .value{font-size:24px}
    .row.sub{opacity:0.7;padding:8px 0 8px 16px;font-size:14px}
    .info-box{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);border-radius:8px;padding:12px 16px;margin-top:20px;font-size:13px;color:var(--yellow)}
    .loading-text{text-align:center;color:var(--text2);padding:40px}
    .settle-btn{width:100%;background:var(--green);color:#fff;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-top:20px;transition:all 0.2s}
    .settle-btn:hover{background:#16a34a;transform:translateY(-1px)}
    .settle-btn:disabled{background:var(--border);cursor:not-allowed;transform:none}
    .settle-btn.loading{background:var(--yellow);cursor:wait}
    .settle-btn.counter-btn{background:var(--orange)}
    .settle-btn.counter-btn:hover{background:#ea580c}
  </style>
</head>
<body>
  <div class="pin-screen" id="pinScreen">
    <div class="pin-box">
      <div class="icon">üîê</div>
      <h2>Runner Settlement</h2>
      <p>Enter your 4-digit PIN to continue</p>
      <div class="pin-input" id="pinInput">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
      </div>
      <div class="pin-success" id="pinSuccess">‚úì Welcome back</div>
    </div>
  </div>
  <div class="dashboard" id="dashboard">
    <div class="header">
      <h1>Runner Settlement</h1>
      <div class="user-badge">
        <span class="dot"></span>
        <span class="name" id="userName"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="content">
      <div class="section-title">Select Runner or Counter</div>
      <div class="runner-grid" id="runnerGrid"></div>
      <div class="panel" id="panel">
        <div class="panel-header">
          <h2 id="runnerName"></h2>
          <span class="period" id="period"></span>
        </div>
        <div id="panelContent"></div>
      </div>
    </div>
  </div>
  <script>
    const $=id=>document.getElementById(id);
    const fmt=n=>'‚Çπ'+n.toLocaleString('en-IN');
    const RUNNERS=[
      {id:'counter',name:'üí∞ Cash Counter',barcode:'POS-27',isCounter:true},
      {id:64,name:'FAROOQ',barcode:'RUN001'},
      {id:65,name:'AMIN',barcode:'RUN002'},
      {id:66,name:'NCH Runner 03',barcode:'RUN003'},
      {id:67,name:'NCH Runner 04',barcode:'RUN004'},
      {id:68,name:'NCH Runner 05',barcode:'RUN005'}
    ];
    let currentUser=null,selectedRunner=null,currentRunnerData=null,currentPeriodStart=null,currentCounterData=null;
    const pins=Array.from($('pinInput').querySelectorAll('input'));
    pins.forEach((input,i)=>{
      input.addEventListener('input',e=>{
        const v=e.target.value;
        if(v){input.classList.add('filled');if(i<3)pins[i+1].focus();else checkPin();}
        else input.classList.remove('filled');
      });
      input.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!e.target.value&&i>0){pins[i-1].focus();pins[i-1].value='';pins[i-1].classList.remove('filled');}});
    });
    async function checkPin(){
      const pin=pins.map(p=>p.value).join('');
      if(pin.length!==4)return;
      try{
        const res=await fetch('/api/settlement?action=verify-pin&pin='+pin);
        const data=await res.json();
        if(data.success){
          currentUser=data.user;
          $('pinSuccess').textContent='‚úì Welcome, '+data.user;
          $('pinSuccess').classList.add('show');
          $('userName').textContent=data.user;
          setTimeout(()=>{$('pinScreen').classList.add('hidden');$('dashboard').classList.add('show');renderRunners();},800);
        }else{
          pins.forEach(p=>{p.value='';p.classList.remove('filled');p.style.borderColor='var(--red)';});
          setTimeout(()=>pins.forEach(p=>p.style.borderColor=''),500);
          pins[0].focus();
        }
      }catch(e){console.error(e);}
    }
    function logout(){currentUser=null;selectedRunner=null;$('dashboard').classList.remove('show');$('pinScreen').classList.remove('hidden');$('pinSuccess').classList.remove('show');pins.forEach(p=>{p.value='';p.classList.remove('filled');});pins[0].focus();}
    function renderRunners(){$('runnerGrid').innerHTML=RUNNERS.map(r=>'<div class="runner-card'+(r.isCounter?' counter':'')+'" onclick="selectRunner('+(typeof r.id==='string'?"'"+r.id+"'":r.id)+',this)"><div class="name">'+r.name+'</div><div class="code">'+r.barcode+'</div></div>').join('');}
    
    function toLocalISO(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      const h=String(d.getHours()).padStart(2,'0');
      const min=String(d.getMinutes()).padStart(2,'0');
      const sec=String(d.getSeconds()).padStart(2,'0');
      return y+'-'+m+'-'+day+'T'+h+':'+min+':'+sec;
    }
    
    const fmtD=(d)=>{
      const day=d.getDate().toString().padStart(2,'0');
      const mon=d.toLocaleString('en-IN',{month:'short'});
      const hr=d.getHours().toString().padStart(2,'0');
      const mn=d.getMinutes().toString().padStart(2,'0');
      return day+' '+mon+' '+hr+':'+mn;
    };
    
    async function selectRunner(id,el){
      document.querySelectorAll('.runner-card').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      selectedRunner=RUNNERS.find(r=>r.id===id);
      $('panel').classList.add('show');
      $('runnerName').textContent=selectedRunner.name;
      $('period').textContent='Loading...';
      $('panelContent').innerHTML='<div class="loading-text">Checking last settlement...</div>';
      
      if(id==='counter'){
        await loadCounterSettlement();
      }else{
        await loadRunnerSettlement(id);
      }
    }
    
    async function loadCounterSettlement(){
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id=counter');
        const lastData=await lastRes.json();
        
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.lastSettlement ? new Date(lastData.lastSettlement.settled_at) : baseline;
        currentPeriodStart=fromDate;
        
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo...</div>';
        
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        
        const mc=data.data.mainCounter;
        currentCounterData=mc;
        
        // Counter Revenue = Cash + UPI + Card (NOT token issue, NOT complimentary)
        const counterRevenue=mc.cash+mc.upi+mc.card;
        // Cash to Settle = Cash (UPI & Card go directly to bank)
        const cashToSettle=mc.cash;
        
        const hasLast=lastData.lastSettlement;
        let statusBox='';
        if(hasLast){
          const who=hasLast.settled_by===currentUser ? 'You' : hasLast.settled_by;
          statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+' (‚Çπ'+hasLast.cash_settled.toLocaleString('en-IN')+' cash)</div>';
        }else{
          statusBox='<div class="info-box">‚ö†Ô∏è Never settled. Showing from baseline (Feb 4, 5 PM).</div>';
        }

        let settleBtn='';
        if(counterRevenue>0){
          settleBtn='<button class="settle-btn counter-btn" onclick="settleCounter()">‚úì Settle '+fmt(cashToSettle)+' Cash</button>';
        }

        if(counterRevenue>0 || hasLast){
          $('panelContent').innerHTML=
            '<div class="row"><span class="label">Counter Revenue</span><span class="value">'+fmt(counterRevenue)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ Cash</span><span class="value">'+fmt(mc.cash)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ UPI (to bank)</span><span class="value" style="color:var(--blue)">'+fmt(mc.upi)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ Card (to bank)</span><span class="value" style="color:var(--blue)">'+fmt(mc.card)+'</span></div>'+
            '<div class="row" style="opacity:0.5"><span class="label">Token Issue (‚Üí Runners)</span><span class="value">'+fmt(mc.tokenIssue)+'</span></div>'+
            '<div class="row" style="opacity:0.5"><span class="label">Complimentary</span><span class="value">'+fmt(mc.complimentary)+'</span></div>'+
            '<div class="row total"><span class="label">Cash to Settle</span><span class="value" style="color:var(--orange)">'+fmt(cashToSettle)+'</span></div>'+
            statusBox+settleBtn;
        }else{
          if(hasLast){
            const who=hasLast.settled_by===currentUser ? 'you' : hasLast.settled_by;
            $('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';
          }else{
            $('panelContent').innerHTML='<div class="loading-text">No counter activity</div>';
          }
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }
    
    async function loadRunnerSettlement(id){
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id='+id);
        const lastData=await lastRes.json();
        
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.lastSettlement ? new Date(lastData.lastSettlement.settled_at) : baseline;
        currentPeriodStart=fromDate;
        
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo & Razorpay...</div>';
        
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        
        const runner=data.data.runners.find(r=>r.id===id);
        currentRunnerData=runner;
        
        const hasLast=lastData.lastSettlement;
        const hasActivity=runner && (runner.tokens>0 || runner.sales>0 || runner.upi>0);

        // Build last settlement info
        let statusBox='';
        if(hasLast){
          const who=hasLast.settled_by===currentUser ? 'You' : hasLast.settled_by;
          statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+' (‚Çπ'+hasLast.cash_settled.toLocaleString('en-IN')+' cash)</div>';
        }else{
          statusBox='<div class="info-box">‚ö†Ô∏è Never settled. Showing from baseline (Feb 4, 5 PM).</div>';
        }

        if(hasActivity){
          const cash=runner.cashToCollect;
          currentRunnerData=runner;

          let settleBtn='';
          if(cash>0){
            settleBtn='<button class="settle-btn" onclick="settleRunner()">‚úì Settle '+fmt(cash)+' Cash</button>';
          }else if(cash<0){
            settleBtn='<div class="info-box" style="background:rgba(59,130,246,0.1);border-color:var(--blue);color:var(--blue)">Runner collected more UPI than sales - verify before settling</div><button class="settle-btn" style="background:var(--blue)" onclick="settleRunner()">‚úì Confirm Settlement</button>';
          }else{
            settleBtn='<button class="settle-btn" onclick="settleRunner()">‚úì Mark as Settled (‚Çπ0 cash)</button>';
          }

          $('panelContent').innerHTML='<div class="row"><span class="label">Tokens Issued (Chai)</span><span class="value">'+fmt(runner.tokens)+'</span></div><div class="row"><span class="label">Sales Made (Snacks)</span><span class="value">'+fmt(runner.sales)+'</span></div><div class="row"><span class="label">UPI Collected (Razorpay)</span><span class="value" style="color:var(--blue)">'+fmt(runner.upi)+'</span></div><div class="row total"><span class="label">Cash to Collect</span><span class="value" style="color:'+(cash>=0?'var(--green)':'var(--red)')+'">'+fmt(cash)+'</span></div>'+statusBox+settleBtn;
        }else{
          if(hasLast){
            const who=hasLast.settled_by===currentUser ? 'you' : hasLast.settled_by;
            $('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';
          }else{
            $('panelContent').innerHTML='<div class="loading-text">No activity for this runner</div>';
          }
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }
    
    async function settleRunner(){
      if(!selectedRunner||!currentRunnerData)return;
      const btn=document.querySelector('.settle-btn');
      btn.disabled=true;
      btn.classList.add('loading');
      btn.textContent='Recording settlement...';
      
      try{
        const now=new Date();
        const res=await fetch('/api/settlement?action=settle',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            runner_id:selectedRunner.id,
            runner_name:selectedRunner.name,
            settled_by:currentUser,
            period_start:toLocalISO(currentPeriodStart),
            period_end:toLocalISO(now),
            tokens_amount:currentRunnerData.tokens,
            sales_amount:currentRunnerData.sales,
            upi_amount:currentRunnerData.upi,
            cash_settled:currentRunnerData.cashToCollect,
            notes:'Settled via dashboard'
          })
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Settlement Recorded!';
          btn.style.background='var(--green)';
          setTimeout(()=>{
            const card=document.querySelector('.runner-card.selected');
            if(card)selectRunner(selectedRunner.id,card);
          },1500);
        }else{
          throw new Error(data.error);
        }
      }catch(e){
        btn.disabled=false;
        btn.classList.remove('loading');
        btn.textContent='Error: '+e.message;
        btn.style.background='var(--red)';
      }
    }
    
    async function settleCounter(){
      if(!currentCounterData)return;
      const btn=document.querySelector('.settle-btn');
      btn.disabled=true;
      btn.classList.add('loading');
      btn.textContent='Recording settlement...';
      
      try{
        const now=new Date();
        const cashToSettle=currentCounterData.cash;
        const res=await fetch('/api/settlement?action=settle',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            runner_id:'counter',
            runner_name:'Cash Counter',
            settled_by:currentUser,
            period_start:toLocalISO(currentPeriodStart),
            period_end:toLocalISO(now),
            tokens_amount:0,
            sales_amount:currentCounterData.cash+currentCounterData.upi+currentCounterData.card,
            upi_amount:currentCounterData.upi+currentCounterData.card,
            cash_settled:cashToSettle,
            notes:'Counter settlement - Cash:'+currentCounterData.cash+' UPI:'+currentCounterData.upi+' Card:'+currentCounterData.card
          })
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Settlement Recorded!';
          btn.style.background='var(--green)';
          setTimeout(()=>{
            const card=document.querySelector('.runner-card.selected');
            if(card)selectRunner('counter',card);
          },1500);
        }else{
          throw new Error(data.error);
        }
      }catch(e){
        btn.disabled=false;
        btn.classList.remove('loading');
        btn.textContent='Error: '+e.message;
        btn.style.background='var(--red)';
      }
    }
    
    pins[0].focus();
  </script>
</body>
</html>
