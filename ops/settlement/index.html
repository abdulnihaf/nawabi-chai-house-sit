<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCH Runner Settlement</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--yellow:#eab308;--orange:#f97316}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .pin-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .pin-screen.hidden{display:none}
    .pin-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;max-width:360px;width:100%}
    .pin-box .icon{font-size:48px;margin-bottom:20px}
    .pin-box h2{font-size:24px;margin-bottom:8px}
    .pin-box p{color:var(--text2);font-size:14px;margin-bottom:24px}
    .pin-input{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .pin-input input{width:48px;height:56px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:24px;text-align:center;font-family:'JetBrains Mono',monospace;transition:all 0.2s}
    .pin-input input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(168,85,247,0.2)}
    .pin-input input.filled{border-color:var(--green);background:rgba(34,197,94,0.1)}
    .pin-success{display:none;align-items:center;gap:8px;justify-content:center;color:var(--green);font-weight:600;margin-top:16px}
    .pin-success.show{display:flex}
    .dashboard{display:none;min-height:100vh}
    .dashboard.show{display:block}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:20px;display:flex;align-items:center;gap:8px}
    .header h1::before{content:'';width:4px;height:24px;background:var(--purple);border-radius:2px}
    .user-badge{display:flex;align-items:center;gap:12px}
    .user-badge .dot{width:8px;height:8px;background:var(--green);border-radius:50%}
    .user-badge .name{font-weight:600}
    .logout-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px}
    .logout-btn:hover{background:var(--border)}
    .content{padding:24px;max-width:1200px;margin:0 auto}
    .section-title{font-size:14px;color:var(--text2);margin-bottom:16px}
    .runner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-bottom:32px}
    .runner-card{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
    .runner-card:hover{border-color:var(--purple);transform:translateY(-2px)}
    .runner-card.selected{border-color:var(--purple);background:rgba(168,85,247,0.1)}
    .runner-card.counter{border-color:var(--orange)}
    .runner-card.counter:hover{border-color:var(--orange);background:rgba(249,115,22,0.1)}
    .runner-card.counter.selected{border-color:var(--orange);background:rgba(249,115,22,0.2)}
    .runner-card.expense{border-color:var(--red)}
    .runner-card.expense:hover{border-color:var(--red);background:rgba(239,68,68,0.1)}
    .runner-card.expense.selected{border-color:var(--red);background:rgba(239,68,68,0.2)}
    .runner-card .name{font-weight:600;margin-bottom:4px}
    .runner-card .code{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;display:none}
    .panel.show{display:block}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .panel-header h2{font-size:20px}
    .panel-header .period{font-size:12px;color:var(--text2);background:var(--bg2);padding:6px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace}
    .row{display:flex;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border)}
    .row:last-of-type{border-bottom:none}
    .row .label{color:var(--text2)}
    .row .value{font-weight:600;font-family:'JetBrains Mono',monospace}
    .row.total{padding-top:20px;margin-top:8px;border-top:2px solid var(--border);border-bottom:none}
    .row.total .label{font-weight:600;color:var(--text)}
    .row.total .value{font-size:24px}
    .row.sub{opacity:0.7;padding:8px 0 8px 16px;font-size:14px}
    .info-box{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);border-radius:8px;padding:12px 16px;margin-top:20px;font-size:13px;color:var(--yellow)}
    .loading-text{text-align:center;color:var(--text2);padding:40px}
    .settle-btn{width:100%;background:var(--green);color:#fff;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-top:20px;transition:all 0.2s}
    .settle-btn:hover{background:#16a34a;transform:translateY(-1px)}
    .settle-btn:disabled{background:var(--border);cursor:not-allowed;transform:none}
    .settle-btn.loading{background:var(--yellow);cursor:wait}
    .settle-btn.counter-btn{background:var(--orange)}
    .settle-btn.counter-btn:hover{background:#ea580c}
    .collection-panel{background:var(--card);border:2px solid var(--yellow);border-radius:16px;padding:24px;margin-top:32px;display:none}
    .collection-panel.show{display:block}
    .collection-panel h3{font-size:18px;margin-bottom:4px}
    .collection-panel .subtitle{font-size:13px;color:var(--text2);margin-bottom:20px}
    .collection-big-number{text-align:center;padding:24px 0}
    .collection-big-number .amount{font-size:48px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .collection-big-number .label{font-size:14px;color:var(--text2);margin-top:4px}
    .collection-breakdown{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
    .collection-breakdown .cb-card{background:var(--bg2);border-radius:10px;padding:14px;text-align:center}
    .collection-breakdown .cb-card .cb-val{font-size:20px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .collection-breakdown .cb-card .cb-label{font-size:11px;color:var(--text2);margin-top:4px}
    .settlement-list{margin:16px 0;max-height:200px;overflow-y:auto}
    .settlement-list .sl-item{display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);font-size:13px}
    .settlement-list .sl-item:last-child{border-bottom:none}
    .settlement-list .sl-who{color:var(--text2)}
    .settlement-list .sl-amount{font-family:'JetBrains Mono',monospace;font-weight:500}
    .collect-btn{width:100%;background:var(--yellow);color:#000;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin-top:16px;transition:all 0.2s}
    .collect-btn:hover{background:#ca8a04;transform:translateY(-1px)}
    .collect-btn:disabled{background:var(--border);color:var(--text2);cursor:not-allowed;transform:none}
    .field-group{margin-top:12px}
    .field-group label{font-size:13px;color:var(--text2);display:block;margin-bottom:6px}
    .field-group input,.field-group select{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;padding:12px;font-family:'JetBrains Mono',monospace}
    .field-group input:focus,.field-group select:focus{outline:none;border-color:var(--yellow)}
    .collection-history{margin-top:24px;border-top:1px solid var(--border);padding-top:16px}
    .collection-history h4{font-size:14px;color:var(--text2);margin-bottom:12px}
    .ch-item{background:var(--bg2);border-radius:10px;padding:14px;margin-bottom:8px}
    .ch-item .ch-top{display:flex;justify-content:space-between;align-items:center}
    .ch-item .ch-amount{font-size:18px;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .ch-item .ch-date{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .ch-item .ch-detail{font-size:12px;color:var(--text2);margin-top:6px}
    .counter-balance-readonly{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-top:32px;display:none}
    .counter-balance-readonly.show{display:block}
    .counter-balance-readonly h3{font-size:16px;margin-bottom:12px;color:var(--text2)}
    .counter-balance-readonly .bal-amount{font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--yellow)}
    .counter-balance-readonly .bal-detail{font-size:12px;color:var(--text2);margin-top:6px}
    .bal-breakdown{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px}
    .bal-breakdown .bb{background:var(--bg2);border-radius:8px;padding:10px;text-align:center}
    .bal-breakdown .bb-val{font-size:16px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .bal-breakdown .bb-label{font-size:10px;color:var(--text2);margin-top:2px}
    .expense-input{background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;padding:10px;font-family:'JetBrains Mono',monospace;width:100%}
    .expense-input:focus{outline:none;border-color:var(--red)}
    .expense-reason{background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;padding:10px;width:100%;font-family:'Plus Jakarta Sans',sans-serif}
    .expense-reason:focus{outline:none;border-color:var(--red)}
    .verify-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .verify-badge.ok{background:rgba(34,197,94,0.15);color:var(--green)}
    .verify-badge.warn{background:rgba(239,68,68,0.15);color:var(--red)}
    .verify-box{background:var(--bg2);border-radius:10px;padding:14px;margin-top:16px;font-size:13px}
    .verify-box .verify-title{font-size:12px;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
    .verify-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
    .verify-row:last-child{border-bottom:none}
    .verify-row .vr-label{color:var(--text2)}
    .verify-row .vr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .audit-banner{border-radius:10px;padding:14px;margin-top:16px;font-size:13px;display:flex;gap:10px;align-items:flex-start}
    .audit-banner.warning{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);color:var(--yellow)}
    .audit-banner.critical{background:rgba(239,68,68,0.1);border:1px solid var(--red);color:var(--red)}
    .audit-banner .ab-icon{font-size:18px;flex-shrink:0}
    .audit-banner .ab-text{flex:1;line-height:1.4}
    .discrepancy-list{margin-top:16px}
    .discrepancy-item{background:var(--bg2);border-radius:8px;padding:12px;margin-bottom:8px;font-size:13px;display:flex;gap:8px;align-items:flex-start}
    .discrepancy-item.warning{border-left:3px solid var(--yellow)}
    .discrepancy-item.critical{border-left:3px solid var(--red)}
    .discrepancy-item .di-icon{flex-shrink:0}
    .discrepancy-item .di-text{flex:1;color:var(--text2);line-height:1.4}
    .discrepancy-item .di-text strong{color:var(--text)}
    .recon-panel{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:24px;margin-top:32px;display:none}
    .recon-panel.show{display:block}
    .recon-panel.balanced{border-color:var(--green)}
    .recon-panel.warning{border-color:var(--yellow)}
    .recon-panel.critical{border-color:var(--red)}
    .recon-panel h3{font-size:18px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .recon-equation{background:var(--bg2);border-radius:10px;padding:16px;margin:16px 0;text-align:center;font-family:'JetBrains Mono',monospace}
    .recon-equation .eq-main{font-size:16px;font-weight:600;line-height:1.8}
    .recon-equation .eq-status{font-size:14px;font-weight:700;margin-top:8px}
    .recon-section{margin-top:16px}
    .recon-section h4{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
    .recon-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px}
    .recon-row .rr-label{color:var(--text2)}
    .recon-row .rr-val{font-family:'JetBrains Mono',monospace;font-weight:500}
    .recon-row.total{border-top:1px solid var(--border);margin-top:4px;padding-top:8px;font-weight:600}
    .recon-row.total .rr-label{color:var(--text)}
    .cross-payment-notice{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.3);border-radius:10px;padding:14px;margin-top:12px;font-size:13px}
    .cross-payment-notice .cpn-title{font-weight:600;color:var(--yellow);margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .cross-payment-notice .cpn-item{color:var(--text2);line-height:1.5;padding:4px 0}
    .cross-payment-notice .cpn-shift{color:var(--green);font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="pin-screen" id="pinScreen">
    <div class="pin-box">
      <div class="icon">üîê</div>
      <h2>Runner Settlement</h2>
      <p>Enter your 4-digit PIN to continue</p>
      <div class="pin-input" id="pinInput">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
      </div>
      <div class="pin-success" id="pinSuccess">‚úì Welcome back</div>
    </div>
  </div>
  <div class="dashboard" id="dashboard">
    <div class="header">
      <h1>Runner Settlement</h1>
      <div class="user-badge">
        <span class="dot"></span>
        <span class="name" id="userName"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="content">
      <div class="section-title">Select Runner, Counter, or Record Expense</div>
      <div class="runner-grid" id="runnerGrid"></div>
      <div class="panel" id="panel">
        <div class="panel-header">
          <h2 id="runnerName"></h2>
          <span class="period" id="period"></span>
        </div>
        <div id="panelContent"></div>
      </div>
      <div class="counter-balance-readonly" id="counterBalanceReadonly"></div>
      <div class="collection-panel" id="collectionPanel"></div>
      <div class="recon-panel" id="shiftReconPanel"></div>
    </div>
  </div>
  <script>
    const $=id=>document.getElementById(id);
    const fmt=n=>'‚Çπ'+n.toLocaleString('en-IN');
    const RUNNERS=[
      {id:'counter',name:'üí∞ Cash Counter',barcode:'POS-27',isCounter:true},
      {id:'expense',name:'üìù Record Expense',barcode:'Cash Out',isExpense:true},
      {id:64,name:'FAROOQ',barcode:'RUN001'},
      {id:65,name:'AMIN',barcode:'RUN002'},
      {id:66,name:'NCH Runner 03',barcode:'RUN003'},
      {id:67,name:'NCH Runner 04',barcode:'RUN004'},
      {id:68,name:'NCH Runner 05',barcode:'RUN005'}
    ];
    const COLLECTORS=['Naveen','Nihaf'];
    let currentUser=null,selectedRunner=null,currentRunnerData=null,currentPeriodStart=null,currentCounterData=null,currentCounterTotal=0,currentLiveCounterCash=0;

    const pins=Array.from($('pinInput').querySelectorAll('input'));
    pins.forEach((input,i)=>{
      input.addEventListener('input',e=>{
        const v=e.target.value;
        if(v){input.classList.add('filled');if(i<3)pins[i+1].focus();else checkPin();}
        else input.classList.remove('filled');
      });
      input.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!e.target.value&&i>0){pins[i-1].focus();pins[i-1].value='';pins[i-1].classList.remove('filled');}});
    });

    async function checkPin(){
      const pin=pins.map(p=>p.value).join('');
      if(pin.length!==4)return;
      try{
        const res=await fetch('/api/settlement?action=verify-pin&pin='+pin);
        const data=await res.json();
        if(data.success){
          currentUser=data.user;
          $('pinSuccess').textContent='‚úì Welcome, '+data.user;
          $('pinSuccess').classList.add('show');
          $('userName').textContent=data.user;
          setTimeout(()=>{
            $('pinScreen').classList.add('hidden');
            $('dashboard').classList.add('show');
            renderRunners();
            loadCashAtCounter();
            loadShiftReconciliation();
          },800);
        }else{
          pins.forEach(p=>{p.value='';p.classList.remove('filled');p.style.borderColor='var(--red)';});
          setTimeout(()=>pins.forEach(p=>p.style.borderColor=''),500);
          pins[0].focus();
        }
      }catch(e){console.error(e);}
    }

    function logout(){
      currentUser=null;selectedRunner=null;
      $('dashboard').classList.remove('show');
      $('pinScreen').classList.remove('hidden');
      $('pinSuccess').classList.remove('show');
      $('collectionPanel').classList.remove('show');
      $('counterBalanceReadonly').classList.remove('show');
      $('panel').classList.remove('show');
      $('shiftReconPanel').classList.remove('show');
      lastShiftReconData=null;
      pins.forEach(p=>{p.value='';p.classList.remove('filled');});
      pins[0].focus();
    }

    function renderRunners(){
      $('runnerGrid').innerHTML=RUNNERS.map(r=>{
        const cls=r.isCounter?' counter':(r.isExpense?' expense':'');
        const idStr=typeof r.id==='string'?"'"+r.id+"'":r.id;
        return '<div class="runner-card'+cls+'" onclick="selectRunner('+idStr+',this)"><div class="name">'+r.name+'</div><div class="code">'+r.barcode+'</div></div>';
      }).join('');
    }

    function toLocalISO(d){
      return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
    }
    const fmtD=(d)=>{const day=d.getDate().toString().padStart(2,'0');const mon=d.toLocaleString('en-IN',{month:'short'});const hr=d.getHours().toString().padStart(2,'0');const mn=d.getMinutes().toString().padStart(2,'0');return day+' '+mon+' '+hr+':'+mn;};
    const fmtDate=(d)=>{const day=d.getDate().toString().padStart(2,'0');const mon=d.toLocaleString('en-IN',{month:'short'});const yr=d.getFullYear();const hr=d.getHours().toString().padStart(2,'0');const mn=d.getMinutes().toString().padStart(2,'0');return day+' '+mon+' '+yr+', '+hr+':'+mn;};

    async function selectRunner(id,el){
      document.querySelectorAll('.runner-card').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      selectedRunner=RUNNERS.find(r=>r.id===id);
      $('panel').classList.add('show');

      if(id==='expense'){
        $('runnerName').textContent='üìù Record Expense';
        $('period').textContent='';
        loadExpensePanel();
      }else if(id==='counter'){
        $('runnerName').textContent=selectedRunner.name;
        $('period').textContent='Loading...';
        $('panelContent').innerHTML='<div class="loading-text">Checking last settlement...</div>';
        await loadCounterSettlement();
      }else{
        $('runnerName').textContent=selectedRunner.name;
        $('period').textContent='Loading...';
        $('panelContent').innerHTML='<div class="loading-text">Checking last settlement...</div>';
        await loadRunnerSettlement(id);
      }
    }

    // === EXPENSE PANEL ===
    function loadExpensePanel(){
      $('panelContent').innerHTML=
        '<div style="margin-bottom:16px;color:var(--text2);font-size:14px">Record cash given out from the counter for supplies, milk, etc.</div>'+
        '<div class="field-group"><label>Amount (‚Çπ)</label><input type="number" id="expenseAmount" class="expense-input" placeholder="e.g. 200" min="1" step="10" inputmode="numeric"></div>'+
        '<div class="field-group" style="margin-top:12px"><label>Reason</label><input type="text" id="expenseReason" class="expense-reason" placeholder="e.g. Milk, Sugar, Supplies"></div>'+
        '<button class="settle-btn" style="background:var(--red)" onclick="recordExpense()">Record Expense</button>';
    }

    async function recordExpense(){
      const amount=parseFloat(document.getElementById('expenseAmount')?.value||'0');
      const reason=(document.getElementById('expenseReason')?.value||'').trim();
      const btn=document.querySelector('.settle-btn');

      if(amount<=0){btn.textContent='Enter amount';btn.style.background='var(--red)';setTimeout(()=>{btn.textContent='Record Expense';},1500);return;}
      if(!reason){btn.textContent='Enter reason';btn.style.background='var(--red)';setTimeout(()=>{btn.textContent='Record Expense';},1500);return;}

      btn.disabled=true;btn.textContent='Recording...';

      try{
        const res=await fetch('/api/settlement?action=record-expense',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({recorded_by:currentUser,amount,reason})
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Expense Recorded!';btn.style.background='var(--green)';
          setTimeout(()=>{loadExpensePanel();loadCashAtCounter();},1500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // === MISSED EXPENSE (Naveen records on behalf of cashier) ===
    async function recordMissedExpense(){
      const amount=parseFloat(document.getElementById('missedExpAmount')?.value||'0');
      const reason=(document.getElementById('missedExpReason')?.value||'').trim();
      const cashier=document.getElementById('missedExpCashier')?.value||'';
      const btn=document.getElementById('missedExpBtn');

      if(amount<=0){btn.textContent='Enter amount';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}
      if(!reason){btn.textContent='Enter reason';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}
      if(!cashier){btn.textContent='Select cashier';setTimeout(()=>{btn.textContent='Record Missed Expense';},1500);return;}

      btn.disabled=true;btn.textContent='Recording...';

      try{
        const res=await fetch('/api/settlement?action=record-expense',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({recorded_by:currentUser,amount,reason,attributed_to:cashier,notes:'Missed expense recorded by '+currentUser})
        });
        const data=await res.json();
        if(data.success){
          btn.textContent='‚úì Expense Recorded!';btn.style.background='var(--green)';
          setTimeout(()=>loadCashAtCounter(),1500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;}
    }

    // === COUNTER SETTLEMENT ===
    async function loadCounterSettlement(){
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id=counter');
        const lastData=await lastRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.periodStart?new Date(lastData.periodStart):baseline;
        currentPeriodStart=fromDate;
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo...</div>';
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        const mc=data.data.mainCounter;currentCounterData=mc;
        const vf=data.data.verification;const rc=data.data.runnerCounter;
        // Check for discrepancies at counter level
        const counterDisc=(data.data.discrepancies||[]).filter(d=>d.type==='token_issue_no_runner'||d.type==='runner_ledger_no_runner');
        const counterRevenue=mc.cash+mc.upi+mc.card;const cashToSettle=mc.cash;
        const hasLast=lastData.lastSettlement;
        const periodReason=lastData.periodReason;
        let statusBox='';
        if(periodReason==='last_collection'&&lastData.lastCollection){statusBox='<div class="info-box" style="background:rgba(234,179,8,0.1);border-color:var(--yellow);color:var(--yellow)">üì¶ Period reset by cash collection at '+fmtD(new Date(lastData.lastCollection.collected_at))+'</div>';}
        else if(hasLast){const who=hasLast.settled_by===currentUser?'You':hasLast.settled_by;statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+' (‚Çπ'+hasLast.cash_settled.toLocaleString('en-IN')+' cash)</div>';}
        else{statusBox='<div class="info-box">‚ö†Ô∏è Never settled. Showing from baseline (Feb 4, 5 PM).</div>';}

        // Build UPI verification box
        let verifyHtml='';
        if(vf){
          const ccOk=vf.cashCounter.status==='ok';const rcOk=vf.runnerCounter.status==='ok';
          const ccBadge=ccOk?'<span class="verify-badge ok">‚úì Verified</span>':'<span class="verify-badge warn">‚ö† ‚Çπ'+Math.abs(vf.cashCounter.variance)+' variance</span>';
          const rcBadge=rcOk?'<span class="verify-badge ok">‚úì Verified</span>':'<span class="verify-badge warn">‚ö† ‚Çπ'+Math.abs(vf.runnerCounter.variance)+' variance</span>';
          verifyHtml='<div class="verify-box"><div class="verify-title">üîç UPI Cross-Verification (Odoo ‚Üî Razorpay)</div>'+
            '<div class="verify-row"><span class="vr-label">Cash Counter UPI</span><span class="vr-val">Odoo: '+fmt(vf.cashCounter.odooUPI)+' | Razorpay: '+fmt(vf.cashCounter.razorpayUPI)+' '+ccBadge+'</span></div>'+
            '<div class="verify-row"><span class="vr-label">Runner Counter UPI</span><span class="vr-val">Odoo: '+fmt(vf.runnerCounter.odooUPI)+' | Razorpay: '+fmt(vf.runnerCounter.razorpayUPI)+' '+rcBadge+'</span></div>';
          if(!ccOk){
            const dir=vf.cashCounter.variance>0?'Odoo shows more UPI than Razorpay received ‚Äî possible cash recorded as UPI':'Razorpay received more than Odoo recorded ‚Äî possible missed UPI entry';
            verifyHtml+='<div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:12px;color:var(--red)">Cash Counter: '+dir+'</div>';
          }
          if(!rcOk){
            const dir=vf.runnerCounter.variance>0?'Odoo shows more UPI than Razorpay received ‚Äî possible runner sale recorded as UPI':'Razorpay received more than Odoo recorded ‚Äî possible missed order';
            verifyHtml+='<div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:12px;color:var(--red)">Runner Counter: '+dir+'</div>';
          }
          verifyHtml+='</div>';
        }

        // Runner Counter direct UPI info
        let rcHtml='';
        if(rc&&rc.upi>0){
          rcHtml='<div class="row" style="opacity:0.5"><span class="label">Runner Counter UPI (direct)</span><span class="value" style="color:var(--blue)">'+fmt(rc.upi)+'</span></div>';
        }

        let settleBtn='';if(counterRevenue>0){settleBtn='<button class="settle-btn counter-btn" onclick="settleCounter()">‚úì Settle '+fmt(cashToSettle)+' Cash</button>';}
        if(counterRevenue>0||hasLast){
          $('panelContent').innerHTML=
            '<div class="row"><span class="label">Counter Revenue</span><span class="value">'+fmt(counterRevenue)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ Cash</span><span class="value">'+fmt(mc.cash)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ UPI (to bank)</span><span class="value" style="color:var(--blue)">'+fmt(mc.upi)+'</span></div>'+
            '<div class="row sub"><span class="label">‚Ü≥ Card (to bank)</span><span class="value" style="color:var(--blue)">'+fmt(mc.card)+'</span></div>'+
            '<div class="row" style="opacity:0.5"><span class="label">Token Issue (‚Üí Runners)</span><span class="value">'+fmt(mc.tokenIssue)+'</span></div>'+
            '<div class="row" style="opacity:0.5"><span class="label">Complimentary</span><span class="value">'+fmt(mc.complimentary)+'</span></div>'+
            rcHtml+
            '<div class="row total"><span class="label">Cash to Settle</span><span class="value" style="color:var(--orange)">'+fmt(cashToSettle)+'</span></div>'+
            (counterDisc.length>0?'<div class="discrepancy-list">'+counterDisc.map(d=>'<div class="discrepancy-item '+(d.severity==='critical'?'critical':'warning')+'"><span class="di-icon">'+(d.severity==='critical'?'üö®':'‚ö†Ô∏è')+'</span><span class="di-text">'+d.message+'</span></div>').join('')+'</div>':'')+
            verifyHtml+statusBox+settleBtn;
        }else{
          if(hasLast){const who=hasLast.settled_by===currentUser?'you':hasLast.settled_by;$('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';}
          else{$('panelContent').innerHTML='<div class="loading-text">No counter activity</div>';}
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }

    // === RUNNER SETTLEMENT ===
    async function loadRunnerSettlement(id){
      try{
        const lastRes=await fetch('/api/settlement?action=get-last-settlement&runner_id='+id);
        const lastData=await lastRes.json();
        const baseline=new Date(2026,1,4,17,0,0);
        let fromDate=lastData.periodStart?new Date(lastData.periodStart):baseline;
        currentPeriodStart=fromDate;
        $('period').textContent=fmtD(fromDate)+' ‚Üí Now';
        $('panelContent').innerHTML='<div class="loading-text">Loading from Odoo & Razorpay...</div>';
        const res=await fetch('/api/nch-data?from='+toLocalISO(fromDate));
        const data=await res.json();if(!data.success)throw new Error(data.error);
        const runner=data.data.runners.find(r=>r.id===id);currentRunnerData=runner;
        const hasLast=lastData.lastSettlement;const hasActivity=runner&&(runner.tokens>0||runner.sales>0||runner.upi>0);
        const periodReason=lastData.periodReason;
        // Check for discrepancies affecting this runner
        const disc=data.data.discrepancies||[];
        const runnerDisc=disc.filter(d=>d.runner===selectedRunner.name||d.type==='runner_ledger_no_runner');
        let discHtml='';
        if(runnerDisc.length>0){
          discHtml='<div class="discrepancy-list">';
          for(const d of runnerDisc){
            const cls=d.severity==='critical'?'critical':'warning';
            const icon=d.severity==='critical'?'üö®':'‚ö†Ô∏è';
            discHtml+='<div class="discrepancy-item '+cls+'"><span class="di-icon">'+icon+'</span><span class="di-text">'+d.message+'</span></div>';
          }
          discHtml+='</div>';
        }
        let statusBox='';
        if(periodReason==='last_collection'&&lastData.lastCollection){statusBox='<div class="info-box" style="background:rgba(234,179,8,0.1);border-color:var(--yellow);color:var(--yellow)">üì¶ Period reset by cash collection at '+fmtD(new Date(lastData.lastCollection.collected_at))+'</div>';}
        else if(hasLast){const who=hasLast.settled_by===currentUser?'You':hasLast.settled_by;statusBox='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì Last settled by <strong>'+who+'</strong> at '+fmtD(new Date(hasLast.settled_at))+' (‚Çπ'+hasLast.cash_settled.toLocaleString('en-IN')+' cash)</div>';}
        else{statusBox='<div class="info-box">‚ö†Ô∏è Never settled. Showing from baseline (Feb 4, 5 PM).</div>';}
        if(hasActivity){
          const cash=runner.cashToCollect;currentRunnerData=runner;
          let settleBtn='';
          if(cash>0){settleBtn='<button class="settle-btn" onclick="settleRunner()">‚úì Settle '+fmt(cash)+' Cash</button>';}
          else if(cash<0){settleBtn='<div class="info-box" style="background:rgba(59,130,246,0.1);border-color:var(--blue);color:var(--blue)">Runner collected more UPI than sales - verify before settling</div><button class="settle-btn" style="background:var(--blue)" onclick="settleRunner()">‚úì Confirm Settlement</button>';}
          else{settleBtn='<button class="settle-btn" onclick="settleRunner()">‚úì Mark as Settled (‚Çπ0 cash)</button>';}
          const crossPayHtml=renderCrossPaymentNotice(selectedRunner.name);
          $('panelContent').innerHTML='<div class="row"><span class="label">Tokens Issued (Chai)</span><span class="value">'+fmt(runner.tokens)+'</span></div><div class="row"><span class="label">Sales Made (Snacks)</span><span class="value">'+fmt(runner.sales)+'</span></div><div class="row"><span class="label">UPI Collected (Razorpay)</span><span class="value" style="color:var(--blue)">'+fmt(runner.upi)+'</span></div><div class="row total"><span class="label">Cash to Collect</span><span class="value" style="color:'+(cash>=0?'var(--green)':'var(--red)')+'">'+fmt(cash)+'</span></div>'+discHtml+crossPayHtml+statusBox+settleBtn;
        }else{
          if(hasLast){const who=hasLast.settled_by===currentUser?'you':hasLast.settled_by;$('panelContent').innerHTML='<div class="loading-text" style="color:var(--green)">‚úì Already settled<br><small style="color:var(--text2)">Settled by '+who+' at '+fmtD(new Date(hasLast.settled_at))+'<br>No new activity since then</small></div>';}
          else{$('panelContent').innerHTML='<div class="loading-text">No activity for this runner</div>';}
        }
      }catch(e){$('panelContent').innerHTML='<div class="loading-text" style="color:var(--red)">Error: '+e.message+'</div>';}
    }

    async function settleRunner(){
      if(!selectedRunner||!currentRunnerData)return;
      const btn=document.querySelector('.settle-btn');btn.disabled=true;btn.classList.add('loading');btn.textContent='Recording settlement...';
      try{
        const now=new Date();
        const res=await fetch('/api/settlement?action=settle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({runner_id:selectedRunner.id,runner_name:selectedRunner.name,settled_by:currentUser,period_start:toLocalISO(currentPeriodStart),period_end:toLocalISO(now),tokens_amount:currentRunnerData.tokens,sales_amount:currentRunnerData.sales,upi_amount:currentRunnerData.upi,cash_settled:currentRunnerData.cashToCollect,notes:'Settled via dashboard'})});
        const data=await res.json();
        if(data.success){btn.textContent='‚úì Settlement Recorded!';btn.style.background='var(--green)';setTimeout(()=>{const card=document.querySelector('.runner-card.selected');if(card)selectRunner(selectedRunner.id,card);loadCashAtCounter();loadShiftReconciliation();},1500);}
        else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.classList.remove('loading');btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    async function settleCounter(){
      if(!currentCounterData)return;
      const btn=document.querySelector('.settle-btn');btn.disabled=true;btn.classList.add('loading');btn.textContent='Recording settlement...';
      try{
        const now=new Date();const cashToSettle=currentCounterData.cash;
        const res=await fetch('/api/settlement?action=settle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({runner_id:'counter',runner_name:'Cash Counter',settled_by:currentUser,period_start:toLocalISO(currentPeriodStart),period_end:toLocalISO(now),tokens_amount:0,sales_amount:currentCounterData.cash+currentCounterData.upi+currentCounterData.card,upi_amount:currentCounterData.upi+currentCounterData.card,cash_settled:cashToSettle,notes:'Counter settlement - Cash:'+currentCounterData.cash+' UPI:'+currentCounterData.upi+' Card:'+currentCounterData.card})});
        const data=await res.json();
        if(data.success){btn.textContent='‚úì Settlement Recorded!';btn.style.background='var(--green)';setTimeout(()=>{const card=document.querySelector('.runner-card.selected');if(card)selectRunner('counter',card);loadCashAtCounter();loadShiftReconciliation();},1500);}
        else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.classList.remove('loading');btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // ========== CASH AT COUNTER / COLLECTION ==========
    async function loadCashAtCounter(){
      const isCollector=COLLECTORS.includes(currentUser);
      try{
        const baseline=new Date(2026,1,4,17,0,0);
        // Fetch D1 balance, counter period, and collection history in parallel
        const [balRes,counterPeriodRes,histRes]=await Promise.all([
          fetch('/api/settlement?action=counter-balance'),
          fetch('/api/settlement?action=get-last-settlement&runner_id=counter'),
          fetch('/api/settlement?action=collection-history&limit=5')
        ]);
        const data=await balRes.json();if(!data.success)throw new Error(data.error);
        const bal=data.balance;const lastCol=data.lastCollection;
        const counterPeriod=await counterPeriodRes.json();

        // Counter's own period: unsettled counter cash starts from here
        const counterFrom=counterPeriod.periodStart?new Date(counterPeriod.periodStart):baseline;

        // Fetch live Odoo counter cash from counter's period (unsettled cash only)
        const odooRes=await fetch('/api/nch-data?from='+toLocalISO(counterFrom));
        const odooData=await odooRes.json();
        let liveCounterCash=0;
        if(odooData.success){liveCounterCash=odooData.data.mainCounter.cash||0;}
        currentLiveCounterCash=liveCounterCash;

        // Total cash at counter = petty + runner settlements + settled counter cash + UNSETTLED counter cash - expenses
        const totalCash=bal.pettyCash+bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;
        currentCounterTotal=totalCash;

        if(isCollector){
          $('counterBalanceReadonly').classList.remove('show');
          $('collectionPanel').classList.add('show');
          let sinceText='Since baseline (Feb 4)';
          if(lastCol){sinceText='Since last collection by '+lastCol.collected_by+' on '+fmtDate(new Date(lastCol.collected_at));}

          // New cash = runner settlements + settled counter + unsettled counter cash - expenses
          const newCash=bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;

          // Settlement list (runner settlements from D1)
          let slHtml='';
          if(bal.settlements.length>0){
            slHtml='<div class="settlement-list">';
            for(const s of bal.settlements){const t=new Date(s.settled_at);const source=s.runner_id==='counter'?'Counter':s.runner_name;slHtml+='<div class="sl-item"><span class="sl-who">'+source+' ‚Äî '+s.settled_by+' '+fmtD(t)+'</span><span class="sl-amount">'+fmt(s.cash_settled)+'</span></div>';}
            slHtml+='</div>';
          }
          // Expense list
          let expHtml='';
          if(bal.expenses&&bal.expenses.length>0){
            expHtml='<div class="settlement-list" style="margin-top:8px">';
            for(const e of bal.expenses){const t=new Date(e.recorded_at);const attr=e.attributed_to?' (by '+e.attributed_to+')':'';expHtml+='<div class="sl-item"><span class="sl-who" style="color:var(--red)">Expense: '+e.reason+attr+' ‚Äî '+e.recorded_by+' '+fmtD(t)+'</span><span class="sl-amount" style="color:var(--red)">-'+fmt(e.amount)+'</span></div>';}
            expHtml+='</div>';
          }

          // Collection history
          let histHtml='';
          const histData=await histRes.json();
          if(histData.success&&histData.collections.length>0){
            histHtml='<div class="collection-history"><h4>Recent Collections</h4>';
            for(const c of histData.collections){
              const cd=new Date(c.collected_at);
              let dl='By '+c.collected_by+' ‚Äî Collected: '+fmt(c.amount);
              if(c.expenses>0)dl+=' | Expenses: '+fmt(c.expenses);
              if(c.petty_cash>0)dl+=' | Left behind: '+fmt(c.petty_cash);
              if(c.discrepancy&&c.discrepancy!==0){const dc=c.discrepancy>0?'var(--red)':'var(--green)';const dl2=c.discrepancy>0?'Short':'Extra';dl+=' | <span style="color:'+dc+'">'+dl2+': '+fmt(Math.abs(c.discrepancy))+'</span>';}
              histHtml+='<div class="ch-item"><div class="ch-top"><span class="ch-amount">'+fmt(c.amount)+'</span><span class="ch-date">'+fmtDate(cd)+'</span></div><div class="ch-detail">'+dl+'</div></div>';
            }
            histHtml+='</div>';
          }

          // Missed expense section (Naveen can add expenses cashiers forgot to record)
          let missedExpenseHtml='<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px">'+
            '<div style="font-size:14px;font-weight:600;margin-bottom:4px;color:var(--red)">üìù Record Missed Expense</div>'+
            '<div style="font-size:12px;color:var(--text2);margin-bottom:12px">If a cashier forgot to record an expense, add it here before collecting</div>'+
            '<div class="field-group"><label>Amount (‚Çπ)</label><input type="number" id="missedExpAmount" class="expense-input" placeholder="e.g. 200" min="1" step="10" inputmode="numeric"></div>'+
            '<div class="field-group" style="margin-top:8px"><label>Reason</label><input type="text" id="missedExpReason" class="expense-reason" placeholder="e.g. Milk, Sugar, Supplies"></div>'+
            '<div class="field-group" style="margin-top:8px"><label>Which cashier gave this cash?</label><select id="missedExpCashier" style="width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;padding:10px">'+
            '<option value="">‚Äî Select Cashier ‚Äî</option>'+
            '<option value="Tanveer">Tanveer</option>'+
            '<option value="Md Kesmat">Md Kesmat</option>'+
            '<option value="Jafar">Jafar</option>'+
            '<option value="Yashwant">Yashwant</option>'+
            '<option value="Zoya">Zoya</option>'+
            '</select></div>'+
            '<button class="settle-btn" style="background:var(--red);margin-top:12px" id="missedExpBtn" onclick="recordMissedExpense()">Record Missed Expense</button></div>';

          // Collect section ‚Äî show if there's any cash at the counter
          let collectBtn='';
          if(totalCash>0){
            collectBtn='<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px"><div style="font-size:14px;font-weight:600;margin-bottom:12px">Collect Cash</div>'+
              '<div class="field-group"><label>How much cash are you taking?</label><input type="number" id="collectAmountInput" placeholder="Count and enter" min="0" step="50" oninput="updateCollectSummary()"></div>'+
              '<div id="collectSummary" style="margin-top:12px"></div>'+
              '<button class="collect-btn" id="collectBtn" onclick="collectCash()" disabled>Enter amount above</button></div>';
          }else{
            collectBtn='<div class="info-box" style="background:rgba(34,197,94,0.1);border-color:var(--green);color:var(--green)">‚úì No cash pending collection</div>';
          }

          // Breakdown cards for new cash
          const totalCounterCash=bal.counterCash+liveCounterCash;
          let bdHtml='<div class="collection-breakdown">';
          bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</div><div class="cb-label">Runner Settlements</div></div>';
          bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--orange)">'+fmt(totalCounterCash)+'</div><div class="cb-label">Counter Cash</div></div>';
          if(bal.totalExpenses>0)bdHtml+='<div class="cb-card"><div class="cb-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</div><div class="cb-label">Expenses</div></div>';
          bdHtml+='</div>';

          // TWO BIG CARDS: Total Cash at Counter, then New Cash Since Last Collection
          let cardsHtml=
            '<div style="display:grid;gap:14px;margin-bottom:16px">'+
              '<div style="background:linear-gradient(135deg,rgba(234,179,8,0.15),rgba(234,179,8,0.05));border:1.5px solid var(--yellow);border-radius:14px;padding:20px;text-align:center">'+
                '<div style="font-size:13px;color:var(--text2);margin-bottom:6px">Total Cash at Counter</div>'+
                '<div style="font-size:44px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--yellow)">'+fmt(totalCash)+'</div>'+
                '<div style="font-size:12px;color:var(--text2);margin-top:4px">Petty ‚Çπ'+bal.pettyCash.toLocaleString('en-IN')+' + New ‚Çπ'+newCash.toLocaleString('en-IN')+'</div>'+
              '</div>'+
              '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center">'+
                '<div style="font-size:12px;color:var(--text2);margin-bottom:4px">New Cash Since Last Collection</div>'+
                '<div style="font-size:28px;font-weight:700;font-family:JetBrains Mono,monospace;color:var(--green)">'+fmt(newCash)+'</div>'+
              '</div>'+
            '</div>';

          $('collectionPanel').innerHTML=
            '<h3>üí∞ Cash Collection</h3><div class="subtitle">'+sinceText+'</div>'+
            cardsHtml+bdHtml+slHtml+expHtml+missedExpenseHtml+collectBtn+histHtml;

        }else{
          // Staff read-only view
          $('collectionPanel').classList.remove('show');
          $('counterBalanceReadonly').classList.add('show');
          let sinceText='';if(lastCol){sinceText='Since '+fmtDate(new Date(lastCol.collected_at));}
          const staffNewCash=bal.runnerCash+bal.counterCash+liveCounterCash-bal.totalExpenses;
          const staffTotalCounter=bal.counterCash+liveCounterCash;

          let breakdownHtml='<div class="bal-breakdown">';
          breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--purple)">'+fmt(bal.runnerCash)+'</div><div class="bb-label">Runner Cash</div></div>';
          breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--orange)">'+fmt(staffTotalCounter)+'</div><div class="bb-label">Counter Cash</div></div>';
          if(bal.totalExpenses>0){breakdownHtml+='<div class="bb"><div class="bb-val" style="color:var(--red)">-'+fmt(bal.totalExpenses)+'</div><div class="bb-label">Expenses</div></div>';}
          breakdownHtml+='</div>';

          $('counterBalanceReadonly').innerHTML=
            '<h3>üí∞ Cash at Counter</h3>'+
            '<div style="display:grid;gap:12px;margin-bottom:12px">'+
              '<div style="text-align:center">'+
                '<div class="bal-amount">'+fmt(totalCash)+'</div>'+
                '<div class="bal-detail">Total cash at counter</div>'+
              '</div>'+
              '<div style="background:var(--bg2);border-radius:10px;padding:12px;text-align:center">'+
                '<div style="font-size:20px;font-weight:600;font-family:JetBrains Mono,monospace;color:var(--green)">'+fmt(staffNewCash)+'</div>'+
                '<div style="font-size:11px;color:var(--text2);margin-top:2px">New cash since last collection</div>'+
              '</div>'+
            '</div>'+
            (bal.pettyCash>0?'<div style="background:var(--bg2);border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:12px;color:var(--text2);display:flex;justify-content:space-between"><span>Petty cash (from last collection)</span><span style="font-family:JetBrains Mono,monospace;color:var(--yellow)">'+fmt(bal.pettyCash)+'</span></div>':'')+
            breakdownHtml+
            (sinceText?'<div class="bal-detail" style="margin-top:8px">'+sinceText+'</div>':'')+
            '<div class="bal-detail">'+bal.settlementCount+' settlement'+(bal.settlementCount!==1?'s':'')+' since last collection</div>';
        }
      }catch(e){console.error('Counter balance error:',e);}
    }

    function updateCollectSummary(){
      const collectAmt=parseFloat(document.getElementById('collectAmountInput')?.value||'0');
      const summaryEl=document.getElementById('collectSummary');
      const btn=document.getElementById('collectBtn');
      if(!summaryEl||!btn)return;

      // Total physical cash at counter
      const expected=currentCounterTotal;

      if(collectAmt<=0){summaryEl.innerHTML='';btn.disabled=true;btn.textContent='Enter amount above';return;}

      if(collectAmt>expected){
        // Taking more than expected ‚Äî flag it
        const over=collectAmt-expected;
        summaryEl.innerHTML=
          '<div style="background:var(--bg2);border-radius:10px;padding:14px;font-size:13px">'+
          '<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text2)">Total cash at counter</span><span style="font-family:JetBrains Mono,monospace">'+fmt(expected)+'</span></div>'+
          '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">You are taking</span><span style="font-family:JetBrains Mono,monospace">'+fmt(collectAmt)+'</span></div>'+
          '<div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px;margin-top:6px"><span style="color:var(--text2)">Left at counter (petty)</span><span style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--red)">‚Çπ0</span></div>'+
          '<div style="color:var(--red);font-weight:600;margin-top:8px">‚ö† Taking ‚Çπ'+over.toLocaleString('en-IN')+' more than system expected</div></div>';
        btn.disabled=false;
        btn.textContent='Confirm Collection ‚Äî Taking '+fmt(collectAmt);
        return;
      }

      // Remainder automatically becomes petty cash
      const remainder=expected-collectAmt;

      summaryEl.innerHTML=
        '<div style="background:var(--bg2);border-radius:10px;padding:14px;font-size:13px">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text2)">Total cash at counter</span><span style="font-family:JetBrains Mono,monospace">'+fmt(expected)+'</span></div>'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">You are taking</span><span style="font-family:JetBrains Mono,monospace">-'+fmt(collectAmt)+'</span></div>'+
        '<div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px;margin-top:6px"><span style="color:var(--yellow)">Left at counter (becomes petty cash)</span><span style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--yellow)">'+fmt(remainder)+'</span></div>'+
        '</div>';

      btn.disabled=false;
      btn.textContent='Confirm Collection ‚Äî Taking '+fmt(collectAmt);
    }

    async function collectCash(){
      const btn=document.getElementById('collectBtn');if(!btn)return;
      btn.disabled=true;btn.textContent='Recording collection...';
      try{
        const collectAmt=parseFloat(document.getElementById('collectAmountInput')?.value||'0');
        if(collectAmt<=0){btn.disabled=false;btn.textContent='Enter the cash amount';btn.style.background='var(--red)';setTimeout(()=>{btn.style.background='';updateCollectSummary();},2000);return;}

        // Auto-calculate petty cash: whatever is left at the counter after collection
        const pettyCash=Math.max(0,currentCounterTotal-collectAmt);

        const res=await fetch('/api/settlement?action=collect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({collected_by:currentUser,amount:collectAmt,petty_cash:pettyCash,live_counter_cash:currentLiveCounterCash,notes:'Collected via dashboard'})});
        const data=await res.json();
        if(data.success){
          let msg='‚úì Collected '+fmt(collectAmt)+' ‚Äî ‚Çπ'+pettyCash.toLocaleString('en-IN')+' left as petty';
          btn.textContent=msg;btn.style.background='var(--green)';btn.style.color='#fff';
          setTimeout(()=>loadCashAtCounter(),2500);
        }else{throw new Error(data.error);}
      }catch(e){btn.disabled=false;btn.textContent='Error: '+e.message;btn.style.background='var(--red)';}
    }

    // ========== SHIFT RECONCILIATION ==========
    let lastShiftReconData=null;

    async function loadShiftReconciliation(){
      try{
        const now=new Date();const todayISO=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+'T00:00:00';
        const res=await fetch('/api/nch-data?from='+todayISO);
        const data=await res.json();
        if(!data.success||!data.data.shiftReconciliation){$('shiftReconPanel').classList.remove('show');return;}
        const sr=data.data.shiftReconciliation;
        lastShiftReconData=sr;
        const bc=sr.balanceCheck;
        const panel=$('shiftReconPanel');
        panel.classList.add('show');
        panel.classList.remove('balanced','warning','critical');
        if(bc.isBalanced)panel.classList.add('balanced');
        else if(Math.abs(bc.variance)<=50)panel.classList.add('warning');
        else panel.classList.add('critical');

        const statusIcon=bc.isBalanced?'‚úÖ':Math.abs(bc.variance)<=50?'‚ö†Ô∏è':'üö®';
        const statusText=bc.isBalanced?'SHIFT BALANCED':bc.variance>0?'‚Çπ'+Math.abs(bc.variance)+' UNACCOUNTED':'‚Çπ'+Math.abs(bc.variance)+' EXTRA';
        const statusColor=bc.isBalanced?'var(--green)':Math.abs(bc.variance)<=50?'var(--yellow)':'var(--red)';

        let html='<h3>'+statusIcon+' Shift Reconciliation</h3>';
        html+='<div class="recon-equation">';
        html+='<div class="eq-main">Sales '+fmt(sr.totalSales)+' = Cash '+fmt(bc.expectedCash)+' + UPI '+fmt(sr.verifiedUPI.total)+' + Card '+fmt(sr.card)+' + Comp '+fmt(sr.complimentary)+'</div>';
        html+='<div class="eq-status" style="color:'+statusColor+'">'+statusText+'</div>';
        html+='</div>';

        // Cash breakdown
        html+='<div class="recon-section"><h4>Cash Breakdown</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter Drawer (PM 37)</span><span class="rr-val">'+fmt(sr.cashBreakdown.counterDrawer)+'</span></div>';
        for(const r of sr.cashBreakdown.runnerCashObligations){
          if(r.tokens>0||r.sales>0||r.upi>0){
            html+='<div class="recon-row"><span class="rr-label">'+r.name+' Cash Owed</span><span class="rr-val" style="color:'+(r.cashToCollect>=0?'var(--green)':'var(--red)')+'">'+fmt(r.cashToCollect)+'</span></div>';
          }
        }
        html+='<div class="recon-row total"><span class="rr-label">Total Expected Cash</span><span class="rr-val">'+fmt(bc.expectedCash)+'</span></div>';
        html+='</div>';

        // UPI breakdown
        html+='<div class="recon-section"><h4>UPI Breakdown (Razorpay Verified)</h4>';
        html+='<div class="recon-row"><span class="rr-label">Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.counterQR)+'</span></div>';
        html+='<div class="recon-row"><span class="rr-label">Runner Counter QR</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.runnerCounterQR)+'</span></div>';
        for(const [barcode,amt] of Object.entries(sr.verifiedUPI.runnerQRs)){
          if(amt>0)html+='<div class="recon-row"><span class="rr-label">'+barcode+' QR</span><span class="rr-val">'+fmt(amt)+'</span></div>';
        }
        html+='<div class="recon-row total"><span class="rr-label">Total Verified UPI</span><span class="rr-val" style="color:var(--blue)">'+fmt(sr.verifiedUPI.total)+'</span></div>';
        html+='</div>';

        // Card + Comp
        if(sr.card>0||sr.complimentary>0){
          html+='<div class="recon-section"><h4>Other</h4>';
          if(sr.card>0)html+='<div class="recon-row"><span class="rr-label">Card</span><span class="rr-val">'+fmt(sr.card)+'</span></div>';
          if(sr.complimentary>0)html+='<div class="recon-row"><span class="rr-label">Complimentary</span><span class="rr-val" style="color:var(--text2)">'+fmt(sr.complimentary)+'</span></div>';
          html+='</div>';
        }

        // Cross-payments
        if(sr.crossPayments&&sr.crossPayments.length>0){
          html+='<div class="recon-section"><h4>Cross-Payments</h4>';
          for(const cp of sr.crossPayments){
            html+='<div class="cross-payment-notice"><div class="cpn-title">‚ö†Ô∏è '+cp.orderName+'</div><div class="cpn-item">'+cp.description+'</div><div class="cpn-item">'+cp.runnerCashImpact+'</div><div class="cpn-shift">'+cp.shiftImpact+'</div></div>';
          }
          html+='</div>';
        }

        panel.innerHTML=html;
      }catch(e){console.error('Shift recon error:',e);}
    }

    function getCrossPaymentsForRunner(runnerName){
      if(!lastShiftReconData||!lastShiftReconData.crossPayments)return[];
      return lastShiftReconData.crossPayments.filter(cp=>cp.runner===runnerName);
    }

    function renderCrossPaymentNotice(runnerName){
      const cps=getCrossPaymentsForRunner(runnerName);
      if(cps.length===0)return '';
      let html='<div class="cross-payment-notice"><div class="cpn-title">‚ö†Ô∏è Cross-Payment Notice</div>';
      for(const cp of cps){
        html+='<div class="cpn-item">'+cp.description+'</div><div class="cpn-item" style="color:var(--yellow)">'+cp.runnerCashImpact+'</div>';
      }
      html+='<div class="cpn-shift">Shift total is correct ‚Äî UPI covers this amount at the counter level.</div></div>';
      return html;
    }

    pins[0].focus();
  </script>
</body>
</html>
