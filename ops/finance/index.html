<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NCH Finance Operations</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:#f7f7f5;color:#1f2937;min-height:100vh}
button{cursor:pointer;font-family:inherit}
input,select,textarea{font-family:inherit}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateY(30px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes fadeOverlay{from{opacity:0}to{opacity:1}}
.fade-in{animation:fadeUp .3s ease-out}

/* PIN Screen */
.pin-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%)}
.pin-box{background:#fff;border-radius:20px;padding:40px 36px;max-width:360px;width:100%;text-align:center;box-shadow:0 25px 60px rgba(0,0,0,.3)}
.pin-box h2{font-size:22px;font-weight:800;margin-bottom:4px;color:#1a1a2e}
.pin-box .sub{font-size:13px;color:#6b7280;margin-bottom:28px}
.pin-inputs{display:flex;gap:12px;justify-content:center;margin-bottom:24px}
.pin-inputs input{width:52px;height:60px;text-align:center;font-size:24px;font-weight:800;border:2px solid #e5e7eb;border-radius:12px;outline:none;transition:all .2s;font-family:'DM Mono',monospace}
.pin-inputs input:focus{border-color:#1a1a2e;box-shadow:0 0 0 3px rgba(26,26,46,.1)}
.pin-error{color:#dc2626;font-size:13px;font-weight:600;min-height:20px;margin-bottom:8px}

/* Header */
.header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);color:#fff;padding:20px 28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.header-left{display:flex;align-items:center;gap:14px}
.logo{font-size:32px;width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.1);border-radius:12px}
.header h1{font-size:20px;font-weight:800;letter-spacing:-.5px}
.header .sub{font-size:12px;opacity:.65;margin-top:2px;font-weight:500}
.header-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* Date Controls */
.date-ctrl{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);border-radius:10px;padding:6px 10px}
.date-chip{padding:5px 12px;border:none;background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);border-radius:6px;font-size:12px;font-weight:600;transition:all .2s;white-space:nowrap}
.date-chip:hover{background:rgba(255,255,255,.15);color:#fff}
.date-chip.active{background:#fff;color:#1a1a2e}
.date-input-wrap{display:flex;align-items:center;gap:4px}
.date-input-wrap span{font-size:11px;opacity:.5;color:#fff}
.date-input{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:6px;padding:5px 8px;font-size:12px;font-family:'DM Mono',monospace;outline:none;width:120px;transition:border-color .2s}
.date-input:focus{border-color:rgba(255,255,255,.5)}
.date-input::-webkit-calendar-picker-indicator{filter:invert(1);opacity:.5;cursor:pointer}
.time-box{font-size:18px;font-weight:700;font-family:'DM Mono',monospace;background:rgba(255,255,255,.08);padding:8px 14px;border-radius:8px}

/* Nav */
.nav{display:flex;gap:4px;padding:12px 24px;background:#fff;border-bottom:1px solid #e5e7eb;overflow-x:auto;flex-wrap:wrap}
.tab-btn{display:flex;align-items:center;gap:6px;padding:8px 16px;border:none;background:transparent;border-radius:8px;font-size:13px;font-weight:600;color:#6b7280;transition:all .2s;white-space:nowrap}
.tab-btn:hover{background:#f3f4f6}
.tab-btn.active{background:#1a1a2e;color:#fff}

/* Action Bar */
.action-bar{display:flex;gap:10px;padding:14px 28px;background:#fff;border-bottom:1px solid #e5e7eb;flex-wrap:wrap}
.action-btn{display:flex;align-items:center;gap:8px;padding:10px 18px;border:2px dashed #d1d5db;background:#f9fafb;border-radius:10px;font-size:13px;font-weight:600;color:#374151;transition:all .2s}
.action-btn:hover{border-color:#9ca3af;background:#f3f4f6;transform:translateY(-1px)}
.action-btn .act-icon{font-size:18px}
.action-btn.green{border-color:#86efac;background:#f0fdf4;color:#16a34a}
.action-btn.green:hover{border-color:#16a34a;background:#dcfce7}
.action-btn.red{border-color:#fca5a5;background:#fef2f2;color:#dc2626}
.action-btn.red:hover{border-color:#dc2626;background:#fee2e2}
.action-btn.purple{border-color:#c4b5fd;background:#faf5ff;color:#7c3aed}
.action-btn.purple:hover{border-color:#7c3aed;background:#ede9fe}

/* Main */
.main{padding:24px 28px;max-width:1200px;margin:0 auto}
.tab-content{display:none}
.tab-content.active{display:block}
.dashboard{display:none}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:24px}
.kpi-card{border-radius:14px;padding:20px 22px;border:1px solid #e5e7eb}
.kpi-card.highlight{border-width:2px}
.kpi-card .icon{font-size:28px;margin-bottom:4px}
.kpi-card .label{font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.8px}
.kpi-card .value{font-size:28px;font-weight:900;margin:4px 0}
.kpi-card .sub-text{font-size:11px;color:#9ca3af;line-height:1.4}

/* Expense Split Cards */
.exp-split{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.exp-card{border-radius:14px;padding:20px 22px;border:1px solid #e5e7eb;position:relative;overflow:hidden}
.exp-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.exp-card.counter::before{background:linear-gradient(90deg,#f87171,#dc2626)}
.exp-card.business::before{background:linear-gradient(90deg,#a78bfa,#7c3aed)}
.exp-card .exp-icon{font-size:24px;margin-bottom:6px}
.exp-card .exp-label{font-size:11px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.8px;margin-bottom:2px}
.exp-card .exp-value{font-size:26px;font-weight:900;margin-bottom:6px}
.exp-card .exp-detail{font-size:11px;color:#9ca3af;line-height:1.6}
.exp-card .exp-items{margin-top:10px;border-top:1px solid #f3f4f6;padding-top:8px}
.exp-card .exp-item{display:flex;justify-content:space-between;font-size:12px;padding:3px 0;color:#6b7280}
.exp-card .exp-item span:last-child{font-weight:600;color:#374151}

/* Status Row */
.status-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:28px}
.status-card{display:flex;align-items:center;gap:14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px 18px;text-align:left;transition:all .15s}
.status-card:hover{border-color:#d1d5db;transform:translateY(-1px)}
.status-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;flex-shrink:0}
.status-num{font-size:18px;font-weight:800;color:#1f2937}
.status-label{font-size:11px;color:#6b7280;font-weight:500;margin-top:1px}

.sec-hdr{margin-bottom:16px;margin-top:8px}
.sec-hdr h2{font-size:16px;font-weight:800;color:#1f2937}
.sec-hdr p{font-size:12px;color:#9ca3af;margin-top:2px}

/* Cash Flow */
.flow-card{background:#fff;border-radius:14px;padding:24px;border:1px solid #e5e7eb;margin-bottom:28px}
.flow-row{display:flex;align-items:center;gap:14px;padding:12px 0;border-bottom:1px solid #f3f4f6}
.flow-icon{font-size:18px;width:32px;text-align:center}
.flow-label{font-size:14px;font-weight:500;color:#374151;flex:1}
.flow-amount{font-size:16px;font-weight:800;font-family:'DM Mono',monospace;min-width:100px;text-align:right}
.flow-total{display:flex;justify-content:space-between;align-items:center;padding:16px 0 4px;margin-top:8px;border-top:2px dashed #d1d5db}
.flow-total-label{font-size:16px;font-weight:800}
.flow-total-amount{font-size:28px;font-weight:900}

.two-col{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.bank-card{background:#fff;border-radius:12px;padding:20px;border:1px solid #e5e7eb}
.bank-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f3f4f6;font-size:14px}
.bank-total{border-top:2px solid #e5e7eb;padding-top:12px;margin-top:4px}

/* P&L */
.pnl-hero{border-radius:16px;padding:28px 32px;margin-bottom:28px;text-align:center;border-width:2px;border-style:solid}
.pnl-hero .label{font-size:14px;font-weight:600;color:#6b7280;margin-bottom:4px;letter-spacing:1px;text-transform:uppercase}
.pnl-hero .big{font-size:42px;font-weight:900}
.pnl-hero .detail{font-size:13px;color:#6b7280;margin-top:6px}
.pnl-section{background:#fff;border-radius:12px;padding:20px;border:1px solid #e5e7eb;margin-bottom:16px}
.pnl-section-title{font-size:14px;font-weight:800;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #f3f4f6}
.pnl-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:13px;border-bottom:1px solid #f9fafb}
.pnl-total{display:flex;justify-content:space-between;align-items:center;padding:12px 0 4px;margin-top:8px;border-top:2px solid #e5e7eb;font-size:15px;font-weight:800}
.mode-tag{font-size:10px;margin-left:6px;padding:1px 6px;border-radius:4px;font-weight:700;text-transform:uppercase}
.mode-bank{background:#ede9fe;color:#7c3aed}
.mode-cash{background:#fef3c7;color:#92400e}

/* Ledger */
.ledger-filters{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.ledger-filters .filter-btn{padding:6px 14px;border:1px solid #e5e7eb;background:#fff;border-radius:8px;font-size:12px;font-weight:600;color:#6b7280;transition:all .2s}
.ledger-filters .filter-btn:hover{border-color:#d1d5db}
.ledger-filters .filter-btn.active{background:#1a1a2e;color:#fff;border-color:#1a1a2e}
.ledger-search{padding:8px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;outline:none;width:200px;transition:border-color .2s}
.ledger-search:focus{border-color:#1a1a2e}

/* Txn Log */
.txn-log{margin-top:28px}
.txn-item{display:flex;align-items:center;gap:14px;padding:14px 18px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:8px;transition:all .15s}
.txn-item:hover{border-color:#d1d5db}
.txn-type-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.txn-info{flex:1;min-width:0}
.txn-label{font-size:14px;font-weight:600;color:#1f2937;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.txn-detail{font-size:11px;color:#9ca3af;margin-top:2px}
.txn-amount{font-size:16px;font-weight:800;font-family:'DM Mono',monospace;text-align:right}
.txn-time{font-size:11px;color:#9ca3af;text-align:right;font-family:'DM Mono',monospace}
.txn-delete{width:28px;height:28px;border:none;background:#fef2f2;color:#dc2626;border-radius:6px;font-size:14px;display:flex;align-items:center;justify-content:center;opacity:.4;transition:all .15s;flex-shrink:0}
.txn-delete:hover{opacity:1;background:#fee2e2}

.empty-state{text-align:center;padding:40px 20px;color:#9ca3af}
.empty-state .empty-icon{font-size:40px;margin-bottom:12px;opacity:.5}
.empty-state .empty-text{font-size:14px;font-weight:500}

/* Loading */
.loading{text-align:center;padding:60px 20px;color:#9ca3af}
.loading .spinner{width:36px;height:36px;border:3px solid #e5e7eb;border-top-color:#1a1a2e;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:12px;color:#fff;font-size:14px;font-weight:600;z-index:2000;box-shadow:0 10px 30px rgba(0,0,0,.2);animation:slideIn .3s ease-out;display:flex;align-items:center;gap:10px;white-space:nowrap}
.toast.hidden{display:none}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeOverlay .2s ease}
.modal-overlay.hidden{display:none}
.modal{background:#fff;border-radius:18px;width:100%;max-width:480px;box-shadow:0 25px 60px rgba(0,0,0,.2);animation:slideIn .3s ease-out;overflow:hidden}
.modal-header{padding:22px 28px 0;display:flex;justify-content:space-between;align-items:flex-start}
.modal-header h3{font-size:18px;font-weight:800;color:#1f2937}
.modal-header .modal-sub{font-size:12px;color:#9ca3af;margin-top:2px}
.modal-close{width:36px;height:36px;border:none;background:#f3f4f6;border-radius:10px;font-size:18px;color:#6b7280;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.modal-close:hover{background:#e5e7eb;color:#1f2937}
.modal-body{padding:20px 28px 28px}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:12px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.form-input{width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:10px;font-size:15px;color:#1f2937;outline:none;transition:border-color .2s;background:#f9fafb}
.form-input:focus{border-color:#1a1a2e;background:#fff}
.form-input::placeholder{color:#c4c4c4}
.form-select{width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:10px;font-size:15px;color:#1f2937;outline:none;background:#f9fafb;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='%236b7280'%3E%3Cpath d='M7 8l3 3 3-3'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;cursor:pointer;transition:border-color .2s}
.form-select:focus{border-color:#1a1a2e;background-color:#fff}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-submit{width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:700;color:#fff;cursor:pointer;transition:all .2s;letter-spacing:.3px}
.form-submit:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
.form-submit:active{transform:translateY(0)}
.form-submit.green{background:linear-gradient(135deg,#16a34a,#15803d)}
.form-submit.red{background:linear-gradient(135deg,#dc2626,#b91c1c)}
.form-submit.purple{background:linear-gradient(135deg,#7c3aed,#6d28d9)}
.form-submit:disabled{opacity:.5;cursor:not-allowed;transform:none!important;box-shadow:none!important}

.footer{text-align:center;padding:16px 24px;font-size:11px;color:#9ca3af;display:flex;justify-content:center;gap:8px;border-top:1px solid #e5e7eb}

/* Delete confirm modal */
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1100;display:flex;align-items:center;justify-content:center;padding:20px}
.confirm-box{background:#fff;border-radius:16px;padding:28px;max-width:360px;width:100%;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,.2)}
.confirm-box h3{font-size:16px;font-weight:800;margin-bottom:8px}
.confirm-box p{font-size:13px;color:#6b7280;margin-bottom:20px;line-height:1.5}
.confirm-actions{display:flex;gap:10px;justify-content:center}
.confirm-actions button{padding:10px 24px;border:none;border-radius:10px;font-size:14px;font-weight:700;transition:all .2s}
.btn-cancel{background:#f3f4f6;color:#374151}
.btn-cancel:hover{background:#e5e7eb}
.btn-danger{background:#dc2626;color:#fff}
.btn-danger:hover{background:#b91c1c}

@media(max-width:640px){
  .header{padding:16px 18px}
  .main{padding:16px 14px}
  .nav{padding:10px 14px}
  .action-bar{padding:10px 14px}
  .kpi-card .value{font-size:22px}
  .pnl-hero .big{font-size:32px}
  .flow-total-amount{font-size:22px}
  .form-row{grid-template-columns:1fr}
  .modal{max-width:100%;border-radius:14px}
  .action-btn{padding:8px 12px;font-size:12px}
  .exp-split{grid-template-columns:1fr}
  .exp-card .exp-value{font-size:22px}
  .date-ctrl{flex-wrap:wrap}
  .ledger-search{width:140px}
}
</style>
</head>
<body>

<!-- PIN Screen -->
<div class="pin-screen" id="pinScreen">
  <div class="pin-box">
    <h2>Finance Operations</h2>
    <p class="sub">Enter your 4-digit PIN to access</p>
    <div class="pin-inputs">
      <input type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autofocus>
      <input type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
      <input type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
      <input type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
    </div>
    <div class="pin-error" id="pinError"></div>
  </div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
  <header class="header">
    <div class="header-left">
      <div class="logo">‚òï</div>
      <div><h1>Nawabi Chai House</h1><p class="sub">Finance Operations ‚Äî <span id="userName"></span></p></div>
    </div>
    <div class="header-right">
      <div class="date-ctrl">
        <button class="date-chip active" data-range="today">Today</button>
        <button class="date-chip" data-range="yesterday">Yesterday</button>
        <button class="date-chip" data-range="week">This Week</button>
        <button class="date-chip" data-range="month">This Month</button>
        <div class="date-input-wrap">
          <input type="date" class="date-input" id="dateFrom">
          <span>to</span>
          <input type="date" class="date-input" id="dateTo">
        </div>
      </div>
      <div class="time-box" id="headerTime"></div>
    </div>
  </header>

  <div class="action-bar">
    <button class="action-btn purple" onclick="openModal('expense')"><span class="act-icon">üìù</span> Business Expense</button>
    <button class="action-btn green" onclick="openModal('deposit')"><span class="act-icon">üè¶</span> Bank Deposit</button>
    <button class="action-btn red" onclick="openModal('withdraw')"><span class="act-icon">üè¶</span> Bank Withdrawal</button>
  </div>

  <nav class="nav" id="tabNav"></nav>

  <main class="main">
    <div id="tab-overview" class="tab-content active"></div>
    <div id="tab-cash" class="tab-content"></div>
    <div id="tab-pnl" class="tab-content"></div>
    <div id="tab-ledger" class="tab-content"></div>
  </main>

  <footer class="footer">
    <span>NCH Finance Ops</span><span style="opacity:.5">&middot;</span>
    <span id="dateRangeLabel">Today</span><span style="opacity:.5">&middot;</span>
    <span id="footerSync"></span>
  </footer>
</div>

<div class="modal-overlay hidden" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalContent"></div>
</div>
<div class="toast hidden" id="toast"></div>

<script>
const API = '/api/finance';
let currentUser = null;
let currentPin = null;
let currentTab = 'overview';
let dateFrom = '', dateTo = '';
let overviewData = null, cashFlowData = null, pnlData = null, ledgerData = null;

const fmt = n => {
  if (n === null || n === undefined) return '‚Çπ0';
  const abs = Math.abs(n);
  return (n < 0 ? '-' : '') + '‚Çπ' + abs.toLocaleString('en-IN', {maximumFractionDigits: 0});
};
const todayStr = () => {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
};
const fmtTime = iso => {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
};
const fmtDate = iso => {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString('en-IN', {day: 'numeric', month: 'short'});
};
const fmtDateTime = iso => {
  if (!iso) return '';
  return fmtDate(iso) + ' ' + fmtTime(iso);
};

// ‚ïê‚ïê‚ïê PIN ‚ïê‚ïê‚ïê
(function initPIN() {
  const inputs = document.querySelectorAll('.pin-inputs input');
  inputs.forEach((inp, i) => {
    inp.addEventListener('input', () => {
      inp.value = inp.value.replace(/\D/g, '');
      if (inp.value && i < 3) inputs[i+1].focus();
      if (i === 3 && inp.value) {
        const pin = Array.from(inputs).map(x => x.value).join('');
        if (pin.length === 4) verifyPIN(pin);
      }
    });
    inp.addEventListener('keydown', e => {
      if (e.key === 'Backspace' && !inp.value && i > 0) inputs[i-1].focus();
    });
    inp.addEventListener('paste', e => {
      e.preventDefault();
      const paste = (e.clipboardData.getData('text') || '').replace(/\D/g, '').slice(0, 4);
      paste.split('').forEach((c, j) => { if (inputs[j]) inputs[j].value = c; });
      if (paste.length === 4) verifyPIN(paste);
      else if (paste.length > 0) inputs[Math.min(paste.length, 3)].focus();
    });
  });
})();

async function verifyPIN(pin) {
  const errEl = document.getElementById('pinError');
  try {
    const res = await fetch(`${API}?action=verify-pin&pin=${pin}`);
    const data = await res.json();
    if (data.success) {
      currentUser = data.user;
      currentPin = pin;
      document.getElementById('pinScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('userName').textContent = currentUser;
      initDashboard();
    } else {
      errEl.textContent = 'Invalid PIN';
      const inputs = document.querySelectorAll('.pin-inputs input');
      inputs.forEach(i => i.value = '');
      inputs[0].focus();
    }
  } catch (e) {
    errEl.textContent = 'Connection error';
  }
}

// ‚ïê‚ïê‚ïê DASHBOARD INIT ‚ïê‚ïê‚ïê
function initDashboard() {
  setDateRange('today');
  renderNav();
  updateClock();
  setInterval(updateClock, 60000);

  // Date chips
  document.querySelectorAll('.date-chip').forEach(chip => {
    chip.addEventListener('click', () => setDateRange(chip.dataset.range));
  });
  document.getElementById('dateFrom').addEventListener('change', () => setDateRange('custom'));
  document.getElementById('dateTo').addEventListener('change', () => setDateRange('custom'));

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
}

function setDateRange(range) {
  const today = new Date();
  const label = document.getElementById('dateRangeLabel');
  document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));

  if (range === 'today') {
    dateFrom = dateTo = todayStr();
    document.querySelector('[data-range="today"]').classList.add('active');
    label.textContent = 'Today ‚Äî ' + today.toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'});
  } else if (range === 'yesterday') {
    const y = new Date(today); y.setDate(y.getDate()-1);
    dateFrom = dateTo = y.getFullYear()+'-'+String(y.getMonth()+1).padStart(2,'0')+'-'+String(y.getDate()).padStart(2,'0');
    document.querySelector('[data-range="yesterday"]').classList.add('active');
    label.textContent = 'Yesterday ‚Äî ' + y.toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'});
  } else if (range === 'week') {
    const start = new Date(today); start.setDate(start.getDate() - start.getDay());
    dateFrom = start.getFullYear()+'-'+String(start.getMonth()+1).padStart(2,'0')+'-'+String(start.getDate()).padStart(2,'0');
    dateTo = todayStr();
    document.querySelector('[data-range="week"]').classList.add('active');
    label.textContent = start.toLocaleDateString('en-IN',{day:'numeric',month:'short'}) + ' ‚Äî ' + today.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
  } else if (range === 'month') {
    const start = new Date(today.getFullYear(), today.getMonth(), 1);
    dateFrom = start.getFullYear()+'-'+String(start.getMonth()+1).padStart(2,'0')+'-01';
    dateTo = todayStr();
    document.querySelector('[data-range="month"]').classList.add('active');
    label.textContent = today.toLocaleDateString('en-IN',{month:'long',year:'numeric'});
  } else if (range === 'custom') {
    const f = document.getElementById('dateFrom').value;
    const t = document.getElementById('dateTo').value;
    if (f && t) { dateFrom = f; dateTo = t; label.textContent = fmtDate(f) + ' ‚Äî ' + fmtDate(t); }
    else return;
  }

  document.getElementById('dateFrom').value = dateFrom;
  document.getElementById('dateTo').value = dateTo;

  // Clear cached data and reload current tab
  overviewData = cashFlowData = pnlData = ledgerData = null;
  loadTab(currentTab);
}

// ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê
const tabs = [
  {id:'overview', icon:'‚óâ', label:'Overview'},
  {id:'cash', icon:'‚Çπ', label:'Cash Flow'},
  {id:'pnl', icon:'üìä', label:'P&L'},
  {id:'ledger', icon:'‚ò∞', label:'Ledger'},
];

function renderNav() {
  document.getElementById('tabNav').innerHTML = tabs.map(t =>
    `<button class="tab-btn ${t.id===currentTab?'active':''}" data-tab="${t.id}"><span>${t.icon}</span> ${t.label}</button>`
  ).join('');
  document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));
}

function switchTab(id) {
  currentTab = id;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-'+id));
  loadTab(id);
}

async function loadTab(id) {
  const el = document.getElementById('tab-'+id);
  el.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading...</div></div>';

  try {
    if (id === 'overview') {
      if (!overviewData) {
        const res = await fetch(`${API}?action=overview&from=${dateFrom}&to=${dateTo}`);
        overviewData = await res.json();
      }
      if (overviewData.success) renderOverview(overviewData);
      else el.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†</div><div class="empty-text">${overviewData.error}</div></div>`;
    } else if (id === 'cash') {
      if (!cashFlowData) {
        const res = await fetch(`${API}?action=cash-flow&from=${dateFrom}&to=${dateTo}`);
        cashFlowData = await res.json();
      }
      if (cashFlowData.success) renderCashFlow(cashFlowData);
      else el.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†</div><div class="empty-text">${cashFlowData.error}</div></div>`;
    } else if (id === 'pnl') {
      if (!pnlData) {
        const res = await fetch(`${API}?action=pnl&from=${dateFrom}&to=${dateTo}`);
        pnlData = await res.json();
      }
      if (pnlData.success) renderPnL(pnlData);
      else el.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†</div><div class="empty-text">${pnlData.error}</div></div>`;
    } else if (id === 'ledger') {
      if (!ledgerData) {
        const res = await fetch(`${API}?action=ledger&from=${dateFrom}&to=${dateTo}`);
        ledgerData = await res.json();
      }
      if (ledgerData.success) renderLedger(ledgerData);
      else el.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†</div><div class="empty-text">${ledgerData.error}</div></div>`;
    }
  } catch (e) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†</div><div class="empty-text">Failed to load: ${e.message}</div></div>`;
  }
}

// ‚ïê‚ïê‚ïê OVERVIEW TAB ‚ïê‚ïê‚ïê
function renderOverview(d) {
  const rev = d.pnl.revenue;
  const np = d.pnl.adjusted_net_profit;
  const cih = d.cashInHand;
  const ce = d.counterExpenses;
  const be = d.businessExpenses;

  document.getElementById('tab-overview').innerHTML = `<div class="fade-in">
    <div class="kpi-grid">
      ${kpi('üí∞','Cash in Hand',fmt(cih),'All-time running balance','#16a34a','#f0fdf4')}
      ${kpi('üìà','Revenue (Period)',fmt(rev),`${d.pnl.settlement_count || 0} settlement${d.pnl.settlement_count!==1?'s':''} in range`,'#2563eb','#eff6ff')}
      ${kpi(np>=0?'‚úÖ':'‚ùå','Net P&L (Period)',fmt(Math.abs(np)),np>=0?'Profit':'Loss',np>=0?'#16a34a':'#dc2626',np>=0?'#f0fdf4':'#fef2f2',true)}
    </div>

    <div class="exp-split">
      <div class="exp-card counter" style="background:#fef2f2">
        <div class="exp-icon">üßæ</div>
        <div class="exp-label">Counter Expenses</div>
        <div class="exp-value" style="color:#dc2626">${fmt(ce)}</div>
        <div class="exp-detail">Paid by counter staff from counter cash</div>
      </div>
      <div class="exp-card business" style="background:#faf5ff">
        <div class="exp-icon">üìù</div>
        <div class="exp-label">Business Expenses</div>
        <div class="exp-value" style="color:#7c3aed">${fmt(be.total)}</div>
        <div class="exp-detail">Cash: ${fmt(be.cash)} &middot; Bank: ${fmt(be.bank)}</div>
        ${be.byCategory && be.byCategory.length ? `<div class="exp-items">${be.byCategory.slice(0,4).map(c => `<div class="exp-item"><span>${c.category}</span><span>${fmt(c.total)}</span></div>`).join('')}</div>` : ''}
      </div>
    </div>

    <div class="status-row">
      <div class="status-card" onclick="switchTab('cash')">
        <div class="status-icon" style="background:#fffbeb;color:#d97706">üíµ</div>
        <div><div class="status-num">${fmt(d.collections.total)}</div><div class="status-label">Collections (${d.collections.count})</div></div>
      </div>
      <div class="status-card" onclick="switchTab('cash')">
        <div class="status-icon" style="background:#eff6ff;color:#2563eb">üè¶</div>
        <div><div class="status-num">${fmt(d.bankTransactions.deposits)}</div><div class="status-label">Bank Deposits</div></div>
      </div>
      <div class="status-card" onclick="switchTab('pnl')">
        <div class="status-icon" style="background:${d.pnl.wastage>0?'#fef2f2':'#f0fdf4'};color:${d.pnl.wastage>0?'#dc2626':'#16a34a'}">üìâ</div>
        <div><div class="status-num">${fmt(d.pnl.wastage)}</div><div class="status-label">Wastage Cost</div></div>
      </div>
      <div class="status-card" onclick="switchTab('pnl')">
        <div class="status-icon" style="background:${Math.abs(d.pnl.discrepancy)>0?'#fffbeb':'#f0fdf4'};color:${Math.abs(d.pnl.discrepancy)>0?'#d97706':'#16a34a'}">‚ö†</div>
        <div><div class="status-num">${fmt(Math.abs(d.pnl.discrepancy))}</div><div class="status-label">Discrepancy</div></div>
      </div>
    </div>

    <div class="sec-hdr"><h2>Recent Entries</h2><p>Latest transactions in this period</p></div>
    <div id="overview-recent"></div>
  </div>`;

  // Load recent entries
  loadRecentEntries();
}

async function loadRecentEntries() {
  const el = document.getElementById('overview-recent');
  if (!el) return;
  try {
    const res = await fetch(`${API}?action=ledger&from=${dateFrom}&to=${dateTo}`);
    const data = await res.json();
    if (data.success) {
      ledgerData = data; // cache
      el.innerHTML = renderTxnList(data.entries.slice(0, 10));
    }
  } catch (e) { el.innerHTML = ''; }
}

function kpi(icon, label, value, sub, color, bg, highlight) {
  return `<div class="kpi-card ${highlight?'highlight':''}" style="background:${bg};${highlight?`border-color:${color};box-shadow:0 0 20px ${color}20`:''}">
    <div class="icon">${icon}</div><div class="label">${label}</div>
    <div class="value" style="color:${color}">${value}</div><div class="sub-text">${sub}</div>
  </div>`;
}

// ‚ïê‚ïê‚ïê CASH FLOW TAB ‚ïê‚ïê‚ïê
function renderCashFlow(d) {
  const steps = [
    {l:'Opening Cash Balance', a:d.openingBalance, t:'neutral', i:'üèÅ'},
    {l:'Collections from Counter', a:d.collections.total, t:'in', i:'üíµ'},
    {l:'Bank Withdrawals', a:d.bankWithdrawals.total, t:'in', i:'üè¶'},
    {l:'Cash Business Expenses', a:-d.cashExpenses.total, t:'out', i:'üìù'},
    {l:'Bank Deposits', a:-d.bankDeposits.total, t:'out', i:'üè¶'},
  ];

  const netBank = d.bankWithdrawals.total - d.bankDeposits.total - d.bankExpenses.total;

  document.getElementById('tab-cash').innerHTML = `<div class="fade-in">
    <div class="sec-hdr"><h2>Cash Flow Tracker</h2><p>Follow the money ‚Äî every rupee in and out</p></div>
    <div class="flow-card">
      ${steps.map(s => `<div class="flow-row"><div class="flow-icon">${s.i}</div><div class="flow-label">${s.l}</div><div class="flow-amount" style="color:${s.t==='in'?'#16a34a':s.t==='out'?'#dc2626':'#374151'}">${s.a>=0?'+':''}${fmt(Math.abs(s.a))}</div></div>`).join('')}
      <div class="flow-total"><div class="flow-total-label">= Cash in Hand</div><div class="flow-total-amount" style="color:${d.cashInHand>=0?'#16a34a':'#dc2626'}">${fmt(d.cashInHand)}</div></div>
    </div>

    <div class="two-col">
      <div>
        <div class="sec-hdr"><h2>Bank Transactions</h2><p>Period movements</p></div>
        <div class="bank-card">
          <div class="bank-row"><span>Deposits to Bank</span><span style="color:#dc2626;font-weight:700">- ${fmt(d.bankDeposits.total)}</span></div>
          <div class="bank-row"><span>Withdrawals from Bank</span><span style="color:#16a34a;font-weight:700">+ ${fmt(d.bankWithdrawals.total)}</span></div>
          <div class="bank-row"><span>Business Expenses via Bank</span><span style="color:#7c3aed;font-weight:700">- ${fmt(d.bankExpenses.total)}</span></div>
          <div class="bank-row bank-total"><span style="font-weight:700">Net Bank Movement</span><span style="font-weight:800;font-size:18px">${fmt(netBank)}</span></div>
        </div>
      </div>
      <div>
        <div class="sec-hdr"><h2>Cash Summary</h2><p>Cash-only movements</p></div>
        <div class="bank-card">
          <div class="bank-row"><span>Collections from Counter</span><span style="color:#16a34a;font-weight:700">+ ${fmt(d.collections.total)}</span></div>
          <div class="bank-row"><span>Cash Business Expenses</span><span style="color:#dc2626;font-weight:700">- ${fmt(d.cashExpenses.total)}</span></div>
          <div class="bank-row bank-total"><span style="font-weight:700">Cash in Hand</span><span style="font-weight:800;font-size:18px;color:#16a34a">${fmt(d.cashInHand)}</span></div>
        </div>
      </div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê P&L TAB ‚ïê‚ïê‚ïê
function renderPnL(d) {
  const p = d.pnl;
  const np = p.adjusted_net_profit;

  document.getElementById('tab-pnl').innerHTML = `<div class="fade-in">
    <div class="sec-hdr"><h2>Profit & Loss Statement</h2><p>${p.settlement_count || 0} settlement period${p.settlement_count!==1?'s':''} in range</p></div>

    <div class="pnl-hero" style="background:linear-gradient(135deg,${np>=0?'#f0fdf4,#dcfce7':'#fef2f2,#fee2e2'});border-color:${np>=0?'#86efac':'#fca5a5'}">
      <div class="label">Adjusted Net ${np>=0?'Profit':'Loss'}</div>
      <div class="big" style="color:${np>=0?'#16a34a':'#dc2626'}">${np>=0?'+':'-'} ${fmt(Math.abs(np))}</div>
      <div class="detail">Revenue ${fmt(p.revenue_total)} &middot; COGS ${fmt(p.cogs_actual)} &middot; OpEx ${fmt(p.opex_total)}</div>
    </div>

    <div class="two-col">
      <div>
        <div class="pnl-section">
          <div class="pnl-section-title"><span style="color:#16a34a">‚ñ≤</span> Revenue</div>
          <div class="pnl-row"><span>Cash Counter</span><span style="font-weight:700;color:#16a34a">+ ${fmt(p.revenue_cash_counter)}</span></div>
          <div class="pnl-row"><span>Runner Counter</span><span style="font-weight:700;color:#16a34a">+ ${fmt(p.revenue_runner_counter)}</span></div>
          ${p.revenue_whatsapp > 0 ? `<div class="pnl-row"><span>WhatsApp</span><span style="font-weight:700;color:#16a34a">+ ${fmt(p.revenue_whatsapp)}</span></div>` : ''}
          <div class="pnl-total"><span>Total Revenue</span><span style="color:#16a34a">${fmt(p.revenue_total)}</span></div>
        </div>

        <div class="pnl-section">
          <div class="pnl-section-title"><span style="color:#dc2626">‚ñº</span> Cost of Goods Sold</div>
          <div class="pnl-row"><span>Raw Material Consumption</span><span style="font-weight:700;color:#dc2626">- ${fmt(p.cogs_actual)}</span></div>
          ${p.cogs_expected > 0 ? `<div class="pnl-row"><span style="color:#9ca3af">Expected (from recipes)</span><span style="color:#9ca3af">${fmt(p.cogs_expected)}</span></div>` : ''}
          <div class="pnl-total"><span>Gross Profit</span><span style="color:${p.gross_profit>=0?'#16a34a':'#dc2626'}">${fmt(p.gross_profit)}</span></div>
        </div>
      </div>

      <div>
        <div class="pnl-section">
          <div class="pnl-section-title"><span style="color:#dc2626">‚ñº</span> Operating Expenses</div>
          <div class="pnl-row"><span>Staff Salaries (prorated)</span><span style="font-weight:700;color:#dc2626">- ${fmt(p.opex_salaries)}</span></div>
          <div class="pnl-row"><span>Counter Expenses</span><span style="font-weight:700;color:#dc2626">- ${fmt(p.opex_counter_expenses)}</span></div>
          ${p.opex_non_consumable > 0 ? `<div class="pnl-row"><span>Non-Consumable</span><span style="font-weight:700;color:#dc2626">- ${fmt(p.opex_non_consumable)}</span></div>` : ''}
          <div class="pnl-total"><span>Net Profit</span><span style="color:${p.net_profit>=0?'#16a34a':'#dc2626'}">${fmt(p.net_profit)}</span></div>
        </div>

        <div class="pnl-section">
          <div class="pnl-section-title">Adjustments</div>
          <div class="pnl-row"><span>Wastage Cost</span><span style="font-weight:700;color:#d97706">- ${fmt(p.wastage_total_value)}</span></div>
          <div class="pnl-row"><span>Inventory Discrepancy</span><span style="font-weight:700;color:#d97706">${fmt(p.discrepancy_value)}</span></div>
          <div class="pnl-total"><span>Adjusted Net Profit</span><span style="color:${np>=0?'#16a34a':'#dc2626'}">${fmt(np)}</span></div>
        </div>

        ${d.businessExpenses > 0 ? `<div class="pnl-section">
          <div class="pnl-section-title"><span style="color:#7c3aed">‚ñº</span> Business Expenses (Outside P&L)</div>
          <div class="pnl-row"><span>Your business expenses</span><span style="font-weight:700;color:#7c3aed">- ${fmt(d.businessExpenses)}</span></div>
          <div style="font-size:11px;color:#9ca3af;padding-top:8px">Not included in store P&L ‚Äî tracked separately</div>
        </div>` : ''}
      </div>
    </div>

    ${d.periods && d.periods.length > 1 ? `<div style="margin-top:28px">
      <div class="sec-hdr"><h2>Settlement Periods</h2><p>Individual P&L per settlement</p></div>
      ${d.periods.map(s => `<div class="txn-item">
        <div class="txn-type-icon" style="background:${s.adjusted_net_profit>=0?'#f0fdf4':'#fef2f2'};color:${s.adjusted_net_profit>=0?'#16a34a':'#dc2626'}">${s.adjusted_net_profit>=0?'‚úÖ':'‚ùå'}</div>
        <div class="txn-info"><div class="txn-label">${s.settlement_date} ‚Äî ${s.settled_by}</div><div class="txn-detail">Rev ${fmt(s.revenue_total)} &middot; COGS ${fmt(s.cogs_actual)} &middot; OpEx ${fmt(s.opex_total)}</div></div>
        <div style="text-align:right"><div class="txn-amount" style="color:${s.adjusted_net_profit>=0?'#16a34a':'#dc2626'}">${fmt(s.adjusted_net_profit)}</div></div>
      </div>`).join('')}
    </div>` : ''}
  </div>`;
}

// ‚ïê‚ïê‚ïê LEDGER TAB ‚ïê‚ïê‚ïê
let ledgerFilter = 'all';
let ledgerSearchTerm = '';

function renderLedger(d) {
  const el = document.getElementById('tab-ledger');
  el.innerHTML = `<div class="fade-in">
    <div class="sec-hdr"><h2>Transaction Ledger</h2><p>${d.entries.length} entries in this period</p></div>
    <div class="ledger-filters">
      <button class="filter-btn ${ledgerFilter==='all'?'active':''}" data-filter="all">All</button>
      <button class="filter-btn ${ledgerFilter==='collection'?'active':''}" data-filter="collection">Collections</button>
      <button class="filter-btn ${ledgerFilter==='counter_expense'?'active':''}" data-filter="counter_expense">Counter Exp</button>
      <button class="filter-btn ${ledgerFilter==='business_expense'?'active':''}" data-filter="business_expense">Business Exp</button>
      <button class="filter-btn ${ledgerFilter==='bank_deposit'?'active':''}" data-filter="bank_deposit">Deposits</button>
      <button class="filter-btn ${ledgerFilter==='bank_withdrawal'?'active':''}" data-filter="bank_withdrawal">Withdrawals</button>
      <input type="text" class="ledger-search" placeholder="Search..." value="${ledgerSearchTerm}" id="ledgerSearch">
    </div>
    <div id="ledger-list"></div>
  </div>`;

  document.querySelectorAll('.filter-btn').forEach(b => b.addEventListener('click', () => {
    ledgerFilter = b.dataset.filter;
    document.querySelectorAll('.filter-btn').forEach(x => x.classList.toggle('active', x.dataset.filter === ledgerFilter));
    updateLedgerList(d.entries);
  }));

  document.getElementById('ledgerSearch').addEventListener('input', e => {
    ledgerSearchTerm = e.target.value.toLowerCase();
    updateLedgerList(d.entries);
  });

  updateLedgerList(d.entries);
}

function updateLedgerList(entries) {
  let filtered = entries;
  if (ledgerFilter !== 'all') filtered = filtered.filter(e => e.type === ledgerFilter);
  if (ledgerSearchTerm) filtered = filtered.filter(e => (e.description || '').toLowerCase().includes(ledgerSearchTerm) || (e.recorded_by || '').toLowerCase().includes(ledgerSearchTerm));

  document.getElementById('ledger-list').innerHTML = renderTxnList(filtered, true);

  // Attach delete handlers
  document.querySelectorAll('.txn-delete').forEach(btn => {
    btn.addEventListener('click', () => confirmDelete(btn.dataset.table, btn.dataset.id, btn.dataset.desc));
  });
}

// ‚ïê‚ïê‚ïê TXN RENDERING ‚ïê‚ïê‚ïê
const TXN_ICONS = {
  collection: {icon: 'üíµ', bg: '#fffbeb', color: '#d97706', label: 'Collection'},
  counter_expense: {icon: 'üßæ', bg: '#fef2f2', color: '#dc2626', label: 'Counter Expense'},
  business_expense: {icon: 'üìù', bg: '#faf5ff', color: '#7c3aed', label: 'Business Expense'},
  bank_deposit: {icon: 'üè¶', bg: '#f0fdf4', color: '#16a34a', label: 'Bank Deposit'},
  bank_withdrawal: {icon: 'üè¶', bg: '#fef2f2', color: '#dc2626', label: 'Bank Withdrawal'},
};

function renderTxnList(entries, showDelete) {
  if (!entries || !entries.length) return `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No entries for this period</div></div>`;

  return entries.map(e => {
    const t = TXN_ICONS[e.type] || {icon:'üìã', bg:'#f3f4f6', color:'#6b7280', label:e.type};
    const isInflow = e.type === 'collection' || e.type === 'bank_withdrawal';
    const amountColor = isInflow ? '#16a34a' : '#dc2626';
    const amountPrefix = isInflow ? '+' : '-';
    const canDelete = showDelete && currentUser === 'Nihaf' && (e.source_table === 'business_expenses' || e.source_table === 'bank_transactions');

    let detail = t.label;
    if (e.payment_mode) detail += ` ¬∑ <span class="mode-tag ${e.payment_mode==='bank'?'mode-bank':'mode-cash'}">${e.payment_mode}</span>`;
    if (e.category) detail += ` ¬∑ ${e.category}`;
    if (e.method) detail += ` ¬∑ ${e.method}`;
    if (e.recorded_by) detail += ` ¬∑ ${e.recorded_by}`;

    return `<div class="txn-item">
      <div class="txn-type-icon" style="background:${t.bg};color:${t.color}">${t.icon}</div>
      <div class="txn-info"><div class="txn-label">${e.description || 'No description'}</div><div class="txn-detail">${detail}</div></div>
      <div style="text-align:right"><div class="txn-amount" style="color:${amountColor}">${amountPrefix} ${fmt(e.amount)}</div><div class="txn-time">${fmtDateTime(e.timestamp)}</div></div>
      ${canDelete ? `<button class="txn-delete" data-table="${e.source_table}" data-id="${e.id}" data-desc="${(e.description||'').replace(/"/g,'&quot;')}" title="Delete">‚úï</button>` : ''}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê DELETE ‚ïê‚ïê‚ïê
function confirmDelete(table, id, desc) {
  const overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.innerHTML = `<div class="confirm-box">
    <h3>Delete Entry?</h3>
    <p>Are you sure you want to delete "<strong>${desc}</strong>"? This cannot be undone.</p>
    <div class="confirm-actions">
      <button class="btn-cancel" onclick="this.closest('.confirm-overlay').remove()">Cancel</button>
      <button class="btn-danger" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#confirmDeleteBtn').addEventListener('click', async () => {
    overlay.remove();
    try {
      const res = await fetch(`${API}?action=delete-entry`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pin: currentPin, table, id: parseInt(id)})
      });
      const data = await res.json();
      if (data.success) {
        showToast('Entry deleted', '#6b7280');
        overviewData = cashFlowData = pnlData = ledgerData = null;
        loadTab(currentTab);
      } else {
        showToast(data.error || 'Delete failed', '#dc2626');
      }
    } catch (e) { showToast('Error: ' + e.message, '#dc2626'); }
  });
}

// ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê
function openModal(type) {
  const overlay = document.getElementById('modalOverlay');
  const content = document.getElementById('modalContent');
  overlay.classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  const modals = {
    expense: {
      title: 'üìù Business Expense',
      sub: 'Record an expense ‚Äî cash or bank transfer',
      fields: `
        <div class="form-group"><label>Description</label><input type="text" class="form-input" id="f-desc" placeholder="e.g. Staff uniform purchase" autofocus></div>
        <div class="form-row">
          <div class="form-group"><label>Amount (‚Çπ)</label><input type="number" class="form-input" id="f-amount" placeholder="e.g. 3500"></div>
          <div class="form-group"><label>Payment Mode</label><select class="form-select" id="f-mode"><option value="cash">Cash</option><option value="bank">Bank Transfer / UPI</option></select></div>
        </div>
        <div class="form-group"><label>Category</label><select class="form-select" id="f-category">
          <option value="supplies">Supplies & Materials</option><option value="salary">Staff / Salary</option>
          <option value="rent">Rent / Utilities</option><option value="equipment">Equipment / Repair</option>
          <option value="marketing">Marketing / Branding</option><option value="license">License / Compliance</option>
          <option value="packaging">Packaging</option><option value="transport">Transport / Delivery</option>
          <option value="other">Other</option>
        </select></div>
        <div class="form-group"><label>Notes (Optional)</label><input type="text" class="form-input" id="f-notes" placeholder="e.g. Vendor: Kumar Textiles, Bill #456"></div>
        <button class="form-submit purple" id="modalSubmit">Record Expense</button>`,
      submit: submitExpense
    },
    deposit: {
      title: 'üè¶ Bank Deposit',
      sub: 'Record cash deposited into bank account',
      fields: `
        <div class="form-group"><label>Amount (‚Çπ)</label><input type="number" class="form-input" id="f-amount" placeholder="e.g. 10000" autofocus></div>
        <div class="form-group"><label>Description</label><input type="text" class="form-input" id="f-desc" placeholder="e.g. Daily deposit at ICICI"></div>
        <div class="form-group"><label>Method</label><select class="form-select" id="f-method">
          <option value="cash_deposit">Cash Deposit</option><option value="cheque">Cheque</option>
          <option value="neft">NEFT / IMPS</option><option value="upi">UPI Transfer</option>
        </select></div>
        <div class="form-group"><label>Notes (Optional)</label><input type="text" class="form-input" id="f-notes" placeholder="e.g. Deposit slip #12345"></div>
        <button class="form-submit green" id="modalSubmit">Record Deposit</button>`,
      submit: submitDeposit
    },
    withdraw: {
      title: 'üè¶ Bank Withdrawal',
      sub: 'Record cash withdrawn from bank account',
      fields: `
        <div class="form-group"><label>Amount (‚Çπ)</label><input type="number" class="form-input" id="f-amount" placeholder="e.g. 5000" autofocus></div>
        <div class="form-group"><label>Purpose</label><input type="text" class="form-input" id="f-desc" placeholder="e.g. Petty cash for operations"></div>
        <div class="form-group"><label>Method</label><select class="form-select" id="f-method">
          <option value="atm">ATM</option><option value="counter">Bank Counter</option>
          <option value="cheque">Self Cheque</option><option value="upi">UPI Transfer</option>
        </select></div>
        <div class="form-group"><label>Notes (Optional)</label><input type="text" class="form-input" id="f-notes" placeholder="e.g. For weekly supplies"></div>
        <button class="form-submit red" id="modalSubmit">Record Withdrawal</button>`,
      submit: submitWithdrawal
    },
  };

  const m = modals[type];
  content.innerHTML = `<div class="modal-header"><div><h3>${m.title}</h3><div class="modal-sub">${m.sub}</div></div><button class="modal-close" onclick="closeModal()">‚úï</button></div><div class="modal-body">${m.fields}</div>`;

  const submitBtn = content.querySelector('#modalSubmit');
  submitBtn.addEventListener('click', m.submit);

  setTimeout(() => { const i = content.querySelector('input'); if (i) i.focus(); }, 100);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.add('hidden');
  document.body.style.overflow = '';
}

async function submitExpense() {
  const desc = document.getElementById('f-desc').value.trim();
  const amount = parseFloat(document.getElementById('f-amount').value);
  const mode = document.getElementById('f-mode').value;
  const category = document.getElementById('f-category').value;
  const notes = document.getElementById('f-notes').value.trim();

  if (!desc) return showToast('Enter a description', '#dc2626');
  if (!amount || amount <= 0) return showToast('Enter a valid amount', '#dc2626');

  const btn = document.getElementById('modalSubmit');
  btn.disabled = true; btn.textContent = 'Saving...';

  try {
    const res = await fetch(`${API}?action=record-expense`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({pin: currentPin, amount, description: desc, category, payment_mode: mode, notes})
    });
    const data = await res.json();
    if (data.success) {
      closeModal();
      showToast(`Expense recorded: ${fmt(amount)} (${mode})`, '#7c3aed');
      overviewData = cashFlowData = pnlData = ledgerData = null;
      loadTab(currentTab);
    } else showToast(data.error || 'Failed', '#dc2626');
  } catch (e) { showToast('Error: ' + e.message, '#dc2626'); }
  finally { btn.disabled = false; btn.textContent = 'Record Expense'; }
}

async function submitDeposit() {
  const amount = parseFloat(document.getElementById('f-amount').value);
  const desc = document.getElementById('f-desc').value.trim() || 'Bank Deposit';
  const method = document.getElementById('f-method').value;
  const notes = document.getElementById('f-notes').value.trim();

  if (!amount || amount <= 0) return showToast('Enter a valid amount', '#dc2626');

  const btn = document.getElementById('modalSubmit');
  btn.disabled = true; btn.textContent = 'Saving...';

  try {
    const res = await fetch(`${API}?action=record-bank-txn`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({pin: currentPin, type: 'deposit', amount, description: desc, method, notes})
    });
    const data = await res.json();
    if (data.success) {
      closeModal();
      showToast(`Bank deposit recorded: ${fmt(amount)}`, '#16a34a');
      overviewData = cashFlowData = pnlData = ledgerData = null;
      loadTab(currentTab);
    } else showToast(data.error || 'Failed', '#dc2626');
  } catch (e) { showToast('Error: ' + e.message, '#dc2626'); }
  finally { btn.disabled = false; btn.textContent = 'Record Deposit'; }
}

async function submitWithdrawal() {
  const amount = parseFloat(document.getElementById('f-amount').value);
  const desc = document.getElementById('f-desc').value.trim() || 'Bank Withdrawal';
  const method = document.getElementById('f-method').value;
  const notes = document.getElementById('f-notes').value.trim();

  if (!amount || amount <= 0) return showToast('Enter a valid amount', '#dc2626');

  const btn = document.getElementById('modalSubmit');
  btn.disabled = true; btn.textContent = 'Saving...';

  try {
    const res = await fetch(`${API}?action=record-bank-txn`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({pin: currentPin, type: 'withdrawal', amount, description: desc, method, notes})
    });
    const data = await res.json();
    if (data.success) {
      closeModal();
      showToast(`Bank withdrawal recorded: ${fmt(amount)}`, '#dc2626');
      overviewData = cashFlowData = pnlData = ledgerData = null;
      loadTab(currentTab);
    } else showToast(data.error || 'Failed', '#dc2626');
  } catch (e) { showToast('Error: ' + e.message, '#dc2626'); }
  finally { btn.disabled = false; btn.textContent = 'Record Withdrawal'; }
}

// ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê
function showToast(msg, color) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = color || '#1a1a2e';
  t.classList.remove('hidden');
  setTimeout(() => t.classList.add('hidden'), 3000);
}

// ‚ïê‚ïê‚ïê CLOCK ‚ïê‚ïê‚ïê
function updateClock() {
  const n = new Date();
  document.getElementById('headerTime').textContent = n.toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit'});
  document.getElementById('footerSync').textContent = 'Last sync: ' + n.toLocaleTimeString('en-IN');
}
</script>
</body>
</html>
