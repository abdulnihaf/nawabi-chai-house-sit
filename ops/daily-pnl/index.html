<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCH Daily Settlement</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--muted:#64748b;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--yellow:#eab308;--orange:#f97316;--cyan:#06b6d4;--teal:#14b8a6}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .mono{font-family:'JetBrains Mono',monospace}

    /* ‚îÄ‚îÄ PIN SCREEN ‚îÄ‚îÄ */
    .pin-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .pin-screen.hidden{display:none}
    .pin-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;max-width:360px;width:100%}
    .pin-box .icon{font-size:48px;margin-bottom:20px}
    .pin-box h2{font-size:24px;margin-bottom:8px}
    .pin-box p{color:var(--text2);font-size:14px;margin-bottom:24px}
    .pin-input{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .pin-input input{width:48px;height:56px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:24px;text-align:center;font-family:'JetBrains Mono',monospace;transition:all 0.2s}
    .pin-input input:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px rgba(20,184,166,0.2)}
    .pin-input input.filled{border-color:var(--green);background:rgba(34,197,94,0.1)}
    .pin-success{display:none;align-items:center;gap:8px;justify-content:center;color:var(--green);font-weight:600;margin-top:16px}
    .pin-success.show{display:flex}
    .pin-error{display:none;color:var(--red);font-size:13px;margin-top:8px}
    .pin-error.show{display:block}

    /* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
    .dashboard{display:none;min-height:100vh}
    .dashboard.show{display:block}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
    .header h1{font-size:20px;display:flex;align-items:center;gap:8px}
    .header h1::before{content:'';width:4px;height:24px;background:linear-gradient(180deg,var(--teal),var(--cyan));border-radius:2px}
    .user-badge{display:flex;align-items:center;gap:12px}
    .user-badge .dot{width:8px;height:8px;background:var(--green);border-radius:50%}
    .user-badge .name{font-weight:600}
    .logout-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px}
    .logout-btn:hover{background:var(--border)}
    .content{padding:20px;max-width:900px;margin:0 auto}

    /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
    .tabs{display:flex;gap:4px;margin-bottom:24px;background:var(--bg2);border-radius:10px;padding:4px;overflow-x:auto}
    .tab{padding:10px 20px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;white-space:nowrap;color:var(--text2);transition:all .2s}
    .tab:hover{color:var(--text)}
    .tab.active{background:var(--card);color:var(--text);font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .tab-content{display:none}
    .tab-content.show{display:block}

    /* ‚îÄ‚îÄ DATE PICKER ‚îÄ‚îÄ */
    .date-bar{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    .date-bar input[type="date"]{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:14px;font-family:'JetBrains Mono',monospace}
    .date-bar input:focus{outline:none;border-color:var(--teal)}
    .date-bar input::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer}
    .btn{padding:10px 20px;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-family:inherit;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,var(--teal),var(--cyan));color:#fff}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(20,184,166,0.3)}
    .btn-secondary{background:var(--bg2);border:1px solid var(--border);color:var(--text)}
    .btn-secondary:hover{border-color:var(--text2)}
    .btn-green{background:var(--green);color:#fff}
    .btn-green:hover{background:#16a34a}
    .btn-orange{background:var(--orange);color:#fff}
    .btn-orange:hover{background:#ea580c}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .badge{display:inline-flex;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .badge-green{background:rgba(34,197,94,0.15);color:var(--green)}
    .badge-yellow{background:rgba(234,179,8,0.15);color:var(--yellow)}
    .badge-blue{background:rgba(59,130,246,0.15);color:var(--blue)}
    .badge-red{background:rgba(239,68,68,0.15);color:var(--red)}
    .badge-orange{background:rgba(249,115,22,0.15);color:var(--orange)}

    /* ‚îÄ‚îÄ INFO / ALERTS ‚îÄ‚îÄ */
    .alert{border-radius:10px;padding:14px 16px;margin-bottom:16px;font-size:13px;display:flex;gap:10px;align-items:flex-start}
    .alert-info{background:rgba(59,130,246,0.1);border:1px solid var(--blue);color:var(--blue)}
    .alert-warning{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);color:var(--yellow)}
    .alert-success{background:rgba(34,197,94,0.1);border:1px solid var(--green);color:var(--green)}
    .alert-error{background:rgba(239,68,68,0.1);border:1px solid var(--red);color:var(--red)}
    .alert .alert-icon{font-size:18px;flex-shrink:0}
    .alert .alert-text{flex:1;line-height:1.5}

    /* ‚îÄ‚îÄ SECTIONS / CARDS ‚îÄ‚îÄ */
    .section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
    .section-title{font-size:14px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;color:var(--text2)}
    .section-title .sec-icon{font-size:18px}

    /* ‚îÄ‚îÄ INPUT FIELDS ‚îÄ‚îÄ */
    .field{margin-bottom:16px}
    .field-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .field-label .hint{text-transform:none;letter-spacing:0;font-weight:400;color:var(--text2);opacity:0.7;font-size:11px}
    .field-row{display:flex;gap:10px;align-items:flex-end}
    .field-row .field{flex:1;margin-bottom:0}
    .input{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;padding:12px;font-family:'JetBrains Mono',monospace;transition:all .2s}
    .input:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px rgba(20,184,166,0.15)}
    .input::placeholder{color:var(--muted)}
    .input-sm{font-size:14px;padding:10px}
    select.input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
    .computed-value{font-family:'JetBrains Mono',monospace;color:var(--cyan);font-size:13px;margin-top:4px}

    /* ‚îÄ‚îÄ VESSEL ROW ‚îÄ‚îÄ */
    .vessel-group{margin-bottom:12px}
    .vessel-entries{display:flex;flex-direction:column;gap:8px}
    .vessel-entry{display:flex;gap:8px;align-items:center;background:var(--bg2);border-radius:8px;padding:10px 12px}
    .vessel-entry select{flex:1;min-width:0}
    .vessel-entry .weight-input{width:100px}
    .vessel-entry .net-display{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--cyan);min-width:80px;text-align:right}
    .vessel-entry .remove-vessel{background:none;border:none;color:var(--red);cursor:pointer;font-size:16px;padding:4px}
    .add-vessel-btn{background:none;border:1px dashed var(--border);border-radius:8px;padding:8px;color:var(--text2);font-size:13px;cursor:pointer;width:100%;text-align:center;margin-top:6px;transition:all .2s}
    .add-vessel-btn:hover{border-color:var(--teal);color:var(--teal)}

    /* ‚îÄ‚îÄ WASTAGE ‚îÄ‚îÄ */
    .wastage-entry{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .wastage-entry select{flex:1;min-width:0}
    .wastage-entry .qty-input{width:80px}
    .wastage-entry .reason-input{flex:1;min-width:100px}

    /* ‚îÄ‚îÄ PRINT HEADER (hidden on screen, visible in PDF) ‚îÄ‚îÄ */
    .print-header{display:none}

    /* ‚îÄ‚îÄ INVENTORY TABLE ‚îÄ‚îÄ */
    .inv-table{width:100%;border-collapse:collapse;font-size:13px}
    .inv-table th{text-align:left;padding:8px 10px;font-size:11px;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border)}
    .inv-table td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .inv-table tr:last-child td{border-bottom:none}
    .inv-table .num{font-family:'JetBrains Mono',monospace;text-align:right}
    .inv-table .disc-pos{color:var(--red)}
    .inv-table .disc-neg{color:var(--green)}

    /* ‚îÄ‚îÄ HISTORY LIST ‚îÄ‚îÄ */
    .history-item{background:var(--bg2);border-radius:10px;padding:16px;margin-bottom:10px;cursor:pointer;transition:all .2s;border:1px solid transparent}
    .history-item:hover{border-color:var(--border);transform:translateX(4px)}
    .history-item .hi-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .history-item .hi-date{font-weight:600;font-family:'JetBrains Mono',monospace}
    .history-item .hi-status{font-size:11px}
    .history-item .hi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .history-item .hi-stat{text-align:center}
    .history-item .hi-stat .hs-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600}
    .history-item .hi-stat .hs-label{font-size:10px;color:var(--muted);margin-top:2px}

    /* ‚îÄ‚îÄ DECOMPOSITION PREVIEW ‚îÄ‚îÄ */
    .decomp-preview{background:var(--bg2);border-radius:8px;padding:12px;margin-top:12px;font-size:12px}
    .decomp-preview h4{font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;letter-spacing:0.5px}
    .decomp-preview .dp-row{display:flex;justify-content:space-between;padding:3px 0}
    .decomp-preview .dp-row .dp-name{color:var(--text2)}
    .decomp-preview .dp-row .dp-val{font-family:'JetBrains Mono',monospace;color:var(--cyan)}

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    .loading{text-align:center;padding:40px;color:var(--text2)}
    .spinner{display:inline-block;width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ‚îÄ‚îÄ PHOTO VERIFICATION ‚îÄ‚îÄ */
    .photo-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer;color:var(--text2);transition:all .2s;display:inline-flex;align-items:center;gap:4px;vertical-align:middle;margin-left:4px}
    .photo-btn:hover{border-color:var(--teal);color:var(--teal)}
    .photo-btn.has-photo{border-color:var(--green);color:var(--green);background:rgba(34,197,94,0.1)}
    .photo-btn.verifying{border-color:var(--yellow);color:var(--yellow);background:rgba(234,179,8,0.1)}
    .photo-btn .cam-icon{font-size:14px}
    .ai-badge{display:inline-flex;font-size:10px;font-family:'JetBrains Mono',monospace;padding:2px 6px;border-radius:4px;margin-left:4px;vertical-align:middle;letter-spacing:0.3px;font-weight:500}
    .ai-match{background:rgba(34,197,94,0.15);color:var(--green)}
    .ai-mismatch{background:rgba(239,68,68,0.15);color:var(--red)}
    .ai-pending{background:rgba(234,179,8,0.15);color:var(--yellow)}

    /* ‚îÄ‚îÄ IN-APP CAMERA OVERLAY ‚îÄ‚îÄ */
    .camera-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;background:#000;flex-direction:column}
    .camera-overlay.active{display:flex}
    .camera-overlay video{flex:1;object-fit:cover;width:100%}
    .camera-overlay canvas{display:none}
    .camera-controls{position:absolute;bottom:0;left:0;right:0;display:flex;align-items:center;justify-content:center;padding:24px 20px 40px;background:linear-gradient(transparent,rgba(0,0,0,0.7))}
    .camera-shutter{width:72px;height:72px;border-radius:50%;border:4px solid #fff;background:rgba(255,255,255,0.2);cursor:pointer;transition:all .15s}
    .camera-shutter:active{transform:scale(0.9);background:rgba(255,255,255,0.5)}
    .camera-close{position:absolute;top:16px;right:16px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .camera-label{position:absolute;top:16px;left:16px;color:#fff;font-size:13px;font-weight:600;background:rgba(0,0,0,0.5);padding:6px 12px;border-radius:8px}

    /* ‚îÄ‚îÄ TIMESTAMP BADGES ‚îÄ‚îÄ */
    .ts-badge{display:none;font-size:10px;font-family:'JetBrains Mono',monospace;padding:2px 6px;border-radius:4px;margin-left:6px;vertical-align:middle;letter-spacing:0.3px;font-weight:500}
    .ts-fresh{background:rgba(34,197,94,0.15);color:var(--green)}
    .ts-warn{background:rgba(234,179,8,0.15);color:var(--yellow)}
    .ts-old{background:rgba(249,115,22,0.15);color:var(--orange)}
    .field-label .ts-badge{font-size:10px}

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media(max-width:600px){
      .content{padding:12px}
      .header{padding:12px 16px}
      .header h1{font-size:16px}
      .tabs{gap:2px;padding:3px}
      .tab{padding:8px 14px;font-size:13px}
      .field-row{flex-direction:column}
      .vessel-entry{flex-wrap:wrap}
      .vessel-entry select{width:100%}
      .vessel-entry .weight-input{width:100%;flex:none}
      .history-item .hi-grid{grid-template-columns:repeat(2,1fr)}
    }

    /* ‚îÄ‚îÄ PRINT / PDF ‚îÄ‚îÄ */
    @media print {
      .pin-screen, .header, .tabs, .date-bar, .logout-btn,
      #settleForm, #settleLoading, #settleAlreadyDone, #periodInfo,
      .history-item, #historyLoading, .camera-overlay,
      button, .btn, .no-print { display: none !important; }
      body { background: #fff !important; color: #000 !important; font-size: 11pt; }
      .dashboard, .content, .tab-content { background: #fff !important; padding: 0 !important; max-width: 100% !important; }
      .tab-content.show { display: block !important; }
      .section { background: #fff !important; border: 1px solid #ccc !important; box-shadow: none !important; page-break-inside: avoid; margin-bottom: 12px !important; }
      .inv-table th { color: #333 !important; border-bottom: 2px solid #333 !important; }
      .inv-table td { color: #000 !important; border-bottom: 1px solid #ddd !important; }
      .mono, .num { color: #000 !important; }
      .print-header { display: block !important; text-align: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #333; }
      .print-header h2 { margin: 0 0 4px 0; font-size: 18pt; color: #000; }
      .print-header p { margin: 2px 0; font-size: 11pt; color: #333; }
    }
  </style>
</head>
<body>
  <!-- ‚ïê‚ïê‚ïê PIN SCREEN ‚ïê‚ïê‚ïê -->
  <div class="pin-screen" id="pinScreen">
    <div class="pin-box">
      <div class="icon">üìä</div>
      <h2>Daily Settlement</h2>
      <p>Enter your 4-digit PIN to continue</p>
      <div class="pin-input" id="pinInput">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
        <input type="password" maxlength="1" inputmode="numeric">
      </div>
      <div class="pin-success" id="pinSuccess">‚úì Welcome back</div>
      <div class="pin-error" id="pinError">Invalid PIN ‚Äî try again</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
  <div class="dashboard" id="dashboard">
    <div class="header">
      <h1>Daily Settlement</h1>
      <div class="user-badge">
        <span class="dot"></span>
        <span class="name" id="userName"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="content">
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="settle" onclick="switchTab('settle')">üìù Settle</div>
        <div class="tab" data-tab="history" onclick="switchTab('history')">üìã History</div>
        <div class="tab" data-tab="config" onclick="switchTab('config')">‚öôÔ∏è Config</div>
      </div>

      <!-- ‚ïê‚ïê‚ïê SETTLE TAB ‚ïê‚ïê‚ïê -->
      <div class="tab-content show" id="tab-settle">
        <div class="date-bar">
          <button class="btn btn-primary" onclick="prepareSettlement()" id="startSettleBtn">Start New Settlement</button>
          <span id="dateStatus" style="font-size:13px;color:var(--text2)"></span>
        </div>
        <div id="periodInfo" style="display:none;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:13px">
          <span style="color:var(--text2)">Period:</span> <span id="periodText" class="mono" style="color:var(--cyan)"></span>
          <span id="periodDuration" style="color:var(--text2);margin-left:8px"></span>
        </div>

        <div id="settleLoading" class="loading" style="display:none"><div class="spinner"></div><p style="margin-top:12px">Loading settlement data...</p></div>
        <div id="settleAlreadyDone" style="display:none"></div>
        <div id="settleForm" style="display:none">
          <!-- Bootstrap banner -->
          <div id="bootstrapBanner" class="alert alert-info" style="display:none">
            <span class="alert-icon">üèÅ</span>
            <div class="alert-text"><strong>Bootstrap Settlement</strong> ‚Äî No previous settlement found. This will record your baseline inventory. Only physical counts are needed ‚Äî no P&L will be calculated.<br><br>Count everything as accurately as possible. This becomes Day 0.</div>
          </div>

          <!-- Revenue hidden ‚Äî inventory-only mode -->
          <div id="revenueSection" style="display:none"></div>

          <!-- ‚ïê‚ïê‚ïê INVENTORY COUNT ‚Äî 4 PHYSICAL ZONES ‚ïê‚ïê‚ïê -->

          <!-- ‚îÄ‚îÄ SECTION 1: FREEZER ‚îÄ‚îÄ -->
          <div class="section">
            <div class="section-title"><span class="sec-icon">‚ùÑÔ∏è</span> Freezer</div>
            <div class="field">
              <div class="field-label">Raw Buffalo Milk <span class="hint">(unboiled, litres)</span><span class="ts-badge" data-ts-for="raw_buffalo_milk"></span></div>
              <input type="number" class="input" id="raw_buffalo_milk" step="0.1" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('raw_buffalo_milk');updateDecomp()">
            </div>
            <div class="field-row">
              <div class="field">
                <div class="field-label">Raw Cutlets <span class="hint">(frozen)</span><span class="ts-badge" data-ts-for="raw_cutlets"></span>
                  <button class="photo-btn" data-photo-field="raw_cutlets" onclick="triggerPhoto('count','raw_cutlets')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_raw_cutlets"></span>
                </div>
                <input type="number" class="input input-sm" id="raw_cutlets" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('raw_cutlets');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Raw Samosa <span class="hint">(frozen)</span><span class="ts-badge" data-ts-for="raw_samosa"></span>
                  <button class="photo-btn" data-photo-field="raw_samosa" onclick="triggerPhoto('count','raw_samosa')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_raw_samosa"></span>
                </div>
                <input type="number" class="input input-sm" id="raw_samosa" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('raw_samosa');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Raw Cheese Balls <span class="hint">(frozen)</span><span class="ts-badge" data-ts-for="raw_cheese_balls"></span>
                  <button class="photo-btn" data-photo-field="raw_cheese_balls" onclick="triggerPhoto('count','raw_cheese_balls')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_raw_cheese_balls"></span>
                </div>
                <input type="number" class="input input-sm" id="raw_cheese_balls" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('raw_cheese_balls');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Butter <span class="hint">(kg ‚Äî blocks/tubs)</span><span class="ts-badge" data-ts-for="butter"></span></div>
                <input type="number" class="input input-sm" id="butter" step="0.01" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('butter');updateDecomp()">
              </div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ SECTION 2: KITCHEN ‚îÄ‚îÄ -->
          <div class="section">
            <div class="section-title"><span class="sec-icon">üç≥</span> Kitchen</div>
            <div class="field-row">
              <div class="field">
                <div class="field-label">Sugar <span class="hint">(kg ‚Äî bags)</span><span class="ts-badge" data-ts-for="raw_sugar"></span></div>
                <div id="sugar_direct_mode">
                  <input type="number" class="input input-sm" id="raw_sugar" step="0.1" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('raw_sugar');updateDecomp()">
                </div>
                <div id="sugar_container_mode" style="display:none">
                  <input type="number" class="input input-sm" id="sugar_container_weight" step="0.01" min="0" placeholder="Gross weight on scale" inputmode="decimal" onchange="recordTimestamp('raw_sugar');updateDecomp()">
                  <div class="computed-value" id="sugar_container_net">Net: ‚Äî kg (tare 1.7 kg)</div>
                </div>
                <label style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:11px;color:var(--text2);cursor:pointer">
                  <input type="checkbox" id="sugar_use_container" onchange="toggleContainerMode('sugar')"> Weigh in container (KIT-DRY-1)
                </label>
              </div>
              <div class="field">
                <div class="field-label">Milkmaid <span class="hint">(kg ‚Äî cans)</span><span class="ts-badge" data-ts-for="raw_milkmaid"></span></div>
                <input type="number" class="input input-sm" id="raw_milkmaid" step="0.01" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('raw_milkmaid');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">SMP <span class="hint">(kg ‚Äî packets)</span><span class="ts-badge" data-ts-for="raw_smp"></span></div>
                <input type="number" class="input input-sm" id="raw_smp" step="0.01" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('raw_smp');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Tea Powder <span class="hint">(kg ‚Äî unmixed)</span><span class="ts-badge" data-ts-for="raw_tea_powder"></span></div>
                <div id="tea_powder_direct_mode">
                  <input type="number" class="input input-sm" id="raw_tea_powder" step="0.01" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('raw_tea_powder');updateDecomp()">
                </div>
                <div id="tea_powder_container_mode" style="display:none">
                  <input type="number" class="input input-sm" id="tea_powder_container_weight" step="0.01" min="0" placeholder="Gross weight on scale" inputmode="decimal" onchange="recordTimestamp('raw_tea_powder');updateDecomp()">
                  <div class="computed-value" id="tea_powder_container_net">Net: ‚Äî kg (tare 1.7 kg)</div>
                </div>
                <label style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:11px;color:var(--text2);cursor:pointer">
                  <input type="checkbox" id="tea_powder_use_container" onchange="toggleContainerMode('tea_powder')"> Weigh in container (KIT-DRY-1)
                </label>
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Tea-Sugar Boxes <span class="hint">(pre-mixed)</span><span class="ts-badge" data-ts-for="tea_sugar_boxes"></span></div>
                <input type="number" class="input input-sm" id="tea_sugar_boxes" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('tea_sugar_boxes');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Coffee Powder <span class="hint">(kg)</span><span class="ts-badge" data-ts-for="coffee_powder"></span></div>
                <input type="number" class="input input-sm" id="coffee_powder" step="0.01" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('coffee_powder');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Honey <span class="hint">(kg)</span><span class="ts-badge" data-ts-for="honey"></span></div>
                <input type="number" class="input input-sm" id="honey" step="0.01" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('honey');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Lemons <span class="hint">(count)</span><span class="ts-badge" data-ts-for="lemons"></span></div>
                <input type="number" class="input input-sm" id="lemons" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('lemons');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Oil <span class="hint">(litres)</span><span class="ts-badge" data-ts-for="oil"></span></div>
                <input type="number" class="input input-sm" id="oil" step="0.1" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('oil');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Plain Buns <span class="hint">(uncut ‚Äî count)</span><span class="ts-badge" data-ts-for="plain_buns"></span>
                  <button class="photo-btn" data-photo-field="plain_buns" onclick="triggerPhoto('count','plain_buns')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_plain_buns"></span>
                </div>
                <input type="number" class="input input-sm" id="plain_buns" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('plain_buns');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Water Bottles <span class="hint">(kitchen storage)</span><span class="ts-badge" data-ts-for="water_bottles_kitchen"></span></div>
                <input type="number" class="input input-sm" id="water_bottles_kitchen" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('water_bottles_kitchen');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Niloufer Boxes <span class="hint">(kitchen storage)</span><span class="ts-badge" data-ts-for="niloufer_kitchen"></span></div>
                <input type="number" class="input input-sm" id="niloufer_kitchen" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('niloufer_kitchen');updateDecomp()">
              </div>
            </div>
            <div class="field">
              <div class="field-label" style="margin-top:12px">Osmania Packets <span class="hint">(kitchen ‚Äî sealed, 24/pkt)</span><span class="ts-badge" data-ts-for="osmania_packets_kitchen"></span></div>
              <input type="number" class="input" id="osmania_packets_kitchen" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('osmania_packets_kitchen');updateDecomp()">
            </div>
            <!-- Kitchen fried items -->
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Fried Cutlets <span class="hint">(kitchen)</span><span class="ts-badge" data-ts-for="fried_cutlets_kitchen"></span>
                  <button class="photo-btn" data-photo-field="fried_cutlets_kitchen" onclick="triggerPhoto('count','fried_cutlets_kitchen')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_fried_cutlets_kitchen"></span>
                </div>
                <input type="number" class="input input-sm" id="fried_cutlets_kitchen" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('fried_cutlets_kitchen');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Fried Samosa <span class="hint">(kitchen)</span><span class="ts-badge" data-ts-for="fried_samosa_kitchen"></span>
                  <button class="photo-btn" data-photo-field="fried_samosa_kitchen" onclick="triggerPhoto('count','fried_samosa_kitchen')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_fried_samosa_kitchen"></span>
                </div>
                <input type="number" class="input input-sm" id="fried_samosa_kitchen" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('fried_samosa_kitchen');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Fried Cheese Balls <span class="hint">(kitchen)</span><span class="ts-badge" data-ts-for="fried_cheese_balls_kitchen"></span>
                  <button class="photo-btn" data-photo-field="fried_cheese_balls_kitchen" onclick="triggerPhoto('count','fried_cheese_balls_kitchen')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_fried_cheese_balls_kitchen"></span>
                </div>
                <input type="number" class="input input-sm" id="fried_cheese_balls_kitchen" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('fried_cheese_balls_kitchen');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Malai <span class="hint">(kg ‚Äî byproduct)</span><span class="ts-badge" data-ts-for="malai"></span></div>
                <input type="number" class="input input-sm" id="malai" step="0.01" min="0" placeholder="0" inputmode="decimal" onchange="recordTimestamp('malai')">
              </div>
            </div>
            <!-- Kitchen vessels -->
            <div class="vessel-group" style="margin-top:16px">
              <div class="field-label">Boiled Milk ‚Äî Kitchen Patila <span class="hint">(place on scale)</span><span class="ts-badge" data-ts-for="boiled_milk_kitchen"></span></div>
              <div class="vessel-entries" id="boiled_milk_kitchen"></div>
              <button class="add-vessel-btn" onclick="addVesselEntry('boiled_milk_kitchen','boiled_milk','kitchen')">+ Add kitchen milk vessel</button>
            </div>
            <div class="vessel-group" style="margin-top:12px">
              <div class="field-label">Tea Decoction ‚Äî Kitchen <span class="hint">(place on scale)</span><span class="ts-badge" data-ts-for="tea_decoction_kitchen"></span></div>
              <div class="vessel-entries" id="tea_decoction_kitchen"></div>
              <button class="add-vessel-btn" onclick="addVesselEntry('tea_decoction_kitchen','decoction','kitchen')">+ Add kitchen decoction vessel</button>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ SECTION 3: DISPLAY COUNTER ‚îÄ‚îÄ -->
          <div class="section">
            <div class="section-title"><span class="sec-icon">üè™</span> Display Counter</div>
            <div class="field-row">
              <div class="field">
                <div class="field-label">Water Bottles <span class="hint">(display)</span><span class="ts-badge" data-ts-for="water_bottles_display"></span></div>
                <input type="number" class="input input-sm" id="water_bottles_display" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('water_bottles_display');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Niloufer Boxes <span class="hint">(display)</span><span class="ts-badge" data-ts-for="niloufer_display"></span></div>
                <input type="number" class="input input-sm" id="niloufer_display" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('niloufer_display');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Osmania Packets <span class="hint">(display, 24/pkt)</span><span class="ts-badge" data-ts-for="osmania_packets_display"></span></div>
                <input type="number" class="input input-sm" id="osmania_packets_display" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('osmania_packets_display');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Osmania Loose <span class="hint">(individual pieces)</span><span class="ts-badge" data-ts-for="osmania_loose_display"></span></div>
                <input type="number" class="input input-sm" id="osmania_loose_display" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('osmania_loose_display');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Fried Cutlets <span class="hint">(display)</span><span class="ts-badge" data-ts-for="fried_cutlets_display"></span>
                  <button class="photo-btn" data-photo-field="fried_cutlets_display" onclick="triggerPhoto('count','fried_cutlets_display')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_fried_cutlets_display"></span>
                </div>
                <input type="number" class="input input-sm" id="fried_cutlets_display" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('fried_cutlets_display');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Fried Samosa <span class="hint">(display)</span><span class="ts-badge" data-ts-for="fried_samosa_display"></span>
                  <button class="photo-btn" data-photo-field="fried_samosa_display" onclick="triggerPhoto('count','fried_samosa_display')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_fried_samosa_display"></span>
                </div>
                <input type="number" class="input input-sm" id="fried_samosa_display" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('fried_samosa_display');updateDecomp()">
              </div>
            </div>
            <div class="field-row" style="margin-top:12px">
              <div class="field">
                <div class="field-label">Fried Cheese Balls <span class="hint">(display)</span><span class="ts-badge" data-ts-for="fried_cheese_balls_display"></span>
                  <button class="photo-btn" data-photo-field="fried_cheese_balls_display" onclick="triggerPhoto('count','fried_cheese_balls_display')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_fried_cheese_balls_display"></span>
                </div>
                <input type="number" class="input input-sm" id="fried_cheese_balls_display" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('fried_cheese_balls_display');updateDecomp()">
              </div>
              <div class="field">
                <div class="field-label">Ready Bun Maska <span class="hint">(cut + buttered)</span><span class="ts-badge" data-ts-for="prepared_bun_maska"></span>
                  <button class="photo-btn" data-photo-field="prepared_bun_maska" onclick="triggerPhoto('count','prepared_bun_maska')"><span class="cam-icon">üì∑</span></button>
                  <span class="ai-badge" id="ai_prepared_bun_maska"></span>
                </div>
                <input type="number" class="input input-sm" id="prepared_bun_maska" step="1" min="0" placeholder="0" inputmode="numeric" onchange="recordTimestamp('prepared_bun_maska');updateDecomp()">
              </div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ SECTION 4: TEA COUNTER ‚îÄ‚îÄ -->
          <div class="section">
            <div class="section-title"><span class="sec-icon">‚òï</span> Tea Counter</div>
            <div class="vessel-group">
              <div class="field-label">Counter Milk Vessel <span class="hint">(place on scale)</span><span class="ts-badge" data-ts-for="boiled_milk_counter"></span></div>
              <div class="vessel-entries" id="boiled_milk_counter"></div>
              <button class="add-vessel-btn" onclick="addVesselEntry('boiled_milk_counter','boiled_milk','counter')">+ Add counter milk vessel</button>
            </div>
            <div class="vessel-group" style="margin-top:12px">
              <div class="field-label">Counter Decoction Vessels <span class="hint">(place each on scale)</span><span class="ts-badge" data-ts-for="tea_decoction_counter"></span></div>
              <div class="vessel-entries" id="tea_decoction_counter"></div>
              <button class="add-vessel-btn" onclick="addVesselEntry('tea_decoction_counter','decoction','counter')">+ Add counter decoction vessel</button>
            </div>
          </div>

          <!-- Runner Tokens -->
          <div class="section" id="runnerTokenSection">
            <div class="section-title"><span class="sec-icon">üéüÔ∏è</span> Runner Tokens <span class="hint" style="font-size:12px;text-transform:none;letter-spacing:0">(unsold tokens held by runners)</span></div>
            <div class="field-row">
              <div class="field">
                <div class="field-label">FAROOQ</div>
                <input type="number" class="input input-sm" id="tokens_64" step="1" min="0" placeholder="0" inputmode="numeric">
              </div>
              <div class="field">
                <div class="field-label">AMIN</div>
                <input type="number" class="input input-sm" id="tokens_65" step="1" min="0" placeholder="0" inputmode="numeric">
              </div>
            </div>
            <div class="field-row" style="margin-top:8px">
              <div class="field">
                <div class="field-label">RUN 03</div>
                <input type="number" class="input input-sm" id="tokens_66" step="1" min="0" placeholder="0" inputmode="numeric">
              </div>
              <div class="field">
                <div class="field-label">RUN 04</div>
                <input type="number" class="input input-sm" id="tokens_67" step="1" min="0" placeholder="0" inputmode="numeric">
              </div>
              <div class="field">
                <div class="field-label">RUN 05</div>
                <input type="number" class="input input-sm" id="tokens_68" step="1" min="0" placeholder="0" inputmode="numeric">
              </div>
            </div>
          </div>

          <!-- Wastage -->
          <div class="section">
            <div class="section-title"><span class="sec-icon">üóëÔ∏è</span> Wastage <span class="hint" style="font-size:12px;text-transform:none;letter-spacing:0">(record any known wastage)</span></div>
            <div id="wastageEntries"></div>
            <button class="add-vessel-btn" onclick="addWastageEntry()" style="margin-top:8px">+ Add wastage item</button>
          </div>

          <!-- Notes -->
          <div class="section">
            <div class="section-title"><span class="sec-icon">üìù</span> Notes</div>
            <textarea class="input" id="settlementNotes" rows="3" placeholder="Any notes about today's settlement..." style="font-family:inherit;font-size:14px;resize:vertical"></textarea>
          </div>

          <!-- Decomposition Preview (shown above submit so staff can review) -->
          <div class="decomp-preview" id="decompPreview" style="display:none">
            <h4>üî¨ Raw Material Decomposition Preview</h4>
            <div id="decompContent"></div>
          </div>

          <!-- Submit -->
          <div style="margin-top:20px">
            <button class="btn btn-green" id="submitBtn" onclick="submitSettlement()" style="width:100%;padding:16px;font-size:16px;border-radius:12px">
              ‚úÖ Submit Settlement
            </button>
            <button class="btn btn-secondary" onclick="if(confirm('Clear all entered data?')){resetForm()}" style="width:100%;padding:12px;font-size:14px;margin-top:8px;border-radius:10px">
              üîÑ Reset Form
            </button>
          </div>
        </div>

        <!-- Settlement result -->
        <div id="settleResult" style="display:none"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê HISTORY TAB ‚ïê‚ïê‚ïê -->
      <div class="tab-content" id="tab-history">
        <div id="historyLoading" class="loading"><div class="spinner"></div><p style="margin-top:12px">Loading history...</p></div>
        <div id="historyList"></div>
        <div id="historyDetail" style="display:none"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê CONFIG TAB ‚ïê‚ïê‚ïê -->
      <div class="tab-content" id="tab-config">
        <!-- Vessels -->
        <div class="section">
          <div class="section-title"><span class="sec-icon">‚öñÔ∏è</span> Vessels (Tare Weights)</div>
          <div id="vesselList"></div>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
            <div class="section-title" style="margin-bottom:12px"><span class="sec-icon">‚ûï</span> Add / Update Vessel</div>
            <div class="field-row">
              <div class="field"><div class="field-label">Code</div><input type="text" class="input input-sm" id="vesselCode" placeholder="e.g. CTR-MILK-2"></div>
              <div class="field"><div class="field-label">Name</div><input type="text" class="input input-sm" id="vesselName" placeholder="e.g. Counter Milk Vessel 2"></div>
            </div>
            <div class="field-row" style="margin-top:8px">
              <div class="field"><div class="field-label">Liquid Type</div>
                <select class="input input-sm" id="vesselType"><option value="boiled_milk">Boiled Milk</option><option value="decoction">Tea Decoction</option><option value="oil">Oil</option><option value="raw_milk">Raw Milk</option><option value="dry_goods">Dry Goods (Sugar/Tea Powder)</option></select>
              </div>
              <div class="field"><div class="field-label">Location</div>
                <select class="input input-sm" id="vesselLocation"><option value="kitchen">Kitchen</option><option value="counter">Counter</option></select>
              </div>
              <div class="field"><div class="field-label">Empty Weight (kg)</div>
                <input type="number" class="input input-sm" id="vesselWeight" step="0.01" placeholder="0.00">
              </div>
            </div>
            <button class="btn btn-primary" onclick="saveVessel()" style="margin-top:12px">Save Vessel</button>
          </div>
        </div>

        <!-- Salaries ‚Äî managed on staffing page -->
        <div class="section">
          <div class="section-title"><span class="sec-icon">üë§</span> Staff Salaries</div>
          <p style="color:var(--text2);font-size:13px;margin-bottom:12px">Staff costs are now managed on the dedicated Staffing page.</p>
          <a href="/ops/staffing/" style="color:var(--teal);font-size:13px;font-weight:600;text-decoration:none">‚Üí Open Staffing Cost Dashboard</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê IN-APP CAMERA ‚ïê‚ïê‚ïê -->
  <div class="camera-overlay" id="cameraOverlay">
    <video id="cameraVideo" autoplay playsinline></video>
    <canvas id="cameraCanvas"></canvas>
    <div class="camera-label" id="cameraLabel"></div>
    <button class="camera-close" onclick="closeCamera()">‚úï</button>
    <div class="camera-controls">
      <button class="camera-shutter" onclick="capturePhoto()"></button>
    </div>
  </div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NCH Daily Settlement ‚Äî Frontend
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const API = '/api/daily-settlement';
const $ = id => document.getElementById(id);
const fmt = n => '‚Çπ' + Math.round(n).toLocaleString('en-IN');
const fmtDec = (n, d=2) => n.toFixed(d);

let currentUser = null;
let currentPin = null;
let settleData = null;  // data from prepare endpoint
let vessels = [];       // available vessels from config
let isBootstrap = false;

// ‚îÄ‚îÄ TIMESTAMP & EDIT TRAIL TRACKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Records when each field was last edited ‚Äî backend uses this to adjust
// for items sold between counting and submission
const fieldTimestamps = {};
const editTrail = {}; // {fieldId: [{value, at}]}

function recordTimestamp(fieldId) {
  const now = new Date();
  fieldTimestamps[fieldId] = now.toISOString();
  // Capture value for edit trail
  const el = $(fieldId);
  if (el) {
    if (!editTrail[fieldId]) editTrail[fieldId] = [];
    editTrail[fieldId].push({value: el.value, at: now.toISOString()});
  }
  // Update visual badge
  const badge = document.querySelector(`[data-ts-for="${fieldId}"]`);
  if (badge) {
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    badge.textContent = `‚úì ${hh}:${mm}`;
    badge.style.display = 'inline';
    badge.className = 'ts-badge ts-fresh';
  }
  // Auto-save draft
  saveDraftToLocal();
}

// ‚îÄ‚îÄ CONTAINER TOGGLE (sugar/tea powder) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CONTAINER_TARE = 1.7; // KIT-DRY-1 empty weight
function toggleContainerMode(type) {
  const useContainer = $(`${type}_use_container`).checked;
  $(`${type}_direct_mode`).style.display = useContainer ? 'none' : '';
  $(`${type}_container_mode`).style.display = useContainer ? '' : 'none';
  if (useContainer) {
    // Attach live update for container net weight display
    const weightInput = $(`${type}_container_weight`);
    weightInput.oninput = () => {
      const gross = parseFloat(weightInput.value) || 0;
      const net = Math.max(0, gross - CONTAINER_TARE);
      $(`${type}_container_net`).textContent = `Net: ${net.toFixed(2)} kg (tare ${CONTAINER_TARE} kg)`;
      recordTimestamp(type === 'sugar' ? 'raw_sugar' : 'raw_tea_powder');
      updateDecomp();
    };
  }
  updateDecomp();
}

// ‚îÄ‚îÄ DRAFT AUTO-SAVE (localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveDraftToLocal() {
  if (_restoringDraft) return; // Don't overwrite draft while restoring
  const date = settleData?.settlementDate || new Date(Date.now() + 5.5*3600000).toISOString().slice(0,10);
  try {
    const draft = {
      rawInput: collectRawInput(),
      timestamps: {...fieldTimestamps},
      trail: JSON.parse(JSON.stringify(editTrail)),
      runnerTokens: collectRunnerTokens(),
      wastageItems: getWastageItems(),
      notes: $('settlementNotes')?.value || '',
      savedAt: new Date().toISOString(),
    };
    localStorage.setItem(`nch_draft_${date}`, JSON.stringify(draft));
  } catch (e) { /* quota exceeded ‚Äî ignore */ }
}

function loadDraftFromLocal(date) {
  try {
    const raw = localStorage.getItem(`nch_draft_${date}`);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch { return null; }
}

function clearDraftFromLocal(date) {
  localStorage.removeItem(`nch_draft_${date}`);
}

let _restoringDraft = false;
function restoreDraft(draft) {
  if (!draft || !draft.rawInput) return;
  _restoringDraft = true;
  const ri = draft.rawInput;
  // Restore simple fields
  const simpleFields = [
    'raw_buffalo_milk','raw_cutlets','raw_samosa','raw_cheese_balls','butter',
    'raw_sugar','raw_milkmaid','raw_smp','raw_tea_powder','tea_sugar_boxes',
    'coffee_powder','honey','lemons','oil','plain_buns','prepared_bun_maska','malai',
    'water_bottles_kitchen','water_bottles_display','niloufer_kitchen','niloufer_display',
    'osmania_packets_kitchen','osmania_packets_display','osmania_loose_display',
    'fried_cutlets_kitchen','fried_cutlets_display',
    'fried_samosa_kitchen','fried_samosa_display',
    'fried_cheese_balls_kitchen','fried_cheese_balls_display',
  ];
  for (const f of simpleFields) {
    if ($(f) && ri[f]) $(f).value = ri[f];
  }
  // Restore container modes if used
  if (ri.sugar_container && Array.isArray(ri.sugar_container) && ri.sugar_container.length > 0) {
    $('sugar_use_container').checked = true;
    toggleContainerMode('sugar');
    $('sugar_container_weight').value = ri.sugar_container[0].weight_kg;
    const net = Math.max(0, ri.sugar_container[0].weight_kg - CONTAINER_TARE);
    $('sugar_container_net').textContent = `Net: ${net.toFixed(2)} kg (tare ${CONTAINER_TARE} kg)`;
  }
  if (ri.tea_powder_container && Array.isArray(ri.tea_powder_container) && ri.tea_powder_container.length > 0) {
    $('tea_powder_use_container').checked = true;
    toggleContainerMode('tea_powder');
    $('tea_powder_container_weight').value = ri.tea_powder_container[0].weight_kg;
    const net = Math.max(0, ri.tea_powder_container[0].weight_kg - CONTAINER_TARE);
    $('tea_powder_container_net').textContent = `Net: ${net.toFixed(2)} kg (tare ${CONTAINER_TARE} kg)`;
  }
  // Restore runner tokens
  if (draft.runnerTokens) {
    for (const [rid, val] of Object.entries(draft.runnerTokens)) {
      const el = $(`tokens_${rid}`);
      if (el && val) el.value = val;
    }
  }
  // Restore wastage entries
  if (draft.wastageItems && draft.wastageItems.length > 0) {
    $('wastageEntries').innerHTML = '';
    for (const w of draft.wastageItems) {
      addWastageEntry();
      const entry = $('wastageEntries').lastElementChild;
      const itemSelect = entry.querySelector('.wastage-item-select');
      itemSelect.value = w.item;
      updateWastageStates(itemSelect);
      const stateSelect = entry.querySelector('.wastage-state-select');
      stateSelect.value = w.state;
      updateWastageVesselUI(stateSelect);
      entry.querySelector('.qty-input').value = w.qty;
      entry.querySelector('.reason-input').value = w.reason || '';
    }
  }
  // Restore notes
  if (draft.notes && $('settlementNotes')) $('settlementNotes').value = draft.notes;
  // Restore timestamps and trail
  if (draft.timestamps) Object.assign(fieldTimestamps, draft.timestamps);
  if (draft.trail) Object.assign(editTrail, draft.trail);
  // Update decomp preview
  updateDecomp();
  _restoringDraft = false;
}

function collectEditTrail() {
  return JSON.parse(JSON.stringify(editTrail));
}

// Update badge colors based on age (called every 30s)
function refreshTimestampBadges() {
  const now = Date.now();
  document.querySelectorAll('.ts-badge').forEach(badge => {
    const fieldId = badge.dataset.tsFor;
    const ts = fieldTimestamps[fieldId];
    if (!ts) return;
    const ageMin = (now - new Date(ts).getTime()) / 60000;
    badge.className = 'ts-badge ' + (ageMin < 5 ? 'ts-fresh' : ageMin < 15 ? 'ts-warn' : 'ts-old');
  });
}
setInterval(refreshTimestampBadges, 30000);

// ‚îÄ‚îÄ PHOTO VERIFICATION (IN-APP CAMERA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Uses getUserMedia for camera-only capture (no gallery on any device)
// Sends to backend for AI verification via Gemini
// Owner gets WhatsApp alert ONLY on discrepancy
const fieldPhotos = {}; // {fieldId: {base64, type, aiReading, verified}}
let cameraStream = null;
let cameraFieldId = null;
let cameraType = null;

function triggerPhoto(type, fieldId) {
  cameraFieldId = fieldId;
  cameraType = type;
  $('cameraLabel').textContent = type === 'scale' ? 'üì∑ Scale Reading' : 'üì∑ Count Items';
  $('cameraOverlay').classList.add('active');
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false })
    .then(stream => {
      cameraStream = stream;
      $('cameraVideo').srcObject = stream;
    })
    .catch(err => {
      console.error('Camera error:', err);
      alert('Camera not available. Please check permissions.');
      closeCamera();
    });
}

function closeCamera() {
  $('cameraOverlay').classList.remove('active');
  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
  $('cameraVideo').srcObject = null;
  cameraFieldId = null;
  cameraType = null;
}

function capturePhoto() {
  if (!cameraStream || !cameraFieldId) return;
  const video = $('cameraVideo');
  const canvas = $('cameraCanvas');
  // Capture at video resolution, then compress
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  // Compress: scale down to max 1024px, JPEG 82%
  const maxDim = 1024;
  let w = canvas.width, h = canvas.height;
  if (w > maxDim || h > maxDim) {
    if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
    else { w = Math.round(w * maxDim / h); h = maxDim; }
  }
  const outCanvas = document.createElement('canvas');
  outCanvas.width = w; outCanvas.height = h;
  outCanvas.getContext('2d').drawImage(canvas, 0, 0, w, h);
  const dataUrl = outCanvas.toDataURL('image/jpeg', 0.82);
  const base64 = dataUrl.split(',')[1];

  const fieldId = cameraFieldId;
  const type = cameraType;
  closeCamera();

  // Update button state
  const btn = document.querySelector(`[data-photo-field="${fieldId}"]`);
  if (btn) { btn.classList.add('has-photo'); btn.innerHTML = '<span class="cam-icon">üì∑</span> ‚úì'; }

  fieldPhotos[fieldId] = { base64, type, timestamp: new Date().toISOString() };
  // Send to backend for AI verification (async, non-blocking)
  verifyPhoto(fieldId, base64, type);
}

async function verifyPhoto(fieldId, base64, type) {
  // Show "verifying" badge for vessel photos
  const aiBadge = $(`ai_${fieldId}`);
  if (aiBadge) { aiBadge.textContent = '‚è≥'; aiBadge.className = 'ai-badge ai-pending'; }

  try {
    const res = await fetch(`${API}?action=verify-photo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ field_id: fieldId, type, image_base64: base64 }),
    });
    const data = await res.json();
    if (data.success && data.ai_reading !== undefined) {
      fieldPhotos[fieldId].aiReading = data.ai_reading;
      fieldPhotos[fieldId].confidence = data.confidence;
      fieldPhotos[fieldId].verified = true;
      // Show AI reading badge (subtle ‚Äî staff sees it but it looks informational)
      if (aiBadge) {
        aiBadge.textContent = type === 'scale' ? `AI: ${data.ai_reading} kg` : `AI: ${data.ai_reading}`;
        aiBadge.className = 'ai-badge ai-match';
      }
    }
  } catch (e) {
    console.error('Photo verify error:', e);
    if (aiBadge) { aiBadge.textContent = ''; aiBadge.className = ''; }
  }
}

function collectPhotoVerifications() {
  const verifications = {};
  for (const [fieldId, data] of Object.entries(fieldPhotos)) {
    if (data.verified) {
      verifications[fieldId] = {
        type: data.type,
        ai_reading: data.aiReading,
        confidence: data.confidence,
        timestamp: data.timestamp,
      };
    }
  }
  return verifications;
}

// Raw materials reference (mirrored from API)
const RAW_MATERIALS = {
  1095:{name:'Buffalo Milk',uom:'L'},1096:{name:'SMP',uom:'kg'},1097:{name:'Sugar',uom:'kg'},
  1098:{name:'Tea Powder',uom:'kg'},1101:{name:'Filter Water',uom:'L'},1104:{name:'Buns',uom:'Units'},
  1105:{name:'Osmania (Loose)',uom:'Units'},1106:{name:'Cutlet',uom:'Units'},1107:{name:'Water Bottle',uom:'Units'},
  1110:{name:'Niloufer Box',uom:'Units'},1112:{name:'Condensed Milk',uom:'kg'},1113:{name:'Samosa',uom:'Units'},
  1114:{name:'Oil',uom:'L'},1116:{name:'Cheese Balls',uom:'Units'},1119:{name:'Butter',uom:'kg'},
  1120:{name:'Coffee Powder',uom:'kg'},1121:{name:'Lemon',uom:'Units'},1123:{name:'Honey',uom:'kg'},
};

// ‚îÄ‚îÄ PRODUCT DISPLAY CONFIG (for inventory report UI) ‚îÄ‚îÄ
const PRODUCT_DISPLAY = {
  1028:{name:'Irani Chai',icon:'‚òï',order:1},
  1102:{name:'Nawabi Special Coffee',icon:'‚òï',order:2},
  1103:{name:'Lemon Tea',icon:'üçã',order:3},
  1029:{name:'Bun Maska',icon:'üçû',order:4},
  1118:{name:'Malai Bun',icon:'üçû',order:5},
  1031:{name:'Chicken Cutlet',icon:'üçó',order:6},
  1115:{name:'Pyaaz Samosa',icon:'ü•ü',order:7},
  1117:{name:'Cheese Balls',icon:'üßÄ',order:8},
  1033:{name:'Osmania Pack of 3',icon:'üç™',order:9},
  1030:{name:'Osmania Loose',icon:'üç™',order:10},
  1111:{name:'Niloufer Box 500g',icon:'üì¶',order:11},
  1094:{name:'Water',icon:'üíß',order:12},
};

// Count-check mapping: raw material ID ‚Üí which POS products contribute (with multiplier)
const COUNT_CHECK_ITEMS = [
  {rmId:'1104', name:'Buns',        sources:[{pid:1029,mult:1},{pid:1118,mult:1}]},
  {rmId:'1106', name:'Cutlet',      sources:[{pid:1031,mult:1}]},
  {rmId:'1113', name:'Samosa',      sources:[{pid:1115,mult:1}]},
  {rmId:'1116', name:'Cheese Balls',sources:[{pid:1117,mult:2}]},
  {rmId:'1105', name:'Osmania (Loose)', sources:[{pid:1033,mult:3},{pid:1030,mult:1}]},
  {rmId:'1107', name:'Water Bottle',sources:[{pid:1094,mult:1}]},
  {rmId:'1110', name:'Niloufer Box',sources:[{pid:1111,mult:1}]},
];

// Beverage raw materials to show in consumption section
const BEVERAGE_MATERIALS = [
  {rmId:'1095', name:'Buffalo Milk', uom:'L', perCupUnit:'ml', perCupMult:1000},
  {rmId:'1112', name:'Condensed Milk', uom:'kg', perCupUnit:'g', perCupMult:1000},
  {rmId:'1096', name:'SMP (Milk Powder)', uom:'kg', perCupUnit:'g', perCupMult:1000},
  {rmId:'1098', name:'Tea Powder', uom:'kg', perCupUnit:'g', perCupMult:1000},
  {rmId:'1097', name:'Sugar', uom:'kg', perCupUnit:'g', perCupMult:1000},
];

// State-based wastage items (perishable/prepared items only)
const WASTAGE_ITEMS = {
  buffalo_milk: {label:'Buffalo Milk', uom:'L', states:{raw:{label:'Raw'},boiled:{label:'Boiled'}}},
  cutlet: {label:'Cutlet', uom:'units', states:{frozen:{label:'Frozen/Raw'},fried:{label:'Fried'}}},
  samosa: {label:'Samosa', uom:'units', states:{frozen:{label:'Frozen/Raw'},fried:{label:'Fried'}}},
  cheese_balls: {label:'Cheese Balls', uom:'units', states:{frozen:{label:'Frozen/Raw'},fried:{label:'Fried'}}},
  buns: {label:'Buns', uom:'units', states:{plain:{label:'Plain'},bun_maska:{label:'Bun Maska (prepared)'}}},
  tea_decoction: {label:'Tea Decoction', uom:'L', states:{liquid:{label:'Liquid'}}},
  sugar: {label:'Sugar', uom:'kg', states:{raw:{label:'Raw'}}},
  tea_powder: {label:'Tea Powder', uom:'kg', states:{raw:{label:'Raw'}}},
  oil: {label:'Oil', uom:'L', states:{waste:{label:'Used/Waste'}}},
  condensed_milk: {label:'Condensed Milk', uom:'kg', states:{raw:{label:'Raw'}}},
  smp: {label:'SMP (Milk Powder)', uom:'kg', states:{raw:{label:'Raw'}}},
};

// Wastage decomposition: maps {item,state} ‚Üí raw material decomposition (mirrors API)
const WASTAGE_DECOMPOSITION = {
  buffalo_milk: {raw:{1095:1}, boiled:{1095:0.957, 1096:0.02392, 1112:0.01914}},
  cutlet: {frozen:{1106:1}, fried:{1106:1, 1114:0.03}},
  samosa: {frozen:{1113:1}, fried:{1113:1, 1114:0.02}},
  cheese_balls: {frozen:{1116:1}, fried:{1116:1, 1114:0.015}},
  buns: {plain:{1104:1}, bun_maska:{1104:1, 1119:0.05, 1097:0.004}},
  tea_decoction: {liquid:{1098:0.005618, 1097:0.01124, 1101:0.9831}},
  sugar: {raw:{1097:1}},
  tea_powder: {raw:{1098:1}},
  oil: {waste:{1114:1}},
  condensed_milk: {raw:{1112:1}},
  smp: {raw:{1096:1}},
};

// Count check wastage mapping: rmId ‚Üí which wastage items contribute units
// Each entry maps a count-check raw material to the wastage item key that consumes it
const COUNT_CHECK_WASTAGE_MAP = {
  '1104': 'buns',         // Buns ‚Äî wastage of buns (plain or bun_maska) = 1 unit each
  '1106': 'cutlet',       // Cutlet ‚Äî wastage of cutlet (frozen or fried) = 1 unit each
  '1113': 'samosa',       // Samosa ‚Äî wastage of samosa (frozen or fried) = 1 unit each
  '1116': 'cheese_balls', // Cheese Balls ‚Äî wastage of cheese_balls = 1 unit each
};

// Coffee recipe (per cup) ‚Äî to subtract from chai per-cup calc
// Coffee uses 2x the boiled milk of chai (milk poured directly into coffee powder)
const COFFEE_RECIPE = {1095:0.11484,1096:0.002871,1112:0.002297};
// Lemon Tea recipe (per cup) ‚Äî uses tea powder, sugar, water
const LEMON_TEA_RECIPE = {1098:0.000449,1097:0.000899};
// Bun Maska recipe ‚Äî uses sugar
const BUN_MASKA_SUGAR = 0.004;

// Decomposition ratios (mirrored from API)
const BOILED_MILK_RATIO = {1095:0.957,1096:0.02392,1112:0.01914};
const DECOCTION_RATIO = {1098:0.005618,1097:0.01124,1101:0.9831};
const TEA_SUGAR_BOX_RATIO = {1098:0.4,1097:0.8};
const FRIED_OIL = {1106:0.03,1113:0.02,1116:0.015};
const BUN_MASKA_RATIO = {1104:1,1119:0.05,1097:0.004};
const OSMANIA_PER_PACKET = 24;
const DENSITY = {boiled_milk:1.035,tea_decoction:1.03,oil:0.92,dry_goods:1.0};

// Default vessels (fallback if DB empty)
const DEFAULT_VESSELS = [
  {code:'KIT-PATILA-1',name:'Kitchen Large Patila',liquid_type:'boiled_milk',location:'kitchen',empty_weight_kg:12.9},
  {code:'KIT-MILK-2',name:'Kitchen Milk Vessel 2',liquid_type:'boiled_milk',location:'kitchen',empty_weight_kg:3.498},
  {code:'CTR-MILK-1',name:'Counter Milk Vessel',liquid_type:'boiled_milk',location:'counter',empty_weight_kg:3.15},
  {code:'CTR-DEC-1',name:'Counter Decoction 1',liquid_type:'decoction',location:'counter',empty_weight_kg:5.0},
  {code:'CTR-DEC-2',name:'Counter Decoction 2',liquid_type:'decoction',location:'counter',empty_weight_kg:5.0},
  {code:'KIT-DEC-1',name:'Kitchen Decoction Vessel',liquid_type:'decoction',location:'kitchen',empty_weight_kg:11.0},
  {code:'KIT-DRY-1',name:'Sugar/Tea Powder Container',liquid_type:'dry_goods',location:'kitchen',empty_weight_kg:1.7},
];

// ‚îÄ‚îÄ PIN AUTHENTICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const pins = Array.from($('pinInput').querySelectorAll('input'));
pins.forEach((input, i) => {
  input.addEventListener('input', e => {
    if (e.target.value) { input.classList.add('filled'); if (i < 3) pins[i+1].focus(); else checkPin(); }
    else input.classList.remove('filled');
  });
  input.addEventListener('keydown', e => {
    if (e.key === 'Backspace' && !e.target.value && i > 0) { pins[i-1].focus(); pins[i-1].value = ''; pins[i-1].classList.remove('filled'); }
  });
});

async function checkPin() {
  const pin = pins.map(p => p.value).join('');
  if (pin.length !== 4) return;
  try {
    const res = await fetch(`${API}?action=verify-pin&pin=${pin}`);
    const data = await res.json();
    if (data.success) {
      currentUser = data.user;
      currentPin = pin;
      $('pinSuccess').textContent = `‚úì Welcome, ${data.user}`;
      $('pinSuccess').classList.add('show');
      $('pinError').classList.remove('show');
      setTimeout(() => {
        $('pinScreen').classList.add('hidden');
        $('dashboard').classList.add('show');
        $('userName').textContent = data.user;
        initDashboard();
      }, 600);
    } else {
      $('pinError').classList.add('show');
      pins.forEach(p => { p.value = ''; p.classList.remove('filled'); });
      pins[0].focus();
    }
  } catch (e) {
    $('pinError').textContent = 'Network error ‚Äî try again';
    $('pinError').classList.add('show');
    pins.forEach(p => { p.value = ''; p.classList.remove('filled'); });
    pins[0].focus();
  }
}

function logout() {
  currentUser = null;
  currentPin = null;
  $('pinScreen').classList.remove('hidden');
  $('dashboard').classList.remove('show');
  pins.forEach(p => { p.value = ''; p.classList.remove('filled'); });
  $('pinSuccess').classList.remove('show');
  $('pinError').classList.remove('show');
  pins[0].focus();
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function initDashboard() {
  loadConfig();
}

async function loadConfig() {
  try {
    const res = await fetch(`${API}?action=get-config`);
    const data = await res.json();
    if (data.success) {
      vessels = data.vessels && data.vessels.length > 0 ? data.vessels : DEFAULT_VESSELS;
      renderVesselConfig();
    }
  } catch (e) {
    vessels = DEFAULT_VESSELS;
  }
  loadSalaries();
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('show', c.id === `tab-${tab}`));
  if (tab === 'history') loadHistory();
}

// ‚îÄ‚îÄ PREPARE SETTLEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function prepareSettlement() {
  $('settleLoading').style.display = 'block';
  $('settleForm').style.display = 'none';
  $('settleAlreadyDone').style.display = 'none';
  $('settleResult').style.display = 'none';
  $('periodInfo').style.display = 'none';
  $('dateStatus').textContent = '';
  $('startSettleBtn').disabled = true;

  try {
    const res = await fetch(`${API}?action=prepare`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    settleData = data;
    $('settleLoading').style.display = 'none';
    $('startSettleBtn').disabled = false;

    // Show period info
    if (data.period) {
      $('periodInfo').style.display = 'block';
      $('periodText').textContent = `${formatTime(data.period.start)} ‚Üí ${formatTime(data.period.end)}`;
      const hrs = data.period.hours || 0;
      $('periodDuration').textContent = hrs > 0 ? `(${Math.floor(hrs)}h ${Math.round((hrs % 1) * 60)}m)` : '';
    }

    // Show form
    isBootstrap = data.needsBootstrap;
    $('settleForm').style.display = 'block';
    $('bootstrapBanner').style.display = isBootstrap ? 'flex' : 'none';
    $('runnerTokenSection').style.display = isBootstrap ? 'none' : 'block';
    $('submitBtn').textContent = isBootstrap ? 'üèÅ Submit Bootstrap Count' : '‚úÖ Submit Settlement';
    $('dateStatus').textContent = isBootstrap ? 'üèÅ Bootstrap mode' : `üìä Settlement #${data.previousSettlement ? data.previousSettlement.id + 1 : '1'}`;

    // Pre-populate default vessel entries
    resetForm();

    // Check for saved draft
    const draftKey = data.settlementDate || new Date(Date.now() + 5.5*3600000).toISOString().slice(0,10);
    const draft = loadDraftFromLocal(draftKey);
    if (draft && draft.savedAt) {
      const age = (Date.now() - new Date(draft.savedAt).getTime()) / 3600000;
      if (age < 24 && confirm(`Draft from ${formatTime(draft.savedAt)} found. Restore?`)) {
        restoreDraft(draft);
      }
    }

  } catch (e) {
    $('settleLoading').style.display = 'none';
    $('settleAlreadyDone').style.display = 'block';
    $('startSettleBtn').disabled = false;
    console.error('Prepare settlement error:', e);
    $('settleAlreadyDone').innerHTML = `<div class="alert alert-error"><span class="alert-icon">‚ùå</span><div class="alert-text">Could not load settlement data. Please check your internet connection and try again.</div></div>`;
  }
}

function resetForm() {
  // Clear all inputs
  const inputs = document.querySelectorAll('#settleForm input[type="number"], #settleForm textarea');
  inputs.forEach(i => i.value = '');

  // Clear timestamps
  Object.keys(fieldTimestamps).forEach(k => delete fieldTimestamps[k]);
  document.querySelectorAll('.ts-badge').forEach(b => { b.style.display = 'none'; b.textContent = ''; });

  // Clear vessel entries
  ['boiled_milk_kitchen','boiled_milk_counter','tea_decoction_kitchen','tea_decoction_counter'].forEach(id => {
    if ($(id)) $(id).innerHTML = '';
  });

  // Add one default vessel entry per group
  const kitchenMilkVessels = vessels.filter(v => v.liquid_type === 'boiled_milk' && v.location === 'kitchen');
  const counterMilkVessels = vessels.filter(v => v.liquid_type === 'boiled_milk' && v.location === 'counter');
  const kitchenDecVessels = vessels.filter(v => v.liquid_type === 'decoction' && v.location === 'kitchen');
  const counterDecVessels = vessels.filter(v => v.liquid_type === 'decoction' && v.location === 'counter');

  if (kitchenMilkVessels.length > 0) addVesselEntry('boiled_milk_kitchen', 'boiled_milk', 'kitchen');
  if (counterMilkVessels.length > 0) addVesselEntry('boiled_milk_counter', 'boiled_milk', 'counter');
  if (kitchenDecVessels.length > 0) addVesselEntry('tea_decoction_kitchen', 'decoction', 'kitchen');
  // Pre-populate 2 counter decoction entries (NCH always has 2 decoction vessels at counter)
  if (counterDecVessels.length > 0) {
    addVesselEntry('tea_decoction_counter', 'decoction', 'counter', 'CTR-DEC-1');
    if (counterDecVessels.length > 1) addVesselEntry('tea_decoction_counter', 'decoction', 'counter', 'CTR-DEC-2');
  }

  // Clear wastage
  $('wastageEntries').innerHTML = '';
  $('decompPreview').style.display = 'none';
}

// renderRevenue removed ‚Äî inventory-only mode

// ‚îÄ‚îÄ VESSEL ENTRIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function addVesselEntry(containerId, liquidType, location, defaultCode) {
  const container = $(containerId);
  const filtered = vessels.filter(v => v.liquid_type === liquidType && (!location || v.location === location));
  if (filtered.length === 0) {
    container.innerHTML = `<div style="color:var(--yellow);font-size:12px;padding:8px">No vessels configured for this type. Add one in Config tab.</div>`;
    return;
  }

  const entry = document.createElement('div');
  entry.className = 'vessel-entry';
  const photoFieldId = `${containerId}_${Date.now()}`;
  entry.innerHTML = `
    <select class="input input-sm" onchange="updateVesselDisplay(this)" style="flex:1">
      ${filtered.map(v => `<option value="${v.code}" data-tare="${v.empty_weight_kg}" ${defaultCode && v.code === defaultCode ? 'selected' : ''}>${v.name} (${v.empty_weight_kg} kg)</option>`).join('')}
    </select>
    <input type="number" class="input input-sm weight-input" placeholder="kg on scale" step="0.01" inputmode="decimal" onchange="recordTimestamp('${containerId}');updateVesselDisplay(this);updateDecomp()">
    <button class="photo-btn" data-photo-field="${photoFieldId}" onclick="triggerPhoto('scale','${containerId}')" title="Photo of scale"><span class="cam-icon">üì∑</span></button>
    <span class="net-display">‚Äî</span>
    <button class="remove-vessel" onclick="this.closest('.vessel-entry').remove();updateDecomp()" title="Remove">‚úï</button>
  `;
  container.appendChild(entry);
}

function updateVesselDisplay(el) {
  const entry = el.closest('.vessel-entry');
  const select = entry.querySelector('select');
  const weightInput = entry.querySelector('.weight-input');
  const display = entry.querySelector('.net-display');
  const tare = parseFloat(select.selectedOptions[0]?.dataset.tare || 0);
  const gross = parseFloat(weightInput.value) || 0;

  if (gross <= 0) { display.textContent = '‚Äî'; return; }

  const net = Math.max(0, gross - tare);
  const liquidType = getLiquidTypeForContainer(entry.closest('.vessel-entries')?.id);
  const density = DENSITY[liquidType] || 1;
  const litres = net / density;
  display.textContent = `${litres.toFixed(2)} L`;
  display.style.color = net > 0 ? 'var(--cyan)' : 'var(--red)';
}

function getLiquidTypeForContainer(containerId) {
  if (containerId?.includes('milk')) return 'boiled_milk';
  if (containerId?.includes('decoction')) return 'tea_decoction';
  return 'boiled_milk';
}

function getVesselEntries(containerId) {
  const entries = [];
  const container = $(containerId);
  if (!container) return entries;
  container.querySelectorAll('.vessel-entry').forEach(row => {
    const code = row.querySelector('select')?.value;
    const weight = parseFloat(row.querySelector('.weight-input')?.value) || 0;
    if (code && weight > 0) entries.push({vessel_code: code, weight_kg: weight});
  });
  return entries;
}

// ‚îÄ‚îÄ WASTAGE ENTRIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function addWastageEntry() {
  const container = $('wastageEntries');
  const entry = document.createElement('div');
  entry.className = 'wastage-entry';
  const itemOptions = Object.entries(WASTAGE_ITEMS).map(([key, item]) =>
    `<option value="${key}">${item.label}</option>`
  ).join('');
  entry.innerHTML = `
    <select class="input input-sm wastage-item-select" style="flex:1" onchange="updateWastageStates(this)">
      <option value="">Select item...</option>
      ${itemOptions}
    </select>
    <select class="input input-sm wastage-state-select" style="flex:0.8" onchange="updateWastageVesselUI(this)">
      <option value="">State...</option>
    </select>
    <div class="wastage-qty-area" style="flex:0.5;display:flex;flex-direction:column;gap:4px">
      <input type="number" class="input input-sm qty-input" placeholder="Qty" step="0.1" inputmode="decimal">
    </div>
    <div class="wastage-vessel-area" style="display:none;flex:1.2;flex-direction:column;gap:4px"></div>
    <input type="text" class="input input-sm reason-input" placeholder="Reason" style="flex:0.8">
    <button class="remove-vessel" onclick="this.closest('.wastage-entry').remove();saveDraftToLocal()" title="Remove">‚úï</button>
  `;
  container.appendChild(entry);
  // Auto-save draft when wastage fields change
  entry.querySelector('.qty-input').addEventListener('change', saveDraftToLocal);
  entry.querySelector('.reason-input').addEventListener('change', saveDraftToLocal);
  // Auto-trigger state population if first item is pre-selected
  const itemSelect = entry.querySelector('.wastage-item-select');
  if (itemSelect.value) updateWastageStates(itemSelect);
}

function updateWastageStates(itemSelect) {
  const entry = itemSelect.closest('.wastage-entry');
  const stateSelect = entry.querySelector('.wastage-state-select');
  const qtyInput = entry.querySelector('.qty-input');
  const itemKey = itemSelect.value;
  const item = WASTAGE_ITEMS[itemKey];
  if (!item) { stateSelect.innerHTML = '<option value="">State...</option>'; return; }
  const states = Object.entries(item.states);
  stateSelect.innerHTML = states.length === 1
    ? states.map(([key, s]) => `<option value="${key}" selected>${s.label}</option>`).join('')
    : '<option value="">Select state...</option>' + states.map(([key, s]) => `<option value="${key}">${s.label}</option>`).join('');
  qtyInput.placeholder = item.uom;
  // Trigger vessel UI check after state auto-selection
  updateWastageVesselUI(stateSelect);
  saveDraftToLocal();
}

function updateWastageVesselUI(stateSelect) {
  const entry = stateSelect.closest('.wastage-entry');
  const itemKey = entry.querySelector('.wastage-item-select')?.value;
  const stateKey = stateSelect.value;
  const vesselArea = entry.querySelector('.wastage-vessel-area');
  const qtyArea = entry.querySelector('.wastage-qty-area');

  // Show vessel weighing only for buffalo_milk + boiled
  if (itemKey === 'buffalo_milk' && stateKey === 'boiled') {
    const milkVessels = vessels.filter(v => v.liquid_type === 'boiled_milk');
    if (milkVessels.length > 0) {
      const vesselOpts = milkVessels.map(v => `<option value="${v.code}" data-tare="${v.empty_weight_kg}">${v.name} (${v.empty_weight_kg} kg)</option>`).join('');
      vesselArea.style.display = 'flex';
      vesselArea.innerHTML = `
        <div style="display:flex;gap:4px;align-items:center">
          <select class="input input-sm wastage-vessel-select" style="flex:1" onchange="calcWastageVessel(this)">
            <option value="">No vessel (manual)</option>
            ${vesselOpts}
          </select>
          <input type="number" class="input input-sm wastage-gross-input" placeholder="kg on scale" step="0.01" inputmode="decimal" style="width:90px" onchange="calcWastageVessel(this)">
          <span class="wastage-net-display" style="font-size:11px;color:var(--text2);white-space:nowrap">‚Äî</span>
        </div>
      `;
      return;
    }
  }
  // Hide vessel area for all other combos
  vesselArea.style.display = 'none';
  vesselArea.innerHTML = '';
  saveDraftToLocal();
}

function calcWastageVessel(el) {
  const entry = el.closest('.wastage-entry');
  const vesselSelect = entry.querySelector('.wastage-vessel-select');
  const grossInput = entry.querySelector('.wastage-gross-input');
  const netDisplay = entry.querySelector('.wastage-net-display');
  const qtyInput = entry.querySelector('.qty-input');
  const vesselCode = vesselSelect?.value;
  const gross = parseFloat(grossInput?.value) || 0;

  if (!vesselCode || gross <= 0) {
    if (netDisplay) netDisplay.textContent = '‚Äî';
    return;
  }
  const tare = parseFloat(vesselSelect.selectedOptions[0]?.dataset.tare || 0);
  const net = Math.max(0, gross - tare);
  const litres = net / DENSITY.boiled_milk;
  if (netDisplay) {
    netDisplay.textContent = `${litres.toFixed(2)} L`;
    netDisplay.style.color = litres > 0 ? 'var(--cyan)' : 'var(--red)';
  }
  // Auto-fill qty
  if (qtyInput) qtyInput.value = litres.toFixed(2);
  saveDraftToLocal();
}

function getWastageItems() {
  const items = [];
  $('wastageEntries').querySelectorAll('.wastage-entry').forEach(row => {
    const itemKey = row.querySelector('.wastage-item-select')?.value;
    const state = row.querySelector('.wastage-state-select')?.value;
    const qty = parseFloat(row.querySelector('.qty-input')?.value) || 0;
    const reason = row.querySelector('.reason-input')?.value || '';
    if (itemKey && state && qty > 0) items.push({item: itemKey, state, qty, reason});
  });
  return items;
}

// ‚îÄ‚îÄ DECOMPOSITION PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateDecomp() {
  const input = collectRawInput();
  const totals = clientDecompose(input);

  const nonZero = Object.entries(totals).filter(([_, v]) => v > 0.0001);
  if (nonZero.length === 0) { $('decompPreview').style.display = 'none'; return; }

  $('decompPreview').style.display = 'block';
  let html = '';
  nonZero.sort((a, b) => {
    const nameA = RAW_MATERIALS[a[0]]?.name || '';
    const nameB = RAW_MATERIALS[b[0]]?.name || '';
    return nameA.localeCompare(nameB);
  });
  for (const [matId, qty] of nonZero) {
    const mat = RAW_MATERIALS[matId];
    if (!mat) continue;
    html += `<div class="dp-row"><span class="dp-name">${mat.name}</span><span class="dp-val">${fmtQty(qty, mat.uom)} ${mat.uom}</span></div>`;
  }
  $('decompContent').innerHTML = html;
}

function fmtQty(v, uom) {
  if (uom === 'Units') return Math.round(v).toString();
  if (v < 0.01) return v.toFixed(4);
  if (v < 1) return v.toFixed(3);
  return v.toFixed(2);
}

function clientDecompose(input) {
  const totals = {};
  const add = (id, qty) => { totals[id] = (totals[id] || 0) + qty; };

  // Direct raw materials
  if (input.raw_buffalo_milk) add(1095, input.raw_buffalo_milk);
  if (input.raw_milkmaid) add(1112, input.raw_milkmaid);
  if (input.raw_smp) add(1096, input.raw_smp);
  if (input.raw_sugar) add(1097, input.raw_sugar);
  if (input.raw_tea_powder) add(1098, input.raw_tea_powder);
  if (input.butter) add(1119, input.butter);
  if (input.coffee_powder) add(1120, input.coffee_powder);
  if (input.honey) add(1123, input.honey);
  if (input.lemons) add(1121, input.lemons);
  if (input.oil) add(1114, input.oil);

  // Water bottles: kitchen + display
  const waterTotal = (input.water_bottles_kitchen || 0) + (input.water_bottles_display || 0);
  if (waterTotal) add(1107, waterTotal);

  // Boiled milk
  const milkLitres = calcVesselLitres('boiled_milk_kitchen', DENSITY.boiled_milk)
    + calcVesselLitres('boiled_milk_counter', DENSITY.boiled_milk);
  if (milkLitres > 0) for (const [id, r] of Object.entries(BOILED_MILK_RATIO)) add(id, milkLitres * r);

  // Decoction: kitchen + counter
  const decLitres = calcVesselLitres('tea_decoction_kitchen', DENSITY.tea_decoction)
    + calcVesselLitres('tea_decoction_counter', DENSITY.tea_decoction);
  if (decLitres > 0) for (const [id, r] of Object.entries(DECOCTION_RATIO)) add(id, decLitres * r);

  // Tea-Sugar boxes
  if (input.tea_sugar_boxes) for (const [id, r] of Object.entries(TEA_SUGAR_BOX_RATIO)) add(id, input.tea_sugar_boxes * r);

  // Buns
  if (input.plain_buns) add(1104, input.plain_buns);
  if (input.prepared_bun_maska) for (const [id, r] of Object.entries(BUN_MASKA_RATIO)) add(id, input.prepared_bun_maska * r);

  // Fried items: sum kitchen + display
  if (input.raw_cutlets) add(1106, input.raw_cutlets);
  const friedCutlets = (input.fried_cutlets_kitchen || 0) + (input.fried_cutlets_display || 0);
  if (friedCutlets) { add(1106, friedCutlets); add(1114, friedCutlets * FRIED_OIL[1106]); }
  if (input.raw_samosa) add(1113, input.raw_samosa);
  const friedSamosa = (input.fried_samosa_kitchen || 0) + (input.fried_samosa_display || 0);
  if (friedSamosa) { add(1113, friedSamosa); add(1114, friedSamosa * FRIED_OIL[1113]); }
  if (input.raw_cheese_balls) add(1116, input.raw_cheese_balls);
  const friedCheese = (input.fried_cheese_balls_kitchen || 0) + (input.fried_cheese_balls_display || 0);
  if (friedCheese) { add(1116, friedCheese); add(1114, friedCheese * FRIED_OIL[1116]); }

  // Osmania: packets from kitchen + display, loose from display only
  const osmaniaPackets = (input.osmania_packets_kitchen || 0) + (input.osmania_packets_display || 0);
  if (osmaniaPackets) add(1105, osmaniaPackets * OSMANIA_PER_PACKET);
  if (input.osmania_loose_display) add(1105, input.osmania_loose_display);

  // Niloufer: kitchen + display
  const niloufer = (input.niloufer_kitchen || 0) + (input.niloufer_display || 0);
  if (niloufer) add(1110, niloufer);

  return totals;
}

function calcVesselLitres(containerId, density) {
  let total = 0;
  const container = $(containerId);
  if (!container) return 0;
  container.querySelectorAll('.vessel-entry').forEach(row => {
    const select = row.querySelector('select');
    const weight = parseFloat(row.querySelector('.weight-input')?.value) || 0;
    const tare = parseFloat(select?.selectedOptions[0]?.dataset.tare || 0);
    if (weight > 0) total += Math.max(0, weight - tare) / density;
  });
  return total;
}

// ‚îÄ‚îÄ COLLECT RAW INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function collectRawInput() {
  // Sugar: direct or container mode
  let raw_sugar = 0, sugar_container = undefined;
  if ($('sugar_use_container')?.checked) {
    const gross = parseFloat($('sugar_container_weight')?.value) || 0;
    if (gross > 0) {
      sugar_container = [{vessel_code: 'KIT-DRY-1', weight_kg: gross}];
      raw_sugar = Math.max(0, gross - CONTAINER_TARE);
    }
  } else {
    raw_sugar = parseFloat($('raw_sugar')?.value) || 0;
  }
  // Tea powder: direct or container mode
  let raw_tea_powder = 0, tea_powder_container = undefined;
  if ($('tea_powder_use_container')?.checked) {
    const gross = parseFloat($('tea_powder_container_weight')?.value) || 0;
    if (gross > 0) {
      tea_powder_container = [{vessel_code: 'KIT-DRY-1', weight_kg: gross}];
      raw_tea_powder = Math.max(0, gross - CONTAINER_TARE);
    }
  } else {
    raw_tea_powder = parseFloat($('raw_tea_powder')?.value) || 0;
  }
  const result = {
    // Freezer
    raw_buffalo_milk: parseFloat($('raw_buffalo_milk')?.value) || 0,
    raw_cutlets: parseInt($('raw_cutlets')?.value) || 0,
    raw_samosa: parseInt($('raw_samosa')?.value) || 0,
    raw_cheese_balls: parseInt($('raw_cheese_balls')?.value) || 0,
    butter: parseFloat($('butter')?.value) || 0,
    // Kitchen
    raw_sugar,
    raw_milkmaid: parseFloat($('raw_milkmaid')?.value) || 0,
    raw_smp: parseFloat($('raw_smp')?.value) || 0,
    raw_tea_powder,
    tea_sugar_boxes: parseInt($('tea_sugar_boxes')?.value) || 0,
    coffee_powder: parseFloat($('coffee_powder')?.value) || 0,
    honey: parseFloat($('honey')?.value) || 0,
    lemons: parseInt($('lemons')?.value) || 0,
    oil: parseFloat($('oil')?.value) || 0,
    plain_buns: parseInt($('plain_buns')?.value) || 0,
    water_bottles_kitchen: parseInt($('water_bottles_kitchen')?.value) || 0,
    niloufer_kitchen: parseInt($('niloufer_kitchen')?.value) || 0,
    osmania_packets_kitchen: parseInt($('osmania_packets_kitchen')?.value) || 0,
    fried_cutlets_kitchen: parseInt($('fried_cutlets_kitchen')?.value) || 0,
    fried_samosa_kitchen: parseInt($('fried_samosa_kitchen')?.value) || 0,
    fried_cheese_balls_kitchen: parseInt($('fried_cheese_balls_kitchen')?.value) || 0,
    malai: parseFloat($('malai')?.value) || 0,
    boiled_milk_kitchen: getVesselEntries('boiled_milk_kitchen'),
    tea_decoction_kitchen: getVesselEntries('tea_decoction_kitchen'),
    // Display Counter
    water_bottles_display: parseInt($('water_bottles_display')?.value) || 0,
    niloufer_display: parseInt($('niloufer_display')?.value) || 0,
    osmania_packets_display: parseInt($('osmania_packets_display')?.value) || 0,
    osmania_loose_display: parseInt($('osmania_loose_display')?.value) || 0,
    fried_cutlets_display: parseInt($('fried_cutlets_display')?.value) || 0,
    fried_samosa_display: parseInt($('fried_samosa_display')?.value) || 0,
    fried_cheese_balls_display: parseInt($('fried_cheese_balls_display')?.value) || 0,
    prepared_bun_maska: parseInt($('prepared_bun_maska')?.value) || 0,
    // Tea Counter
    boiled_milk_counter: getVesselEntries('boiled_milk_counter'),
    tea_decoction_counter: getVesselEntries('tea_decoction_counter'),
  };
  // Add container entries if used (API will use these for decomposition)
  if (sugar_container) result.sugar_container = sugar_container;
  if (tea_powder_container) result.tea_powder_container = tea_powder_container;
  return result;
}

// Collect only non-empty timestamps for fields that have been edited
function collectTimestamps() {
  const ts = {};
  for (const [fieldId, isoStr] of Object.entries(fieldTimestamps)) {
    if (isoStr) ts[fieldId] = isoStr;
  }
  return ts;
}

function collectRunnerTokens() {
  return {
    '64': parseInt($('tokens_64')?.value) || 0,
    '65': parseInt($('tokens_65')?.value) || 0,
    '66': parseInt($('tokens_66')?.value) || 0,
    '67': parseInt($('tokens_67')?.value) || 0,
    '68': parseInt($('tokens_68')?.value) || 0,
  };
}

// ‚îÄ‚îÄ SUBMIT SETTLEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function submitSettlement() {
  const btn = $('submitBtn');
  if (btn.disabled) return;

  const rawInput = collectRawInput();
  const runnerTokens = collectRunnerTokens();
  const wastageItems = getWastageItems();
  const notes = $('settlementNotes')?.value || '';

  // ‚îÄ‚îÄ VALIDATION: Ensure at least some inventory data is entered ‚îÄ‚îÄ
  const hasVesselData = getVesselEntries('boiled_milk_kitchen').length > 0
    || getVesselEntries('boiled_milk_counter').length > 0
    || getVesselEntries('tea_decoction_kitchen').length > 0
    || getVesselEntries('tea_decoction_counter').length > 0;
  const hasRawData = rawInput.raw_buffalo_milk > 0 || rawInput.raw_milkmaid > 0 || rawInput.raw_smp > 0
    || rawInput.raw_sugar > 0 || rawInput.raw_tea_powder > 0 || rawInput.butter > 0
    || rawInput.plain_buns > 0 || rawInput.prepared_bun_maska > 0
    || rawInput.raw_cutlets > 0 || rawInput.fried_cutlets_kitchen > 0 || rawInput.fried_cutlets_display > 0
    || rawInput.raw_samosa > 0 || rawInput.fried_samosa_kitchen > 0 || rawInput.fried_samosa_display > 0
    || rawInput.raw_cheese_balls > 0 || rawInput.fried_cheese_balls_kitchen > 0 || rawInput.fried_cheese_balls_display > 0
    || rawInput.osmania_packets_kitchen > 0 || rawInput.osmania_packets_display > 0 || rawInput.osmania_loose_display > 0
    || rawInput.water_bottles_kitchen > 0 || rawInput.water_bottles_display > 0 || rawInput.oil > 0
    || rawInput.coffee_powder > 0 || rawInput.honey > 0 || rawInput.lemons > 0;

  if (!hasVesselData && !hasRawData) {
    alert('‚ö†Ô∏è Empty form ‚Äî please enter at least some inventory counts before submitting.');
    return;
  }

  // ‚îÄ‚îÄ CONFIRMATION DIALOG ‚îÄ‚îÄ
  const decomp = clientDecompose(rawInput);
  const matCount = Object.keys(decomp).filter(k => decomp[k] > 0.0001).length;
  const periodStr = settleData?.period ? `${formatTime(settleData.period.start)} ‚Üí ${formatTime(settleData.period.end)}` : '';
  const confirmMsg = isBootstrap
    ? `üèÅ BOOTSTRAP SETTLEMENT\n\n${matCount} raw materials counted\n\nThis establishes your Day 0 baseline.\nProceed?`
    : `‚úÖ SUBMIT SETTLEMENT\n\nPeriod: ${periodStr}\n${matCount} raw materials counted\n${wastageItems.length > 0 ? wastageItems.length + ' wastage items\n' : ''}\nThis action cannot be undone.\nProceed?`;

  if (!confirm(confirmMsg)) return;

  btn.disabled = true;
  btn.innerHTML = isBootstrap
    ? '<div class="spinner" style="width:18px;height:18px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px"></div> Submitting bootstrap...'
    : '<div class="spinner" style="width:18px;height:18px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px"></div> Calculating settlement...';

  try {
    const res = await fetch(`${API}?action=submit`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        pin: currentPin,
        raw_input: rawInput,
        wastage_items: wastageItems,
        runner_tokens: runnerTokens,
        notes,
        is_bootstrap: isBootstrap,
        field_timestamps: collectTimestamps(),
        photo_verifications: collectPhotoVerifications(),
        edit_trail: collectEditTrail(),
      }),
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    // Clear draft on success
    const draftKey = data.settlementDate || settleData?.settlementDate || new Date(Date.now() + 5.5*3600000).toISOString().slice(0,10);
    clearDraftFromLocal(draftKey);

    // Show result
    $('settleForm').style.display = 'none';
    $('settleResult').style.display = 'block';

    if (isBootstrap) {
      $('settleResult').innerHTML = `
        <div class="alert alert-success" style="margin-bottom:16px">
          <span class="alert-icon">üèÅ</span>
          <div class="alert-text"><strong>Bootstrap Settlement Complete!</strong><br>Baseline inventory recorded. You can now run daily settlements going forward.</div>
        </div>
        ${data.rawInput ? `<div class="section"><div class="section-title"><span class="sec-icon">üìã</span> Staff Physical Count <span style="font-size:11px;background:rgba(6,182,212,0.15);color:var(--cyan);padding:2px 8px;border-radius:4px;margin-left:8px">RAW</span></div>${renderRawInputTable(data.rawInput)}</div>` : ''}
        <div class="section">
          <div class="section-title"><span class="sec-icon">üì¶</span> Baseline Inventory <span style="font-size:11px;background:rgba(168,85,247,0.15);color:var(--purple);padding:2px 8px;border-radius:4px;margin-left:8px">DECOMPOSED</span></div>
          ${renderInventoryTable(data.inventory)}
        </div>
      `;
    } else {
      // Attach local wastage items to data for report rendering
      data.wastageItems = wastageItems;
      renderPnlResult(data);
    }
    // Scroll to top so staff sees the result
    window.scrollTo({top: 0, behavior: 'smooth'});

  } catch (e) {
    btn.disabled = false;
    btn.textContent = isBootstrap ? 'üèÅ Submit Bootstrap Count' : '‚úÖ Submit Settlement';
    console.error('Settlement submit error:', e);
    // Show friendly message ‚Äî don't expose API internals to staff
    const friendlyMsg = e.message?.includes('wait 2 minutes') ? e.message
      : e.message?.includes('pin') || e.message?.includes('PIN') ? 'PIN verification failed. Please logout and try again.'
      : 'Something went wrong. Please try again. If the problem persists, contact management.';
    alert('‚ö†Ô∏è ' + friendlyMsg);
  }
}

// ‚îÄ‚îÄ RAW INPUT DISPLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIELD_LABELS = {
  raw_buffalo_milk: ['Buffalo Milk (raw)', 'L'], raw_cutlets: ['Cutlets (frozen)', 'pcs'],
  raw_samosa: ['Samosa (frozen)', 'pcs'], raw_cheese_balls: ['Cheese Balls (frozen)', 'pcs'],
  butter: ['Butter', 'kg'], raw_sugar: ['Sugar', 'kg'], raw_milkmaid: ['Condensed Milk', 'kg'],
  raw_smp: ['Milk Powder (SMP)', 'kg'], raw_tea_powder: ['Tea Powder', 'kg'],
  tea_sugar_boxes: ['Tea+Sugar Boxes', 'boxes'], coffee_powder: ['Coffee Powder', 'kg'],
  honey: ['Honey', 'kg'], lemons: ['Lemons', 'pcs'], oil: ['Cooking Oil', 'L'],
  plain_buns: ['Plain Buns', 'pcs'], prepared_bun_maska: ['Bun Maska (prepared)', 'pcs'],
  malai: ['Malai', 'kg'],
  water_bottles_kitchen: ['Water Bottles (kitchen)', 'pcs'], water_bottles_display: ['Water Bottles (display)', 'pcs'],
  niloufer_kitchen: ['Niloufer Boxes (kitchen)', 'pcs'], niloufer_display: ['Niloufer Boxes (display)', 'pcs'],
  osmania_packets_kitchen: ['Osmania Packets (kitchen)', 'pkt'], osmania_packets_display: ['Osmania Packets (display)', 'pkt'],
  osmania_loose_display: ['Osmania Loose (display)', 'pcs'],
  fried_cutlets_kitchen: ['Fried Cutlets (kitchen)', 'pcs'], fried_cutlets_display: ['Fried Cutlets (display)', 'pcs'],
  fried_samosa_kitchen: ['Fried Samosa (kitchen)', 'pcs'], fried_samosa_display: ['Fried Samosa (display)', 'pcs'],
  fried_cheese_balls_kitchen: ['Fried Cheese Balls (kitchen)', 'pcs'], fried_cheese_balls_display: ['Fried Cheese Balls (display)', 'pcs'],
  boiled_milk_kitchen: ['Boiled Milk (kitchen)', 'vessels'], boiled_milk_counter: ['Boiled Milk (counter)', 'vessels'],
  tea_decoction_kitchen: ['Tea Decoction (kitchen)', 'vessels'], tea_decoction_counter: ['Tea Decoction (counter)', 'vessels'],
  sugar_container: ['Sugar (container)', 'vessels'], tea_powder_container: ['Tea Powder (container)', 'vessels'],
};

const RAW_INPUT_GROUPS = [
  {name: 'Freezer', fields: ['raw_buffalo_milk','raw_cutlets','raw_samosa','raw_cheese_balls','butter']},
  {name: 'Kitchen', fields: ['raw_sugar','sugar_container','raw_milkmaid','raw_smp','raw_tea_powder','tea_powder_container','tea_sugar_boxes','coffee_powder','honey','lemons','oil','plain_buns','water_bottles_kitchen','niloufer_kitchen','osmania_packets_kitchen','fried_cutlets_kitchen','fried_samosa_kitchen','fried_cheese_balls_kitchen','malai','boiled_milk_kitchen','tea_decoction_kitchen']},
  {name: 'Display Counter', fields: ['water_bottles_display','niloufer_display','osmania_packets_display','osmania_loose_display','fried_cutlets_display','fried_samosa_display','fried_cheese_balls_display','prepared_bun_maska']},
  {name: 'Tea Counter', fields: ['boiled_milk_counter','tea_decoction_counter']},
];

function renderRawInputTable(rawInput) {
  if (!rawInput || Object.keys(rawInput).length === 0) return '<div style="color:var(--text2);font-size:13px">Raw data not recorded</div>';
  let html = '';
  for (const group of RAW_INPUT_GROUPS) {
    const rows = [];
    for (const field of group.fields) {
      const val = rawInput[field];
      const label = FIELD_LABELS[field];
      if (!label) continue;
      // Vessel entries (arrays)
      if (Array.isArray(val) && val.length > 0) {
        for (const v of val) {
          if (v.weight_kg > 0) rows.push(`<tr><td>${label[0]} ‚Äî ${v.vessel_code}</td><td class="num">${v.weight_kg} kg</td></tr>`);
        }
      } else if (typeof val === 'number' && val > 0) {
        rows.push(`<tr><td>${label[0]}</td><td class="num">${val} ${label[1]}</td></tr>`);
      }
    }
    if (rows.length > 0) {
      html += `<div style="margin-bottom:8px"><div style="font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${group.name}</div>`;
      html += `<table class="inv-table"><tr><th>Item</th><th style="text-align:right">Count</th></tr>${rows.join('')}</table></div>`;
    }
  }
  return html || '<div style="color:var(--text2);font-size:13px">No items recorded</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVENTORY REPORT SECTIONS (staff-friendly, post-settlement)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderItemsSold(products, complimentaryProducts) {
  if (!products || Object.keys(products).length === 0) return '';
  complimentaryProducts = complimentaryProducts || {};
  const items = Object.entries(products)
    .map(([pid, p]) => ({pid: parseInt(pid), name: p.name, qty: p.qty, display: PRODUCT_DISPLAY[pid], comp: complimentaryProducts[pid]?.qty || 0}))
    .filter(p => p.qty > 0)
    .sort((a, b) => ((a.display?.order || 99) - (b.display?.order || 99)));
  if (items.length === 0) return '';
  const totalItems = items.reduce((s, p) => s + p.qty, 0);
  let html = `<div class="section"><div class="section-title"><span class="sec-icon">üõí</span> Items Sold This Period <span style="font-size:12px;color:var(--text2);margin-left:8px">${totalItems} items total</span></div>`;
  html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:12px">`;
  for (const item of items) {
    const icon = item.display?.icon || 'üì¶';
    const name = item.display?.name || item.name;
    const compBadge = item.comp > 0 ? `<div style="font-size:10px;color:var(--purple);margin-top:2px">(${item.comp} comp)</div>` : '';
    html += `<div style="background:var(--bg2);border-radius:10px;padding:14px 12px;text-align:center">
      <div style="font-size:24px;margin-bottom:4px">${icon}</div>
      <div style="font-size:22px;font-weight:700;color:var(--golden-amber)">${item.qty}</div>${compBadge}
      <div style="font-size:11px;color:var(--text2);margin-top:2px;line-height:1.3">${name}</div>
    </div>`;
  }
  html += `</div></div>`;
  return html;
}

function renderCountCheck(products, inventory, complimentaryProducts, wastageItems) {
  if (!products || !inventory) return '';
  complimentaryProducts = complimentaryProducts || {};
  wastageItems = wastageItems || [];

  // Pre-compute wasted units per count-check raw material from wastage items
  const wastedUnits = {};
  for (const w of wastageItems) {
    if (w.item && w.state) {
      // New format: {item, state, qty}
      const wastageKey = COUNT_CHECK_WASTAGE_MAP ? Object.entries(COUNT_CHECK_WASTAGE_MAP).find(([rmId, itemKey]) => itemKey === w.item) : null;
      if (wastageKey) {
        wastedUnits[wastageKey[0]] = (wastedUnits[wastageKey[0]] || 0) + (w.qty || 0);
      }
    } else if (w.material_id) {
      // Old format: {material_id, qty} ‚Äî direct raw material
      wastedUnits[String(w.material_id)] = (wastedUnits[String(w.material_id)] || 0) + (w.qty || 0);
    }
  }

  // Check if any comp items exist
  const hasComp = Object.keys(complimentaryProducts).length > 0;

  let html = `<div class="section"><div class="section-title"><span class="sec-icon">üìã</span> Count Check ‚Äî Inventory Tracking</div>`;
  html += `<div style="overflow-x:auto;margin-top:8px"><table class="inv-table">
    <tr><th>Item</th><th style="text-align:right">Opening</th><th style="text-align:right">Bought</th><th style="text-align:right">Sold</th>${hasComp ? '<th style="text-align:right">Comp</th>' : ''}<th style="text-align:right">Should Be</th><th style="text-align:right">Counted</th><th style="text-align:right">Wasted</th><th style="text-align:right">Missing</th></tr>`;

  let totalWasted = 0, totalMissing = 0;
  for (const item of COUNT_CHECK_ITEMS) {
    const opening = inventory.opening?.[item.rmId] || 0;
    const purchased = inventory.purchases?.[item.rmId]?.qty || inventory.purchases?.[item.rmId] || 0;
    const closing = inventory.closing?.[item.rmId] || 0;
    // Sold = only paid orders
    let sold = 0;
    for (const src of item.sources) {
      const p = products[String(src.pid)];
      if (p) sold += p.qty * src.mult;
    }
    // Comp = complimentary orders for same products
    let comp = 0;
    for (const src of item.sources) {
      const cp = complimentaryProducts[String(src.pid)];
      if (cp) comp += cp.qty * src.mult;
    }
    // Sold should exclude comp (API products already includes comp, so subtract)
    const paidSold = Math.max(0, sold - comp);
    const shouldBe = Math.round((opening + purchased - paidSold - comp) * 100) / 100;
    const wasted = wastedUnits[item.rmId] || 0;
    const missing = Math.round((shouldBe - closing - wasted) * 100) / 100;
    totalWasted += wasted;
    totalMissing += Math.max(0, missing);

    const rowStyle = missing > 0 ? 'background:rgba(239,68,68,0.08)' : missing < 0 ? 'background:rgba(234,179,8,0.08)' : '';
    const missingStr = missing === 0 ? '<span style="color:var(--green);font-weight:600">0</span>'
      : missing > 0 ? `<span style="color:var(--red);font-weight:700">${missing}</span>`
      : `<span style="color:var(--yellow);font-weight:600">+${Math.abs(missing)}</span>`;
    const wastedStr = wasted > 0 ? `<span style="color:var(--orange);font-weight:600">${wasted}</span>` : '‚Äî';
    const compStr = comp > 0 ? `<span style="color:var(--purple);font-weight:600">${comp}</span>` : '‚Äî';

    html += `<tr style="${rowStyle}">
      <td style="font-weight:500">${item.name}</td>
      <td class="num">${opening}</td>
      <td class="num">${purchased > 0 ? purchased : '‚Äî'}</td>
      <td class="num" style="color:var(--cyan)">${paidSold}</td>
      ${hasComp ? `<td class="num">${compStr}</td>` : ''}
      <td class="num">${shouldBe}</td>
      <td class="num">${closing}</td>
      <td class="num">${wastedStr}</td>
      <td class="num">${missingStr}</td>
    </tr>`;
  }
  html += `</table></div>`;

  // Summary badges
  const summaryParts = [];
  if (totalWasted > 0) summaryParts.push(`<span class="badge badge-orange">${totalWasted} wasted (recorded)</span>`);
  if (totalMissing > 0) summaryParts.push(`<span class="badge badge-red">${totalMissing} missing (unaccounted)</span>`);
  if (summaryParts.length > 0) {
    html += `<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">${summaryParts.join('')}</div>`;
  }
  html += `</div>`;
  return html;
}

function renderBeverageConsumption(products, inventory, complimentaryProducts, wastedRawMaterials) {
  if (!products || !inventory) return '';
  complimentaryProducts = complimentaryProducts || {};
  wastedRawMaterials = wastedRawMaterials || {};
  const chaiQty = products['1028']?.qty || 0;
  const coffeeQty = products['1102']?.qty || 0;
  const lemonTeaQty = products['1103']?.qty || 0;
  if (chaiQty === 0 && coffeeQty === 0 && lemonTeaQty === 0) return '';
  const chaiComp = complimentaryProducts['1028']?.qty || 0;
  const coffeeComp = complimentaryProducts['1102']?.qty || 0;
  const lemonTeaComp = complimentaryProducts['1103']?.qty || 0;
  let html = `<div class="section"><div class="section-title"><span class="sec-icon">‚òï</span> Chai & Coffee ‚Äî Raw Material Consumed</div>`;
  html += `<div style="display:flex;gap:16px;flex-wrap:wrap;margin:10px 0 14px">`;
  if (chaiQty > 0) {
    const chaiLabel = chaiComp > 0 ? `<strong style="color:var(--golden-amber)">${chaiQty - chaiComp}</strong> paid + <strong style="color:var(--purple)">${chaiComp}</strong> comp` : `<strong style="color:var(--golden-amber)">${chaiQty}</strong> cups`;
    html += `<div style="background:var(--bg2);padding:8px 14px;border-radius:8px;font-size:13px">Irani Chai: ${chaiLabel}</div>`;
  }
  if (coffeeQty > 0) {
    const coffeeLabel = coffeeComp > 0 ? `<strong style="color:var(--golden-amber)">${coffeeQty - coffeeComp}</strong> paid + <strong style="color:var(--purple)">${coffeeComp}</strong> comp` : `<strong style="color:var(--golden-amber)">${coffeeQty}</strong> cups`;
    html += `<div style="background:var(--bg2);padding:8px 14px;border-radius:8px;font-size:13px">Coffee: ${coffeeLabel}</div>`;
  }
  if (lemonTeaQty > 0) {
    const ltLabel = lemonTeaComp > 0 ? `<strong style="color:var(--golden-amber)">${lemonTeaQty - lemonTeaComp}</strong> paid + <strong style="color:var(--purple)">${lemonTeaComp}</strong> comp` : `<strong style="color:var(--golden-amber)">${lemonTeaQty}</strong> cups`;
    html += `<div style="background:var(--bg2);padding:8px 14px;border-radius:8px;font-size:13px">Lemon Tea: ${ltLabel}</div>`;
  }
  html += `</div>`;
  html += `<table class="inv-table">
    <tr><th>Raw Material</th><th style="text-align:right">Total Consumed</th>${chaiQty > 0 ? '<th style="text-align:right">Per Chai Cup</th>' : ''}</tr>`;
  for (const mat of BEVERAGE_MATERIALS) {
    const consumed = inventory.consumption?.[mat.rmId] || 0;
    if (consumed <= 0) continue;
    let perCupStr = '';
    if (chaiQty > 0) {
      // Subtract coffee & lemon tea share before dividing by chai cups
      let otherShare = 0;
      if (COFFEE_RECIPE[mat.rmId]) otherShare += coffeeQty * COFFEE_RECIPE[mat.rmId];
      if (LEMON_TEA_RECIPE[mat.rmId]) otherShare += lemonTeaQty * LEMON_TEA_RECIPE[mat.rmId];
      if (mat.rmId === '1097') otherShare += (products['1029']?.qty || 0) * BUN_MASKA_SUGAR; // bun maska sugar
      const wastedAmount = wastedRawMaterials[mat.rmId] || 0;
      const chaiOnly = consumed - otherShare - wastedAmount;
      const perCup = (chaiOnly / chaiQty) * mat.perCupMult;
      perCupStr = `<td class="num" style="color:var(--golden-amber);font-weight:600">~${Math.round(perCup * 10) / 10} ${mat.perCupUnit}</td>`;
    }
    html += `<tr>
      <td>${mat.name}</td>
      <td class="num">${consumed.toFixed(3)} ${mat.uom}</td>
      ${perCupStr}
    </tr>`;
  }
  html += `</table></div>`;
  return html;
}

function renderPnlResult(data) {
  let html = '';

  // Show warnings banner if any negative consumption detected
  if (data.warnings && data.warnings.length > 0) {
    html += `<div class="alert alert-warning" style="margin-bottom:16px">
      <span class="alert-icon">üö®</span>
      <div class="alert-text">
        <strong>${data.warnings.length} Inventory Warning(s)</strong><br>
        ${data.warnings.map(w => `<div style="margin-top:4px;font-size:12px">‚Ä¢ <strong>${w.materialName}</strong>: ${w.message}</div>`).join('')}
      </div>
    </div>`;
  }

  const periodStr = data.period ? `${formatTime(data.period.start)} ‚Üí ${formatTime(data.period.end)} (${Math.floor(data.period.hours)}h ${Math.round((data.period.hours % 1) * 60)}m)` : '';

  // ‚îÄ‚îÄ Print header (hidden on screen, visible in PDF) ‚îÄ‚îÄ
  html += `<div class="print-header">
    <h2>Nawabi Chai House ‚Äî Inventory Report</h2>
    <p><strong>${data.settlementDate}</strong></p>
    ${periodStr ? `<p>Period: ${periodStr}</p>` : ''}
    <p>Settled by: ${data.settledBy}</p>
  </div>`;

  // ‚îÄ‚îÄ INVENTORY REPORT (shown first ‚Äî staff-friendly) ‚îÄ‚îÄ
  html += `<div style="margin-bottom:8px;padding:10px 14px;background:var(--bg2);border-radius:10px;display:flex;justify-content:space-between;align-items:center">
    <div>
      <div style="font-size:15px;font-weight:600">Inventory Report ‚Äî ${data.settlementDate}</div>
      <div style="font-size:12px;color:var(--text2)">Settled by ${data.settledBy}${periodStr ? ` | ${periodStr}` : ''}</div>
    </div>
    <button class="btn btn-secondary no-print" onclick="window.print()" style="padding:6px 14px;font-size:13px">üì• Download PDF</button>
  </div>`;

  // Section A: Items Sold
  html += renderItemsSold(data.products, data.complimentaryProducts);

  // Section B: Count Check (with comp and wastage separation)
  const wastageItemsForReport = data.rawInput?.wastage_items || data.wastageItems || [];
  html += renderCountCheck(data.products, data.inventory, data.complimentaryProducts, wastageItemsForReport);

  // Section C: Beverage Consumption
  const wastedRawMaterialsForReport = data.inventory?.wastedRawMaterials || {};
  html += renderBeverageConsumption(data.products, data.inventory, data.complimentaryProducts, wastedRawMaterialsForReport);

  // ‚îÄ‚îÄ Inventory Movement (visible to all) ‚îÄ‚îÄ
  if (data.inventory) {
    html += `<div class="section"><div class="section-title"><span class="sec-icon">üì¶</span> Inventory Movement <span style="font-size:11px;background:rgba(168,85,247,0.15);color:var(--purple);padding:2px 8px;border-radius:4px;margin-left:8px">DECOMPOSED</span></div>`;
    html += renderInventoryMovement(data.inventory, data.inventory?.wastedRawMaterials);
    html += `</div>`;
  }

  // ‚îÄ‚îÄ Runner Tokens ‚îÄ‚îÄ
  if (data.runnerTokens?.current) {
    const tokens = data.runnerTokens.current;
    const tokenTotal = Object.values(tokens).reduce((a, b) => a + b, 0);
    if (tokenTotal > 0) {
      const runnerNames = {64:'FAROOQ',65:'AMIN',66:'RUN03',67:'RUN04',68:'RUN05'};
      html += `<div class="section"><div class="section-title"><span class="sec-icon">üéüÔ∏è</span> Runner Tokens (${tokenTotal} total)</div><div style="display:flex;gap:12px;flex-wrap:wrap">`;
      for (const [rid, count] of Object.entries(tokens)) {
        if (count > 0) html += `<div style="background:var(--bg2);padding:8px 14px;border-radius:8px;font-size:13px"><span style="color:var(--text2)">${runnerNames[rid] || rid}:</span> <span class="mono">${count}</span></div>`;
      }
      html += '</div></div>';
    }
  }

  // ‚îÄ‚îÄ Notes ‚îÄ‚îÄ
  const settlementNotes = $('settlementNotes')?.value || '';
  if (settlementNotes) {
    html += `<div class="section"><div class="section-title"><span class="sec-icon">üìù</span> Notes</div><div style="font-size:14px;color:var(--text2);line-height:1.6">${settlementNotes}</div></div>`;
  }

  $('settleResult').innerHTML = html;
}

function renderInventoryTable(inv) {
  let html = `<table class="inv-table"><tr><th>Material</th><th style="text-align:right">Qty</th></tr>`;
  for (const [matId, qty] of Object.entries(inv).sort((a, b) => (RAW_MATERIALS[a[0]]?.name || '').localeCompare(RAW_MATERIALS[b[0]]?.name || ''))) {
    if (qty < 0.0001) continue;
    const mat = RAW_MATERIALS[matId];
    html += `<tr><td>${mat?.name || matId}</td><td class="num">${fmtQty(qty, mat?.uom || '')} ${mat?.uom || ''}</td></tr>`;
  }
  html += '</table>';
  return html;
}

function renderInventoryMovement(inv, wastedRawMaterials) {
  wastedRawMaterials = wastedRawMaterials || {};
  // Only discrete countable items have meaningful "Missing" (fixed 1:1 ratio with POS sales)
  // Variable-consumption items (milk, sugar, tea etc.) show consumption only ‚Äî difference is recipe deviation, not loss
  const COUNTABLE_IDS = new Set(COUNT_CHECK_ITEMS.map(i => i.rmId));
  const allMats = new Set([
    ...Object.keys(inv.opening || {}),
    ...Object.keys(inv.closing || {}),
    ...Object.keys(inv.consumption || {}),
  ]);

  let html = `<div style="overflow-x:auto"><table class="inv-table">
    <tr><th>Material</th><th style="text-align:right">Opening</th><th style="text-align:right">Purchased</th><th style="text-align:right">Closing</th><th style="text-align:right">Consumed</th><th style="text-align:right">Expected</th><th style="text-align:right">Wasted</th><th style="text-align:right">Missing</th></tr>`;

  const sorted = [...allMats].sort((a, b) => (RAW_MATERIALS[a]?.name || '').localeCompare(RAW_MATERIALS[b]?.name || ''));
  for (const matId of sorted) {
    const mat = RAW_MATERIALS[matId];
    if (!mat) continue;
    const uom = mat.uom;
    const opening = inv.opening?.[matId] || 0;
    const purchased = inv.purchases?.[matId]?.qty || 0;
    const closing = inv.closing?.[matId] || 0;
    const consumed = inv.consumption?.[matId] || 0;
    const expected = inv.expected?.[matId] || 0;
    const wasted = wastedRawMaterials[matId] || 0;
    if (opening < 0.0001 && purchased < 0.0001 && closing < 0.0001) continue;

    const isCountable = COUNTABLE_IDS.has(matId);
    // Missing only meaningful for discrete countable items (fixed ratio: 1 bun = 1 bun maska)
    // For variable-consumption items (milk, sugar, tea), consumed vs expected is recipe deviation, not loss
    let missingRounded = 0;
    if (isCountable) {
      const discrepancy = consumed - expected;
      const missing = discrepancy - wasted;
      missingRounded = Math.round(missing * 10000) / 10000;
    }

    const wastedStr = wasted > 0 ? `<span style="color:var(--orange)">${fmtQty(wasted, uom)}</span>` : '‚Äî';
    const missingStr = !isCountable ? '‚Äî'
      : Math.abs(missingRounded) < 0.0001 ? '‚Äî'
      : missingRounded > 0 ? `<span style="color:var(--red)">${fmtQty(missingRounded, uom)}</span>`
      : `<span style="color:var(--yellow)">+${fmtQty(Math.abs(missingRounded), uom)}</span>`;

    html += `<tr>
      <td>${mat.name}</td>
      <td class="num">${fmtQty(opening, uom)}</td>
      <td class="num">${purchased > 0 ? fmtQty(purchased, uom) : '‚Äî'}</td>
      <td class="num">${fmtQty(closing, uom)}</td>
      <td class="num">${consumed > 0 ? fmtQty(consumed, uom) : '‚Äî'}</td>
      <td class="num">${expected > 0 ? fmtQty(expected, uom) : '‚Äî'}</td>
      <td class="num">${wastedStr}</td>
      <td class="num">${missingStr}</td>
    </tr>`;
  }
  html += '</table></div>';
  return html;
}

// ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadHistory() {
  $('historyLoading').style.display = 'block';
  $('historyList').innerHTML = '';
  $('historyDetail').style.display = 'none';

  try {
    const res = await fetch(`${API}?action=history`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    $('historyLoading').style.display = 'none';

    if (!data.settlements || data.settlements.length === 0) {
      $('historyList').innerHTML = `<div class="alert alert-info"><span class="alert-icon">üìã</span><div class="alert-text">No settlements yet. Start with a bootstrap settlement.</div></div>`;
      return;
    }

    let html = '';
    for (const s of data.settlements) {
      const statusBadge = s.status === 'bootstrap' ? '<span class="badge badge-blue">Bootstrap</span>' : '<span class="badge badge-green">Completed</span>';
      // Period duration
      let periodLabel = '';
      if (s.period_start && s.period_end && s.status !== 'bootstrap') {
        const hrs = (new Date(s.period_end) - new Date(s.period_start)) / 3600000;
        periodLabel = `<span style="font-size:11px;color:var(--muted);margin-left:8px">${Math.floor(hrs)}h ${Math.round((hrs % 1) * 60)}m</span>`;
      }
      html += `
        <div class="history-item" onclick="loadSettlementDetail(${s.id})">
          <div class="hi-top">
            <span class="hi-date">${s.settlement_date}</span>
            <span style="font-size:12px;color:var(--text2)">${formatTime(s.settled_at)}</span>
            ${statusBadge}${periodLabel}
          </div>
          ${s.status === 'completed' ? `
          <div style="font-size:13px;color:var(--text2);margin-top:4px">Settled by ${s.settled_by}</div>` : `
          <div style="font-size:13px;color:var(--text2);margin-top:4px">Baseline inventory recorded by ${s.settled_by}</div>`}
        </div>
      `;
    }
    $('historyList').innerHTML = html;

  } catch (e) {
    $('historyLoading').style.display = 'none';
    console.error('History load error:', e);
    $('historyList').innerHTML = `<div class="alert alert-error"><span class="alert-icon">‚ùå</span><div class="alert-text">Could not load history. Please check your connection and try again.</div></div>`;
  }
}

async function loadSettlementDetail(id) {
  $('historyDetail').style.display = 'block';
  $('historyDetail').innerHTML = `<div class="loading"><div class="spinner"></div><p style="margin-top:12px">Loading settlement #${id}...</p></div>`;

  try {
    const res = await fetch(`${API}?action=get-settlement&id=${id}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    const s = data.settlement;
    let html = `<div style="margin-bottom:16px"><button class="btn btn-secondary" onclick="$('historyDetail').style.display='none'">‚Üê Back to list</button></div>`;

    // Parse raw input for both views
    let rawInput = null;
    try { rawInput = JSON.parse(s.inventory_raw_input || '{}'); } catch {}

    if (s.status === 'bootstrap') {
      html += `
        <div class="alert alert-info" style="margin-bottom:16px"><span class="alert-icon">üèÅ</span><div class="alert-text"><strong>Bootstrap ‚Äî ${s.settlement_date}</strong><br>Settled by ${s.settled_by} at ${formatTime(s.settled_at)}</div></div>
        ${rawInput && Object.keys(rawInput).length > 0 ? `<div class="section"><div class="section-title"><span class="sec-icon">üìã</span> Staff Physical Count <span style="font-size:11px;background:rgba(6,182,212,0.15);color:var(--cyan);padding:2px 8px;border-radius:4px;margin-left:8px">RAW</span></div>${renderRawInputTable(rawInput)}</div>` : ''}
        <div class="section"><div class="section-title"><span class="sec-icon">üì¶</span> Baseline Inventory <span style="font-size:11px;background:rgba(168,85,247,0.15);color:var(--purple);padding:2px 8px;border-radius:4px;margin-left:8px">DECOMPOSED</span></div>
          ${renderInventoryTable(JSON.parse(s.inventory_decomposed || '{}'))}
        </div>
      `;
    } else {
      // Period info
      let periodLabel = '';
      if (s.period_start && s.period_end) {
        const hrs = (new Date(s.period_end) - new Date(s.period_start)) / 3600000;
        periodLabel = ` | ${Math.floor(hrs)}h ${Math.round((hrs % 1) * 60)}m`;
      }

      // Parse all inventory data
      const revenueData = JSON.parse(s.revenue_breakdown || '{}');
      delete revenueData.__complimentary; // Clean up embedded key if present
      const products = revenueData;
      // Use API-provided complimentary data (fetched live from Odoo)
      const complimentaryProducts = data.complimentaryProducts || {};
      const inventory = {
        opening: JSON.parse(s.inventory_opening || '{}'),
        purchases: JSON.parse(s.inventory_purchases || '{}'),
        closing: JSON.parse(s.inventory_closing || '{}'),
        consumption: JSON.parse(s.inventory_consumption || '{}'),
        expected: JSON.parse(s.inventory_expected || '{}'),
      };

      // Parse wastage items and compute wastedRawMaterials from stored data
      const storedWastage = JSON.parse(s.wastage_items || '[]');
      const wastedRawMaterials = {};
      for (const w of storedWastage) {
        if (w.item && w.state && WASTAGE_DECOMPOSITION[w.item]?.[w.state]) {
          // New format: decompose via state
          for (const [matId, qtyPerUnit] of Object.entries(WASTAGE_DECOMPOSITION[w.item][w.state])) {
            wastedRawMaterials[matId] = (wastedRawMaterials[matId] || 0) + (w.qty || 0) * qtyPerUnit;
          }
        } else if (w.material_id) {
          // Old format: direct raw material
          wastedRawMaterials[String(w.material_id)] = (wastedRawMaterials[String(w.material_id)] || 0) + (w.qty || 0);
        }
      }

      // ‚îÄ‚îÄ Print header (hidden on screen, visible in PDF) ‚îÄ‚îÄ
      const periodStrFull = s.period_start && s.period_end
        ? `${formatTime(s.period_start)} ‚Üí ${formatTime(s.period_end)}${periodLabel}`
        : '';
      html += `<div class="print-header">
        <h2>Nawabi Chai House ‚Äî Inventory Report</h2>
        <p><strong>${s.settlement_date}</strong></p>
        ${periodStrFull ? `<p>Period: ${periodStrFull}</p>` : ''}
        <p>Settled by: ${s.settled_by} at ${formatTime(s.settled_at)}</p>
      </div>`;

      // ‚îÄ‚îÄ INVENTORY REPORT (shown first) ‚îÄ‚îÄ
      html += `<div style="margin-bottom:8px;padding:10px 14px;background:var(--bg2);border-radius:10px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:15px;font-weight:600">Inventory Report ‚Äî ${s.settlement_date}</div>
          <div style="font-size:12px;color:var(--text2)">Settled by ${s.settled_by} at ${formatTime(s.settled_at)}${periodLabel}</div>
        </div>
        <button class="btn btn-secondary no-print" onclick="window.print()" style="padding:6px 14px;font-size:13px">üì• Download PDF</button>
      </div>`;

      // Section A: Items Sold
      html += renderItemsSold(products, complimentaryProducts);

      // Section B: Count Check (with comp and wastage separation)
      html += renderCountCheck(products, inventory, complimentaryProducts, storedWastage);

      // Section C: Beverage Consumption
      html += renderBeverageConsumption(products, inventory, complimentaryProducts, wastedRawMaterials);

      // ‚îÄ‚îÄ Inventory Movement (visible to all) ‚îÄ‚îÄ
      html += `<div class="section"><div class="section-title"><span class="sec-icon">üì¶</span> Inventory Movement <span style="font-size:11px;background:rgba(168,85,247,0.15);color:var(--purple);padding:2px 8px;border-radius:4px;margin-left:8px">DECOMPOSED</span></div>`;
      html += renderInventoryMovement(inventory, wastedRawMaterials);
      html += `</div>`;

      // Runner tokens
      const tokens = JSON.parse(s.runner_tokens || '{}');
      const tokenTotal = Object.values(tokens).reduce((a, b) => a + b, 0);
      if (tokenTotal > 0) {
        html += `<div class="section"><div class="section-title"><span class="sec-icon">üéüÔ∏è</span> Runner Tokens (${tokenTotal} total)</div><div style="display:flex;gap:12px;flex-wrap:wrap">`;
        const runnerNames = {64:'FAROOQ',65:'AMIN',66:'RUN03',67:'RUN04',68:'RUN05'};
        for (const [rid, count] of Object.entries(tokens)) {
          if (count > 0) html += `<div style="background:var(--bg2);padding:8px 14px;border-radius:8px;font-size:13px"><span style="color:var(--text2)">${runnerNames[rid] || rid}:</span> <span class="mono">${count}</span></div>`;
        }
        html += '</div></div>';
      }

      // Notes
      if (s.notes) {
        html += `<div class="section"><div class="section-title"><span class="sec-icon">üìù</span> Notes</div><div style="font-size:14px;color:var(--text2);line-height:1.6">${s.notes}</div></div>`;
      }
    }

    $('historyDetail').innerHTML = html;
  } catch (e) {
    console.error('Settlement detail load error:', e);
    $('historyDetail').innerHTML = `<div class="alert alert-error"><span class="alert-icon">‚ùå</span><div class="alert-text">Could not load settlement details. Please try again.</div></div>`;
  }
}

// ‚îÄ‚îÄ CONFIG: VESSELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderVesselConfig() {
  const container = $('vesselList');
  if (!vessels || vessels.length === 0) {
    container.innerHTML = `<div style="color:var(--text2);font-size:13px">No vessels configured yet. Using defaults.</div>`;
    return;
  }
  let html = `<table class="inv-table">
    <tr><th>Code</th><th>Name</th><th>Type</th><th>Location</th><th style="text-align:right">Tare (kg)</th></tr>`;
  for (const v of vessels) {
    html += `<tr>
      <td class="mono" style="font-size:12px">${v.code}</td>
      <td>${v.name}</td>
      <td style="font-size:12px">${v.liquid_type}</td>
      <td style="font-size:12px">${v.location}</td>
      <td class="num">${v.empty_weight_kg}</td>
    </tr>`;
  }
  html += '</table>';
  container.innerHTML = html;
}

async function saveVessel() {
  const code = $('vesselCode').value.trim();
  const name = $('vesselName').value.trim();
  const liquid_type = $('vesselType').value;
  const location = $('vesselLocation').value;
  const empty_weight_kg = parseFloat($('vesselWeight').value);

  if (!code || !name || isNaN(empty_weight_kg)) {
    alert('Please fill in all vessel fields');
    return;
  }

  try {
    const res = await fetch(`${API}?action=save-vessel`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({code, name, liquid_type, location, empty_weight_kg, notes: ''}),
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    // Clear form
    $('vesselCode').value = '';
    $('vesselName').value = '';
    $('vesselWeight').value = '';

    // Reload config
    loadConfig();
    alert('Vessel saved!');
  } catch (e) {
    console.error('Vessel save error:', e);
    alert('‚ö†Ô∏è Could not save vessel. Please try again.');
  }
}

// ‚îÄ‚îÄ CONFIG: SALARIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadSalaries() {
  // Salaries now managed on /ops/staffing/ page ‚Äî nothing to load here
}

// saveSalary removed ‚Äî salaries now managed on /ops/staffing/ page

// ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function formatTime(isoStr) {
  if (!isoStr) return '';
  const d = new Date(isoStr);
  const ist = new Date(d.getTime() + 5.5 * 3600000);
  const dd = String(ist.getUTCDate()).padStart(2, '0');
  const mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][ist.getUTCMonth()];
  const hh = String(ist.getUTCHours()).padStart(2, '0');
  const mm = String(ist.getUTCMinutes()).padStart(2, '0');
  return `${dd} ${mon} ${hh}:${mm}`;
}

// Focus first PIN input on load
pins[0].focus();
</script>
</body>
</html>
