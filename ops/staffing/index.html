<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCH Staffing Cost</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--muted:#64748b;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--yellow:#eab308;--orange:#f97316;--teal:#14b8a6}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:16px;max-width:800px;margin:0 auto}
    .mono{font-family:'JetBrains Mono',monospace}
    h1{font-size:20px;font-weight:700;margin-bottom:4px}
    .subtitle{color:var(--text2);font-size:13px;margin-bottom:20px}
    .back{color:var(--text2);text-decoration:none;font-size:13px;display:inline-flex;align-items:center;gap:4px;margin-bottom:16px}
    .back:hover{color:var(--text)}

    .date-row{display:flex;align-items:center;gap:12px;margin-bottom:20px}
    .date-row input{background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px 12px;font-family:inherit;font-size:14px}
    .btn{background:var(--teal);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600}
    .btn:hover{opacity:.9}
    .btn-sm{padding:6px 12px;font-size:12px}
    .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
    .btn-outline:hover{border-color:var(--text2);color:var(--text)}

    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
    .summary-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .summary-card .label{color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
    .summary-card .value{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace}
    .summary-card .value.green{color:var(--green)}
    .summary-card .value.orange{color:var(--orange)}
    .summary-card .value.teal{color:var(--teal)}

    .section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
    .section-title{font-size:15px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .badge{font-size:10px;padding:2px 8px;border-radius:20px;font-weight:600}
    .badge-half{background:rgba(234,179,8,.15);color:var(--yellow)}
    .badge-office{background:rgba(139,92,246,.15);color:var(--purple)}
    .badge-inactive{background:rgba(239,68,68,.15);color:var(--red)}

    table{width:100%;border-collapse:collapse;font-size:13px}
    th{text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:.5px;padding:8px 6px;border-bottom:1px solid var(--border)}
    td{padding:8px 6px;border-bottom:1px solid rgba(45,58,79,.5)}
    td.name{font-weight:600}
    td.num{font-family:'JetBrains Mono',monospace;text-align:right}
    tr:last-child td{border-bottom:none}
    .tot-row td{border-top:2px solid var(--border);font-weight:700}

    .loading{text-align:center;padding:40px;color:var(--text2)}
    .error-msg{color:var(--red);padding:16px;text-align:center}

    @media(max-width:600px){
      .summary{grid-template-columns:1fr}
      table{font-size:12px}
      th,td{padding:6px 4px}
    }
  </style>
</head>
<body>
  <a href="/ops/" class="back">‚Üê Operations Hub</a>
  <h1>üë§ NCH Staffing Cost</h1>
  <p class="subtitle">Daily staff cost breakdown by employee</p>

  <div class="date-row">
    <input type="date" id="dateInput">
    <button class="btn" onclick="loadCosts()">Load</button>
    <button class="btn btn-outline btn-sm" onclick="syncOdoo()">‚Üª Sync Odoo</button>
  </div>

  <div class="summary" id="summary" style="display:none">
    <div class="summary-card"><div class="label">NCH Direct</div><div class="value green" id="nchTotal">‚Äî</div></div>
    <div class="summary-card"><div class="label">Office</div><div class="value orange" id="officeTotal">‚Äî</div></div>
    <div class="summary-card"><div class="label">Grand Total</div><div class="value teal" id="grandTotal">‚Äî</div></div>
  </div>

  <div id="content"><div class="loading">Select a date and click Load</div></div>

  <script>
    const API = '/api/staffing';
    const $ = id => document.getElementById(id);
    const fmt = n => '‚Çπ' + Math.round(n).toLocaleString('en-IN');

    // Default to today IST
    const now = new Date(Date.now() + 5.5 * 3600000);
    $('dateInput').value = now.toISOString().slice(0, 10);

    async function loadCosts() {
      const date = $('dateInput').value;
      if (!date) return;
      $('content').innerHTML = '<div class="loading">Loading...</div>';

      try {
        const res = await fetch(`${API}?action=get-daily-costs&date=${date}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.error);

        $('summary').style.display = '';
        $('nchTotal').textContent = fmt(data.totals.nch);
        $('officeTotal').textContent = fmt(data.totals.office);
        $('grandTotal').textContent = fmt(data.totals.grand);

        let html = '';

        // NCH Direct Staff
        if (data.nchDirect.length > 0) {
          html += `<div class="section">
            <div class="section-title"><span>üè™</span> NCH Direct Staff <span class="badge" style="background:rgba(34,197,94,.15);color:var(--green)">${data.nchDirect.length} active</span></div>
            <table>
              <tr><th>Name</th><th>Role</th><th style="text-align:right">Monthly</th><th style="text-align:right">Daily</th><th>Status</th></tr>
              ${data.nchDirect.map(s => `<tr>
                <td class="name">${s.name}</td>
                <td>${s.role}</td>
                <td class="num">${fmt(s.monthly)}</td>
                <td class="num">${fmt(s.daily)}${s.halfPay ? ' <span class="badge badge-half">50%</span>' : ''}</td>
                <td><span style="color:var(--green);font-size:11px">‚óè</span></td>
              </tr>`).join('')}
              <tr class="tot-row"><td colspan="3" style="text-align:right">Total</td><td class="num">${fmt(data.totals.nch)}</td><td></td></tr>
            </table>
          </div>`;
        }

        // Office Staff
        if (data.office.length > 0) {
          html += `<div class="section">
            <div class="section-title"><span>üè¢</span> Office Staff <span class="badge badge-office">${data.office.length} staff</span></div>
            <table>
              <tr><th>Name</th><th>Role</th><th style="text-align:right">Monthly</th><th style="text-align:right">Daily</th><th>Note</th></tr>
              ${data.office.map(s => `<tr>
                <td class="name">${s.name}</td>
                <td>${s.role}</td>
                <td class="num">${fmt(s.monthly)}</td>
                <td class="num">${fmt(s.daily)}${s.halfPay ? ' <span class="badge badge-half">50%</span>' : ''}</td>
                <td style="font-size:11px;color:var(--text2)">Tracked separately</td>
              </tr>`).join('')}
              <tr class="tot-row"><td colspan="3" style="text-align:right">Total</td><td class="num">${fmt(data.totals.office)}</td><td></td></tr>
            </table>
          </div>`;
        }

        // Inactive Staff
        if (data.inactive && data.inactive.length > 0) {
          html += `<div class="section">
            <div class="section-title"><span>‚è∏Ô∏è</span> Inactive Staff <span class="badge badge-inactive">${data.inactive.length}</span></div>
            <table>
              <tr><th>Name</th><th>Role</th><th>Start Date</th><th style="text-align:right">Monthly</th></tr>
              ${data.inactive.map(s => `<tr style="opacity:.5">
                <td class="name">${s.name}</td>
                <td>${s.role}</td>
                <td>${s.startDate}</td>
                <td class="num">${fmt(s.monthly)}</td>
              </tr>`).join('')}
            </table>
          </div>`;
        }

        // Pre-opening note
        if (date < '2026-02-03') {
          html += `<div class="section" style="border-color:var(--yellow)">
            <div class="section-title"><span>‚ö†Ô∏è</span> Pre-Opening Period</div>
            <p style="font-size:13px;color:var(--text2)">The outlet opened on Feb 3, 2026. Staff who started before this date are at 50% salary for pre-opening days.</p>
          </div>`;
        }

        $('content').innerHTML = html;
      } catch (e) {
        $('content').innerHTML = `<div class="error-msg">${e.message}</div>`;
      }
    }

    async function syncOdoo() {
      if (!confirm('Sync all staff data to Odoo hr.employee?')) return;
      try {
        const res = await fetch(`${API}?action=sync-odoo`, {method: 'POST', headers: {'Content-Type': 'application/json'}});
        const data = await res.json();
        if (data.success) {
          const summary = data.results.map(r => `${r.name}: ${r.action}`).join('\n');
          alert('Sync complete!\n\n' + summary);
        } else {
          alert('Sync failed: ' + data.error);
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Auto-load on page open
    loadCosts();
  </script>
</body>
</html>
