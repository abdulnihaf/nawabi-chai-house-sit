<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCH Token Settlement</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--border:#2d3a4f;--text:#f1f5f9;--text2:#94a3b8;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--yellow:#eab308;--orange:#f97316}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .pin-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .pin-screen.hidden{display:none}
    .pin-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;text-align:center;max-width:360px;width:100%}
    .pin-box .icon{font-size:48px;margin-bottom:20px}
    .pin-box h2{font-size:24px;margin-bottom:8px}
    .pin-box p{color:var(--text2);font-size:14px;margin-bottom:24px}
    .pin-input{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .pin-input input{width:48px;height:56px;background:var(--bg2);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:24px;text-align:center;font-family:'JetBrains Mono',monospace;transition:all 0.2s}
    .pin-input input:focus{outline:none;border-color:var(--orange);box-shadow:0 0 0 3px rgba(249,115,22,0.2)}
    .pin-input input.filled{border-color:var(--green);background:rgba(34,197,94,0.1)}
    .pin-error{color:var(--red);font-size:13px;margin-top:8px;display:none}
    .pin-success{display:none;align-items:center;gap:8px;justify-content:center;color:var(--green);font-weight:600;margin-top:16px}
    .pin-success.show{display:flex}
    .dashboard{display:none;min-height:100vh}
    .dashboard.show{display:block}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .header h1{font-size:20px;display:flex;align-items:center;gap:8px}
    .header h1::before{content:'';width:4px;height:24px;background:var(--orange);border-radius:2px}
    .user-badge{display:flex;align-items:center;gap:12px}
    .user-badge .dot{width:8px;height:8px;background:var(--green);border-radius:50%}
    .user-badge .name{font-weight:600}
    .logout-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px}
    .logout-btn:hover{background:var(--border)}
    .content{padding:24px;max-width:700px;margin:0 auto}
    .status-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px}
    .status-card h3{font-size:16px;margin-bottom:4px}
    .status-card .period{font-size:13px;color:var(--text2);font-family:'JetBrains Mono',monospace;margin-bottom:4px}
    .status-card .elapsed{font-size:12px;color:var(--orange)}
    .status-card .carry-info{font-size:12px;color:var(--yellow);margin-top:6px}
    .section-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px}
    .section-card h3{font-size:16px;margin-bottom:16px}
    .weight-row{display:flex;gap:12px;align-items:flex-end}
    .weight-field{flex:1}
    .weight-field label{font-size:13px;color:var(--text2);display:block;margin-bottom:6px}
    .weight-field input{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:24px;padding:12px;font-family:'JetBrains Mono',monospace;text-align:center}
    .weight-field input:focus{outline:none;border-color:var(--orange)}
    .token-estimate{background:var(--bg2);border-radius:10px;padding:16px;text-align:center;min-width:140px}
    .token-estimate .count{font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--orange)}
    .token-estimate .label{font-size:11px;color:var(--text2);margin-top:4px}
    .runner-unsold{margin-top:20px}
    .runner-unsold h4{font-size:13px;color:var(--text2);margin-bottom:10px}
    .runner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
    .runner-item{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center}
    .runner-item .rname{font-size:12px;color:var(--text2);margin-bottom:4px}
    .runner-item .rcontext{font-size:10px;color:var(--yellow);margin-bottom:4px;font-family:'JetBrains Mono',monospace}
    .runner-item .rmax{font-size:10px;color:var(--text2);margin-top:3px}
    .runner-item input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:18px;padding:8px;font-family:'JetBrains Mono',monospace;text-align:center}
    .runner-item input:focus{outline:none;border-color:var(--orange)}
    .runner-item input.over-max{border-color:var(--red);background:rgba(239,68,68,0.1)}
    .unsold-total{margin-top:10px;font-size:13px;color:var(--text2);text-align:right}
    .unsold-total span{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--orange)}
    .reset-btn{background:none;border:1px solid var(--red);color:var(--red);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;margin-top:12px}
    .reset-btn:hover{background:rgba(239,68,68,0.1)}
    .btn{width:100%;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:16px}
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{background:var(--border);color:var(--text2);cursor:not-allowed;transform:none;pointer-events:none}
    .btn-preview{background:var(--blue);color:#fff}
    .btn-preview:hover{background:#2563eb}
    .btn-settle{background:var(--green);color:#fff}
    .btn-settle:hover{background:#16a34a}
    .btn.loading{pointer-events:none;opacity:0.8}
    .btn .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .success-banner{background:rgba(34,197,94,0.15);border:1px solid var(--green);border-radius:12px;padding:16px;text-align:center;margin-bottom:16px;animation:fadeIn 0.3s ease}
    .success-banner .check{font-size:28px;margin-bottom:4px}
    .success-banner .msg{font-size:15px;font-weight:600;color:var(--green)}
    .success-banner .sub{font-size:12px;color:var(--text2);margin-top:4px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    .btn-done{background:var(--green);color:#fff;pointer-events:none;opacity:0.9}
    .btn-bootstrap{background:var(--orange);color:#fff}
    .btn-bootstrap:hover{background:#ea580c}
    .preview-card{background:var(--card);border:2px solid var(--orange);border-radius:16px;padding:24px;margin-bottom:24px;display:none}
    .preview-card.show{display:block}
    .preview-card h3{font-size:16px;margin-bottom:16px}
    .breakdown-table{width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px}
    .breakdown-table th{text-align:left;color:var(--text2);font-weight:500;padding:8px 0;border-bottom:2px solid var(--border)}
    .breakdown-table th:not(:first-child){text-align:right}
    .breakdown-table td{padding:8px 0;border-bottom:1px solid var(--border)}
    .breakdown-table td:not(:first-child){text-align:right;font-family:'JetBrains Mono',monospace;font-weight:500}
    .breakdown-table tr.total-row td{border-top:2px solid var(--border);font-weight:700;padding-top:12px}
    .formula-box{background:var(--bg2);border-radius:10px;padding:16px;margin:16px 0;font-family:'JetBrains Mono',monospace;font-size:13px;line-height:2}
    .formula-box .formula-line{display:flex;justify-content:space-between;padding:2px 0}
    .formula-box .formula-line.total{border-top:2px solid var(--border);margin-top:6px;padding-top:8px;font-weight:700;font-size:15px}
    .formula-box .formula-label{color:var(--text2)}
    .formula-box .formula-val{font-weight:600}
    .result-row{display:flex;justify-content:space-between;padding:12px 16px;background:var(--bg2);border-radius:10px;margin-bottom:8px}
    .result-row .label{color:var(--text2);font-size:14px}
    .result-row .value{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:16px}
    .discrepancy-box{border-radius:10px;padding:16px;text-align:center;margin:16px 0}
    .discrepancy-box .disc-value{font-size:32px;font-weight:700;font-family:'JetBrains Mono',monospace}
    .discrepancy-box .disc-label{font-size:12px;margin-top:4px}
    .disc-green{background:rgba(34,197,94,0.1);border:1px solid var(--green);color:var(--green)}
    .disc-yellow{background:rgba(234,179,8,0.1);border:1px solid var(--yellow);color:var(--yellow)}
    .disc-red{background:rgba(239,68,68,0.1);border:1px solid var(--red);color:var(--red)}
    .info-row{display:flex;gap:12px;margin-top:12px}
    .info-chip{flex:1;background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:12px;color:var(--text2);text-align:center}
    .info-chip .chip-val{font-size:16px;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--text);margin-bottom:2px}
    .notes-field{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;padding:10px;font-family:'Plus Jakarta Sans',sans-serif;margin-top:12px;resize:vertical;min-height:60px}
    .notes-field:focus{outline:none;border-color:var(--orange)}
    .history-section{margin-top:32px}
    .history-section h3{font-size:16px;color:var(--text2);margin-bottom:16px}
    .history-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
    .history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .history-date{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
    .history-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace}
    .history-badge.green{background:rgba(34,197,94,0.15);color:var(--green)}
    .history-badge.yellow{background:rgba(234,179,8,0.15);color:var(--yellow)}
    .history-badge.red{background:rgba(239,68,68,0.15);color:var(--red)}
    .history-detail{font-size:12px;color:var(--text2);line-height:1.6}
    .history-detail span{font-family:'JetBrains Mono',monospace;color:var(--text);font-weight:500}
    .history-formula{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace;margin-top:4px;padding-top:4px;border-top:1px solid var(--border)}
    .loading{text-align:center;color:var(--text2);padding:40px}
    .report-section{background:var(--card);border:2px solid var(--green);border-radius:16px;padding:24px;margin-bottom:24px;display:none}
    .report-section.show{display:block}
    .report-section h3{font-size:18px;margin-bottom:16px;color:var(--green)}
    .report-actions{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
    .report-actions .btn{width:auto;flex:1;min-width:160px;font-size:13px;padding:12px 16px}
    .btn-download{background:var(--purple);color:#fff}
    .btn-download:hover{background:#9333ea}
    .btn-wa{background:#25d366;color:#fff}
    .btn-wa:hover{background:#1fb855}
    .wa-status{font-size:12px;color:var(--text2);margin-top:8px;text-align:center}
    .wa-status.sent{color:var(--green)}
    .wa-status.fail{color:var(--red)}
    .history-actions{display:flex;gap:8px;margin-top:8px}
    .history-dl{background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;display:inline-flex;align-items:center;gap:4px}
    .history-dl:hover{background:var(--border);color:var(--text)}
    .bootstrap-card{background:var(--card);border:2px dashed var(--orange);border-radius:16px;padding:32px;text-align:center;margin-bottom:24px}
    .bootstrap-card .icon{font-size:48px;margin-bottom:16px}
    .bootstrap-card h3{font-size:20px;margin-bottom:8px}
    .bootstrap-card p{color:var(--text2);font-size:14px;margin-bottom:20px}
    .back-link{display:inline-flex;align-items:center;gap:6px;color:var(--text2);text-decoration:none;font-size:13px;margin-bottom:16px}
    .back-link:hover{color:var(--text)}
    @media(max-width:500px){
      .weight-row{flex-direction:column}
      .token-estimate{min-width:auto}
      .header{padding:12px 16px}
      .content{padding:16px}
      .info-row{flex-direction:column}
      .runner-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
    }
  </style>
</head>
<body>
  <!-- PIN Screen -->
  <div class="pin-screen" id="pinScreen">
    <div class="pin-box">
      <div class="icon">&#9878;&#65039;</div>
      <h2>Token Settlement</h2>
      <p>Enter your PIN to continue</p>
      <div class="pin-input" id="pinInput">
        <input type="tel" maxlength="1" inputmode="numeric" autocomplete="off">
        <input type="tel" maxlength="1" inputmode="numeric" autocomplete="off">
        <input type="tel" maxlength="1" inputmode="numeric" autocomplete="off">
        <input type="tel" maxlength="1" inputmode="numeric" autocomplete="off">
      </div>
      <div class="pin-error" id="pinError">Invalid PIN</div>
      <div class="pin-success" id="pinSuccess">
        <span>&#10003;</span> Welcome, <span id="pinUser"></span>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="header">
      <h1>Token Settlement</h1>
      <div class="user-badge">
        <div class="dot"></div>
        <span class="name" id="userName"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="content">
      <a href="/ops/" class="back-link">&larr; Back to Operations</a>

      <!-- Bootstrap -->
      <div class="bootstrap-card" id="bootstrapCard" style="display:none">
        <div class="icon">&#128230;</div>
        <h3>Start Token Tracking</h3>
        <p>Empty the token box, then enter how many unsold tokens each runner currently has. The system will show Odoo data to help you verify.</p>
        <div id="bootstrapRunnerSection" style="display:none">
          <div class="runner-unsold" style="margin-top:16px">
            <h4>Unsold tokens with runners right now</h4>
            <div class="runner-grid" id="bootstrapRunnerGrid"></div>
            <div class="unsold-total">Total unsold: <span id="bootstrapUnsoldTotal">0</span></div>
          </div>
        </div>
        <button class="btn btn-preview" id="loadContextBtn" onclick="loadRunnerContext('bootstrap')" style="margin-top:16px">Load Runner Data from Odoo</button>
        <button class="btn btn-bootstrap" id="bootstrapBtn" onclick="bootstrap()" style="display:none">Start Token Tracking</button>
      </div>

      <!-- Active tracking -->
      <div id="activeSection" style="display:none">
        <!-- Period status -->
        <div class="status-card" id="statusCard">
          <h3>Current Period</h3>
          <div class="period" id="periodText">Loading...</div>
          <div class="elapsed" id="elapsedText"></div>
          <div class="carry-info" id="carryInfo" style="display:none"></div>
          <button class="reset-btn" onclick="resetTokenTracking()">Reset &amp; Re-bootstrap</button>
        </div>

        <!-- Weight input -->
        <div class="section-card">
          <h3>Weigh Token Box</h3>
          <div class="weight-row">
            <div class="weight-field">
              <label>Gross weight (g)</label>
              <input type="number" id="weightInput" step="1" min="339" placeholder="0" oninput="updateEstimate()">
            </div>
            <div class="token-estimate">
              <div class="count" id="estimateCount">-</div>
              <div class="label">tokens (est.)</div>
            </div>
          </div>

          <!-- Runner unsold tokens -->
          <div class="runner-unsold">
            <h4>Unsold tokens with runners <span style="font-weight:400;color:var(--text2)">(enter 0 if none)</span></h4>
            <button class="reset-btn" style="border-color:var(--blue);color:var(--blue);margin-bottom:10px" onclick="loadRunnerContext('settle')">Load from Odoo (optional)</button>
            <div class="runner-grid" id="runnerGrid"></div>
            <div class="unsold-total">Total unsold: <span id="unsoldTotal">0</span></div>
          </div>

          <button class="btn btn-preview" id="previewBtn" onclick="previewSettlement()" disabled>Preview Settlement</button>
        </div>

        <!-- Preview result -->
        <div class="preview-card" id="previewCard">
          <h3>Settlement Preview</h3>
          <div id="previewContent"></div>
          <textarea class="notes-field" id="notesInput" placeholder="Optional notes..."></textarea>
          <button class="btn btn-settle" id="settleBtn" onclick="settle()">Settle &amp; Empty Box</button>
        </div>

        <!-- Settlement Report (shown after settle) -->
        <div class="report-section" id="reportSection">
          <h3>Settlement Complete</h3>
          <div id="reportContent"></div>
          <div class="report-actions">
            <button class="btn btn-download" onclick="downloadPDF('full')">Download Full Report (PDF)</button>
            <button class="btn btn-download" onclick="downloadPDF('simple')">Download Tea Master Report (PDF)</button>
          </div>
          <div class="wa-status" id="waStatus">Sending report to Mujeeb...</div>
        </div>

        <!-- History -->
        <div class="history-section">
          <h3>Settlement History</h3>
          <div id="historyList"><div class="loading">Loading history...</div></div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const API = '/api/token-settlement';
const WA_PHONES = ['917010426808', '919591170162']; // Nihaf, Mujeeb
const BOX_TARE = 339;    // grams (SF-400 scale)
const TOKEN_WEIGHT = 1.1; // ~1.1 gram per token
const RUNNERS = [
  {id: 64, name: 'FAROOQ'},
  {id: 65, name: 'AMIN'},
  {id: 66, name: 'Runner 03'},
  {id: 67, name: 'Runner 04'},
  {id: 68, name: 'Runner 05'}
];

let currentUser = null;
let lastSettlement = null;
let previewData = null;
let lastSettleResult = null; // stored for PDF download after settlement
let historyData = []; // stored for history PDF downloads
let runnerContext = null; // per-runner token issuance context from Odoo

// ── PIN ──
const pinInputs = document.querySelectorAll('#pinInput input');
pinInputs.forEach((inp, i) => {
  inp.addEventListener('input', () => {
    if (inp.value) {
      inp.classList.add('filled');
      if (i < 3) pinInputs[i + 1].focus();
      if (i === 3) checkPin();
    }
  });
  inp.addEventListener('keydown', e => {
    if (e.key === 'Backspace' && !inp.value && i > 0) {
      pinInputs[i - 1].focus();
      pinInputs[i - 1].value = '';
      pinInputs[i - 1].classList.remove('filled');
    }
  });
});
pinInputs[0].focus();

async function checkPin() {
  const pin = Array.from(pinInputs).map(i => i.value).join('');
  if (pin.length !== 4) return;
  try {
    const res = await fetch(`${API}?action=verify-pin&pin=${pin}`);
    const data = await res.json();
    if (data.success) {
      currentUser = data.user;
      document.getElementById('pinUser').textContent = data.user;
      document.getElementById('pinSuccess').classList.add('show');
      document.getElementById('pinError').style.display = 'none';
      setTimeout(() => {
        document.getElementById('pinScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.add('show');
        document.getElementById('userName').textContent = data.user;
        initRunnerGrid();
        loadStatus();
      }, 600);
    } else {
      document.getElementById('pinError').style.display = 'block';
      pinInputs.forEach(i => { i.value = ''; i.classList.remove('filled'); });
      pinInputs[0].focus();
    }
  } catch (e) {
    document.getElementById('pinError').textContent = 'Connection error';
    document.getElementById('pinError').style.display = 'block';
  }
}

// ── Runner grid ──
function buildRunnerGrid(containerId, prefix) {
  const grid = document.getElementById(containerId);
  grid.innerHTML = RUNNERS.map(r => {
    const ctx = runnerContext ? runnerContext[r.id] : null;
    const contextHtml = ctx ? `<div class="rcontext">issued: ${ctx.issuedSince} | prev unsold: ${ctx.lastUnsold}</div>` : '';
    const maxHtml = ctx ? `<div class="rmax">max possible: ${ctx.maxUnsold}</div>` : '';
    return `
    <div class="runner-item">
      <div class="rname">${r.name}</div>
      ${contextHtml}
      <input type="number" id="${prefix}_${r.id}" value="0" min="0" inputmode="numeric"
        ${ctx ? `max="${ctx.maxUnsold}"` : ''}
        oninput="updateUnsoldTotal('${prefix}')">
      ${maxHtml}
    </div>`;
  }).join('');
}

function initRunnerGrid() {
  buildRunnerGrid('runnerGrid', 'unsold');
}

function getUnsoldTokens(prefix) {
  prefix = prefix || 'unsold';
  let total = 0;
  const detail = {};
  for (const r of RUNNERS) {
    const el = document.getElementById(`${prefix}_${r.id}`);
    if (!el) continue;
    const val = parseInt(el.value) || 0;
    if (val > 0) detail[r.name] = val;
    total += val;
    // Validate against max
    const ctx = runnerContext ? runnerContext[r.id] : null;
    if (ctx && val > ctx.maxUnsold) {
      el.classList.add('over-max');
    } else {
      el.classList.remove('over-max');
    }
  }
  return {total, detail};
}

function updateUnsoldTotal(prefix) {
  prefix = prefix || 'unsold';
  const {total} = getUnsoldTokens(prefix);
  const el = prefix === 'boot' ? document.getElementById('bootstrapUnsoldTotal') : document.getElementById('unsoldTotal');
  if (el) el.textContent = total;
  if (prefix === 'unsold') {
    document.getElementById('previewCard').classList.remove('show');
    previewData = null;
  }
}

// ── Load runner context from Odoo ──
async function loadRunnerContext(target) {
  // Find the button that was clicked
  let btn;
  if (target === 'bootstrap') {
    btn = document.getElementById('loadContextBtn');
  } else {
    // Find the settle runner context button
    btn = document.querySelector('.runner-unsold .reset-btn');
  }
  const origText = btn ? btn.textContent : '';
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner" style="width:12px;height:12px;border-width:1.5px;margin-right:6px"></span>Loading...'; }
  try {
    const res = await fetch(`${API}?action=get-runner-context`);
    const data = await res.json();
    if (!data.success) { alert(data.error); return; }
    runnerContext = data.runners;

    if (target === 'bootstrap') {
      buildRunnerGrid('bootstrapRunnerGrid', 'boot');
      document.getElementById('bootstrapRunnerSection').style.display = 'block';
      document.getElementById('bootstrapBtn').style.display = 'block';
      if (btn) btn.style.display = 'none';
    } else {
      buildRunnerGrid('runnerGrid', 'unsold');
      if (btn) { btn.innerHTML = '&#10003; Loaded'; btn.style.borderColor = 'var(--green)'; btn.style.color = 'var(--green)'; }
    }
  } catch (e) {
    alert('Error loading runner data: ' + e.message);
    if (btn) { btn.textContent = origText; }
  } finally {
    if (btn) btn.disabled = false;
  }
}

// ── Reset ──
async function resetTokenTracking() {
  if (!confirm('This will delete all token settlement records and let you re-bootstrap. Are you sure?')) return;
  try {
    const res = await fetch(`${API}?action=reset`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({settled_by: currentUser})
    });
    const data = await res.json();
    if (data.success) {
      lastSettlement = null;
      runnerContext = null;
      document.getElementById('activeSection').style.display = 'none';
      document.getElementById('bootstrapCard').style.display = 'block';
      // Reset bootstrap UI
      document.getElementById('bootstrapRunnerSection').style.display = 'none';
      document.getElementById('bootstrapBtn').style.display = 'none';
      document.getElementById('loadContextBtn').style.display = 'block';
      document.getElementById('historyList').innerHTML = '<div class="loading">No settlements yet</div>';
    } else {
      alert(data.error);
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// ── Status ──
async function loadStatus() {
  try {
    const res = await fetch(`${API}?action=get-status`);
    const data = await res.json();
    if (!data.success) return;

    if (!data.lastSettlement) {
      document.getElementById('bootstrapCard').style.display = 'block';
      document.getElementById('activeSection').style.display = 'none';
    } else {
      lastSettlement = data.lastSettlement;
      document.getElementById('bootstrapCard').style.display = 'none';
      document.getElementById('activeSection').style.display = 'block';
      updatePeriodDisplay();
      loadHistory();
    }
  } catch (e) {
    console.error('loadStatus error:', e);
  }
}

function updatePeriodDisplay() {
  if (!lastSettlement) return;
  const since = new Date(lastSettlement.settled_at);
  const now = new Date();
  const diffMs = now - since;
  const hours = Math.floor(diffMs / 3600000);
  const mins = Math.floor((diffMs % 3600000) / 60000);

  const istStr = since.toLocaleString('en-IN', {timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: 'numeric', minute: '2-digit', hour12: true});
  document.getElementById('periodText').textContent = `Since ${istStr}`;
  document.getElementById('elapsedText').textContent = `${hours}h ${mins}m ago`;

  const carry = lastSettlement.runner_unsold_qty || 0;
  const carryEl = document.getElementById('carryInfo');
  if (carry > 0) {
    carryEl.textContent = `Carry-forward: ${carry} unsold tokens from previous period`;
    carryEl.style.display = 'block';
  } else {
    carryEl.style.display = 'none';
  }
}

// ── Bootstrap ──
async function bootstrap() {
  const {total, detail} = getUnsoldTokens('boot');
  const btn = document.getElementById('bootstrapBtn');
  btn.disabled = true;
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span>Starting...';
  try {
    const res = await fetch(`${API}?action=bootstrap`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({settled_by: currentUser, unsold_tokens: total, unsold_detail: detail})
    });
    const data = await res.json();
    if (data.success) {
      lastSettlement = {settled_at: data.settled_at, is_bootstrap: 1, runner_unsold_qty: data.runnerUnsold || 0};
      document.getElementById('bootstrapCard').style.display = 'none';
      document.getElementById('activeSection').style.display = 'block';
      initRunnerGrid();
      updatePeriodDisplay();
      loadHistory();
    } else {
      alert(data.error);
    }
  } catch (e) {
    alert('Error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'Start Token Tracking';
  }
}

// ── Weight estimate ──
function updateEstimate() {
  const w = parseFloat(document.getElementById('weightInput').value);
  const btn = document.getElementById('previewBtn');
  if (!w || w < BOX_TARE) {
    document.getElementById('estimateCount').textContent = '-';
    btn.disabled = true;
    return;
  }
  const count = Math.round((w - BOX_TARE) / TOKEN_WEIGHT);
  document.getElementById('estimateCount').textContent = '~' + count;
  btn.disabled = false;
  // Hide previous preview if weight changes
  document.getElementById('previewCard').classList.remove('show');
  previewData = null;
}

// ── Preview ──
let previewing = false;
async function previewSettlement() {
  if (previewing) return;
  previewing = true;
  const btn = document.getElementById('previewBtn');
  btn.disabled = true;
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span>Fetching Odoo data...';

  try {
    const periodStart = lastSettlement.settled_at;
    const periodEnd = new Date().toISOString();
    const res = await fetch(`${API}?action=get-beverage-data&from=${encodeURIComponent(periodStart)}&to=${encodeURIComponent(periodEnd)}`);
    const data = await res.json();
    if (!data.success) { alert(data.error); return; }

    const w = parseFloat(document.getElementById('weightInput').value);
    const tokenCount = Math.round((w - BOX_TARE) / TOKEN_WEIGHT);
    const carryForward = lastSettlement.runner_unsold_qty || 0;
    const {total: unsoldTokens, detail: unsoldDetail} = getUnsoldTokens();
    const expected = carryForward + data.total - unsoldTokens;
    const discrepancy = tokenCount - expected;

    previewData = {
      odooTotal: data.total, chai: data.chai, coffee: data.coffee, lemonTea: data.lemon_tea,
      tokenIssueQty: data.tokenIssueQty, compQty: data.compQty || 0,
      carryForward, unsoldTokens, unsoldDetail,
      expected, tokenCount, discrepancy, grossWeight: w
    };
    renderPreview(previewData);
    // Reset settle button for new preview
    const settleBtn = document.getElementById('settleBtn');
    settleBtn.disabled = false;
    settleBtn.classList.remove('loading','btn-done');
    settleBtn.textContent = 'Settle & Empty Box';
    document.getElementById('previewCard').classList.add('show');
    setTimeout(() => document.getElementById('previewCard').scrollIntoView({behavior:'smooth',block:'start'}), 100);
  } catch (e) {
    alert('Error fetching data: ' + e.message);
  } finally {
    previewing = false;
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'Preview Settlement';
  }
}

function renderPreview(d) {
  const discAbs = Math.abs(d.discrepancy);
  let discClass;
  if (discAbs <= 2) discClass = 'disc-green';
  else if (discAbs <= 5) discClass = 'disc-yellow';
  else discClass = 'disc-red';
  const discSign = d.discrepancy > 0 ? '+' : '';

  const allBev = d.odooTotal + d.compQty;
  document.getElementById('previewContent').innerHTML = `
    <table class="breakdown-table">
      <tr><th>Product</th><th>Chai</th><th>Coffee</th><th>Lemon Tea</th><th>Total</th></tr>
      <tr><td>All Beverages (POS)</td><td>${d.chai}</td><td>${d.coffee}</td><td>${d.lemonTea}</td><td>${allBev}</td></tr>
    </table>
    <div class="info-row" style="margin-bottom:16px">
      <div class="info-chip"><div class="chip-val">${d.odooTotal - d.tokenIssueQty}</div>Direct (Cash/UPI/Card)</div>
      <div class="info-chip"><div class="chip-val">${d.tokenIssueQty}</div>Token Issue (runners)</div>
      <div class="info-chip" style="opacity:0.6"><div class="chip-val">${d.compQty}</div>Comp (not in box)</div>
    </div>
    <div class="formula-box">
      <div class="formula-line"><span class="formula-label">Carry-forward (prev unsold)</span><span class="formula-val">${d.carryForward}</span></div>
      <div class="formula-line"><span class="formula-label">+ Pink token beverages</span><span class="formula-val">${d.odooTotal}</span></div>
      <div class="formula-line"><span class="formula-label">&minus; Unsold with runners now</span><span class="formula-val">${d.unsoldTokens}</span></div>
      <div class="formula-line total"><span class="formula-label">= Expected in box</span><span class="formula-val">${d.expected}</span></div>
    </div>
    <div class="result-row"><span class="label">Tokens in Box (by weight)</span><span class="value">${d.tokenCount}</span></div>
    <div class="result-row" style="margin-top:4px"><span class="label">Weight</span><span class="value">${d.grossWeight} g</span></div>
    <div class="discrepancy-box ${discClass}">
      <div class="disc-value">${discSign}${d.discrepancy}</div>
      <div class="disc-label">Discrepancy (physical &minus; expected)</div>
    </div>
  `;
}

// ── Settle ──
let settling = false;
async function settle() {
  if (!previewData || settling) return;
  settling = true;
  const btn = document.getElementById('settleBtn');
  btn.disabled = true;
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span>Settling...';

  try {
    const notes = document.getElementById('notesInput').value.trim();
    const res = await fetch(`${API}?action=settle`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        settled_by: currentUser,
        gross_weight_kg: previewData.grossWeight,
        unsold_tokens: previewData.unsoldTokens,
        unsold_detail: previewData.unsoldDetail,
        notes
      })
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('previewCard').classList.remove('show');
      document.getElementById('weightInput').value = '';
      document.getElementById('estimateCount').textContent = '-';
      document.getElementById('notesInput').value = '';
      document.getElementById('previewBtn').disabled = true;

      // Show success banner + settlement report
      lastSettleResult = data.result;
      lastSettleResult.settledBy = currentUser;
      showSettlementReport(data.result);

      // Mark button as done (don't revert to "Settle & Empty Box")
      btn.classList.remove('loading');
      btn.classList.add('btn-done');
      btn.innerHTML = '&#10003; Settlement Recorded';

      previewData = null;
      RUNNERS.forEach(r => { document.getElementById(`unsold_${r.id}`).value = 0; });
      document.getElementById('unsoldTotal').textContent = '0';
      loadStatus();

      // Scroll to the report
      setTimeout(() => document.getElementById('reportSection').scrollIntoView({behavior:'smooth',block:'start'}), 150);

      // Auto-send tea master PDF via WhatsApp
      autoSendTeaMasterReport(data.result);
    } else {
      alert(data.error);
      btn.disabled = false;
      btn.classList.remove('loading');
      btn.textContent = 'Settle & Empty Box';
    }
  } catch (e) {
    alert('Error: ' + e.message);
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'Settle & Empty Box';
  } finally {
    settling = false;
  }
}

// ── History ──
async function loadHistory() {
  try {
    const res = await fetch(`${API}?action=history`);
    const data = await res.json();
    if (!data.success) return;

    const list = document.getElementById('historyList');
    if (!data.settlements.length) {
      list.innerHTML = '<div class="loading">No settlements yet</div>';
      return;
    }

    historyData = data.settlements; // store for PDF download
    list.innerHTML = data.settlements.map((s, idx) => {
      const discAbs = Math.abs(s.discrepancy || 0);
      let badgeClass, badgeText;
      if (discAbs <= 2) { badgeClass = 'green'; badgeText = discAbs === 0 ? 'Exact' : '\u00B1' + discAbs; }
      else if (discAbs <= 5) { badgeClass = 'yellow'; badgeText = (s.discrepancy > 0 ? '+' : '') + s.discrepancy; }
      else { badgeClass = 'red'; badgeText = (s.discrepancy > 0 ? '+' : '') + s.discrepancy; }

      const dt = new Date(s.settled_at);
      const dateStr = dt.toLocaleString('en-IN', {timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: 'numeric', minute: '2-digit', hour12: true});
      const carry = s.carry_forward_qty || 0;
      const unsold = s.runner_unsold_qty || 0;

      return `<div class="history-item">
        <div class="history-header">
          <span class="history-date">${dateStr} &middot; ${s.settled_by}</span>
          <span class="history-badge ${badgeClass}">${badgeText}</span>
        </div>
        <div class="history-detail">
          Weight: <span>${(s.gross_weight_kg||0) < 50 ? (s.gross_weight_kg||0).toFixed(3)+' kg' : (s.gross_weight_kg||0)+' g'}</span> &rarr; <span>${s.token_count} tokens</span> &middot;
          Chai <span>${s.odoo_chai}</span> Coffee <span>${s.odoo_coffee}</span> Lemon <span>${s.odoo_lemon_tea}</span>
          ${s.notes ? '<br>' + s.notes : ''}
        </div>
        <div class="history-formula">
          ${carry} carry + ${s.odoo_total_beverages} sold &minus; ${unsold} unsold = ${s.expected_tokens} expected
        </div>
        <div class="history-actions">
          <button class="history-dl" onclick="downloadHistoryPDF(historyData[${idx}], 'full')">Full Report</button>
          <button class="history-dl" onclick="downloadHistoryPDF(historyData[${idx}], 'simple')">Tea Master</button>
        </div>
      </div>`;
    }).join('');
  } catch (e) {
    console.error('loadHistory error:', e);
  }
}

// ── Settlement Report ──
function showSettlementReport(d) {
  const fromIST = fmtIST(d.periodStart);
  const toIST = fmtIST(d.periodEnd);
  const discAbs = Math.abs(d.discrepancy);
  let discClass, discText;
  if (discAbs <= 2) { discClass = 'disc-green'; discText = discAbs === 0 ? 'Exact Match' : `±${discAbs} (within tolerance)`; }
  else if (discAbs <= 5) { discClass = 'disc-yellow'; discText = `${d.discrepancy > 0 ? '+' : ''}${d.discrepancy} (minor)`; }
  else { discClass = 'disc-red'; discText = `${d.discrepancy > 0 ? '+' : ''}${d.discrepancy} (needs investigation)`; }

  document.getElementById('reportContent').innerHTML = `
    <div class="success-banner">
      <div class="check">&#10003;</div>
      <div class="msg">Settlement Recorded Successfully</div>
      <div class="sub">${d.tokenCount} tokens &middot; ${fromIST} → ${toIST}</div>
    </div>
    <table class="breakdown-table">
      <tr><th>Product</th><th>Chai</th><th>Coffee</th><th>Lemon Tea</th><th>Total</th></tr>
      <tr><td>Pink Token Beverages</td><td>${d.chai}</td><td>${d.coffee}</td><td>${d.lemonTea}</td><td>${d.odooTotal}</td></tr>
    </table>
    <div class="info-row" style="margin-bottom:16px">
      <div class="info-chip"><div class="chip-val">${d.odooTotal - d.tokenIssueQty}</div>Direct Sales</div>
      <div class="info-chip"><div class="chip-val">${d.tokenIssueQty}</div>Token Issue</div>
      <div class="info-chip" style="opacity:0.6"><div class="chip-val">${d.compQty}</div>Comp (excluded)</div>
    </div>
    <div class="formula-box">
      <div class="formula-line"><span class="formula-label">Carry-forward (prev unsold)</span><span class="formula-val">${d.carryForward}</span></div>
      <div class="formula-line"><span class="formula-label">+ Pink token beverages</span><span class="formula-val">${d.odooTotal}</span></div>
      <div class="formula-line"><span class="formula-label">− Unsold with runners now</span><span class="formula-val">${d.currentUnsold}</span></div>
      <div class="formula-line total"><span class="formula-label">= Expected in box</span><span class="formula-val">${d.expected}</span></div>
    </div>
    <div class="result-row"><span class="label">Tokens in Box (by weight)</span><span class="value">${d.tokenCount}</span></div>
    <div class="result-row" style="margin-top:4px"><span class="label">Weight</span><span class="value">${d.grossWeight} g</span></div>
    <div class="discrepancy-box ${discClass}">
      <div class="disc-value">${d.discrepancy > 0 ? '+' : ''}${d.discrepancy}</div>
      <div class="disc-label">${discText}</div>
    </div>
  `;
  document.getElementById('reportSection').classList.add('show');
}

function fmtIST(iso) {
  return new Date(iso).toLocaleString('en-IN', {timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: 'numeric', minute: '2-digit', hour12: true});
}

// ── PDF Generation ──
function generateTeaMasterPDF(d) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const W = 210, M = 20, CW = 170;
  let y = 0;

  const fromIST = fmtIST(d.periodStart);
  const toIST = fmtIST(d.periodEnd);

  // Header bar
  doc.setFillColor(172, 126, 84);
  doc.rect(0, 0, W, 42, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(22); doc.setFont('helvetica', 'bold');
  doc.text('NAWABI CHAI HOUSE', W / 2, 18, {align: 'center'});
  doc.setFontSize(13); doc.setFont('helvetica', 'normal');
  doc.text('Token Box Settlement Report', W / 2, 30, {align: 'center'});
  doc.setFontSize(10);
  doc.text(`${fromIST}  →  ${toIST}`, W / 2, 38, {align: 'center'});

  y = 54;
  doc.setTextColor(0, 0, 0);

  // ── Period box ──
  doc.setFillColor(245, 245, 245);
  doc.roundedRect(M, y, CW, 22, 3, 3, 'F');
  doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.setTextColor(120, 120, 120);
  doc.text('Tokens collected during this period', M + 5, y + 8);
  doc.setTextColor(0, 0, 0); doc.setFont('helvetica', 'bold'); doc.setFontSize(11);
  doc.text(`From: ${fromIST}`, M + 5, y + 15);
  doc.text(`To: ${toIST}`, M + 5, y + 20);

  y += 32;

  // ── Beverages Sold ──
  doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
  doc.text('Beverages Sold (POS System)', M, y); y += 8;

  // Table header
  doc.setFillColor(235, 235, 235);
  doc.rect(M, y, CW, 9, 'F');
  doc.setFontSize(10); doc.setFont('helvetica', 'bold');
  doc.text('Product', M + 5, y + 6);
  doc.text('Quantity', M + CW - 5, y + 6, {align: 'right'});
  y += 9;

  // Table rows
  const items = [['Irani Chai', d.chai], ['Coffee', d.coffee], ['Lemon Tea', d.lemonTea]];
  doc.setFont('helvetica', 'normal'); doc.setFontSize(12);
  for (const [name, qty] of items) {
    y += 1;
    doc.text(name, M + 5, y + 6);
    doc.text(String(qty), M + CW - 5, y + 6, {align: 'right'});
    y += 8;
    doc.setDrawColor(220, 220, 220); doc.line(M, y, M + CW, y);
  }

  // Total row
  y += 3;
  doc.setFont('helvetica', 'bold'); doc.setFontSize(13);
  doc.text('Total Sold', M + 5, y + 6);
  doc.text(String(d.odooTotal), M + CW - 5, y + 6, {align: 'right'});
  y += 14;

  // ── Token Box ──
  doc.setDrawColor(200, 200, 200);
  doc.setFillColor(250, 250, 250);
  doc.roundedRect(M, y, CW, 28, 3, 3, 'FD');
  doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
  doc.text('Tokens in Box', M + 5, y + 10);
  doc.setFont('helvetica', 'normal'); doc.setFontSize(11);
  doc.setTextColor(100, 100, 100);
  doc.text(`Box Weight: ${d.grossWeight < 50 ? d.grossWeight.toFixed(3)+' kg' : d.grossWeight+' g'}`, M + 5, y + 18);
  doc.setTextColor(0, 0, 0); doc.setFont('helvetica', 'bold'); doc.setFontSize(16);
  doc.text(`${d.tokenCount} tokens`, M + CW - 5, y + 20, {align: 'right'});
  y += 38;

  // ── Result ──
  const discAbs = Math.abs(d.discrepancy);
  let resultText, resultColor;
  if (discAbs <= 2) {
    resultColor = [34, 197, 94]; // green
    resultText = discAbs === 0 ? 'PERFECT MATCH' : `MATCH (±${discAbs} tolerance)`;
  } else if (discAbs <= 5) {
    resultColor = [234, 179, 8]; // yellow
    resultText = d.discrepancy > 0 ? `${d.discrepancy} EXTRA TOKENS` : `${discAbs} TOKENS SHORT`;
  } else {
    resultColor = [239, 68, 68]; // red
    resultText = d.discrepancy > 0 ? `${d.discrepancy} EXTRA TOKENS` : `${discAbs} TOKENS SHORT`;
  }

  doc.setFillColor(...resultColor);
  doc.roundedRect(M, y, CW, 35, 4, 4, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold'); doc.setFontSize(24);
  doc.text(resultText, W / 2, y + 16, {align: 'center'});
  doc.setFontSize(11); doc.setFont('helvetica', 'normal');
  doc.text(`Sold: ${d.odooTotal}  |  Found: ${d.tokenCount}  |  Difference: ${d.discrepancy > 0 ? '+' : ''}${d.discrepancy}`, W / 2, y + 27, {align: 'center'});
  y += 45;

  // ── Footer ──
  doc.setTextColor(150, 150, 150); doc.setFontSize(10); doc.setFont('helvetica', 'normal');
  doc.text(`Settled by ${d.settledBy || currentUser}  •  ${toIST}`, W / 2, y, {align: 'center'});

  return doc;
}

function generateFullPDF(d) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const W = 210, M = 20, CW = 170;
  let y = 0;

  const fromIST = fmtIST(d.periodStart);
  const toIST = fmtIST(d.periodEnd);

  // Header
  doc.setFillColor(26, 34, 52);
  doc.rect(0, 0, W, 42, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(20); doc.setFont('helvetica', 'bold');
  doc.text('NCH Token Settlement — Full Report', W / 2, 18, {align: 'center'});
  doc.setFontSize(11); doc.setFont('helvetica', 'normal');
  doc.text(`${fromIST}  →  ${toIST}`, W / 2, 28, {align: 'center'});
  doc.text(`Settled by ${d.settledBy || currentUser}`, W / 2, 36, {align: 'center'});

  y = 52;
  doc.setTextColor(0, 0, 0);

  // ── Beverage Breakdown ──
  doc.setFont('helvetica', 'bold'); doc.setFontSize(13);
  doc.text('Beverage Breakdown', M, y); y += 7;

  doc.setFillColor(240, 240, 240);
  doc.rect(M, y, CW, 8, 'F');
  doc.setFontSize(9); doc.setFont('helvetica', 'bold');
  doc.text('Category', M + 3, y + 5.5);
  doc.text('Chai', M + 70, y + 5.5, {align: 'right'});
  doc.text('Coffee', M + 100, y + 5.5, {align: 'right'});
  doc.text('Lemon Tea', M + 135, y + 5.5, {align: 'right'});
  doc.text('Total', M + CW - 3, y + 5.5, {align: 'right'});
  y += 8;

  doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
  const allBev = d.odooTotal + (d.compQty || 0);
  doc.text('All POS Beverages', M + 3, y + 5.5);
  doc.text(String(d.chai), M + 70, y + 5.5, {align: 'right'});
  doc.text(String(d.coffee), M + 100, y + 5.5, {align: 'right'});
  doc.text(String(d.lemonTea), M + 135, y + 5.5, {align: 'right'});
  doc.text(String(allBev), M + CW - 3, y + 5.5, {align: 'right'});
  y += 7; doc.setDrawColor(220, 220, 220); doc.line(M, y, M + CW, y);

  doc.setFont('helvetica', 'bold');
  doc.text('Pink Token (in box)', M + 3, y + 5.5);
  doc.text(String(d.odooTotal), M + CW - 3, y + 5.5, {align: 'right'});
  y += 7; doc.line(M, y, M + CW, y);

  doc.setFont('helvetica', 'normal'); doc.setTextColor(150, 150, 150);
  doc.text(`Comp excluded: ${d.compQty || 0}`, M + 3, y + 5.5);
  doc.text(`Token Issue (runners): ${d.tokenIssueQty}`, M + 80, y + 5.5);
  doc.text(`Direct: ${d.odooTotal - d.tokenIssueQty}`, M + CW - 3, y + 5.5, {align: 'right'});
  y += 12;

  // ── Formula ──
  doc.setTextColor(0, 0, 0);
  doc.setFont('helvetica', 'bold'); doc.setFontSize(13);
  doc.text('Expected Token Calculation', M, y); y += 7;

  doc.setFillColor(248, 248, 248);
  doc.roundedRect(M, y, CW, 36, 3, 3, 'F');
  doc.setFontSize(11); doc.setFont('helvetica', 'normal');
  const fy = y + 8;
  doc.setTextColor(100, 100, 100); doc.text('Carry-forward (prev unsold)', M + 5, fy);
  doc.setTextColor(0, 0, 0); doc.setFont('helvetica', 'bold'); doc.text(String(d.carryForward), M + CW - 5, fy, {align: 'right'});
  doc.setFont('helvetica', 'normal'); doc.setTextColor(100, 100, 100); doc.text('+ Pink token beverages', M + 5, fy + 8);
  doc.setTextColor(0, 0, 0); doc.setFont('helvetica', 'bold'); doc.text(String(d.odooTotal), M + CW - 5, fy + 8, {align: 'right'});
  doc.setFont('helvetica', 'normal'); doc.setTextColor(100, 100, 100); doc.text('− Unsold with runners now', M + 5, fy + 16);
  doc.setTextColor(0, 0, 0); doc.setFont('helvetica', 'bold'); doc.text(String(d.currentUnsold), M + CW - 5, fy + 16, {align: 'right'});
  doc.setDrawColor(180, 180, 180); doc.line(M + 5, fy + 19, M + CW - 5, fy + 19);
  doc.setFontSize(13); doc.text('= Expected in box', M + 5, fy + 26);
  doc.text(String(d.expected), M + CW - 5, fy + 26, {align: 'right'});
  y += 44;

  // ── Token Count ──
  doc.setFont('helvetica', 'bold'); doc.setFontSize(13);
  doc.text('Physical Count', M, y); y += 7;

  doc.setFillColor(248, 248, 248);
  doc.roundedRect(M, y, CW, 18, 3, 3, 'F');
  doc.setFontSize(11); doc.setFont('helvetica', 'normal');
  doc.text(`Box Weight: ${d.grossWeight < 50 ? d.grossWeight.toFixed(3)+' kg' : d.grossWeight+' g'}`, M + 5, y + 7);
  doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
  doc.text(`${d.tokenCount} tokens`, M + CW - 5, y + 12, {align: 'right'});
  y += 26;

  // ── Discrepancy ──
  const discAbs = Math.abs(d.discrepancy);
  let bgR, bgG, bgB;
  if (discAbs <= 2) { bgR = 34; bgG = 197; bgB = 94; }
  else if (discAbs <= 5) { bgR = 234; bgG = 179; bgB = 8; }
  else { bgR = 239; bgG = 68; bgB = 68; }

  doc.setFillColor(bgR, bgG, bgB);
  doc.roundedRect(M, y, CW, 22, 4, 4, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold'); doc.setFontSize(18);
  const discSign = d.discrepancy > 0 ? '+' : '';
  doc.text(`Discrepancy: ${discSign}${d.discrepancy}`, W / 2, y + 10, {align: 'center'});
  doc.setFontSize(10); doc.setFont('helvetica', 'normal');
  doc.text(`Expected: ${d.expected}  |  Found: ${d.tokenCount}  |  Physical − Expected`, W / 2, y + 18, {align: 'center'});

  return doc;
}

function downloadPDF(type) {
  const d = lastSettleResult;
  if (!d) return;
  const doc = type === 'simple' ? generateTeaMasterPDF(d) : generateFullPDF(d);
  const dateStr = new Date(d.periodEnd).toLocaleDateString('en-IN', {timeZone: 'Asia/Kolkata', day: '2-digit', month: 'short'}).replace(' ', '');
  doc.save(`NCH_Token_${type === 'simple' ? 'TeaMaster' : 'Full'}_${dateStr}.pdf`);
}

function downloadHistoryPDF(s, type) {
  // Reconstruct data from D1 settlement record
  const allBev = (s.odoo_chai || 0) + (s.odoo_coffee || 0) + (s.odoo_lemon_tea || 0);
  const d = {
    periodStart: s.period_start, periodEnd: s.period_end,
    grossWeight: s.gross_weight_kg, tokenCount: s.token_count,
    odooTotal: s.odoo_total_beverages, chai: s.odoo_chai, coffee: s.odoo_coffee, lemonTea: s.odoo_lemon_tea,
    tokenIssueQty: s.token_issue_qty, compQty: Math.max(0, allBev - s.odoo_total_beverages),
    carryForward: s.carry_forward_qty || 0, currentUnsold: s.runner_unsold_qty || 0,
    expected: s.expected_tokens, discrepancy: s.discrepancy,
    settledBy: s.settled_by
  };
  const doc = type === 'simple' ? generateTeaMasterPDF(d) : generateFullPDF(d);
  const dateStr = new Date(s.settled_at).toLocaleDateString('en-IN', {timeZone: 'Asia/Kolkata', day: '2-digit', month: 'short'}).replace(' ', '');
  doc.save(`NCH_Token_${type === 'simple' ? 'TeaMaster' : 'Full'}_${dateStr}.pdf`);
}

async function autoSendTeaMasterReport(d) {
  const statusEl = document.getElementById('waStatus');
  statusEl.textContent = 'Sending report to WhatsApp...';
  statusEl.className = 'wa-status';

  try {
    const doc = generateTeaMasterPDF(d);
    const pdfBase64 = doc.output('datauristring').split(',')[1];
    const dateStr = new Date(d.periodEnd).toLocaleDateString('en-IN', {timeZone: 'Asia/Kolkata', day: '2-digit', month: 'short'}).replace(' ', '');
    const fileName = `NCH_Token_Report_${dateStr}.pdf`;

    const fromIST = fmtIST(d.periodStart);
    const toIST = fmtIST(d.periodEnd);
    const discSign = d.discrepancy > 0 ? '+' : '';
    const matchText = Math.abs(d.discrepancy) <= 2 ? 'Match' : `${discSign}${d.discrepancy}`;
    const caption = `NCH Token Box Settlement\n${fromIST} → ${toIST}\n\nSold: ${d.odooTotal} | Tokens: ${d.tokenCount} | ${matchText}\n\nSee attached report.`;

    const res = await fetch(`${API}?action=send-report`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({pdf_base64: pdfBase64, file_name: fileName, caption, phones: WA_PHONES})
    });
    const data = await res.json();
    if (data.success) {
      const sent = data.results.filter(r => r.ok).length;
      statusEl.textContent = `Report sent to ${sent} number${sent !== 1 ? 's' : ''}`;
      statusEl.className = 'wa-status sent';
    } else {
      statusEl.textContent = 'Failed to send: ' + (data.error || 'Unknown error');
      statusEl.className = 'wa-status fail';
    }
  } catch (e) {
    statusEl.textContent = 'Send failed: ' + e.message;
    statusEl.className = 'wa-status fail';
  }
}

function logout() {
  currentUser = null;
  lastSettlement = null;
  previewData = null;
  lastSettleResult = null;
  runnerContext = null;
  historyData = [];
  document.getElementById('dashboard').classList.remove('show');
  document.getElementById('pinScreen').classList.remove('hidden');
  document.getElementById('pinSuccess').classList.remove('show');
  document.getElementById('previewCard').classList.remove('show');
  document.getElementById('reportSection').classList.remove('show');
  pinInputs.forEach(i => { i.value = ''; i.classList.remove('filled'); });
  pinInputs[0].focus();
}
</script>
</body>
</html>
